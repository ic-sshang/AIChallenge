Basically this azure function gets records from TransActivity_DetailImport table for over a period of days and prepares a csv file. This file is then uploaded to the azure blob storage and sent in email to the configrued email addresses.
Program also has a HTTP Triggered function (for the same functionality) which accepts a date as an argument, this date argument can be used to test the functionality on any day, function will consider the passed date as current date.
(This was implemented as part of BRAIN-139 to make the functionality testable on any day based on the date argument).
Stored Procedure
Test DB
Description
selTerminalTransActivity
ICG_Test
Gets data from the  
TransActivity_DetailImport 
table based on the CompareDate, Terminal Type Id, Terminal Id, TransactionType, Short Description and InternalUse.
The CompareDate is calculated based on the DaysBack passed to the SP.
DaysBack and TerminalTypeId are mandatory. Others are optional parameters.
selFundingBatchByDate
ICG_Test
Gets Data from the 
FundingBatches 
table based on CompareDate, ServiceFeeBatch, DebitAmount, TerminalID, FundingBatchID.
The CompareDate is calculated based on the DaysBack parameter passed to the SP.
Only CompareDate is mandatory, other parameters are optional.
selICGRecon_SettledBatchTotals
ICG_DW
Process
Get WD_PPAAP, WD_PPAAP_DW transaction records over past daysback number of days from TransActivity_DetailImport table (using selTerminalTransActivity).
for each biller id and terminal from the TransActivity_DetailImport get the funding batch based on terminalid , debit amount and daysback
Get the fundingbatchid and funding processeddate from fundingbatch table
For subscriber id =1 records 
         Get records using selICGRecon_SettledBatchTotals from datawarehouse db
         Get networkreference and Billerportal settled date from it
         we will retry twice by shifting daysback by 1 day each time if no records are found in dw db. 
prepare a csv file based on the records from TransActivity_DetailImport
filename will be HyperWalletPayoutRecon_<date>.csv
Upload the file to azure blob.
send email with the generated file.
log Taskdate and exception count using insFCPTaskLog stored procedure.
 URL:/spaces/ED/pages/2625765408/fnICG_HyperWalletPayoutRecon