Necessary Changes for Containerization
Direct Exclusions
Remove 
External Resources
Remove 
*/ExternalTables
dbo
pdf
RPT
SMS
TRK
Remove 
dbo
 Views that are reliant on 
External Tables
vwEquipment.sql
vwServiceTeams.sql
vwICFTINums.sql
vwEquipmentTracking.sql
vwEquipmentModel.sql
vwEmployees.sql
Schema and Database Object Modifications
Update the 
dbo.IntegratorImages
 table. The 
Image
 column datatype should be changed from 
varchar(25)
 to 
image
.
Without this change, the DACPAC fails to apply due to an incompatible data type.
bash
An error occurred while the batch was being executed.
Updating database (Failed)
*** Could not deploy package.
Error SQL72014: Core Microsoft SqlClient Data Provider: Msg 206, Level 16, State 2, Procedure insIntegratorImage, Line 19 Operand type clash: image is incompatible with varchar
Error SQL72045: Script execution error.  The executed script:
CREATE PROCEDURE [dbo].[insIntegratorImage]
@IntegratorID INT, @ImageTypeID INT, @ImageExtension VARCHAR (4), @Image IMAGE, @IntegratorImageGUID UNIQUEIDENTIFIER=NULL
AS
IF @IntegratorImageGUID IS NULL
    SET @IntegratorImageGUID = (SELECT NewID());
BEGIN
    INSERT  INTO IntegratorImages (IntegratorID, IntegratorImageGUID, ImageTypeID, ImageExtension, [Image])
    VALUES                       (@IntegratorID, @IntegratorImageGUID, @ImageTypeID, @ImageExtension, @Image);
    SELECT @@IDENTITY AS IntegratorImageID;
END
SELECT *
FROM   IntegratorImages;
The existing table definition can be modified to use 
Image
 instead of 
Varchar(25)
 - this better aligns with stored procedures interacting with this table, which do use the 
Image
 datatype
sql
CREATE TABLE [dbo].[IntegratorImages] (
    /** Other items excluded for brevity */
    [Image]               VARCHAR (25)     NOT NULL,
    
    /** Update the [Image] column like so */
    [Image]               IMAGE            NOT NULL,
);
dbo.insIntegratorImage stored proc definition
Update the following stored procedures to avoid invalid parameter state - note that they just need to have the 
default
 parameter explicitly added.
spRPPSLocator.sql
spRPPSLocatorMPW.sql
spRPPSLocatorMPW2.sql
Without this change - the following errors are emitted at the time of DACPAC application to the containerized database:
bash
Error SQL72014: Core Microsoft SqlClient Data Provider:
Msg 313, Level 16, State 2, Procedure spRPPSLocator, 
Line 74 An insufficient number of arguments were supplied for the procedure 
or function dbo.fnRPPSLocator_AutoAcctAmountMatch.

Error SQL72014: Core Microsoft SqlClient Data Provider:
Msg 313, Level 16, State 2, Procedure spRPPSLocator,
Line 82 An insufficient number of arguments were supplied for the procedure
or function dbo.fnRPPSLocator_AutoAcctMatch.
Expand this panel to view the full error output
bash
An error occurred while the batch was being executed.
Updating database (Failed)
*** Could not deploy package.
Error SQL72014: Core Microsoft SqlClient Data Provider: Msg 313, Level 16, State 2, Procedure spRPPSLocator, Line 74 An insufficient number of arguments were supplied for the procedure or function dbo.fnRPPSLocator_AutoAcctAmountMatch.
Error SQL72045: Script execution error.  The executed script:
CREATE PROCEDURE [dbo].[spRPPSLocator]
@BillerID INT, @SearchCustomerName VARCHAR (50), @SearchPaymentAmount MONEY, @SearchAccountNumber VARCHAR (50)
AS
DECLARE @MinBalanceDue AS MONEY;
DECLARE @MaxBalanceDue AS MONEY;
SET @MinBalanceDue = (@SearchPaymentAmount * .9);
SET @MaxBalanceDue = (@SearchPaymentAmount * 1.1);
DECLARE @HistoryCount AS INT, @RPPSHistoryCount AS INT, @Score AS INT, @InvoiceID AS INT, @CustomerID AS INT, @InvoiceNumber AS VARCHAR (50), @InvoiceDate AS DATETIME, @InvoiceGUID AS VARCHAR (50), @TotalAmountDue AS MONEY, @BalanceDue AS MONEY, @AccountNumber AS VARCHAR (50), @CustomerName AS VARCHAR (50), @Custom1 AS VARCHAR (150), @InvoiceFormatGUID AS VARCHAR (50), @InvoiceFormatFilename AS VARCHAR (250), @AutoPriorMatch AS BIT, @AutoAcctMatch AS BIT, @AutoAcctAmountMatch AS BIT, @CatchErr AS VARCHAR (MAX);
SET @HistoryCount = 0;
SET @RPPSHistoryCount = 0;
SET @InvoiceID = 0;
DECLARE @OBD TABLE (
    [Score]                 INT           NOT NULL,
    [InvoiceID]             INT           NO
    
Error SQL72014: Core Microsoft SqlClient Data Provider: Msg 313, Level 16, State 2, Procedure spRPPSLocator, Line 82 An insufficient number of arguments were supplied for the procedure or function dbo.fnRPPSLocator_AutoAcctMatch.
Error SQL72045: Script execution error.  The executed script:
CREATE PROCEDURE [dbo].[spRPPSLocator]
@BillerID INT, @SearchCustomerName VARCHAR (50), @SearchPaymentAmount MONEY, @SearchAccountNumber VARCHAR (50)
AS
DECLARE @MinBalanceDue AS MONEY;
DECLARE @MaxBalanceDue AS MONEY;
SET @MinBalanceDue = (@SearchPaymentAmount * .9);
SET @MaxBalanceDue = (@SearchPaymentAmount * 1.1);
DECLARE @HistoryCount AS INT, @RPPSHistoryCount AS INT, @Score AS INT, @InvoiceID AS INT, @CustomerID AS INT, @InvoiceNumber AS VARCHAR (50), @InvoiceDate AS DATETIME, @InvoiceGUID AS VARCHAR (50), @TotalAmountDue AS MONEY, @BalanceDue AS MONEY, @AccountNumber AS VARCHAR (50), @CustomerName AS VARCHAR (50), @Custom1 AS VARCHAR (150), @InvoiceFormatGUID AS VARCHAR (50), @InvoiceFormatFilename AS VARCHAR (250), @AutoPriorMatch AS BIT, @AutoAcctMatch AS BIT, @AutoAcctAmountMatch AS BIT, @CatchErr AS VARCHAR (MAX);
SET @HistoryCount = 0;
SET @RPPSHistoryCount = 0;
SET @InvoiceID = 0;
DECLARE @OBD TABLE (
    [Score]                 INT           NOT NULL,
    [InvoiceID]             INT           NO

Time elapsed 0:01:58.22
Error: building at STEP "RUN ( /opt/mssql/bin/sqlservr & ) | grep -q "Service Broker manager has started"     && sqlpackage /a:Publish /tec:False /tsn:localhost,1433 /tdn:$DATABASE_NAME /tu:sa /tp:$MSSQL_SA_PASSWORD /sf:/opt/db/database.dacpac     && rm /opt/db/database.dacpac": while running runtime: exit status 1
It is worth noting that the functions 
fnRPPSLocator_AutoAcctMatch
 and 
fnRPPSLocator_AutoAcctAmountMatch
 already define default parameters (see below) - callers of these functions need to pass the 
DEFAULT
 value in place of the missing param - 
the SQL Server 2025 documentation, does indicate this is the correct approach
.
sql
CREATE FUNCTION [dbo].[fnRPPSLocator_AutoAcctMatch]
(
	@BillerID INT
	,@SearchAccountNumber VARCHAR(50)
	,@SearchByDisplayAccount BIT = 0
)

CREATE FUNCTION [dbo].[fnRPPSLocator_AutoAcctAmountMatch]
(
	@BillerID INT
	,@SearchAccountNumber VARCHAR(50)
	,@SearchPaymentAmount MONEY
	,@SearchByDisplayAccount BIT = 0
)
To fix this issue, simply pass 
DEFAULT
 as the value for the missing params in the indicated functions
sql
-- e.g. `spRPPSLocator.sql`
if (@AutoAcctAmountMatch=1)
    begin
	    SET @InvoiceID = dbo.fnRPPSLocator_AutoAcctAmountMatch(@BillerID, @SearchAccountNumber, @SearchPaymentAmount, DEFAULT) -- Explicitly pass 'DEFAULT' as the last param here.
		print 'Ran Auto Account Amount Match'
	end
		
if (@AutoAcctMatch=1 and @InvoiceID=0)
    begin
        SET @InvoiceID = dbo.fnRPPSLocator_AutoAcctMatch(@BillerID,@SearchAccountNumber, DEFAULT) -- Explicitly pass 'DEFAULT' as the last param here.
	    print 'Ran Auto Account Match'
    end		
Configuration for Containerization
In Visual Studio, add a new build configuration called 
Docker
 - following the steps below
Use the Configuration Manager option in the ‘Build’ context menu.
Opt to create a new build configuration.
Create a ‘Docker' build configuration based on ‘Release’
Make sure to edit the project properties & update the Build output path - verify the 
Release
 output path is still valid after copying its build configuration.
Modify the 
IC-BillerShard.sqlproj
 file directly - add another set of 
ItemGroup
 tags inside of the 
Project
 tags (this can be done near the bottom of the file.) and add the following:
xml
<!-- MSBuild condition to run this rule only on the 'Docker' configuration -->
<ItemGroup Condition="'$(Configuration)' == 'Docker'">
  
   <!-- External DataSource to 'DBMaster_GoldAzure' - this won't work in a containerized MSSQL -->
    <Build Remove="External Resources\*.sql" />
  
   <!-- External Tables are dependent on External Data Source -->
    <Build Remove="dbo\External Tables\*.sql" />
    <Build Remove="pdf\External Tables\*.sql" />
    <Build Remove="RPT\External Tables\*.sql" />
    <Build Remove="SMS\External Tables\*.sql" />
    <Build Remove="TRK\External Tables\*.sql" />
  
   <!-- Views are dependent on External Tables -->
    <Build Remove="dbo\Views\vwEquipment.sql" />
    <Build Remove="dbo\Views\vwServiceTeams.sql" />
    <Build Remove="dbo\Views\vwICFTINums.sql" />
    <Build Remove="dbo\Views\vwEquipmentTracking.sql" />
    <Build Remove="dbo\Views\vwEquipmentModel.sql" />
    <Build Remove="dbo\Views\vwEmployees.sql" />
  </ItemGroup>
Once the schema & stored proc updates have been made from the previous section and a new build configuration has been added for Docker that excludes External Tables and dependent views - this solution is ready to be built and containerized. This build can be run directly in Visual Studio or it can be done via command line using the MSBuild CLI:
powershell
& "../MSBuild.exe" ./IC-BillerShard/IC-BillerShard.sqlproj \
/p:OutDir=..\..\db\ \ # Optional - Outputs DACPAC to ./db/ in repository root.
/p:Configuration=Docker \ # Use the 'Docker' build configuration
/p:SkipInvalidConfigurations=true;
Full List of Exclusions
The build result of the 
Docker
 configuration, with the above 
ItemGroup
 set in the 
IC-BillerShard.sqlproject
 excludes the following items:
External Tables
dbo
Accela.sql
ACHSwapTable.sql
ACHVolumeOffenders.sql
Addresses.sql
AIQ.sql
Banks.sql
BillerNotice.sql
BlockedAch.sql
BostonCalendar.sql
BostonFileAudit.sql
BostonInterestFee.sql
BostonInterestFeeAudit.sql
BouncedEmailAddress.sql
CCBlackList.sql
CCBlackListName.sql
ChangeFileSpec.sql
ChaseFin10.sql
ChaseFin10test.sql
ChaseHierarchy.sql
ChaseRejects.sql
clByInvTypeReload.sql
CommercialBinRanges.sql
Contacts.sql
CRMReports.sql
CRMSettings.sql
CRMUserSettings.sql
DecryptionLog.sql
DefaultEmailMessages.sql
Department.sql
Divisions.sql
DW_RealTimeDataRefresh.sql
EmailQueueStats.sql
EmployeeCrmPermissions.sql
EmployeeDepartment.sql
EmployeeHistory.sql
Employees.sql
Equipment.sql
EquipmentTracking.sql
FlaggedIPs.sql
IntegratorBranding.sql
Integrators.sql
InvoiceCustom24.sql
ITRequestApprovals.sql
ITRequestApprovers.sql
IVRMargin.sql
MonthEndBillingConfig.sql
Notes.sql
PaymentScheduleUpdate37.sql
PhoneNumbers.sql
prdCloudStorebak.sql
Process.sql
ProcessEmailList.sql
ProcessLog.sql
ProcessLogDetail.sql
ProcessNote.sql
ProcessSetting.sql
Reconvey.sql
Releases.sql
Reminders.sql
Residual.sql
ResidualDataAmex.sql
ResidualDataCC.sql
ResidualDataEFT.sql
ResidualDataHGO.sql
ResidualDataImportAmex.sql
ResidualDataImportCC.sql
ResidualDataImportEFT.sql
ResidualDataIVR.sql
ResidualDataSalesReps.sql
ResidualDataVendorCC.sql
ResidualDataVendorEFT.sql
RevenueForecasting.sql
Revisions.sql
SalesReps.sql
ServiceTeamMembers.sql
ServiceTeams.sql
SMSErrs.sql
StoredProcedureStats.sql
SubmitterPaymentsWithNoConvFee.sql
SystemStatus.sql
tblEquipment.sql
tblEquipmentMaker.sql
tblEquipmentModel.sql
tblEquipmentStatus.sql
tblEquipmentType.sql
tblFedBankOverrides.sql
tblFedBanks.sql
TITQueue.sql
tmpChaseIDs.sql
TrackParticipants.sql
VisaDebitBin.sql
pdf
BillerAvailablePdfTemplates.sql
PDFExtractionFields.sql
PdfTemplateMarkers.sql
PdfTemplates.sql
RPT
StandardReportFrequencies.sql
StandardReports.sql
SMS
SMSReferenceLock.sql
SMSVendorLog.sql
TRK
BillerTrackDetail.sql
BillerTrackNotes.sql
BillerTracks.sql
SubTrack.sql
SubTracksCreated.sql
tblTrackActionType.sql
tblTrackControlType.sql
tblTrackStepAssignLevel.sql
tblTrackStepMemberType.sql
tblTrackTagTypes.sql
tblTrackUrls.sql
TrackActions.sql
TrackCustomValues.sql
TrackFavorites.sql
Tracks.sql
TrackStepMembers.sql
TrackSteps.sql
TrackTags.sql
Views
dbo
vwEquipment.sql
vwServiceTeams.sql
vwICFTINums.sql
vwEquipmentTracking.sql
vwEquipmentModel.sql
vwEmployees.sql
Stored Procedures in 
IC-BillerShard
 Reliant on External Data Source
dbo
Procs1
insBillerUsers.sql 
insprdPayNearMe.sql 
PurgeDemoData_sdd.sql
 
rptPartnerPaymentSchedules.sql 
selBillerEquipmentModels.sql
Procs2
spBillerSettingsConfig.sql
 
spChaseRejects_Azure.sql
spChaseRejects_AzureShard.sql 
spChaseRejects_AzureV2.sql
Procs3
spCreateBillSummary.sql 
spLoadBiller_Shard.sql 
spLoadBillerPhoneNumbers.sql 
spUIPageTextDefault.sql 
updBillerUsers.sql 
updprdPayNearMe.sql
mcl
selDataForCreditCardExpirationNotification.sql
selLoginUserActivity.sql
References
T-SQL Function Default Values
T-SQL Image Data Type
 URL:/spaces/EA/pages/4605018256/IC-BillerShard