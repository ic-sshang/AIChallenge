1
4
Payer Next Generation Overview
The Next Generation of Payer Application Infrastructure is modeled as a Spoke in the 
InvoiceCloud Hub and Spoke network topology
 and consists of a common VNet and AKS Cluster as well as Service specific (and in lower environments, Application Instance specific) Azure Resources used to support the Application’s distinct microservices.  
Application Instances Explained
An Application Instance is an isolated full stack deployment of the Payer Application within an 
Environment
.  Lower Environments can have multiple Payer Application Instances deployed, while the Production Environment is intended to only have a single Payer Application Instance.  The Application Instance index (a number starting at 0) will be part of the naming convention of the Azure and Kubernetes Resources that make up the Application Instance’s infrastructure stack.  The Application Instance index will also be part of the UI and API URLs in lower environments.
Payer Application Services Info and Endpoints
The Sandbox and DevTest Endpoints mentioned below will only be accessible from the Sandbox/DevTest 
Windows 
and 
Linux 
Jumpboxes.  The Production Endpoints will be accessible publicly and also from the Production 
Windows 
and 
Linux 
Jumpboxes.  The Production Endpoint external and internal traffic will both get routed thru Cloudflare to enable SSL/TLS transport level security.
One Time Payment
Abbreviation:  
otp
Application Instance: 
0
K8s Namespace: 
ns-otp0svc
URLs:
Sandbox
UI:   
http://sapripayer0web2sbx.z13.web.core.windows.net/onetimepayment
API: 
http://apibeta.sbx.invoicecloud.com/payer/otp0
DevTest
UI:   
http://sapripayer0web2dev.z13.web.core.windows.net/onetimepayment
API: 
http://apibeta.dev.invoicecloud.com/payer/otp0
Production
UI:   
https://payerbeta.invoicecloud.com/onetimepayment
API: 
https://apibeta.invoicecloud.com/payer/otp
Health-check Endpoint route: 
/health/
Payment Route
Abbreviation: 
payrte
Application Instance: 
0
K8s Namespace: 
ns-payrte0svc
URLs:
Sandbox
UI:   
http://sapripayer0web2sbx.z13.web.core.windows.net/paymentroute
API: 
http://apibeta.sbx.invoicecloud.com/payer/payment-route0
DevTest
UI:   
http://sapripayer0web2dev.z13.web.core.windows.net/paymentroute
API: 
http://apibeta.dev.invoicecloud.com/payer/payment-route0
Production
UI:   
https://payerbeta.invoicecloud.com/paymentroute
API: 
https://apibeta.invoicecloud.com/payer/payment-route
Health-check Endpoint route: 
/health/
Pay By Text
Abbreviation: 
paytxt
Application Instance: 
0
K8s Namespace: 
ns-paytxt0svc
Sandbox
API: 
http://apibeta.sbx.invoicecloud.com/payer/paytxt0
DevTest
API: 
http://apibeta.dev.invoicecloud.com/payer/paytxt0
Production
API: 
https://apibeta.invoicecloud.com/payer/paytxt
Autopay
Abbreviation: 
autopay
Application Instance: 
0
K8s Namespace: 
ns-autopay0svc
Sandbox
API: 
http://apibeta.sbx.invoicecloud.com/payer/autopay0
 
[Returned 503]
DevTest
API: 
http://apibeta.dev.invoicecloud.com/payer/autopay0
Production
API: 
https://apibeta.invoicecloud.com/payer/autopay
Paperless
Abbreviation: 
pprless
Application Instance: 
0
K8s Namespace: 
ns-pprless0svc
Sandbox
API: 
http://apibeta.sbx.invoicecloud.com/payer/pprless0
DevTest
API: 
http://apibeta.dev.invoicecloud.com/payer/pprless0
Production
API: 
https://apibeta.invoicecloud.com/payer/pprless
Azure Resources
Below are the Azure Resources used to create the Payer Spoke Infrastructure.
Each 
Region
, Primary (
pri
) and Secondary (
sec
), will have nearly identical Resource stacks to produce a redundant Spoke Infrastructure to provide Highly Available functionality.  The difference in Resources between environments will only occur when Azure PaaS resource has built-in Highly Available functionality, wherein the Resource will be deployed to the Primary Region and have the High Available secondary region configured within the Resource itself.
The Highly Available Payer Spoke will be deployed to the 
Sandbox Environment
, the 
DevTest Environment
, and the 
Production Environment
.
The current 
deployment_version
 is 
2
.
Payer Spoke Resource Groups
Azure Resource Group to contain the common Payer Spoke Resources per Region, Deployment Version, and Environment.
Naming Convention: 
rg-{region}-payerspoke{deployment_version}{-lower_environment}
Payer Virtual Network
Each Spoke Resource Group will contain an Azure Virtual Network (VNet).  The VNet will be used to create a Private Azure Kubernetes Cluster and will be peered to the Hub in each Environment’s Region.  
Naming Convention: 
vnet-{region}-payerspoke{deployment_version}{-lower_environment}
The Virtual Network will have the Subnets to which the following type of Resources will be connected:
Storage Account: 
snet-{region}-payerspoke{deployment_version}-storage{-lower_environment}
Key Vault:
 snet-{region}-payerspoke{deployment_version}-keyvault{-lower_environment}
AKS Node Pools: 
snet-{region}-payerspoke{deployment_version}-nodepool{-lower_environment}
Payer Spoke Route Table
The Payer Spoke’s Node Pool will have a Route Table associated with it to route outbound traffic thru the Palo Alto firewall in accordance with InvoiceCloud security policies.
Naming Convention: 
rt-{region}-payerspoke{deployment_version}-nodepool{-lower_environment}
Payer AKS Cluster
Each Spoke Resource Group will contain an Azure Kubernetes Service (AKS) Cluster.  The Cluster will host the Payer Services mentioned above in this article.  Each Service and Application Instance combination will have its own Kubernetes Namespace.
AKS Cluster Naming Convention:
aks-{region}-payerspoke{deployment_version}{-lower_environment}
Service Namespace Naming Convention:  
ns-{service_abbreviation}{application_instance}svc
Payer AKS Cluster’s Managed Identity
Each Payer AKS Cluster will be assigned a Managed Identity.  The Managed Identity will be assigned the 
ACR Pull
 role assignment on the Azure Container Registry that is within the Cluster’s Network topology.
Naming Convention: 
ua-{region}-payerspoke{deployment_version}{-lower_environment}
Payer Service Resource Groups
Azure Resource Group to contain the Payer Service Resources per Application Instance, Region, Deployment Version, and Environment.
Naming Convention: 
rg-{region}-payer{application_instance}app{deployment_version}{-lower_environment}
Payer Service Key Vault
Each Payer Service will have a Key Vault associated that will contain Service Configuration key/value pairs used to seed the Service’s Container Environment variables using the 
AKS Workload Identity
 and 
SecretProviderClass
 integration pattern.  The Key Vault will only be accessible to clients residing within the NonProd or Prod Network topologies via the Azure Private Endpoint networking pattern.  Resources within the Sandbox and DevTest environments will reside in the NonProd Network topology, and Resources within the Production environment will reside in the Prod Network topology.
Key Vault Naming Convention: 
kv-{region}-{service_abbreviation}{application_instance}svc{deployment_version}{-lower_environment}
Private Endpoint Naming Convention: 
pe-{region}-{service_abbreviation}{application_instance}svc{deployment_version}{-lower_environment}
Payer Service Managed Identity
Each Payer Service will have an Azure Managed Identity associated that will be federated with a Kubernetes Service Account as part of the 
AKS Workload Identity
 integration pattern.  The Payer Service’s Managed Identity will get assigned RBAC Roles to other resources within InvoiceCloud’s Azure environments, allowing the Services deployed to the AKS Cluster access to the Azure Resources the Service needs to run, such as the Service specific Key Vault or the common SQL Server/Databases.
Azure Managed Identity Naming Convention: 
pe-{region}-{service_abbreviation}{application_instance}svc{deployment_version}{-lower_environment}
K8s Service Account Naming Convention: 
ns-{service_abbreviation}{application_instance}svc
Payer UI Storage Account to host React App and Components
Each distinct Payer Service Resource Group will contain an Azure Storage Account used to host the React based Payer UI.  The Payer React UI is designed as React Micro UI’s, so the Storage Account will host multiple React Apps/Components delineated by folders inside the root of the 
$web
 Blob Container, such as 
/onetimepayment/
 and 
/paymentroute/
.
Naming Convention:
sa{region}payer{application_instance}web{deployment_version}{lower_environment}
Payer Team Azure AD Groups
The following Azure Active Directory (AD) Groups have been created to enable access to the Azure Resources mentioned above.
payer-team-admins
There is an Azure AD Group for each Environment for Users that require the highest level of access:
Production
payer-team-admins
DevTest
payer-team-admins-dev
Sandbox
payer-team-admins-sbx
This Azure AD Group provides the following 
Azure Resource RBAC Roles
 to Users that are Members of the Group
Contributor
 on Payer Spoke Resource Groups within the Environment.
Contributor
 on Payer Application Instance Resource Groups within the Environment.
Azure Kubernetes Service RBAC Cluster Admin
 on Payer AKS Clusters within the Environment.
Azure Kubernetes Service Cluster Admin Role
 on Payer AKS Clusters within the Environment.
payer-team-developers
There is an Azure AD Group for each Environment for Users that require access that allows the creation, deletion, and modification of some resources but is not the highest level of access. 
Production
payer-team-developers
DevTest
payer-team-developers-dev
Sandbox
payer-team-developers-sbx
This Azure AD Group provides the following 
Azure Resource RBAC Roles
 to Users that are Members of the Group
Contributor
 on Payer Spoke Resource Groups within the Environment.
Contributor
 on Payer Application Instance Resource Groups within the Environment.
Azure Kubernetes Service RBAC Writer
 on Payer AKS Clusters within the Environment.
Azure Kubernetes Service Cluster User Role
 on Payer AKS Clusters within the Environment.
payer-team-readers
There is an Azure AD Group for each Environment for Users that require the ability to read the Payer resources. 
Production
payer-team-readers
DevTest
payer-team-readers-dev
Sandbox
payer-team-readers-sbx
This Azure AD Group provides the following 
Azure Resource RBAC Roles
 to Users that are Members of the Group
Reader
 on Payer Spoke Resource Groups within the Environment.
Reader
 on Payer Application Instance Resource Groups within the Environment.
Azure Kubernetes Service RBAC Reader
on Payer AKS Clusters within the Environment.
Azure Kubernetes Service Cluster User Role
 on Payer AKS Clusters within the Environment.
Network and Payer Architecture Diagram
1
0
2652012545
2667642897
1
network-architecture-mvp1-v4.drawio
0
1
1
https://invoicecloud.atlassian.net/wiki
network-architecture-mvp1-v4.drawio
0
kqf_aG30-MlXnVOoSkw8 1
4016
auto
top
1
1710
Related Articles
Payer Application Service Deployment and Platform Information
Payer Service Information
 URL:/spaces/icinfradoc/pages/2652012545/Payer+Infrastructure