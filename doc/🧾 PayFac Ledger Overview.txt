This page documents the money movement tracking and ledger reconciliation flows in our PayFac system. The goal is to ensure accuracy, traceability, and audit readiness using double-entry bookkeeping principles.
üìò Tables Involved
BankAccounts
 ‚Äî Stores external bank account metadata.
FundingInstructions
 ‚Äî Represents a payout or debit operation (e.g., ACH line item).
LedgerTransactions
 ‚Äî Grouping of ledger entries tied to a funding instruction.
Ledger Entries
 ‚Äî Atomic debit/credit records tracking money movement.
üîÅ Flow 1: Daily Money Movement for a Bank Account
Scenario:
 Track all movement for a merchant‚Äôs bank account on a given day.
Example Query:
SELECT EntryType, Amount, DateRecAdded
FROM LedgerEntries
WHERE BankAccountID = 1
  AND DateRecAdded BETWEEN '2025-07-01' AND '2025-07-01 23:59:59'
ORDER BY DateRecAdded;

D = Debit
C = Credit
Ledger State:
EntryType
Amount
DateRecAdded
D
1000.00
2025-07-01 09:00:00
C
1000.00
2025-07-01 10:00:00
‚úÖ 
Ledger is balanced for the day (Net = 0).
‚ö†Ô∏è Flow 2: Unbalanced Ledger Due to Failed Funding Instruction
Scenario:
 A payout was attempted but failed due to insufficient funds. The credit was logged, but the debit failed.
Ledger State:
BankAccountID - Maps to a merchant's Bank Account 
BankAccountID
EntryType
Amount
Description
2
C
500.00
Funding to the merchant
1
D
0.00
Debit from reserve (FAIL)
‚ö†Ô∏è Debit failed but was still expected, resulting in an imbalance.
Reconciliation Query:
//Find unbalanced ledger transactions
SELECT LedgerTransactionID, SUM(CASE WHEN EntryType = 'D' THEN Amount ELSE 0 END) AS Debits,
       SUM(CASE WHEN EntryType = 'C' THEN Amount ELSE 0 END) AS Credits
FROM LedgerEntries
GROUP BY LedgerTransactionID
HAVING SUM(CASE WHEN EntryType = 'D' THEN Amount ELSE 0 END) 
     <> SUM(CASE WHEN EntryType = 'C' THEN Amount ELSE 0 END);

‚úÖ Use this to 
catch and flag
 funding issues. 
üìâ Flow 3: Bank Account Balance Before & After Failure
Scenario:
 Show balance before a failed funding instruction, and after (to show no net change occurred).
Before FundingInstruction Error
BankAccountID
AccountHolderName
Role
Balance
1
IC Ops Clearing Account
IC
2500.00
2
Kelsey‚Äôs Shoe Warehouse
Merchant
0.00
FundingInstruction Fails
Action
BankAccountID
Role
EntryType
Amount
Status
Attempted Debit
1
IC
D
500.00
Failed
Credit to Merchant
2
Merchant
C
500.00
Completed 
After Ledger Snapshot
BankAccountID
Role
Balance
Note
1
IC
2500.00
No debit recorded
2
Merchant
500.00
Credited without actual funding 
üìä 
Bank Account Balance Report (Live from Ledger)
This query shows how to calculate the 
current balance for each bank account
 by summing all debits and credits from 
LedgerEntries
.
üßæ SQL Query:
SELECT 
  le.BankAccountID,
  ba.AccountHolderName,
  ba.BankAccountRole,
  SUM(CASE 
        WHEN le.EntryType = 'C' THEN le.Amount 
        ELSE -le.Amount 
      END) AS Balance
FROM LedgerEntries le
JOIN BankAccounts ba ON le.BankAccountID = ba.BankAccountID
GROUP BY le.BankAccountID, ba.AccountHolderName, ba.BankAccountRole
ORDER BY ba.AccountHolderName;

üìã
 Sample Output:
BankAccountID
AccountHolderName
BankAccountRole
Balance
1
IC Ops Account
IC
2,500.00
2
Wicked Tendies
Merchant
500.00
3
Kelsey‚Äôs Shoe Warehouse
Merchant
0.00
 
Sample Script:
-- 1) Create temp tables (if not exists) ----------------------------------
IF OBJECT_ID('tempdb..#BankAccounts') IS NULL
BEGIN
  CREATE TABLE #BankAccounts (
    BankAccountID     INT IDENTITY(1,1)   NOT NULL PRIMARY KEY,
    TerminalID        INT                 NOT NULL,
    MerchantGUID      UNIQUEIDENTIFIER    NULL,
    MerchantDBA       VARCHAR(100)        NULL,
    AccountNumber     VARCHAR(50)         NULL,
    RoutingNumber     VARCHAR(9)          NULL,
    BankAccountRole   VARCHAR(20)         NULL,  -- 'IC' or 'Merchant'
    AccountType       INT                 NULL,  -- 1=Checking,2=Savings,...
    AccountName       VARCHAR(50)         NULL,
    AccountHolderName VARCHAR(250)        NULL,
    CurrencyCode      CHAR(3)             NULL,  -- e.g. 'USD'
    DateRecAdded      DATETIME2           NULL,
    Active            BIT                 NULL
  );
END

IF OBJECT_ID('tempdb..#FundingInstructions') IS NULL
BEGIN
  CREATE TABLE #FundingInstructions (
    FundingTransactionID INT IDENTITY(1001,1) NOT NULL PRIMARY KEY,
    ExternalGUID        UNIQUEIDENTIFIER    NULL,
    SubscriberID        INT                 NULL,
    MerchantID          INT                 NULL,
    TerminalID          INT                 NULL,
    BankAccountID       INT                 NULL REFERENCES #BankAccounts(BankAccountID),
    Amount              MONEY               NULL,
    EntryTypeID         INT                 NULL,  -- 1=Credit,2=Debit
    BatchReference      VARCHAR(100)        NULL,
    TransactionType     VARCHAR(20)         NULL,  -- 'ACH','Wire',...
    Status              VARCHAR(50)         NULL,  -- 'Completed','Failed'
    ErrorDescription    VARCHAR(250)        NULL,
    ErrorCode           VARCHAR(20)         NULL,
    InitiatedAt         DATETIME2           NULL,
    CompletedAt         DATETIME2           NULL,
    ExternalReference   VARCHAR(100)        NULL,
    DateRecAdded        DATETIME2           NULL
  );
END

IF OBJECT_ID('tempdb..#LedgerTransactions') IS NULL
BEGIN
  CREATE TABLE #LedgerTransactions (
    LedgerTransactionID  INT IDENTITY(3001,1) NOT NULL PRIMARY KEY,
    FundingTransactionID INT                NULL REFERENCES #FundingInstructions(FundingTransactionID),
    Description          VARCHAR(255)       NULL,
    ReferenceID          VARCHAR(100)       NULL,
    DateRecAdded         DATETIME2          NULL
  );
END

IF OBJECT_ID('tempdb..#LedgerEntries') IS NULL
BEGIN
  CREATE TABLE #LedgerEntries (
    LedgerEntryID        INT IDENTITY(5001,1) NOT NULL PRIMARY KEY,
    LedgerTransactionID  INT                NULL REFERENCES #LedgerTransactions(LedgerTransactionID),
    BankAccountID        INT                NULL REFERENCES #BankAccounts(BankAccountID),
    EntryType            CHAR(1)            NULL,  -- 'D' or 'C'
    Amount               MONEY              NULL,
    CurrencyCode         CHAR(3)            NULL,
    DateRecAdded         DATETIME2          NULL
  );
END


-- 2) Seed sample data ----------------------------------------------------
-- Bank accounts: IC ops + two merchants (names updated)
INSERT INTO #BankAccounts
  (TerminalID, MerchantGUID, MerchantDBA, AccountNumber, RoutingNumber, BankAccountRole,
   AccountType, AccountName, AccountHolderName, CurrencyCode, DateRecAdded, Active)
VALUES
  -- IC platform account
  (101,'123e4567-e89b-12d3-a456-426614174000','Platform Inc','000111222','111000025','IC',1,'IC Clearing','Platform Operations','USD','2025-07-01 00:00:00',1),
  -- Merchant A: now Wicked Tendies
  (101,'234e5678-e89b-12d3-a456-426614174001','Wicked Tendies','987654321','111000025','Merchant',1,'Checking','Wicked Tendies','USD','2025-07-01 00:00:00',1),
  -- Merchant B: now Kelsey's Shoe Warehouse
  (101,'345e6789-e89b-12d3-a456-426614174002','Kelsey''s Shoe Warehouse','123123123','111000025','Merchant',1,'Checking','Kelsey''s Shoe Warehouse','USD','2025-07-01 00:00:00',1);

-- FundingInstructions: one success, one failure
INSERT INTO #FundingInstructions
  (ExternalGUID, SubscriberID, MerchantID, TerminalID, BankAccountID, Amount, EntryTypeID,
   BatchReference, TransactionType, Status, ErrorDescription, ErrorCode,
   InitiatedAt, CompletedAt, ExternalReference, DateRecAdded)
VALUES
  ('acb12345-d678-4f00-a1b2-4d77a3317890',5,2,101,2,500.00,1,'BATCH20250701-001','ACH','Completed',NULL,NULL,'2025-07-01 10:00:00','2025-07-01 10:05:00','ext-ref-1001','2025-07-01 10:00:00'),
  ('bcd23456-e789-5f00-b2c3-4c88b4427901',6,3,101,3,500.00,1,'BATCH20250701-002','ACH','Failed','Insufficient funds','R01','2025-07-01 11:00:00',NULL,'ext-ref-1002','2025-07-01 11:00:00');



-- LedgerTransactions for each funding instruction
INSERT INTO #LedgerTransactions (FundingTransactionID,Description,ReferenceID,DateRecAdded)
VALUES
  (1001,'Disbursement to Wicked Tendies','TXN-20250701-1','2025-07-01 10:01:00'),
  (1002,'Disbursement to Kelsey''s Shoe Warehouse - Failed','TXN-20250701-2','2025-07-01 11:01:00');

-- LedgerEntries: balanced for txn 3001; unbalanced for txn 3002
INSERT INTO #LedgerEntries (LedgerTransactionID,BankAccountID,EntryType,Amount,CurrencyCode,DateRecAdded)
VALUES
  -- Txn 3001 (balanced)
  (3001,1,'D',500.00,'USD','2025-07-01 10:02:00'),
  (3001,2,'C',500.00,'USD','2025-07-01 10:02:00'),
  -- Txn 3002 (unbalanced: only credit to Merchant B)
  (3002,3,'C',500.00,'USD','2025-07-01 11:02:00');

 
Sample Output:
-- get your IC (Platform Operations) account ID
DECLARE @ICAccountID INT = (
  SELECT BankAccountID
  FROM #BankAccounts
  WHERE BankAccountRole  = 'IC'
    AND AccountHolderName = 'Platform Operations'
);

-- show every LedgerTransaction and whether debits = credits
SELECT
  lt.LedgerTransactionID,
  lt.Description,
  SUM(CASE WHEN le.EntryType = 'D' THEN le.Amount ELSE 0 END)   AS TotalDebits,
  SUM(CASE WHEN le.EntryType = 'C' THEN le.Amount ELSE 0 END)   AS TotalCredits,
  CASE
    WHEN SUM(CASE WHEN le.EntryType = 'D' THEN le.Amount ELSE 0 END)
       = SUM(CASE WHEN le.EntryType = 'C' THEN le.Amount ELSE 0 END)
    THEN 'Balanced'
    ELSE 'Unbalanced'
  END AS TxnStatus
FROM #LedgerTransactions lt
LEFT JOIN #LedgerEntries le
  ON le.LedgerTransactionID = lt.LedgerTransactionID
GROUP BY lt.LedgerTransactionID, lt.Description
ORDER BY lt.LedgerTransactionID;


select * from #fundinginstructions

select * from #bankaccounts

select * from #ledgertransactions

select * from #ledgerentries
 URL:/spaces/EA/pages/4474208419/PayFac+Ledger+Overview