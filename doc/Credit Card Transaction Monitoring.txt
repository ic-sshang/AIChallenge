Metric Gathering
A) Ideally, credit card processing would be happening through eventing, and we could create real time stream analysis on the events as they happen, decoupled from the application doing the processing. however, this is probably not where we are, and would require way too much of us just for metrics. 
B) the next most ideal solution would be to add custom instrumentation to the application using OTel, to keep us decoupled from the observability back end. It is ok for an application to be coupled to its metrics (there isn’t really a way around that) but be mindful with the implementation so that metric gathering isn’t muddied with business logic. 
Custom Metrics through OTel
// set up meter provider
var meterProvider = Sdk.CreateMeterProviderBuilder()
    .AddSource("MyCreditCardProcessingApp")
    .AddConsoleExporter()
    .Build();

// later in app logic, get the provider and add the transaction result
// we may also want to track the card provider too
var meter = meterProvider.GetMeter("MyCreditCardProcessingApp");
var transactionCounter = meter.CreateCounter<int>("credit_card_transactions", "transactions", "Tracks the number of credit card transactions processed");
transactionCounter.Add(1, new("status", "declined")); // Or "success" for successful transactions
B alt) In the shorter term, if the application is already tightly coupled to new relic, I would recommend adding custom instrumentation similar to the OTel solution, via NR instrumentation. I believe this is done through ‘custom events’. This will give us a table in NR that we can monitor and alert on.
Implementation is similar to OTel
For the OTel/NR custom instrumentation, we would need (provider, authResponse)
C) Using logs and creating queries with fuzzy text searching to gather decline rates as shown in the example below. This could be done for a dashboard to keep on eye on things in the short term, but I would not recommend it long term. 
an example of a query that could be used in the short-term utilizing log data: 
https://onenr.io/02wdmEOqJRE
A better example using our existing ‘Transactions’ event table in new relic.
https://onenr.io/01wZaXMEaQ6
Monitoring
It might be good to have several alerts. one based on longer history like 4 weeks to now, and one that is more real time, like the last hour to now.
Some formulas to consider implementing for alerting:
Dynamic Thresholds
 - We could use something like, 
NewThreshold=AverageDeclineRateduringSimilarPastPeriods×(1+SensitivityFactor)
Then alert when the new threshold is reached, this could help adjust to on/off peak hours, though does require some good historical metrics, and tuning of sensitivity factor.
Anomaly Detection
 - There are a lot of algorithms to leverage in this space, and once we have good metrics about declines flowing, NR may have something we can lean on for this.
Rolling Averages and Standard Deviation
 - We could calculate the rolling average and standard deviations as, 
sumation(declineRate/timeframe, n)
 and the standard deviation as 
sqrt(sumation(pow(declineRate - rollingAverage, 2) / n)
 then use look for significant deviations and alert on that.
nr example (log based): 
https://onenr.io/02wdmEOqJRE
nr example (transactions event based): 
https://onenr.io/01wZaXMEaQ6
standard deviation to be used in creating an alert: 
https://onenr.io/0LREVaJP5ja
Multi metric Correlation 
- which is 
correlation factor = sumation(x * y, n) - sumation (x, n) * sumation(y, n) / sqrt(sumation(pow(x, 2) - pow(sumation(x,n), 2)) * sqrt(sumation(pow(y, 2) - pow(sumation(y,n), 2))
where x,y are declines and transaction volume
Again, looking for a big deviation.
Maintenance
Getting these alerts right will take some time/iteration.  Even when we get it right, we will likely need to continuously update the alerts. Things that may need updating are things like SensitivyFactor in dynamic thresholds or the Time Window you are looking in various dashboards/alerts. These updates can likely be made automatically with some automation.
 URL:/spaces/DS/pages/3130786194/Credit+Card+Transaction+Monitoring