Item link: 
WDIL-217
2278e126-27dc-36c8-aef9-a32d91bc7ad7
System Jira
 
Epic/Project link: 
WDIL-212
2278e126-27dc-36c8-aef9-a32d91bc7ad7
System Jira
 
Table of Contents:
1
6
false
decimal
list
true
Current Functionality
Safety’s custom Autopay functionality/logic throughout our platform is primarily driven by the 
AutoPayStrategyFactory
 which consists of different functions that will return different objects that’ll result in different behavior - Safety’s custom logic or the default behavior. The relevant functions for our SAML to CloudSSO migration project are: 
GetEligibilityStrategy
, 
GetStrategyForFilteringSSOAutoPayCustomers
, and 
GetStrategyForFilteringAgentConnectAutoPayCustomers
 (
more info about these functions below
).
The home button redirect functionality is not custom/unique for Safety, that was an enhancement IC made to Agent Connect for all billers.
Safety has custom redirect logic to the Saved payment methods page when a customer is not signed up for Autopay and does not have an existing saved payment method.
There is SAML custom logic throughout the platform which does the following (
more info 
here
):
SSO session logic and AutoPaySSOCustomerFilterStrategy ensure that only the SSO customer’s accounts and options are available for AutoPay and related features.
UI and business logic are dynamically adjusted based on SSO context, biller rules, and feature flags.
Security and compliance: Prevents users from accessing or modifying accounts outside their SSO session scope.
Redirect IDs for
 
CloudSSO (
same as SAML
):
(RedirectID / Page):
RedirectID
Page Name
1
Customer Portal Recent Bill Listing
2
Customer Portal Paperless Settings
3
Customer Portal AutoPay Settings
4
Customer Portal Email Change
5
Customer Portal Payment Options
6
Customer Portal Payment History
7
N/A
8
Customer Portal Open Bill Listing
9
Customer Portal Scheduled Payments Listing
10
Customer Portal Recurring Scheduled Payments Listing
11
Customer Portal Pay By Text Enrollment
12
Customer Portal Closed Bill Listing
13
Customer Portal Account Information
14
Customer Portal Linked Accounts
15
Customer Portal Ticketing System
16
Customer Portal Customer Support
17
Customer Portal Change Password
18
(Missing)
19
Customer Welcome
Tech Specs
GetEligibilityStrategy
What It Controls
- Purpose: Determines if a customer is eligible to enroll in AutoPay for a given biller and context (deep link).
- Strategy: Returns either a default or custom eligibility strategy based on biller and context.
References & Impact
Reference location
Controls/Impacts
ctrlCustomerPaymentRouteAutoPay.ascx.vb (Line 164)
Filters customers/invoice types shown for AutoPay signup. Only eligible customers/invoice types are displayed.
AutoPay.aspx.vb (Line 829)	
Controls whether the AutoPay setup panel is shown and which actions are available to the user.
CustomerGroupPaymentOptions.aspx.vb (Line 584)	
Determines which customer groups are eligible for AutoPay, affecting available payment options.
 
wide
1011
Pseudo code

Function GetEligibilityStrategy(billerID, deepLinkID):
If billerID is Safety OR SafetyTest OR QA1 OR ICKatelyn Then
    // Special logic for these billers
    If deepLinkID is AutoPaySettings OR
      (AgentConnectSession exists AND AgentConnectSession.RedirectModeID is AutoPaySettings) Then
      Return new DefaultAutoPayEligibilityStrategy(billerID)
    Else
        Return new AutoPayEligibilityByInvoiceCustomFlagStrategy(InvoiceRepository, billerID)
    End If
Else
    // All other billers use default strategy
    Return new DefaultAutoPayEligibilityStrategy(billerID)
End If

End Function
Diagram for the GetEligibilityStrategy function
GetStrategyForFilteringSSOAutoPayCustomers
What It Controls
- Purpose: Returns a strategy for filtering AutoPay customers in SSO scenarios.
- Strategy: Restricts customer selection to those associated with the SSO session for certain billers.
References & Impact
Reference location
Controls/Impacts
ctrlCustomerAutoPay.ascx.vb (Line 80)
Filters the list of customers eligible for AutoPay in SSO context.
AutoPay.aspx.vb (Line 96)
Limits AutoPay setup to customers relevant to the current SSO session.
CustomerGroupPaymentOptions.aspx.vb (Line 64)
Applies SSO-specific filtering to customer group payment options.
 
wide
1011
Pseudocode

Function GetStrategyForFilteringSSOAutoPayCustomers(billerID):
  
  If billerID is Safety OR SafetyTest OR QA1 OR ICKatelyn Then
      Return new FilterAutoPayCustomersToSamlCustomer()
  Else
      Return new DefaultDoNotFilterAutoPayCustomersToSamlCustomer()
  End If

End Function
Diagram for the GetStrategyForFilteringSSOAutoPayCustomers function
 GetStrategyForFilteringAgentConnectAutoPayCustomers
What It Controls
- Purpose: Returns a strategy for filtering AutoPay customers in AgentConnect scenarios.
- Strategy: Restricts customer selection to those associated with the AgentConnect session for certain billers or feature flags.
References & Impact
Reference location
Controls/Impacts
ctrlCustomerAutoPay.ascx.vb (Line 92)
Filters the list of customers eligible for AutoPay in AgentConnect context.
AutoPay.aspx.vb (Line 108)
Limits AutoPay setup to customers relevant to the current AgentConnect session.
CustomerGroupPaymentOptions.aspx.vb (Line 75)
Applies AgentConnect-specific filtering to customer group payment options.
full-width
1800
Pseudocode

Function GetStrategyForFilteringAgentConnectAutoPayCustomers(billerID):
    hasFilterFeatureFlag = Feature.Client.HasFeatureEnabled(FilterAutoPayCustomersThroughAgentConnect, billerID)

    If billerID is in [Safety, SafetyTest, QA1, ICKatelyn, SouthernFarm, SouthernFarmBureauUAT, SouthernFarmBureauUAT2, SouthernFarmBureauEPQA3, SouthernFarmBureauEPQA7, ICBruno] Then
        Return new FilterAutoPayCustomersToAgentConnectCustomer()
    Else
        If hasFilterFeatureFlag Then
            Return new FilterAutoPayCustomersToAgentConnectCustomer()
        Else
            Return new DefaultDoNotFilterAutoPayCustomersToAgentConnectCustomer()
        End If
    End If
End Function
Diagram for the GetStrategyForFilteringAgentConnectAutoPayCustomers function
Sample of a Safety SAML request in the New Relic logs from 8/29/2025:
wide
1011
Triggered By: "InitiateSingleSignOn". RequestURL: https://sso.invoicecloud.com/saml/18676125-b08f-4cad-8d07-0237c52c2cfd?account=PRV9252625&deeplinkid=1&ViewMode=2&GoBackURL=https:%2F%2Fwww.safetyinsurance.com%2Fmyaccount%2Fbilling.pl%3Fpolicy_num%3DPRV9252625. RelayState: null. StoredRequestStateReturnUrl: https://www.invoicecloud.com/portal/remoteauth/customerportalredirect.aspx.


Triggered By: "InitiateSingleSignOn". StoredRequestStateRelayData: [("BillerId": "1591"), ("BillerGuid": "18676125-b08f-4cad-8d07-0237c52c2cfd"), ("AccountNumber": "PRV9252625"), ("CssUrl": ""), ("DeepLinkId": "1"), ("GoBackUrl": "https://www.safetyinsurance.com/myaccount/billing.pl?policy_num=PRV9252625"), ("ViewMode": "2"), ("FilterID": "-1")].

References Using SAML SSO Session and SAML SSO Customer Filtering
Page/Control
Lines
Purpose
Effect
Jira
ctrlCustomerAutoPay.ascx.vb
403–405, 560, 563
- Checks if SSO session exists and if the current biller requires SSO customer filtering.
- Filters AutoPay report SQL to only include the SSO customer.
- Determines if invoice type hiding should be overridden for SSO context.
- Controls visibility of the AutoPay sign-up button based on SSO customer eligibility.
- Only the SSO customer’s accounts are shown for AutoPay.
- UI elements (sign-up button, invoice types) are dynamically shown/hidden based on SSO context and biller rules.
WDIL-358
2278e126-27dc-36c8-aef9-a32d91bc7ad7
System Jira
 
AutoPay.aspx.vb
476, 480, 483, 660, 661
- Filters accounts and invoice types for AutoPay setup based on SSO session and SSO customer.
- Ensures only the SSO customer can enroll in AutoPay.
- Overrides invoice type hiding logic for SSO context.
- Prevents users from enrolling accounts not associated with the SSO session.
- UI and logic are restricted to the SSO customer.
WDIL-369
2278e126-27dc-36c8-aef9-a32d91bc7ad7
System Jira
 
CustomerGroupChangeAccountInfo.aspx.vb
107, 109
If SSO session exists, sets the account filter to the SSO customer GUID.
Only the SSO customer’s account info is available for editing.
WDIL-370
2278e126-27dc-36c8-aef9-a32d91bc7ad7
System Jira
 
CustomerGroupLedger.aspx.vb
272, 274, 278
- If SSO session exists, filters ledger to SSO customer.
- Optionally shows all accounts if SSOFilterID is set.
Ledger view is restricted to SSO customer unless “Show All Accounts” is selected.
WDIL-371
2278e126-27dc-36c8-aef9-a32d91bc7ad7
System Jira
 
CustomerGroupPayByText.aspx.vb
129, 131
Filters account selection to SSO customer if SSO session exists.
Only SSO customer’s accounts are available for Pay By Text.
WDIL-372
2278e126-27dc-36c8-aef9-a32d91bc7ad7
System Jira
 
CustomerGroupPaymentHistory.aspx.vb
161, 163, 167
- Filters payment history to SSO customer if SSO session exists.
- Optionally shows all accounts if SSOFilterID is set.
Payment history is restricted to SSO customer unless “Show All Accounts” is selected.
WDIL-373
2278e126-27dc-36c8-aef9-a32d91bc7ad7
System Jira
 
CustomerGroupPaymentOptions.aspx.vb
348, 349, 373, 374
- Filters payment options to SSO customer if SSO session exists and biller requires SSO filtering.
- Controls visibility of AutoPay sign-up message and options for SSO customer.
- Overrides invoice type hiding logic for SSO context.
- Only SSO customer’s payment options are shown.
- UI messaging and options are tailored to SSO context.
WDIL-374
2278e126-27dc-36c8-aef9-a32d91bc7ad7
System Jira
 
CustomerGroupScheduledPayments.aspx.vb
190, 192, 196
- Filters scheduled payments to SSO customer if SSO session exists.
- Optionally shows all accounts if SSOFilterID is set.
Scheduled payments view is restricted to SSO customer unless “Show All Accounts” is selected.
WDIL-375
2278e126-27dc-36c8-aef9-a32d91bc7ad7
System Jira
 
RecurringScheduledPayment.aspx.vb
426, 428
Filters account selection to SSO customer if SSO session exists.
Only SSO customer’s accounts are available for recurring scheduled payments.
WDIL-376
2278e126-27dc-36c8-aef9-a32d91bc7ad7
System Jira
 
Necessary Updates (
assuming passwords are already migrated for Safety’s users/customers
)
Disable PlatformFeatureId: 17 (RegisterSamlCustomersIgnorePassword) or remove the SAML configurations for Safety (in the Products > Cloud SSO Connect area in the CRM) so they will no longer be considered a SAML biller by the logic that was implemented via 
EBPP-17180
2278e126-27dc-36c8-aef9-a32d91bc7ad7
System Jira
 in the Register Accounts endpoint. 
 Will not do per VC 9/23/2025 (Group refinement)
Potentially pass an account number parameter in the CloudSSO url for account/customer filtering (
pending WDIL team discussion on final solution
).
We’ll need to update the functions referenced above (
GetEligibilityStrategy
, 
GetStrategyForFilteringSSOAutoPayCustomers
, and 
GetStrategyForFilteringAgentConnectAutoPayCustomers
) to have the same logic in a CloudSSO request as the current functionality when the 
DeepLinkId
 parameter = 3 / 
AutoPaySettings
 from a SAML request.
We’ll need to update 
these references
 (
the References Using SAML SSO Session and SAML SSO Customer Filtering section above
) to have the same existing SAML logic for CloudSSO (
potentially custom for Safety or based on a setting, parameter, feature flag or option
).
A new parameter will need to be added to CloudSSO to support similar functionality as AgentConnect’s Home Button Redirect (
HomeButtonUrl
 parameter).
 URL:/spaces/PE/pages/4623433892/WDIL-217+-+SPIKE+Review+Safety+custom+code+to+maintain+identical+pages+as+SAML+on+SSOConnect