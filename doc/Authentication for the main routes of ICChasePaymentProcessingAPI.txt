Summary
This document outlines the reasoning behind HMAC (Hash-based Message Authentication Code) authentication for the ICChasePaymentProcessingAPI service. The suggestion is made that ICChasePaymentProcessingAPI is an internal service and that we would want to have a secure and performant way to authenticate on all main API routes. The callers for the service will be other services within InvoiceCloud (IC) ecosystem. No external (outside of IC) caller will be allowed to hit the endpoints.
Quick approach benefits overview:
Strong security with minimal overhead
Simple implementation and maintenance
Excellent performance characteristics
Easy to test and validate
Flexible configuration options
Overview
Purpose
The HMAC authentication system provides:
Request Integrity
: Ensures that requests have not been tampered with during transmission
Authenticity
: Verifies that requests originate from authorized sources
Non-repudiation
: Provides cryptographic proof of request origin
Internal Service Security
: Protects API endpoints from unauthorized access
Scope
Protected Endpoints
: All POST endpoints (
/api/v1/sale
, 
/api/v1/refund
, 
/api/v1/void
)
Excluded Endpoints
: Health checks, Swagger documentation, GET endpoints
Authentication Method
: HMAC-SHA256 with Base64 encoding or any other method approved by IC
Header
: 
X-Auth-Signature
Architecture
High-Level Design
┌─────────────────┐    ┌──────────────────┐    ┌─────────────────┐
│   Client        │    │   Middleware     │    │   Controller    │
│                 │    │                  │    │                 │
│ 1. Generate     │───▶│ 2. Extract       │───▶│ 3. Process      │
│    HMAC         │    │    Signature     │    │    Request      │
│ 2. Send Request │    │ 3. Validate      │    │ 4. Return       │
│    + Header     │    │    HMAC          │    │    Response     │
└─────────────────┘    └──────────────────┘    └─────────────────┘
Component Architecture
1. HMAC Service (
IHmacService
)
c#
public interface IHmacService
{
    string GenerateSignature(string payload);
    bool ValidateSignature(string payload, string signature);
}
Responsibilities:
Generate HMAC signatures for outgoing requests
Validate HMAC signatures for incoming requests
2. HMAC Configuration (
HmacConfiguration
)
c#
public class HmacConfiguration
{
    public string SecretKey { get; set; }
    public string HeaderName { get; set; }
    public bool Enabled { get; set; }
    public List<string> ExcludedPaths { get; set; }
}
Responsibilities:
Centralized configuration management
Environment-specific settings
Excluded path configuration
3. HMAC Authentication Middleware
c#
public class HmacAuthenticationMiddleware
{
    public async Task InvokeAsync(HttpContext context)
    {
        // 1. Check if HMAC is enabled
        // 2. Check if path is excluded
        // 3. Extract signature from header
        // 4. Validate signature
        // 5. Continue or reject request
    }
}
Responsibilities:
Intercept all incoming requests
Extract HMAC signature from headers
Validate request integrity
Allow/deny request based on validation
Implementation Details
1. Signature Generation Process
c#
public string GenerateSignature(string payload)
{
    // either use the following code, or incorporate the existing IC library
    using var hmac = new HMACSHA256(Encoding.UTF8.GetBytes(_secretKey));
    var payloadBytes = Encoding.UTF8.GetBytes(payload);
    var hashBytes = hmac.ComputeHash(payloadBytes);
    return Convert.ToBase64String(hashBytes);
}
Process:
Convert JSON payload to UTF-8 bytes
Apply HMAC-SHA256 with secret key
Convert result to Base64 string
Include in 
X-Auth-Signature
 header
2. Signature Validation Process
c#
public bool ValidateSignature(string payload, string signature)
{
    var expectedSignature = GenerateSignature(payload);
    return string.Equals(expectedSignature, signature, StringComparison.Ordinal);
}
Process:
Extract signature from 
X-HMAC-Signature
 header
Generate expected signature from request body
Compare signatures using constant-time comparison
Return validation result
3. Middleware Integration
c#
// Program.cs
app.UseMiddleware<HmacAuthenticationMiddleware>();
Integration Points:
Added after HTTPS redirection
Added before authorization
Added before routing to controllers
4. Service Registration
c#
// Program.cs
builder.Services.Configure<HmacConfiguration>(
    builder.Configuration.GetSection("HmacConfiguration"));
builder.Services.AddScoped<IHmacService, HmacService>();
Security Considerations
1. Secret Key Management
Current Implementation:
Configuration-based secret key storage
Environment-specific keys
Default development key
Best Practices:
Use Azure Key Vault or AWS Secrets Manager in production
Rotate keys regularly (90-180 days)
Use strong, randomly generated keys (32+ characters)
Never commit keys to source control
2. Algorithm Security
HMACSHA256:
Cryptographically secure
Industry standard
Fast performance
Widely supported
Alternative Algorithms:
HMACSHA512: Higher security, slower performance
HMACSHA1: Deprecated, not recommended
HMACMD5: Deprecated, not recommended
3. Timing Attacks Prevention
c#
// Constant-time comparison
return string.Equals(expectedSignature, signature, StringComparison.Ordinal);
Protection:
Use constant-time string comparison
Prevent timing-based attacks
Ensure consistent validation time
4. Request Body Handling
Implementation:
Enable request buffering for multiple reads
Reset request body position after reading
Handle empty request bodies gracefully
5. Header Security
Current Headers:
X-Auth-Signature
: HMAC signature
Content-Type
: application/json
Configuration
1. AppSettings Configuration
json
{
  "HmacConfiguration": {
    "SecretKey": "your-secret-key-here-change-in-production",
    "HeaderName": "X-Auth-Signature",
    "Enabled": true,
    "ExcludedPaths": [
      "/health",
      "/swagger",
      "/api-docs"
    ]
  }
}
2. Environment-Specific Configuration
Development:
json
{
  "HmacConfiguration": {
    "SecretKey": "dev-secret-key-123",
    "Enabled": true
  }
}
Production:
json
{
  "HmacConfiguration": {
    "SecretKey": "${HMAC_SECRET_KEY}",
    "Enabled": true
  }
}
Appendix A. Alternative Authentication Methods Explored
1. JWT (JSON Web Tokens)
Pros:
Stateless authentication
Built-in expiration handling
Rich claim support
Industry standard
Cons:
Token size overhead
Complex key management
Token revocation complexity
Potential security vulnerabilities
Comparison with HMAC:
Aspect
HMAC
JWT
Performance 
Fast 
Slower 
Payload Size 
Small 
Larger 
Key Management 
Simple 
Complex 
Stateless 
Yes 
Yes 
Built-in Expiry 
No 
Yes 
2. API Keys
Pros:
Simple implementation
Easy to understand
Good performance
Easy to revoke
Cons:
No request integrity
Vulnerable to replay attacks
Limited security features
No payload validation
Comparison with HMAC:
Aspect
HMAC
API Keys
Request Integrity 
✅ 
❌ 
Replay Protection 
✅ 
❌ 
Performance 
Fast 
Very Fast 
Implementation 
Medium 
Simple 
Security Level 
High 
Medium 
3. OAuth 2.0
Pros:
Industry standard
Rich authorization features
Token refresh support
Scope-based access control
Cons:
Complex implementation
Heavy overhead
Requires authorization server
Overkill for internal services
Comparison with HMAC:
Aspect
HMAC
OAuth 2.0
Complexity 
Low 
High 
Overhead 
Minimal 
Significant 
Authorization Server 
Not Required 
Required 
Internal Service Fit 
Excellent 
Poor 
4. Mutual TLS (mTLS)
Pros:
Strong security
Certificate-based authentication
Built-in encryption
Industry standard
Cons:
Complex certificate management
Infrastructure overhead
Performance impact
Operational complexity
Comparison with HMAC:
Aspect
HMAC
mTLS
Implementation 
Simple 
Complex 
Certificate Management 
Not Required 
Required 
Performance 
Fast 
Slower 
Infrastructure 
Minimal 
Significant 
Monitoring and Logging
1. Logging Strategy
HMAC Authentication Logs:
json
{
  "Timestamp": "2025-07-29T17:32:43.207Z",
  "Level": "Warning",
  "Category": "HmacAuthenticationMiddleware",
  "Message": "HMAC signature header 'X-Auth-Signature' not found",
  "Path": "/api/v1/...",
  "ClientIP": "127.0.0.1"
}
2. Metrics Collection
Key Metrics:
Authentication success rate
Authentication failure rate
Response time impact
Error rate by endpoint
Signature validation time
3. Alerting
Critical Alerts:
High authentication failure rate (>5%)
System errors in HMAC validation
Missing HMAC configuration
Performance degradation
Warning Alerts:
Increased authentication failures
Configuration changes
Key rotation events
 URL:/spaces/EA/pages/4534501391/Authentication+for+the+main+routes+of+ICChasePaymentProcessingAPI