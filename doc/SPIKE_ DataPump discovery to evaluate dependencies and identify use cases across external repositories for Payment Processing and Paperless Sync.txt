Objective:
Evaluate Dependencies
Identify how DataPump interacts with external repositories.
Map out upstream/downstream systems involved in 
Payment Processing
 and 
Paperless Sync
.
Identify Use Cases
Discover specific scenarios or workflows where DataPump is used.
Understand how these use cases impact or integrate with Payment Processing and Paperless Sync.
Payments Processing:
Stored Procedure used for datapump type payments processig =1:
InsPayments - Search Code - Search
:
sql
wide
760
IF @Approved = 1
BEGIN
	--Find out if the BILLER is Eligible for the datapump and get their DataPumpID (S&S or IC) by checking the BillerDataPump table
	DECLARE 
		@DPEligible int = 0
		,@DataPumpID int = (SELECT DataPumpID FROM BillerDataPump WHERE BillerID = @BillerID)

	IF LEN(@DataPumpID) > 0	--They were in the BillerDataPump table
	BEGIN
		IF @BillerID in (420,545)	--Chandler special handling
		BEGIN
			IF @CustomerID > 0	--We need to have a real customerID for Chandler
			BEGIN
				SET @DPEligible = 1
			END
		END
		ELSE
		BEGIN
			SET @DPEligible = 1
		END
	END

END

--Run stored proc to determine if the payment is eligible and insert it into the appropriate Data Pump
IF @DPEligible = 1
BEGIN
	EXEC dbo.spDataPumpEligible
			@BillerID = @BillerID
			,@PaymentTypeID = @PaymentTypeID
			,@TransactionTypeID = @TransactionTypeID
			,@PaymentSourceID = @PaymentSourceID
			,@TerminalID = @TermID
			,@PaymentID = @PaymentID
			,@DataPumpID = @DataPumpID
END
sql
wide
760
CREATE Procedure [dbo].[spDataPumpEligible]
(
	@BillerID int
	,@PaymentTypeID int
	,@TransactionTypeID int
	,@PaymentSourceID int
	,@TerminalID int
	,@PaymentID int
	,@DataPumpID int
)

AS

/*=========================================================================================================================
Created 4/26/2016 - This sp is called during insPayments and determines whether or not a payment should go to a data pump
					for processing.  If it is elligible, it will insert a record into the correct Data Pump Queue. We 
					currently have one for S&S billers and one (Invoice Cloud) for all other billers.  They will be combined
					in 2017

					The table that determine whether or not a payment is elligible is DataPumpParams. It stores  records by
					billerID for elligible Payment Types, Transaction Types, and Payment Sources.  We also look at the 
					terminals table to see if the biller's terminal for that transaction is data pump elligible.

Modifications:
	4/28/2016:	Added code so that Kiosk Cash payments will be sent to the data pump if the TransactionTypeID is in the 
				Biller's datapumpparams


=========================================================================================================================*/

IF Exists (SELECT BillerID FROM Terminals WHERE BillerID = @BillerID and TerminalID = @TerminalID and DPElligible = 1)
		AND Exists(SELECT BillerID FROM datapumpparams WHERE billerid = @BillerID and DPParamTypeID = 1 and FKID = @PaymentTypeID and DPElligible = 1)
		AND Exists(SELECT BillerID FROM datapumpparams WHERE billerid = @BillerID and DPParamTypeID = 2 and FKID = @TransactionTypeID and DPElligible = 1)
		AND Exists(SELECT BillerID FROM datapumpparams WHERE billerid = @BillerID and DPParamTypeID = 3 and FKID = @PaymentSourceID and DPElligible = 1)
OR (@PaymentSourceID = 19 AND @PaymentTypeID = 6 --Kiosk Cash Payments dont use a terminalID but they still need pumped)								--4/28/2016:
		AND Exists(SELECT BillerID FROM datapumpparams WHERE billerid = @BillerID and DPParamTypeID = 2 and FKID = @TransactionTypeID and DPElligible = 1))
BEGIN
	IF @DataPumpID = 1			--Invoice Cloud DataPump
	BEGIN
		EXEC insDatapump @DataPumpTypeID = 1, @BillerID = @BillerID, @FKID = @PaymentID
	END
	ELSE IF @DataPumpID = 2		--S&S DataPump
	BEGIN
		EXEC insSystemsAndSoftwareQueue @BillerID = @BillerID, @SystemsAndSoftwareQueueTypeID = 1, @FKID = @PaymentID
	END
InsPayemntsToDatapump
:
This procedure promotes payment records from a staging table (DataPumpStaging) into production tables (DataPump and SystemsAndSoftwareQueue) for further processing, based on a list of payment IDs and/or receipt GUIDs. It also handles special logic for non-approved payments.
Step-by-Step Breakdown
Setup Temporary Table
•	Drops and recreates a temp table #temp_Payments to hold candidate payments for promotion.
Populate Temp Table by Payment IDs
•	If any payment IDs are provided, selects unprocessed records from DataPumpStaging matching those IDs and inserts them into #temp_Payments.
Populate Temp Table by Receipt GUIDs
•	If any receipt GUIDs are provided, finds payments in Payments with those GUIDs, joins to DataPumpStaging, and inserts unprocessed records not already in #temp_Payments.
Handle Non-Approved Payments
•	Checks if any candidate payments are not approved (Payments.Approved = 0).
•	For those, marks them as processed in DataPumpStaging unless they meet certain eligibility criteria (based on related Terminals and DataPumpParams).
•	Removes these processed payments from #temp_Payments.
Promote Eligible Payments
•	If any payments remain in #temp_Payments:
•	Inserts records with DataPumpID = 1 into the DataPump table.
•	Inserts records with DataPumpID = 2 into the SystemsAndSoftwareQueue table.
Mark All Promoted Payments as Processed
•	Updates DataPumpStaging to mark all payments in #temp_Payments as processed.
sql
wide
760
CREATE PROCEDURE [dbo].[insPaymentsToDataPump] (
	@BillerID INT,
	@PaymentIDs PaymentIDList READONLY,
	@ReceiptGUIDs ReceiptGUIDList READONLY
)

AS
BEGIN
	DROP TABLE IF EXISTS #temp_Payments;
	CREATE TABLE #temp_Payments 
	(
		DataPumpID INT,
		DataPumpTypeID INT,
		PaymentID INT,
		OptionalSetting BIT,
		PaymentSourceID INT
	)
	
	IF EXISTS (SELECT 1 FROM @PaymentIDs)
	BEGIN
		INSERT INTO #temp_Payments
		(
		    DataPumpID,
		    DataPumpTypeID,
		    PaymentID,
		    OptionalSetting,
		    PaymentSourceID
		)
		SELECT 
            DataPumpID,
            DataPumpTypeID,
            PaymentID,
            OptionalSetting,
            PaymentSourceID
		FROM dbo.DataPumpStaging
		WHERE	PaymentID IN (SELECT PaymentID FROM @PaymentIDs)
				AND Processed is NULL
	END

	IF EXISTS (SELECT 1 FROM @ReceiptGUIDs)
	BEGIN
		INSERT INTO #temp_Payments
		(
		    DataPumpID,
		    DataPumpTypeID,
		    PaymentID,
		    OptionalSetting,
		    PaymentSourceID
		)
		SELECT 
            dps.DataPumpID,
            dps.DataPumpTypeID,
            dps.PaymentID,
            dps.OptionalSetting,
            dps.PaymentSourceID
		FROM dbo.DataPumpStaging AS dps
		INNER JOIN dbo.Payments AS p ON p.PaymentID = dps.PaymentID
		LEFT JOIN #temp_Payments as t ON t.PaymentID = dps.PaymentID
		WHERE	p.ReceiptGUID IN (SELECT ReceiptGUID FROM @ReceiptGUIDs)
				AND t.PaymentID IS NULL
				AND dps.Processed IS NULL
	END 

	-- Added to check non approved payments again, in case voids occurred prior to promotion
	IF EXISTS(
	SELECT TOP 1 
		s.PaymentID 
	FROM 
		#temp_Payments AS tp
	INNER JOIN 
		dbo.DataPumpStaging AS s ON s.PaymentID = tp.PaymentID
	INNER JOIN 
		dbo.Payments AS p ON p.PaymentID = s.PaymentID
	WHERE
		p.Approved = 0)
	BEGIN
		--	Existing code used to check non approved payments in insPayments
		--		IF EXISTS(SELECT BillerID FROM Terminals WHERE BillerID = @BillerID and TerminalID = @TermID and DPElligible = 1)
		--			AND Exists(SELECT BillerID FROM datapumpparams WHERE billerid = @BillerID and DPParamTypeID = 1 and FKID = @PaymentTypeID and DPElligible = 1)
		--			AND Exists(SELECT BillerID FROM datapumpparams WHERE billerid = @BillerID and DPParamTypeID = 2 and FKID = @TransactionTypeID and DPElligible = 1)
		--			AND Exists(SELECT BillerID FROM datapumpparams WHERE billerid = @BillerID and DPParamTypeID = 4 and FKID = @PaymentSourceID and DPElligible = 1)

		UPDATE s SET s.Processed = dbo.CST_GetDate()
		FROM 
			#temp_Payments AS tp
		INNER JOIN 
			dbo.DataPumpStaging AS s ON s.PaymentID = tp.PaymentID
		INNER JOIN 
			dbo.Payments AS p ON p.PaymentID = s.PaymentID
		WHERE
			p.Approved = 0 AND
			s.DPStageID NOT IN(
			SELECT
				s.DPStageID
			FROM 
				#temp_Payments AS tp
			INNER JOIN 
				dbo.DataPumpStaging AS s ON s.PaymentID = tp.PaymentID
			INNER JOIN 
				dbo.Payments AS p ON p.PaymentID = s.PaymentID
			INNER JOIN 
				dbo.Terminals AS t ON p.TermID = t.TerminalID AND p.BillerID = t.BillerID AND t.DPElligible = 1
			INNER JOIN 
				dbo.DataPumpParams AS dp1 ON dp1.BillerID = p.BillerID AND dp1.DPParamTypeID = 1 AND dp1.FKID = p.PaymentTypeID AND dp1.DPElligible = 1
			INNER JOIN 
				dbo.DataPumpParams AS dp2 ON dp2.BillerID = p.BillerID AND dp2.DPParamTypeID = 2 AND dp2.FKID = p.TransactionTypeID AND dp2.DPElligible = 1
			INNER JOIN 
				dbo.DataPumpParams AS dp3 ON dp3.BillerID = p.BillerID AND dp3.DPParamTypeID = 4 AND dp3.FKID = p.PaymentSourceID AND dp3.DPElligible = 1
			WHERE
				p.Approved = 0)

		DELETE tp
		FROM
			#temp_Payments AS tp
		INNER JOIN 
			dbo.DataPumpStaging AS s ON s.PaymentID = tp.PaymentID
		WHERE
			s.Processed IS NOT NULL;
	END
	-- End of Non Approved Check

	IF EXISTS(SELECT 1 FROM #temp_Payments)
	BEGIN

			INSERT INTO dbo.DataPump
			(
				DataPumpTypeID,
				BillerID,
				FKID,
				OptionalSetting,
				PaymentSourceID
			)
			SELECT   
				DataPumpTypeID,       -- DataPumpTypeID - int
				@BillerID,       -- BillerID - int
				PaymentID,       -- FKID - int
				OptionalSetting,    -- OptionalSetting - bit
				PaymentSourceID  -- PaymentSourceID - int
			FROM #temp_Payments 
			WHERE DataPumpID = 1

			INSERT INTO dbo.SystemsAndSoftwareQueue
			(
				BillerID,
				SystemsAndSoftwareQueueTypeID,
				FKID
			)
			SELECT
				@BillerID,       -- BillerID - int
				DataPumpTypeID, -- SystemsAndSoftwareQueueTypeID - int
				PaymentID       -- FKID - int
			FROM #temp_Payments
			WHERE DataPumpID = 2
		END

		UPDATE dps
		SET dps.Processed = dbo.CST_GetDate()
		FROM dbo.DataPumpStaging AS dps
		INNER JOIN #temp_Payments AS t ON t.PaymentID = dps.PaymentID;

END
Repo
code refrence
MyIIS
https://dev.azure.com/invoicecloud/Src/_git/MyIIS?path=/IC.Common/clsUtilities.vb&_a=contents&version=GBrelease
 
BillerPortal
https://dev.azure.com/invoicecloud/Biller/_git/BillerPortal?path=/BillerPortal.Business/Util/Utilities.cs&_a=contents&version=GBmain
 
Dependent InsPayments stored proc:
Repo’s that are using for payments source: (stored Proc InsPayments)
CTP
MyIIS
MC_RPPS
Demo Portals
ICFramework.Business.Data
IC.BatchClose → Test References --> 
BatchCloseProcessorsIntegrationTests.cs
, 
InvoiceCloudClientIntegrationTests.cs
, 
DateTimeExtensionsTests.cs
CloudConnectWS
ICKioskAPI
ICRESTAPI
AutoPaymentProcessing → approved =0 → Payment record not insert in to the datapump
ScheduledPaymentProcessing
CassBankActivityReport → Test Reference → 
DatabaseAccessTests.c
s
CassNachaFileCreation → Test Reference → 
UnitTest1.cs
ICGatewayAutoclose → Test Reference → 
DatabaseHandlerTests.cs
Source repos for datapumptype paymentrocessing async for inserting data into the datapump table
CTP
MyIIS
DataPump
Repos' that are using InsDatapump Stored Proc for insering data in to the datapump table:
CTP → Payment Processing
IC.BlockPaymentMethodNotification --> Inserts AutoPay record
RegisterAutoPay → Auto Pay records will insert 
RemoteAuthentication → Paperless records will insert 
MyIIS → Paperless, Autopay, registrations. changelogs, Payments
RegisterPaperless → Paperless records will insert 
ICRESTAPI → Papperless and autopay records will insert
DemoPortal → Payment record will insert
INSPayments code refernces 
:
Repo name
Class Name
Code Snippet
Summary of Code
MYIIS
acculynkresponse.aspx.vb
 For Each dt As Data.DataTable In ds.Tables

                    'Only call insPayments for tables with data
                    If dt.Rows.Count > 0 Then
                        Invoice = Invoice.LoadInvoiceByGUID(Convert.ToString(dt.Rows(0).Item("InvoiceGUID")), BillerID)
                        If Invoice.BillerID = 911 Then
                            termid = "3376"
                        Else
                            termid = "3279"
                        End If
                        sb.Clear()

                        'Find index of invoice 
                        'This index refers to rest of payment amounts and service fees index
                        Dim index As Integer = lstInvNum.FindIndex(Function(inv)
                                                                       Return Invoice.InvoiceNumber.Equals(inv)
                                                                   End Function)
                        'Load Customer
                        Dim customer As New clsCustomers
                        customer = customer.LoadCustomerByCustomerID(Invoice.CustomerID, Invoice.BillerID)

                        'Evaluate Customer Email Address
                        If customer.Registered = False Then
                            'ITQ 7096 - Update Email Address
                            If String.IsNullOrWhiteSpace(customer.CurrentLogin.EmailAddress) Then
                                customer.CurrentLogin.EmailAddress = clsDatabase.SqlSafe(Request("EmailAddress"))
                                customer.CurrentLogin.UpdateLogin(ChangeRequestor.Cloud_Process)
                            End If

                            'If customer.EmailAddress.Trim = "" Then
                            '    customer.EmailAddress = clsDatabase.SqlSafe(Request("EmailAddress"))
                            '    customer.UpdateCustomer(customer, 4)
                            'End If
                        End If

                        'Get Payment Amount + Service Fee
                        Dim total As Decimal = Convert.ToDecimal(lstAmt(index)) + Convert.ToDecimal(lstsvcFees(index))

                        'Convert total to string for sql
                        Dim amount As String = Convert.ToString(total)


                        'Build sql to call
                        sb.Append("exec insPayments ")
                        sb.Append("@PaymentGUID='" & PaymentGUID & "'")
                        sb.Append(",@InvoiceID=" & Invoice.InvoiceID)
                        sb.Append(",@CustomerID=" & Invoice.CustomerID)
                        sb.Append(",@BillerID=" & Invoice.BillerID)
                        sb.Append(",@InvoiceNumber='" & clsDatabase.SqlSafe(Invoice.InvoiceNumber) & "'")
                        sb.Append(",@CustomerName='" & clsDatabase.SqlSafe(Request("CustomerName")) & "'")
                        sb.Append(",@Address='" & clsDatabase.SqlSafe(customer.Address1) & "'")
                        sb.Append(",@City='" & clsDatabase.SqlSafe(customer.City) & "'")
                        sb.Append(",@State='" & clsDatabase.SqlSafe(customer.State) & "'")
                        sb.Append(",@Zip='" & clsDatabase.SqlSafe(customer.Zip) & "'")
                        sb.Append(",@EmailAddress='" & clsDatabase.SqlSafe(Request("EmailAddress")) & "'")
                        sb.Append(",@PaymentAmount='" & clsDatabase.SqlSafe(amount) & "'")
                        sb.Append(",@PaymentDescription='" & clsDatabase.SqlSafe("Acculynk Credit Card Payment") & "'")
                        sb.Append(",@TransactionTypeID=1")
                        sb.Append(",@PaymentTypeID=1")
                        sb.Append(",@PaymentDate='" & Now.ToString & "'")
                        sb.Append(",@PaymentReference='" & clsDatabase.SqlSafe(Request("pnref")) & "'")
                        sb.Append(",@RejectReference='" & clsDatabase.SqlSafe(Request("pnref")) & "'")
                        sb.Append(",@CloudPortals=0")
                        sb.Append(",@Offline=1")
                        sb.Append(",@ConvenienceFee='" & clsDatabase.SqlSafe(lstsvcFees(index)) & "'")
                        sb.Append(",@PaymentSourceID=1")
                        'sb.Append(",@RemoteIP='" & System.Web.HttpContext.Current.Request.ServerVariables("REMOTE_ADDR") & "'")
                        sb.Append(",@RemoteIP='" & clsUtilities.GetRemoteIP() & "'")
                        sb.Append(",@UserID=0")
                        sb.Append(",@TermID=" & termid)

                        If ResponseCode.ToString = "0" Then
                            sb.Append(",@Approved=1")
                            sb.Append(",@PaymentMessage='" & clsDatabase.SqlSafe("APPROVED " & Request("authcode")) & "'")
                        End If
                        If ResponseCode.ToString = "1" Then
                            sb.Append(",@Approved=0")
                            sb.Append(",@PaymentMessage='" & clsDatabase.SqlSafe(Request("error")) & "'")
                        End If

                        PaymentID = Convert.ToInt32(clsDatabase.EXECUTE_COMMAND_SINGLE_RESULT(sb.ToString, Invoice.BillerID))

                        If ResponseCode.ToString = "0" Then
                            clsPayments.AddPaymentToReceiptQueue(Invoice.BillerID, PaymentID, clsDatabase.SqlSafe(Request("EmailAddress")))
                        End If

                        If PaymentID <> 0 Then
                            ' Sucess, add payment to response
                            ReceiptGUID = PaymentGUID

                        End If

                        'clear sb
                        sb.Clear()

                    End If

                Next
            Case Else
                'ignore
        End Select

ResponseCode Check:
•	If ResponseCode is "0" (Approved) or "1" (Declined), the code proceeds to process payments.
•	Otherwise, it ignores the request.
Parsing Request Data:
•	It splits the query string values for invoicenumber, amount, and servicefee into lists (lstInvNum, lstAmt, lstsvcFees).
•	It counts the number of invoices.
Building SQL Queries:
•	For each invoice number, it builds a SQL query to select invoice details and adds it to a list.
Fetching Invoice Data:
•	Executes all SQL queries at once to get a dataset (ds) containing invoice tables.
Processing Each Invoice Table:
•	For each table in the dataset:
•	If the table has rows (invoice data), it loads the invoice and customer details.
•	Updates the customer's email if not registered.
•	Calculates the total payment amount (amount + service fee).
•	Builds a SQL command to insert the payment (insPayments) with all relevant details.
•	Sets approval and payment message based on ResponseCode.
•	Executes the payment insert and gets a PaymentID.
•	If approved, adds the payment to the receipt queue.
•	If payment succeeded, sets the receipt GUID.
Else Case:
•	If ResponseCode is not "0" or "1", the code does nothing.
Summary:
This code handles batch payments for multiple invoices, building and executing SQL commands for each, and updates customer/payment records based on the approval status. It only runs for approved or declined payments (ResponseCode "0" or "1").
CloudPayments.vb
    <WebMethod()>
    Public Function PostCreditCardPaymentToInvoice(ByVal BillerGUID As String, ByVal WebServiceKey As String, ByVal CustomerAccountNumber As String, ByVal CustomerInvoiceNumber As String, ByVal PaymentAmount As Double, ByVal PaymentReference As String, ByVal PaymentMessage As String) As String
        Dim StartTime As DateTime = Now
        Dim RETVAL As String = ""
        Dim SQL As New Text.StringBuilder
        Dim DT As New Data.DataTable
        Dim PaymentID As Integer = 0
        Dim PaymentGUID As String = System.Guid.NewGuid().ToString
        Dim ErrMsg As New Text.StringBuilder
        ErrMsg.Append("Method: PostCreditCardPaymentToInvoice" & vbCrLf)
        ErrMsg.Append("BillerGUID: " & BillerGUID & vbCrLf)
        ErrMsg.Append("WebServiceKey: " & WebServiceKey & vbCrLf)
        ErrMsg.Append("CustomerAccountNumber: " & CustomerAccountNumber & vbCrLf)
        ErrMsg.Append("CustomerInvoiceNumber: " & CustomerInvoiceNumber & vbCrLf)
        ErrMsg.Append("PaymentAmount: " & PaymentAmount & vbCrLf)
        ErrMsg.Append("PaymentReference: " & PaymentReference & vbCrLf)
        ErrMsg.Append("PaymentMessage: " & PaymentMessage & vbCrLf)

        If clsValidation.isValidGUID(BillerGUID) = False Or clsValidation.isValidGUID(WebServiceKey) = False Then
            Return ""
        End If

        Try
            SQL.Length = 0
            SQL.Append("exec spOfflinePaymentSearch ")
            SQL.Append("@BillerGUID='" & clsDatabase.SqlSafe(BillerGUID) & "'")
            SQL.Append(",@WebServiceKey='" & clsDatabase.SqlSafe(WebServiceKey) & "'")
            SQL.Append(",@AccountNumber='" & clsDatabase.SqlSafe(CustomerAccountNumber) & "'")
            SQL.Append(",@InvoiceNumber='" & clsDatabase.SqlSafe(CustomerInvoiceNumber) & "'")
            DT.Clear()
            DT = clsDatabase.GET_DATASET(SQL.ToString, clsBillers.GetBillerIDFromBillerGUID(Guid.Parse(BillerGUID))).Tables(0)
            If DT.Rows.Count > 0 Then
                With DT.Rows(0)
                    'RECORD PAYMENT
                    SQL.Length = 0
                    SQL.Append("exec insPayments ")
                    SQL.Append("@PaymentGUID='" & PaymentGUID & "'")
                    SQL.Append(",@InvoiceID=" & .Item("InvoiceID"))
                    SQL.Append(",@CustomerID=" & .Item("CustomerID"))
                    SQL.Append(",@BillerID=" & .Item("BillerID"))
                    SQL.Append(",@InvoiceNumber='" & clsDatabase.SqlSafe(CustomerInvoiceNumber) & "'")
                    SQL.Append(",@CustomerName='" & clsDatabase.SqlSafe(.Item("CustomerName")) & "'")
                    SQL.Append(",@Address='" & clsDatabase.SqlSafe(.Item("Address1")) & "'")
                    SQL.Append(",@City='" & clsDatabase.SqlSafe(.Item("City")) & "'")
                    SQL.Append(",@State='" & clsDatabase.SqlSafe(.Item("State")) & "'")
                    SQL.Append(",@Zip='" & clsDatabase.SqlSafe(.Item("Zip")) & "'")
                    SQL.Append(",@PaymentAmount='" & PaymentAmount & "'")
                    SQL.Append(",@PaymentDescription='" & clsDatabase.SqlSafe("Offline Credit Card Payment") & "'")
                    SQL.Append(",@TransactionTypeID=1")
                    SQL.Append(",@PaymentTypeID=1")
                    SQL.Append(",@PaymentDate='" & Now.ToString & "'")
                    SQL.Append(",@PaymentReference='" & clsDatabase.SqlSafe(PaymentReference) & "'")
                    SQL.Append(",@PaymentMessage='" & clsDatabase.SqlSafe(PaymentMessage) & "'")
                    SQL.Append(",@CloudPortals=0")
                    SQL.Append(",@Approved=1")
                    SQL.Append(",@Offline=1")
                    SQL.Append(",@ConvenienceFee=0")
                    SQL.Append(",@PaymentSourceID=1")
                    'SQL.Append(",@RemoteIP='" & System.Web.HttpContext.Current.Request.ServerVariables("REMOTE_ADDR") & "'")
                    SQL.Append(",@RemoteIP='" & clsUtilities.GetRemoteIP() & "'")
                    SQL.Append(",@UserID=0")

                    PaymentID = Convert.ToInt32(clsDatabase.EXECUTE_COMMAND_SINGLE_RESULT(SQL.ToString, .Item("BillerID")))

                    If PaymentID > 0 Then
                        RETVAL = PaymentGUID
                    End If

                    'UPDATE INVOICE BALANCE
                    SQL.Length = 0
                    SQL.Append("exec spRecalculateBalance @InvoiceID=" & .Item("InvoiceID"))
                    clsDatabase.EXECUTE_COMMAND_NONQUERY(SQL.ToString, .Item("BillerID"))

                    'LOG THE CALL
                    SQL.Length = 0
                    SQL.Append("exec insWebMethodLogs @WebMethodID=13, @BillerID=" & .Item("BillerID"))
                    clsDatabase.EXECUTE_COMMAND_NONQUERY(SQL.ToString, .Item("BillerID"))

                End With
            Else
                ErrMsg.Append("Error: Unable to Locate Biller" & vbCrLf)
                Return ""
            End If
        Catch ex As Exception
            Serilog.Log.Error(ex, "Triggered by {Event}. BillerGuid:{BillerGuid}. WebServiceKey:{WebServiceKey}. " &
                                "CustomerAccountNumber : {CustomerAccountNumber}.CustomerInvoiceNumber:{CustomerInvoiceNumber}.PaymentAmount:{PaymentAmount}.  " &
                                " PaymentMessage:{PaymentMessage}. PaymentReference:{PaymentReference}. Message: {Message}.",
                                "PostCreditCardPaymentToInvoice", BillerGUID, WebServiceKey, CustomerAccountNumber,
                                CustomerInvoiceNumber, PaymentAmount, PaymentMessage, PaymentReference, "Error on CloudPayments.vb")

            RETVAL = ""
            ErrMsg.Append("Exception: " & ex.ToString & vbCrLf)
        End Try

        ErrMsg.Append("StartTime: " & StartTime.ToString & vbCrLf)
        ErrMsg.Append("EndTime: " & Now.ToString & vbCrLf)

        Try
            If Convert.ToBoolean(ConfigurationManager.AppSettings("LogCloudPaymentWS")) = True Then
                clsUtilities.WriteDebugLog("C:\temp\" & Now.ToShortDateString.Replace("/", "") & "_CloudPaymentLogs.txt", ErrMsg.ToString)
            End If
        Catch ex As Exception
            Serilog.Log.Error(ex, "Triggered by {Event}. BillerGuid:{BillerGuid}. WebServiceKey:{WebServiceKey}. " &
                                "CustomerAccountNumber : {CustomerAccountNumber}.CustomerInvoiceNumber:{CustomerInvoiceNumber}.PaymentAmount:{PaymentAmount}.  " &
                                " PaymentMessage:{PaymentMessage}. PaymentReference:{PaymentReference}. Message: {Message}.",
                                "PostCreditCardPaymentToInvoice", BillerGUID, WebServiceKey, CustomerAccountNumber,
                                CustomerInvoiceNumber, PaymentAmount, PaymentMessage, PaymentReference, "Error on CloudPayments.vb")
        End Try

        Return RETVAL

    End Function
Step-by-step explanation:
Input Validation:
•	Checks if BillerGUID and WebServiceKey are valid GUIDs. If not, returns an empty string.
Search for Invoice:
•	Builds and executes a SQL query (spOfflinePaymentSearch) to find the invoice and customer details using the provided account and invoice numbers.
If Invoice Found:
•	Builds a SQL command to insert the payment (insPayments) with all relevant details (amount, customer info, payment reference, etc.).
•	Executes the payment insert and gets a PaymentID.
•	If successful, returns the new PaymentGUID.
•	Updates the invoice balance (spRecalculateBalance).
•	Logs the web method call (insWebMethodLogs).
If Invoice Not Found:
•	Logs an error and returns an empty string.
Error Handling:
•	Catches exceptions, logs detailed error information, and returns an empty string.
Debug Logging:
•	Optionally writes debug logs to a file if enabled in configuration
CloudPayments.vb
    <WebMethod()>
    Public Function PostCheckPaymentToInvoice(ByVal BillerGUID As String, ByVal WebServiceKey As String, ByVal CustomerAccountNumber As String, ByVal CustomerInvoiceNumber As String, ByVal PaymentAmount As Double, ByVal PaymentReference As String, ByVal PaymentMessage As String) As String
        Dim StartTime As DateTime = Now
        Dim RETVAL As String = ""
        Dim SQL As New Text.StringBuilder
        Dim DT As New Data.DataTable
        Dim PaymentID As Integer = 0
        Dim PaymentGUID As String = System.Guid.NewGuid().ToString
        Dim ErrMsg As New Text.StringBuilder
        ErrMsg.Append("Method: PostCheckPaymentToInvoice" & vbCrLf)
        ErrMsg.Append("BillerGUID: " & BillerGUID & vbCrLf)
        ErrMsg.Append("WebServiceKey: " & WebServiceKey & vbCrLf)
        ErrMsg.Append("CustomerAccountNumber: " & CustomerAccountNumber & vbCrLf)
        ErrMsg.Append("CustomerInvoiceNumber: " & CustomerInvoiceNumber & vbCrLf)
        ErrMsg.Append("PaymentAmount: " & PaymentAmount & vbCrLf)
        ErrMsg.Append("PaymentReference: " & PaymentReference & vbCrLf)
        ErrMsg.Append("PaymentMessage: " & PaymentMessage & vbCrLf)

        If clsValidation.isValidGUID(BillerGUID) = False Or clsValidation.isValidGUID(WebServiceKey) = False Then
            Return ""
        End If

        Try
            SQL.Length = 0
            SQL.Append("exec spOfflinePaymentSearch ")
            SQL.Append("@BillerGUID='" & clsDatabase.SqlSafe(BillerGUID) & "'")
            SQL.Append(",@WebServiceKey='" & clsDatabase.SqlSafe(WebServiceKey) & "'")
            SQL.Append(",@AccountNumber='" & clsDatabase.SqlSafe(CustomerAccountNumber) & "'")
            SQL.Append(",@InvoiceNumber='" & clsDatabase.SqlSafe(CustomerInvoiceNumber) & "'")
            DT.Clear()
            DT = clsDatabase.GET_DATASET(SQL.ToString, clsBillers.GetBillerIDFromBillerGUID(Guid.Parse(BillerGUID))).Tables(0)
            If DT.Rows.Count > 0 Then
                With DT.Rows(0)
                    'RECORD PAYMENT
                    SQL.Length = 0
                    SQL.Append("exec insPayments ")
                    SQL.Append("@PaymentGUID='" & PaymentGUID & "'")
                    SQL.Append(",@InvoiceID=" & .Item("InvoiceID"))
                    SQL.Append(",@CustomerID=" & .Item("CustomerID"))
                    SQL.Append(",@BillerID=" & .Item("BillerID"))
                    SQL.Append(",@InvoiceNumber='" & clsDatabase.SqlSafe(CustomerInvoiceNumber) & "'")
                    SQL.Append(",@CustomerName='" & clsDatabase.SqlSafe(.Item("CustomerName")) & "'")
                    SQL.Append(",@Address='" & clsDatabase.SqlSafe(.Item("Address1")) & "'")
                    SQL.Append(",@City='" & clsDatabase.SqlSafe(.Item("City")) & "'")
                    SQL.Append(",@State='" & clsDatabase.SqlSafe(.Item("State")) & "'")
                    SQL.Append(",@Zip='" & clsDatabase.SqlSafe(.Item("Zip")) & "'")
                    SQL.Append(",@PaymentAmount='" & PaymentAmount & "'")
                    SQL.Append(",@PaymentDescription='" & clsDatabase.SqlSafe("Offline Check Payment") & "'")
                    SQL.Append(",@TransactionTypeID=1")
                    SQL.Append(",@PaymentTypeID=5")
                    SQL.Append(",@PaymentDate='" & Now.ToString & "'")
                    SQL.Append(",@PaymentReference='" & clsDatabase.SqlSafe(PaymentReference) & "'")
                    SQL.Append(",@PaymentMessage='" & clsDatabase.SqlSafe(PaymentMessage) & "'")
                    SQL.Append(",@CloudPortals=0")
                    SQL.Append(",@Approved=1")
                    SQL.Append(",@Offline=1")
                    SQL.Append(",@ConvenienceFee=0")
                    SQL.Append(",@PaymentSourceID=1")
                    'SQL.Append(",@RemoteIP='" & System.Web.HttpContext.Current.Request.ServerVariables("REMOTE_ADDR") & "'")
                    SQL.Append(",@RemoteIP='" & clsUtilities.GetRemoteIP() & "'")
                    SQL.Append(",@UserID=0")

                    PaymentID = Convert.ToInt32(clsDatabase.EXECUTE_COMMAND_SINGLE_RESULT(SQL.ToString, .Item("BillerID")))

                    If PaymentID > 0 Then
                        RETVAL = PaymentGUID
                    End If

                    'UPDATE INVOICE BALANCE
                    SQL.Length = 0
                    SQL.Append("exec spRecalculateBalance @InvoiceID=" & .Item("InvoiceID"))
                    clsDatabase.EXECUTE_COMMAND_NONQUERY(SQL.ToString, .Item("BillerID"))

                    'LOG THE CALL
                    SQL.Length = 0
                    SQL.Append("exec insWebMethodLogs @WebMethodID=14, @BillerID=" & .Item("BillerID"))
                    clsDatabase.EXECUTE_COMMAND_NONQUERY(SQL.ToString, .Item("BillerID"))

                End With
            Else
                ErrMsg.Append("Error: Unable to Locate Biller" & vbCrLf)
                Return ""
            End If
        Catch ex As Exception
            Serilog.Log.Error(ex, "Triggered by {Event}. BillerGuid:{BillerGuid}. WebServiceKey:{WebServiceKey}. " &
                                "CustomerAccountNumber : {CustomerAccountNumber}.CustomerInvoiceNumber:{CustomerInvoiceNumber}.PaymentAmount:{PaymentAmount}.  " &
                                " PaymentMessage:{PaymentMessage}. PaymentReference:{PaymentReference}. Message: {Message}.",
                                "PostCheckPaymentToInvoice", BillerGUID, WebServiceKey, CustomerAccountNumber,
                                CustomerInvoiceNumber, PaymentAmount, PaymentMessage, PaymentReference, "Error on CloudPayments.vb")

            RETVAL = ""
            ErrMsg.Append("Exception: " & ex.ToString & vbCrLf)
        End Try

        ErrMsg.Append("StartTime: " & StartTime.ToString & vbCrLf)
        ErrMsg.Append("EndTime: " & Now.ToString & vbCrLf)

        Try
            If Convert.ToBoolean(ConfigurationManager.AppSettings("LogCloudPaymentWS")) = True Then
                clsUtilities.WriteDebugLog("C:\temp\" & Now.ToShortDateString.Replace("/", "") & "_CloudPaymentLogs.txt", ErrMsg.ToString)
            End If
        Catch ex As Exception
            Serilog.Log.Error(ex, "Triggered by {Event}. BillerGuid:{BillerGuid}. WebServiceKey:{WebServiceKey}. " &
                                "CustomerAccountNumber : {CustomerAccountNumber}.CustomerInvoiceNumber:{CustomerInvoiceNumber}.PaymentAmount:{PaymentAmount}.  " &
                                " PaymentMessage:{PaymentMessage}. PaymentReference:{PaymentReference}. Message: {Message}.",
                                "PostCheckPaymentToInvoice", BillerGUID, WebServiceKey, CustomerAccountNumber,
                                CustomerInvoiceNumber, PaymentAmount, PaymentMessage, PaymentReference, "Error on CloudPayments.vb")
        End Try

        Return RETVAL


    End Function
Input Validation:
•	Checks if BillerGUID and WebServiceKey are valid GUIDs. If not, returns an empty string.
Search for Invoice:
•	Builds and executes a SQL query (spOfflinePaymentSearch) to find the invoice and customer details using the provided account and invoice numbers.
If Invoice Found:
•	Builds a SQL command to insert the payment (insPayments) with all relevant details (amount, customer info, payment reference, etc.).
•	Sets PaymentTypeID=5 to indicate a check payment.
•	Executes the payment insert and gets a PaymentID.
•	If successful, returns the new PaymentGUID.
•	Updates the invoice balance (spRecalculateBalance).
•	Logs the web method call (insWebMethodLogs).
If Invoice Not Found:
•	Logs an error and returns an empty string.
Error Handling:
•	Catches exceptions, logs detailed error information, and returns an empty string.
Debug Logging:
•	Optionally writes debug logs to a file if enabled in configuration.
CloudPayments.vb
 <WebMethod()>
    Public Function PostCreditAdjustmentToInvoice(ByVal BillerGUID As String, ByVal WebServiceKey As String, ByVal CustomerAccountNumber As String, ByVal CustomerInvoiceNumber As String, ByVal PaymentAmount As Double, ByVal PaymentReference As String, ByVal PaymentMessage As String) As String
        Dim StartTime As DateTime = Now
        Dim RETVAL As String = ""
        Dim SQL As New Text.StringBuilder
        Dim DT As New Data.DataTable
        Dim PaymentID As Integer = 0
        Dim PaymentGUID As String = System.Guid.NewGuid().ToString
        Dim ErrMsg As New Text.StringBuilder
        ErrMsg.Append("Method: PostCreditAdjustmentToInvoice" & vbCrLf)
        ErrMsg.Append("BillerGUID: " & BillerGUID & vbCrLf)
        ErrMsg.Append("WebServiceKey: " & WebServiceKey & vbCrLf)
        ErrMsg.Append("CustomerAccountNumber: " & CustomerAccountNumber & vbCrLf)
        ErrMsg.Append("CustomerInvoiceNumber: " & CustomerInvoiceNumber & vbCrLf)
        ErrMsg.Append("PaymentAmount: " & PaymentAmount & vbCrLf)
        ErrMsg.Append("PaymentReference: " & PaymentReference & vbCrLf)
        ErrMsg.Append("PaymentMessage: " & PaymentMessage & vbCrLf)

        If clsValidation.isValidGUID(BillerGUID) = False Or clsValidation.isValidGUID(WebServiceKey) = False Then
            Return ""
        End If

        Try
            SQL.Length = 0
            SQL.Append("exec spOfflinePaymentSearch ")
            SQL.Append("@BillerGUID='" & clsDatabase.SqlSafe(BillerGUID) & "'")
            SQL.Append(",@WebServiceKey='" & clsDatabase.SqlSafe(WebServiceKey) & "'")
            SQL.Append(",@AccountNumber='" & clsDatabase.SqlSafe(CustomerAccountNumber) & "'")
            SQL.Append(",@InvoiceNumber='" & clsDatabase.SqlSafe(CustomerInvoiceNumber) & "'")
            DT.Clear()
            DT = clsDatabase.GET_DATASET(SQL.ToString, clsBillers.GetBillerIDFromBillerGUID(Guid.Parse(BillerGUID))).Tables(0)
            If DT.Rows.Count > 0 Then
                With DT.Rows(0)
                    'RECORD PAYMENT
                    SQL.Length = 0
                    SQL.Append("exec insPayments ")
                    SQL.Append("@PaymentGUID='" & PaymentGUID & "'")
                    SQL.Append(",@InvoiceID=" & .Item("InvoiceID"))
                    SQL.Append(",@CustomerID=" & .Item("CustomerID"))
                    SQL.Append(",@BillerID=" & .Item("BillerID"))
                    SQL.Append(",@InvoiceNumber='" & clsDatabase.SqlSafe(CustomerInvoiceNumber) & "'")
                    SQL.Append(",@CustomerName='" & clsDatabase.SqlSafe(.Item("CustomerName")) & "'")
                    SQL.Append(",@Address='" & clsDatabase.SqlSafe(.Item("Address1")) & "'")
                    SQL.Append(",@City='" & clsDatabase.SqlSafe(.Item("City")) & "'")
                    SQL.Append(",@State='" & clsDatabase.SqlSafe(.Item("State")) & "'")
                    SQL.Append(",@Zip='" & clsDatabase.SqlSafe(.Item("Zip")) & "'")
                    SQL.Append(",@PaymentAmount='" & PaymentAmount & "'")
                    SQL.Append(",@PaymentDescription='" & clsDatabase.SqlSafe("Offline Credit Adj") & "'")
                    SQL.Append(",@TransactionTypeID=1")
                    SQL.Append(",@PaymentTypeID=3")
                    SQL.Append(",@PaymentDate='" & Now.ToString & "'")
                    SQL.Append(",@PaymentReference='" & clsDatabase.SqlSafe(PaymentReference) & "'")
                    SQL.Append(",@PaymentMessage='" & clsDatabase.SqlSafe(PaymentMessage) & "'")
                    SQL.Append(",@CloudPortals=0")
                    SQL.Append(",@Approved=1")
                    SQL.Append(",@Offline=1")
                    SQL.Append(",@ConvenienceFee=0")
                    SQL.Append(",@PaymentSourceID=1")
                    'SQL.Append(",@RemoteIP='" & System.Web.HttpContext.Current.Request.ServerVariables("REMOTE_ADDR") & "'")
                    SQL.Append(",@RemoteIP='" & clsUtilities.GetRemoteIP() & "'")
                    SQL.Append(",@UserID=0")

                    PaymentID = Convert.ToInt32(clsDatabase.EXECUTE_COMMAND_SINGLE_RESULT(SQL.ToString, .Item("BillerID")))

                    If PaymentID > 0 Then
                        RETVAL = PaymentGUID
                    End If

                    'UPDATE INVOICE BALANCE
                    SQL.Length = 0
                    SQL.Append("exec spRecalculateBalance @InvoiceID=" & .Item("InvoiceID"))
                    clsDatabase.EXECUTE_COMMAND_NONQUERY(SQL.ToString, .Item("BillerID"))

                    'LOG THE CALL
                    SQL.Length = 0
                    SQL.Append("exec insWebMethodLogs @WebMethodID=15, @BillerID=" & .Item("BillerID"))
                    clsDatabase.EXECUTE_COMMAND_NONQUERY(SQL.ToString, .Item("BillerID"))

                End With
            Else
                ErrMsg.Append("Error: Unable to Locate Biller" & vbCrLf)
                Return ""
            End If
        Catch ex As Exception
            Serilog.Log.Error(ex, "Triggered by {Event}. BillerGuid:{BillerGuid}. WebServiceKey:{WebServiceKey}. " &
            "CustomerAccountNumber : {CustomerAccountNumber}.CustomerInvoiceNumber:{CustomerInvoiceNumber}.PaymentAmount:{PaymentAmount}.  " &
            " PaymentMessage:{PaymentMessage}. PaymentReference:{PaymentReference}. Message: {Message}.",
            "PostCreditAdjustmentToInvoice", BillerGUID, WebServiceKey, CustomerAccountNumber,
            CustomerInvoiceNumber, PaymentAmount, PaymentMessage, PaymentReference, "Error on CloudPayments.vb")

            RETVAL = ""
            ErrMsg.Append("Exception: " & ex.ToString & vbCrLf)
        End Try

        ErrMsg.Append(RETVAL & vbCrLf)
        ErrMsg.Append("StartTime: " & StartTime.ToString & vbCrLf)
        ErrMsg.Append("EndTime: " & Now.ToString & vbCrLf)

        Try
            If Convert.ToBoolean(ConfigurationManager.AppSettings("LogCloudPaymentWS")) = True Then
                clsUtilities.WriteDebugLog("C:\temp\" & Now.ToShortDateString.Replace("/", "") & "_CloudPaymentLogs.txt", ErrMsg.ToString)
            End If
        Catch ex As Exception
            Serilog.Log.Error(ex, "Triggered by {Event}. BillerGuid:{BillerGuid}. WebServiceKey:{WebServiceKey}. " &
                    "CustomerAccountNumber : {CustomerAccountNumber}.CustomerInvoiceNumber:{CustomerInvoiceNumber}.PaymentAmount:{PaymentAmount}.  " &
                    " PaymentMessage:{PaymentMessage}. PaymentReference:{PaymentReference}. Message: {Message}.",
                    "PostCreditAdjustmentToInvoice", BillerGUID, WebServiceKey, CustomerAccountNumber,
                    CustomerInvoiceNumber, PaymentAmount, PaymentMessage, PaymentReference, "Error on CloudPayments.vb")
        End Try

        Return RETVAL

    End Function
his function is a web service method that posts a credit adjustment to a specific invoice for a customer.
Step-by-step explanation:
Input Validation:
•	Checks if BillerGUID and WebServiceKey are valid GUIDs. If not, returns an empty string.
Invoice Lookup:
•	Executes a SQL query (spOfflinePaymentSearch) to find the invoice and customer details using the provided account and invoice numbers.
If Invoice Found:
•	Builds a SQL command to insert a payment record (insPayments) with type "Offline Credit Adj" (PaymentTypeID=3), including all relevant details.
•	Executes the payment insert and gets a PaymentID.
•	If successful, returns the new PaymentGUID.
•	Updates the invoice balance (spRecalculateBalance).
•	Logs the web method call (insWebMethodLogs).
If Invoice Not Found:
•	Logs an error and returns an empty string.
Error Handling:
•	Catches exceptions, logs detailed error information, and returns an empty string.
Debug Logging:
•	Optionally writes debug logs to a file if enabled in configuration.
CloudPayments.vb
 <WebMethod()>
    Public Function PostCashPaymentToInvoice(ByVal BillerGUID As String, ByVal WebServiceKey As String, ByVal CustomerAccountNumber As String, ByVal CustomerInvoiceNumber As String, ByVal PaymentAmount As Double, ByVal PaymentReference As String, ByVal PaymentMessage As String) As String

        Dim StartTime As DateTime = Now
        Dim RETVAL As String = ""
        Dim SQL As New Text.StringBuilder
        Dim DT As New Data.DataTable
        Dim PaymentID As Integer = 0
        Dim PaymentGUID As String = System.Guid.NewGuid().ToString
        Dim ErrMsg As New Text.StringBuilder
        ErrMsg.Append("Method: PostCashPaymentToInvoice" & vbCrLf)
        ErrMsg.Append("BillerGUID: " & BillerGUID & vbCrLf)
        ErrMsg.Append("WebServiceKey: " & WebServiceKey & vbCrLf)
        ErrMsg.Append("CustomerAccountNumber: " & CustomerAccountNumber & vbCrLf)
        ErrMsg.Append("CustomerInvoiceNumber: " & CustomerInvoiceNumber & vbCrLf)
        ErrMsg.Append("PaymentAmount: " & PaymentAmount & vbCrLf)
        ErrMsg.Append("PaymentReference: " & PaymentReference & vbCrLf)
        ErrMsg.Append("PaymentMessage: " & PaymentMessage & vbCrLf)

        If clsValidation.isValidGUID(BillerGUID) = False Or clsValidation.isValidGUID(WebServiceKey) = False Then
            Return ""
        End If

        Try
            SQL.Length = 0
            SQL.Append("exec spOfflinePaymentSearch ")
            SQL.Append("@BillerGUID='" & clsDatabase.SqlSafe(BillerGUID) & "'")
            SQL.Append(",@WebServiceKey='" & clsDatabase.SqlSafe(WebServiceKey) & "'")
            SQL.Append(",@AccountNumber='" & clsDatabase.SqlSafe(CustomerAccountNumber) & "'")
            SQL.Append(",@InvoiceNumber='" & clsDatabase.SqlSafe(CustomerInvoiceNumber) & "'")
            DT.Clear()
            DT = clsDatabase.GET_DATASET(SQL.ToString, clsBillers.GetBillerIDFromBillerGUID(Guid.Parse(BillerGUID))).Tables(0)
            If DT.Rows.Count > 0 Then
                With DT.Rows(0)
                    'RECORD PAYMENT
                    SQL.Length = 0
                    SQL.Append("exec insPayments ")
                    SQL.Append("@PaymentGUID='" & PaymentGUID & "'")
                    SQL.Append(",@InvoiceID=" & .Item("InvoiceID"))
                    SQL.Append(",@CustomerID=" & .Item("CustomerID"))
                    SQL.Append(",@BillerID=" & .Item("BillerID"))
                    SQL.Append(",@InvoiceNumber='" & clsDatabase.SqlSafe(CustomerInvoiceNumber) & "'")
                    SQL.Append(",@CustomerName='" & clsDatabase.SqlSafe(.Item("CustomerName")) & "'")
                    SQL.Append(",@Address='" & clsDatabase.SqlSafe(.Item("Address1")) & "'")
                    SQL.Append(",@City='" & clsDatabase.SqlSafe(.Item("City")) & "'")
                    SQL.Append(",@State='" & clsDatabase.SqlSafe(.Item("State")) & "'")
                    SQL.Append(",@Zip='" & clsDatabase.SqlSafe(.Item("Zip")) & "'")
                    SQL.Append(",@PaymentAmount='" & PaymentAmount & "'")
                    SQL.Append(",@PaymentDescription='" & clsDatabase.SqlSafe("Offline Cash Payment") & "'")
                    SQL.Append(",@TransactionTypeID=1")
                    SQL.Append(",@PaymentTypeID=6")
                    SQL.Append(",@PaymentDate='" & Now.ToString & "'")
                    SQL.Append(",@PaymentReference='" & clsDatabase.SqlSafe(PaymentReference) & "'")
                    SQL.Append(",@PaymentMessage='" & clsDatabase.SqlSafe(PaymentMessage) & "'")
                    SQL.Append(",@CloudPortals=0")
                    SQL.Append(",@Approved=1")
                    SQL.Append(",@Offline=1")
                    SQL.Append(",@ConvenienceFee=0")
                    SQL.Append(",@PaymentSourceID=1")
                    'SQL.Append(",@RemoteIP='" & System.Web.HttpContext.Current.Request.ServerVariables("REMOTE_ADDR") & "'")
                    SQL.Append(",@RemoteIP='" & clsUtilities.GetRemoteIP() & "'")
                    SQL.Append(",@UserID=0")

                    PaymentID = Convert.ToInt32(clsDatabase.EXECUTE_COMMAND_SINGLE_RESULT(SQL.ToString, .Item("BillerID")))

                    If PaymentID > 0 Then
                        RETVAL = PaymentGUID
                    End If

                    'UPDATE INVOICE BALANCE
                    SQL.Length = 0
                    SQL.Append("exec spRecalculateBalance @InvoiceID=" & .Item("InvoiceID"))
                    clsDatabase.EXECUTE_COMMAND_NONQUERY(SQL.ToString, .Item("BillerID"))

                    'LOG THE CALL
                    SQL.Length = 0
                    SQL.Append("exec insWebMethodLogs @WebMethodID=16, @BillerID=" & .Item("BillerID"))
                    clsDatabase.EXECUTE_COMMAND_NONQUERY(SQL.ToString, .Item("BillerID"))

                End With
            Else
                ErrMsg.Append("Error: Unable to Locate Biller" & vbCrLf)
                Return ""
            End If
        Catch ex As Exception
            Serilog.Log.Error(ex, "Triggered by {Event}. BillerGuid:{BillerGuid}. WebServiceKey:{WebServiceKey}. " &
                    "CustomerAccountNumber : {CustomerAccountNumber}.CustomerInvoiceNumber:{CustomerInvoiceNumber}.PaymentAmount:{PaymentAmount}.  " &
                    " PaymentMessage:{PaymentMessage}. PaymentReference:{PaymentReference}. Message: {Message}.",
                    "PostCreditAdjustmentToInvoice", BillerGUID, WebServiceKey, CustomerAccountNumber,
                    CustomerInvoiceNumber, PaymentAmount, PaymentMessage, PaymentReference, "Error on CloudPayments.vb")
            RETVAL = ""
            ErrMsg.Append("Exception: " & ex.ToString & vbCrLf)
        End Try

        ErrMsg.Append("StartTime: " & StartTime.ToString & vbCrLf)
        ErrMsg.Append("EndTime: " & Now.ToString & vbCrLf)

        Try
            If Convert.ToBoolean(ConfigurationManager.AppSettings("LogCloudPaymentWS")) = True Then
                clsUtilities.WriteDebugLog("C:\temp\" & Now.ToShortDateString.Replace("/", "") & "_CloudPaymentLogs.txt", ErrMsg.ToString)
            End If
        Catch ex As Exception
            Serilog.Log.Error(ex, "Triggered by {Event}. BillerGuid:{BillerGuid}. WebServiceKey:{WebServiceKey}. " &
                            "CustomerAccountNumber : {CustomerAccountNumber}.CustomerInvoiceNumber:{CustomerInvoiceNumber}.PaymentAmount:{PaymentAmount}.  " &
                            " PaymentMessage:{PaymentMessage}. PaymentReference:{PaymentReference}. Message: {Message}.",
                            "PostCashPaymentToInvoice", BillerGUID, WebServiceKey, CustomerAccountNumber,
                            CustomerInvoiceNumber, PaymentAmount, PaymentMessage, PaymentReference, "Error on CloudPayments.vb")
        End Try

        Return RETVAL


    End Function
This function is a web service method that records an offline cash payment for a specific invoice.
Step-by-step explanation:
Input Validation:
•	Checks if BillerGUID and WebServiceKey are valid GUIDs. If not, returns an empty string.
Invoice Lookup:
•	Executes a SQL query (spOfflinePaymentSearch) to find the invoice and customer details using the provided account and invoice numbers.
If Invoice Found:
•	Builds a SQL command to insert a payment record (insPayments) with type "Offline Cash Payment" (PaymentTypeID=6), including all relevant details.
•	Executes the payment insert and gets a PaymentID.
•	If successful, returns the new PaymentGUID.
•	Updates the invoice balance (spRecalculateBalance).
•	Logs the web method call (insWebMethodLogs).
If Invoice Not Found:
•	Logs an error and returns an empty string.
Error Handling:
•	Catches exceptions, logs detailed error information, and returns an empty string.
Debug Logging:
•	Optionally writes debug logs to a file if enabled in configuration.
CloudPayments.vb
 <WebMethod()>
    Public Function PostDebitAdjustmentToInvoice(ByVal BillerGUID As String, ByVal WebServiceKey As String, ByVal CustomerAccountNumber As String, ByVal CustomerInvoiceNumber As String, ByVal PaymentAmount As Double, ByVal PaymentReference As String, ByVal PaymentMessage As String) As String
        Dim StartTime As DateTime = Now
        Dim RETVAL As String = ""
        Dim SQL As New Text.StringBuilder
        Dim DT As New Data.DataTable
        Dim PaymentID As Integer = 0
        Dim PaymentGUID As String = System.Guid.NewGuid().ToString
        Dim ErrMsg As New Text.StringBuilder
        ErrMsg.Append("Method: PostDebitAdjustmentToInvoice" & vbCrLf)
        ErrMsg.Append("BillerGUID: " & BillerGUID & vbCrLf)
        ErrMsg.Append("WebServiceKey: " & WebServiceKey & vbCrLf)
        ErrMsg.Append("CustomerAccountNumber: " & CustomerAccountNumber & vbCrLf)
        ErrMsg.Append("CustomerInvoiceNumber: " & CustomerInvoiceNumber & vbCrLf)
        ErrMsg.Append("PaymentAmount: " & PaymentAmount & vbCrLf)
        ErrMsg.Append("PaymentReference: " & PaymentReference & vbCrLf)
        ErrMsg.Append("PaymentMessage: " & PaymentMessage & vbCrLf)

        If clsValidation.isValidGUID(BillerGUID) = False Or clsValidation.isValidGUID(WebServiceKey) = False Then
            Return ""
        End If

        Try
            SQL.Length = 0
            SQL.Append("exec spOfflinePaymentSearch ")
            SQL.Append("@BillerGUID='" & clsDatabase.SqlSafe(BillerGUID) & "'")
            SQL.Append(",@WebServiceKey='" & clsDatabase.SqlSafe(WebServiceKey) & "'")
            SQL.Append(",@AccountNumber='" & clsDatabase.SqlSafe(CustomerAccountNumber) & "'")
            SQL.Append(",@InvoiceNumber='" & clsDatabase.SqlSafe(CustomerInvoiceNumber) & "'")
            DT.Clear()
            DT = clsDatabase.GET_DATASET(SQL.ToString, clsBillers.GetBillerIDFromBillerGUID(Guid.Parse(BillerGUID))).Tables(0)
            If DT.Rows.Count > 0 Then
                With DT.Rows(0)
                    'RECORD PAYMENT
                    SQL.Length = 0
                    SQL.Append("exec insPayments ")
                    SQL.Append("@PaymentGUID='" & PaymentGUID & "'")
                    SQL.Append(",@InvoiceID=" & .Item("InvoiceID"))
                    SQL.Append(",@CustomerID=" & .Item("CustomerID"))
                    SQL.Append(",@BillerID=" & .Item("BillerID"))
                    SQL.Append(",@InvoiceNumber='" & clsDatabase.SqlSafe(CustomerInvoiceNumber) & "'")
                    SQL.Append(",@CustomerName='" & clsDatabase.SqlSafe(.Item("CustomerName")) & "'")
                    SQL.Append(",@Address='" & clsDatabase.SqlSafe(.Item("Address1")) & "'")
                    SQL.Append(",@City='" & clsDatabase.SqlSafe(.Item("City")) & "'")
                    SQL.Append(",@State='" & clsDatabase.SqlSafe(.Item("State")) & "'")
                    SQL.Append(",@Zip='" & clsDatabase.SqlSafe(.Item("Zip")) & "'")
                    SQL.Append(",@PaymentAmount='" & (PaymentAmount * -1) & "'")
                    SQL.Append(",@PaymentDescription='" & clsDatabase.SqlSafe("Offline Debit Adj") & "'")
                    SQL.Append(",@PaymentTypeID=8")
                    SQL.Append(",@PaymentDate='" & Now.ToString & "'")
                    SQL.Append(",@PaymentReference='" & clsDatabase.SqlSafe(PaymentReference) & "'")
                    SQL.Append(",@PaymentMessage='" & clsDatabase.SqlSafe(PaymentMessage) & "'")
                    SQL.Append(",@CloudPortals=0")
                    SQL.Append(",@Approved=1")
                    SQL.Append(",@Offline=1")
                    SQL.Append(",@ConvenienceFee=0")
                    SQL.Append(",@PaymentSourceID=1")
                    'SQL.Append(",@RemoteIP='" & System.Web.HttpContext.Current.Request.ServerVariables("REMOTE_ADDR") & "'")
                    SQL.Append(",@RemoteIP='" & clsUtilities.GetRemoteIP() & "'")
                    SQL.Append(",@UserID=0")

                    PaymentID = Convert.ToInt32(clsDatabase.EXECUTE_COMMAND_SINGLE_RESULT(SQL.ToString, .Item("BillerID")))

                    If PaymentID > 0 Then
                        RETVAL = PaymentGUID
                    End If

                    'UPDATE INVOICE BALANCE
                    SQL.Length = 0
                    SQL.Append("exec spRecalculateBalance @InvoiceID=" & .Item("InvoiceID"))
                    clsDatabase.EXECUTE_COMMAND_NONQUERY(SQL.ToString, .Item("BillerID"))

                    'LOG THE CALL
                    SQL.Length = 0
                    SQL.Append("exec insWebMethodLogs @WebMethodID=17, @BillerID=" & .Item("BillerID"))
                    clsDatabase.EXECUTE_COMMAND_NONQUERY(SQL.ToString, .Item("BillerID"))

                End With
            Else
                ErrMsg.Append("Error: Unable to Locate Biller" & vbCrLf)
                Return ""
            End If
        Catch ex As Exception
            Serilog.Log.Error(ex, "Triggered by {Event}. BillerGuid:{BillerGuid}. WebServiceKey:{WebServiceKey}. " &
                                "CustomerAccountNumber : {CustomerAccountNumber}.CustomerInvoiceNumber:{CustomerInvoiceNumber}.PaymentAmount:{PaymentAmount}.  " &
                                " PaymentMessage:{PaymentMessage}. PaymentReference:{PaymentReference}. Message: {Message}.",
                                "PostDebitAdjustmentToInvoice", BillerGUID, WebServiceKey, CustomerAccountNumber,
                                CustomerInvoiceNumber, PaymentAmount, PaymentMessage, PaymentReference, "Error on CloudPayments.vb")
            RETVAL = ""
            ErrMsg.Append("Exception: " & ex.ToString & vbCrLf)
        End Try

        ErrMsg.Append("StartTime: " & StartTime.ToString & vbCrLf)
        ErrMsg.Append("EndTime: " & Now.ToString & vbCrLf)

        Try
            If Convert.ToBoolean(ConfigurationManager.AppSettings("LogCloudPaymentWS")) = True Then
                clsUtilities.WriteDebugLog("C:\temp\" & Now.ToShortDateString.Replace("/", "") & "_CloudPaymentLogs.txt", ErrMsg.ToString)
            End If
        Catch ex As Exception
            Serilog.Log.Error(ex, "Triggered by {Event}. BillerGuid:{BillerGuid}. WebServiceKey:{WebServiceKey}. " &
                        "CustomerAccountNumber : {CustomerAccountNumber}.CustomerInvoiceNumber:{CustomerInvoiceNumber}.PaymentAmount:{PaymentAmount}.  " &
                        " PaymentMessage:{PaymentMessage}. PaymentReference:{PaymentReference}. Message: {Message}.",
                        "PostDebitAdjustmentToInvoice", BillerGUID, WebServiceKey, CustomerAccountNumber,
                        CustomerInvoiceNumber, PaymentAmount, PaymentMessage, PaymentReference, "Error on CloudPayments.vb")
        End Try

        Return RETVAL

    End Function
This function is a web service method that posts a debit adjustment (a negative payment) to a specific invoice for a customer.
Step-by-step explanation:
Input Validation:
•	Checks if BillerGUID and WebServiceKey are valid GUIDs. If not, returns an empty string.
Invoice Lookup:
•	Executes a SQL query (spOfflinePaymentSearch) to find the invoice and customer details using the provided account and invoice numbers.
If Invoice Found:
•	Builds a SQL command to insert a payment record (insPayments) with type "Offline Debit Adj" (PaymentTypeID=8), including all relevant details.
•	The payment amount is multiplied by -1 to indicate a debit (reducing the invoice balance).
•	Executes the payment insert and gets a PaymentID.
•	If successful, returns the new PaymentGUID.
•	Updates the invoice balance (spRecalculateBalance).
•	Logs the web method call (insWebMethodLogs).
If Invoice Not Found:
•	Logs an error and returns an empty string.
Error Handling:
•	Catches exceptions, logs detailed error information, and returns an empty string.
Debug Logging:
•	Optionally writes debug logs to a file if enabled in configuration.
CloudPayments.vb
    <WebMethod()>
    Public Function PostPaymentDiscountToInvoice(ByVal BillerGUID As String, ByVal WebServiceKey As String, ByVal CustomerAccountNumber As String, ByVal CustomerInvoiceNumber As String, ByVal PaymentAmount As Double, ByVal PaymentReference As String, ByVal PaymentMessage As String) As String
        Dim StartTime As DateTime = Now
        Dim RETVAL As String = ""
        Dim SQL As New Text.StringBuilder
        Dim DT As New Data.DataTable
        Dim PaymentID As Integer = 0
        Dim PaymentGUID As String = System.Guid.NewGuid().ToString
        Dim ErrMsg As New Text.StringBuilder
        ErrMsg.Append("Method: PostPaymentDiscountToInvoice" & vbCrLf)
        ErrMsg.Append("BillerGUID: " & BillerGUID & vbCrLf)
        ErrMsg.Append("WebServiceKey: " & WebServiceKey & vbCrLf)
        ErrMsg.Append("CustomerAccountNumber: " & CustomerAccountNumber & vbCrLf)
        ErrMsg.Append("CustomerInvoiceNumber: " & CustomerInvoiceNumber & vbCrLf)
        ErrMsg.Append("PaymentAmount: " & PaymentAmount & vbCrLf)
        ErrMsg.Append("PaymentReference: " & PaymentReference & vbCrLf)
        ErrMsg.Append("PaymentMessage: " & PaymentMessage & vbCrLf)

        If clsValidation.isValidGUID(BillerGUID) = False Or clsValidation.isValidGUID(WebServiceKey) = False Then
            Return ""
        End If

        Try
            SQL.Length = 0
            SQL.Append("exec spOfflinePaymentSearch ")
            SQL.Append("@BillerGUID='" & clsDatabase.SqlSafe(BillerGUID) & "'")
            SQL.Append(",@WebServiceKey='" & clsDatabase.SqlSafe(WebServiceKey) & "'")
            SQL.Append(",@AccountNumber='" & clsDatabase.SqlSafe(CustomerAccountNumber) & "'")
            SQL.Append(",@InvoiceNumber='" & clsDatabase.SqlSafe(CustomerInvoiceNumber) & "'")
            DT.Clear()
            DT = clsDatabase.GET_DATASET(SQL.ToString, clsBillers.GetBillerIDFromBillerGUID(Guid.Parse(BillerGUID))).Tables(0)
            If DT.Rows.Count > 0 Then
                With DT.Rows(0)
                    'RECORD PAYMENT
                    SQL.Length = 0
                    SQL.Append("exec insPayments ")
                    SQL.Append("@PaymentGUID='" & PaymentGUID & "'")
                    SQL.Append(",@InvoiceID=" & .Item("InvoiceID"))
                    SQL.Append(",@CustomerID=" & .Item("CustomerID"))
                    SQL.Append(",@BillerID=" & .Item("BillerID"))
                    SQL.Append(",@InvoiceNumber='" & clsDatabase.SqlSafe(CustomerInvoiceNumber) & "'")
                    SQL.Append(",@CustomerName='" & clsDatabase.SqlSafe(.Item("CustomerName")) & "'")
                    SQL.Append(",@Address='" & clsDatabase.SqlSafe(.Item("Address1")) & "'")
                    SQL.Append(",@City='" & clsDatabase.SqlSafe(.Item("City")) & "'")
                    SQL.Append(",@State='" & clsDatabase.SqlSafe(.Item("State")) & "'")
                    SQL.Append(",@Zip='" & clsDatabase.SqlSafe(.Item("Zip")) & "'")
                    SQL.Append(",@PaymentAmount='" & PaymentAmount & "'")
                    SQL.Append(",@PaymentDescription='" & clsDatabase.SqlSafe("Offline Pmt Disc") & "'")
                    SQL.Append(",@PaymentTypeID=7")
                    SQL.Append(",@PaymentDate='" & Now.ToString & "'")
                    SQL.Append(",@PaymentReference='" & clsDatabase.SqlSafe(PaymentReference) & "'")
                    SQL.Append(",@PaymentMessage='" & clsDatabase.SqlSafe(PaymentMessage) & "'")
                    SQL.Append(",@CloudPortals=0")
                    SQL.Append(",@Approved=1")
                    SQL.Append(",@Offline=1")
                    SQL.Append(",@ConvenienceFee=0")
                    SQL.Append(",@PaymentSourceID=1")
                    'SQL.Append(",@RemoteIP='" & System.Web.HttpContext.Current.Request.ServerVariables("REMOTE_ADDR") & "'")
                    SQL.Append(",@RemoteIP='" & clsUtilities.GetRemoteIP() & "'")
                    SQL.Append(",@UserID=0")

                    PaymentID = Convert.ToInt32(clsDatabase.EXECUTE_COMMAND_SINGLE_RESULT(SQL.ToString, .Item("BillerID")))

                    If PaymentID > 0 Then
                        RETVAL = PaymentGUID
                    End If

                    'UPDATE INVOICE BALANCE
                    SQL.Length = 0
                    SQL.Append("exec spRecalculateBalance @InvoiceID=" & .Item("InvoiceID"))
                    clsDatabase.EXECUTE_COMMAND_NONQUERY(SQL.ToString, .Item("BillerID"))

                    'LOG THE CALL
                    SQL.Length = 0
                    SQL.Append("exec insWebMethodLogs @WebMethodID=18, @BillerID=" & .Item("BillerID"))
                    clsDatabase.EXECUTE_COMMAND_NONQUERY(SQL.ToString, .Item("BillerID"))

                End With
            Else
                ErrMsg.Append("Error: Unable to Locate Biller" & vbCrLf)
                Return ""
            End If
        Catch ex As Exception
            Serilog.Log.Error(ex, "Triggered by {Event}. BillerGuid:{BillerGuid}. WebServiceKey:{WebServiceKey}. " &
                                "CustomerAccountNumber : {CustomerAccountNumber}.CustomerInvoiceNumber:{CustomerInvoiceNumber}.PaymentAmount:{PaymentAmount}.  " &
                                " PaymentMessage:{PaymentMessage}. PaymentReference:{PaymentReference}. Message: {Message}.",
                                "PostPaymentDiscountToInvoice", BillerGUID, WebServiceKey, CustomerAccountNumber,
                                CustomerInvoiceNumber, PaymentAmount, PaymentMessage, PaymentReference, "Error on CloudPayments.vb")
            RETVAL = ""
            ErrMsg.Append("Exception: " & ex.ToString & vbCrLf)
        End Try

        ErrMsg.Append("StartTime: " & StartTime.ToString & vbCrLf)
        ErrMsg.Append("EndTime: " & Now.ToString & vbCrLf)

        Try
            If Convert.ToBoolean(ConfigurationManager.AppSettings("LogCloudPaymentWS")) = True Then
                clsUtilities.WriteDebugLog("C:\temp\" & Now.ToShortDateString.Replace("/", "") & "_CloudPaymentLogs.txt", ErrMsg.ToString)
            End If
        Catch ex As Exception
            Serilog.Log.Error(ex, "Triggered by {Event}. BillerGuid:{BillerGuid}. WebServiceKey:{WebServiceKey}. " &
                                        "CustomerAccountNumber : {CustomerAccountNumber}.CustomerInvoiceNumber:{CustomerInvoiceNumber}.PaymentAmount:{PaymentAmount}.  " &
                                        " PaymentMessage:{PaymentMessage}. PaymentReference:{PaymentReference}. Message: {Message}.",
                                        "PostPaymentDiscountToInvoice", BillerGUID, WebServiceKey, CustomerAccountNumber,
                                        CustomerInvoiceNumber, PaymentAmount, PaymentMessage, PaymentReference, "Error on CloudPayments.vb")
        End Try

        Return RETVAL

    End Function
This function is a web service method that posts a payment discount to a specific invoice for a customer.
Step-by-step explanation:
Input Validation:
•	Checks if BillerGUID and WebServiceKey are valid GUIDs. If not, returns an empty string.
Invoice Lookup:
•	Executes a SQL query (spOfflinePaymentSearch) to find the invoice and customer details using the provided account and invoice numbers.
If Invoice Found:
•	Builds a SQL command to insert a payment record (insPayments) with type "Offline Pmt Disc" (PaymentTypeID=7), including all relevant details.
•	Executes the payment insert and gets a PaymentID.
•	If successful, returns the new PaymentGUID.
•	Updates the invoice balance (spRecalculateBalance).
•	Logs the web method call (insWebMethodLogs).
If Invoice Not Found:
•	Logs an error and returns an empty string.
Error Handling:
•	Catches exceptions, logs detailed error information, and returns an empty string.
Debug Logging:
•	Optionally writes debug logs to a file if enabled in configuration.
IC.Common/
CloudTransactionProcessing.vb
 Public Shared Function INSERT_IC_ACH_CHECK21_PAYMENT_RECORD(ByVal REQ As CTP.IC_ACH_Sale_Request, ByVal MISC As CTP.IC_Misc_Data, ByVal settledBatchID As Integer, ByVal paymentReference As String) As Integer
        Dim SQL As String = ""
        Dim PaymentID As Integer = 0
        ' Dim PaymentGuid As String = System.Guid.NewGuid.ToString()
        Dim ReceiptGUID As String = System.Guid.NewGuid.ToString()

        'INSERT PAYMENT RECORD
        SQL = "exec insPayments "
        SQL = SQL & "@PaymentGUID='" & REQ.PaymentGUID & "'"
        SQL = SQL & ",@InvoiceID=" & MISC.InvoiceID
        SQL = SQL & ",@CustomerID=" & MISC.CustomerID
        SQL = SQL & ",@LoginID=" & MISC.LoginID
        SQL = SQL & ",@BillerID=" & MISC.BillerID
        SQL = SQL & ",@InvoiceNumber='" & clsDatabase.SqlSafe(REQ.InvoiceNumber) & "'"
        SQL = SQL & ",@CustomerName='" & clsDatabase.SqlSafe(REQ.CustomerName) & "'"
        SQL = SQL & ",@Address='" & clsDatabase.SqlSafe(REQ.CustomerAddress) & "'"
        SQL = SQL & ",@City='" & clsDatabase.SqlSafe(REQ.CustomerCity) & "'"
        SQL = SQL & ",@State='" & clsDatabase.SqlSafe(REQ.CustomerState) & "'"
        SQL = SQL & ",@Zip='" & clsDatabase.SqlSafe(REQ.CustomerZip) & "'"
        SQL = SQL & ",@EmailAddress='" & clsDatabase.SqlSafe(REQ.CustomerEmailAddress) & "'"
        SQL = SQL & ",@PaymentAmount=" & REQ.TotalAmount
        SQL = SQL & ",@TransactionTypeID=1" 'Sale
        SQL = SQL & ",@PaymentTypeID=9" 'Check21
        SQL = SQL & ",@PaymentDate='" & Now.ToString & "'"
        SQL = SQL & ",@PaymentReference='" & paymentReference & "'"
        SQL = SQL & ",@PaymentMessage='PAYMENT PROCESSED " & clsUtilities.GenerateApprovalCode() & "'"
        SQL = SQL & ",@SecureAccountNumber='" & REQ.EncryptedBankAccountNumber & "'"
        'SQL = SQL & ",@SecureAccountNumber='"&  clsCryptoService.EncryptPaymentsBankAccountNumber(MISC.BillerGUID, PaymentGuid, REQ.BankAccountNumber) & "'"
        SQL = SQL & ",@PaymentDescription='Checking Account ending in " & Right(REQ.BankAccountNumber, 4) & "'"
        SQL = SQL & ",@RTE='" & clsDatabase.SqlSafe(REQ.BankRTE) & "'"
        SQL = SQL & ",@AccountNumber='" & clsUtilities.MaskBankAccount(REQ.BankAccountNumber) & "'"
        SQL = SQL & ",@Checking=1"
        SQL = SQL & ",@BankAccountTypeID=1"
        SQL = SQL & ",@Approved=1"
        SQL = SQL & ",@CloudPortals=" & Convert.ToInt16(MISC.CloudPortals)
        SQL = SQL & ",@Offline=" & Convert.ToInt16(MISC.Offline)
        SQL = SQL & ",@PaymentSourceID=9" ' Check21
        SQL = SQL & ",@RemoteIP='" & clsDatabase.SqlSafe(MISC.RemoteIP) & "'"
        SQL = SQL & ",@UserID=" & MISC.UserID
        SQL = SQL & ",@ReceiptGUID='" & ReceiptGUID & "'"
        SQL = SQL & ",@SettledBatchID=" & settledBatchID.ToString
        SQL = SQL & ",@RejectReference='" & REQ.RejectReference & "'"
        SQL = SQL & ",@TermID=" & REQ.TerminalID.ToString
        SQL = SQL & ",@TraceNumber='" & REQ.TraceNumber & "'"
        PaymentID = Convert.ToInt32(clsDatabase.EXECUTE_COMMAND_SINGLE_RESULT(SQL, MISC.BillerID))
        Return PaymentID
    End Function
This function inserts a Check21 ACH payment record into the database and returns the new payment ID.
Step-by-step explanation:
Build SQL Command:
•	Constructs a SQL command string to call the stored procedure insPayments with all required payment details.
•	Uses data from the request (REQ) and miscellaneous info (MISC), such as invoice/customer IDs, payment amount, bank account info, and other metadata.
•	Sets PaymentTypeID=9 to indicate a Check21 payment.
•	Includes security features like encrypted bank account number and masked account number.
•	Adds additional info: approval code, payment description, batch ID, terminal ID, trace number, etc.
Execute SQL Command:
•	Runs the SQL command using clsDatabase.EXECUTE_COMMAND_SINGLE_RESULT, which inserts the payment record and returns the new PaymentID.
Return Payment ID:
•	Returns the integer ID of the newly inserted payment record.
IC.Common/
CloudTransactionProcessing.vb
Public Shared Function INSERT_IC_ACH_OBD_PAYMENT_RECORD(ByVal REQ As CTP.IC_ACH_Sale_Request, ByVal MISC As CTP.IC_Misc_Data, ByVal settledBatchID As Integer, ByVal paymentReference As String) As Integer
        Dim SQL As String = ""
        Dim PaymentID As Integer = 0
        ' Dim PaymentGuid As String = System.Guid.NewGuid.ToString()
        Dim ReceiptGUID As String = System.Guid.NewGuid.ToString()

        'INSERT PAYMENT RECORD
        SQL = "exec insPayments "
        SQL = SQL & "@PaymentGUID='" & REQ.PaymentGUID & "'"
        SQL = SQL & ",@InvoiceID=" & MISC.InvoiceID
        SQL = SQL & ",@CustomerID=" & MISC.CustomerID
        SQL = SQL & ",@LoginID=" & MISC.LoginID
        SQL = SQL & ",@BillerID=" & MISC.BillerID
        SQL = SQL & ",@InvoiceNumber='" & clsDatabase.SqlSafe(REQ.InvoiceNumber) & "'"
        SQL = SQL & ",@CustomerName='" & clsDatabase.SqlSafe(REQ.CustomerName) & "'"
        SQL = SQL & ",@Address='" & clsDatabase.SqlSafe(REQ.CustomerAddress) & "'"
        SQL = SQL & ",@City='" & clsDatabase.SqlSafe(REQ.CustomerCity) & "'"
        SQL = SQL & ",@State='" & clsDatabase.SqlSafe(REQ.CustomerState) & "'"
        SQL = SQL & ",@Zip='" & clsDatabase.SqlSafe(REQ.CustomerZip) & "'"
        SQL = SQL & ",@EmailAddress='" & clsDatabase.SqlSafe(REQ.CustomerEmailAddress) & "'"
        SQL = SQL & ",@PaymentAmount=" & REQ.TotalAmount
        SQL = SQL & ",@TransactionTypeID=1" 'Sale
        SQL = SQL & ",@PaymentTypeID=11" 'Online Bank Direct
        SQL = SQL & ",@PaymentDate='" & Now.ToString & "'"
        SQL = SQL & ",@PaymentReference='" & paymentReference & "'"
        SQL = SQL & ",@PaymentMessage='PAYMENT PROCESSED " & clsUtilities.GenerateApprovalCode() & "'"
        SQL = SQL & ",@SecureAccountNumber='" & REQ.EncryptedBankAccountNumber & "'"
        ' SQL = SQL & ",@SecureAccountNumber='" & clsCryptoService.EncryptPaymentsBankAccountNumber(MISC.BillerGUID, PaymentGuid, REQ.BankAccountNumber) & "'"
        SQL = SQL & ",@PaymentDescription='Checking Account ending in " & Right(REQ.BankAccountNumber, 4) & "'"
        SQL = SQL & ",@RTE='" & clsDatabase.SqlSafe(REQ.BankRTE) & "'"
        SQL = SQL & ",@AccountNumber='" & clsUtilities.MaskBankAccount(REQ.BankAccountNumber) & "'"
        SQL = SQL & ",@Checking=1"
        SQL = SQL & ",@BankAccountTypeID=1"
        SQL = SQL & ",@Approved=1"
        SQL = SQL & ",@CloudPortals=" & Convert.ToInt16(MISC.CloudPortals)
        SQL = SQL & ",@Offline=" & Convert.ToInt16(MISC.Offline)
        SQL = SQL & ",@PaymentSourceID=7"
        SQL = SQL & ",@RemoteIP='" & clsDatabase.SqlSafe(MISC.RemoteIP) & "'"
        SQL = SQL & ",@UserID=" & MISC.UserID
        SQL = SQL & ",@ReceiptGUID='" & ReceiptGUID & "'"
        SQL = SQL & ",@SettledBatchID=" & settledBatchID.ToString
        SQL = SQL & ",@TermID=" & REQ.TerminalID.ToString
        SQL = SQL & ",@TraceNumber='" & REQ.TraceNumber & "'"
        PaymentID = Convert.ToInt32(clsDatabase.EXECUTE_COMMAND_SINGLE_RESULT(SQL, MISC.BillerID))
        AzureQueueStorage.AddToPaymentCostQueue(MISC.BillerID, PaymentID)
        Return PaymentID
    End Function
This function inserts an Online Bank Direct (OBD) ACH payment record into the database and returns the new payment ID.
Step-by-step explanation:
Build SQL Command:
•	Constructs a SQL command string to call the stored procedure insPayments with all required payment details.
•	Uses data from the request (REQ) and miscellaneous info (MISC), such as invoice/customer IDs, payment amount, bank account info, and other metadata.
•	Sets PaymentTypeID=11 to indicate an Online Bank Direct payment.
•	Includes security features like encrypted bank account number and masked account number.
•	Adds additional info: approval code, payment description, batch ID, terminal ID, trace number, etc.
Execute SQL Command:
•	Runs the SQL command using clsDatabase.EXECUTE_COMMAND_SINGLE_RESULT, which inserts the payment record and returns the new PaymentID.
Queue Payment Cost Calculation:
•	Adds the new payment to an Azure queue (AzureQueueStorage.AddToPaymentCostQueue) for further cost processing.
Return Payment ID:
•	Returns the integer ID of the newly inserted payment record.
IC.Common/
CloudTransactionProcessing.vb
 Public Shared Function INSERT_IC_ACH_SALE_DISCOUNT_RECORD(ByVal REQ As CTP.IC_ACH_Sale_Request, ByVal RES As CTP.IC_ACH_Sale_Response, ByVal MISC As CTP.IC_Misc_Data) As Integer
        Dim SQL As String = ""
        Dim PaymentID As Integer = 0
        Dim Biller As New clsBillers
        Biller = Biller.LoadBillerByBillerID(MISC.BillerID)
        If Convert.ToBoolean(Convert.ToInt16(Biller.BillerOptions(30).Values.BillerValue)) = True Then
            SQL = "exec insPayments "
            SQL = SQL & "@PaymentGUID='" & System.Guid.NewGuid().ToString & "'"
            SQL = SQL & ",@InvoiceID=" & MISC.InvoiceID
            SQL = SQL & ",@CustomerID=" & MISC.CustomerID
            SQL = SQL & ",@LoginID=" & MISC.LoginID
            SQL = SQL & ",@BillerID=" & MISC.BillerID
            SQL = SQL & ",@InvoiceNumber='" & clsDatabase.SqlSafe(REQ.InvoiceNumber) & "'"
            SQL = SQL & ",@CustomerName='" & clsDatabase.SqlSafe(REQ.CustomerName) & "'"
            SQL = SQL & ",@Address='" & clsDatabase.SqlSafe(REQ.CustomerAddress) & "'"
            SQL = SQL & ",@City='" & clsDatabase.SqlSafe(REQ.CustomerCity) & "'"
            SQL = SQL & ",@State='" & clsDatabase.SqlSafe(REQ.CustomerState) & "'"
            SQL = SQL & ",@Zip='" & clsDatabase.SqlSafe(REQ.CustomerZip) & "'"
            SQL = SQL & ",@EmailAddress='" & clsDatabase.SqlSafe(REQ.CustomerEmailAddress) & "'"
            SQL = SQL & ",@TransactionTypeID=1"
            SQL = SQL & ",@PaymentAmount='" & REQ.PromptPaymentDiscountAmount & "'"
            SQL = SQL & ",@PaymentTypeID=7"
            SQL = SQL & ",@PaymentDate='" & Now.ToString & "'"
            SQL = SQL & ",@PaymentReference='" & clsUtilities.GenerateReference & "'"
            SQL = SQL & ",@PaymentMessage='Prompt Payment Discount'"
            SQL = SQL & ",@PaymentDescription='Prompt Payment Discount'"
            SQL = SQL & ",@Approved=1"
            SQL = SQL & ",@CloudPortals=" & Convert.ToInt16(MISC.CloudPortals)
            SQL = SQL & ",@Offline=" & Convert.ToInt16(MISC.Offline)
            SQL = SQL & ",@PaymentSourceID=" & MISC.PaymentSourceID
            SQL = SQL & ",@RemoteIP='" & clsDatabase.SqlSafe(MISC.RemoteIP) & "'"
            SQL = SQL & ",@UserID=" & MISC.UserID
            SQL = SQL & ",@TraceNumber='" & REQ.TraceNumber & "'"
            PaymentID = Convert.ToInt32(clsDatabase.EXECUTE_COMMAND_SINGLE_RESULT(SQL, MISC.BillerID))
        End If
        Return PaymentID
    End Function

This function inserts a prompt payment discount record for an ACH sale into the database and returns the new payment ID.
Step-by-step explanation:
Check Biller Option:
•	Loads the biller by BillerID and checks if the biller allows prompt payment discounts (option 30).
If Discount Allowed:
•	Builds a SQL command to call the stored procedure insPayments with all required payment details.
•	Sets PaymentTypeID=7 to indicate a payment discount.
•	Uses the discount amount from the request (REQ.PromptPaymentDiscountAmount).
•	Includes customer, invoice, and payment metadata.
Execute SQL Command:
•	Runs the SQL command using clsDatabase.EXECUTE_COMMAND_SINGLE_RESULT, which inserts the discount record and returns the new PaymentID.
Return Payment ID:
•	Returns the integer ID of the newly inserted discount payment record (or 0 if not allowed).
App_code/
CloudTransactionProcessing.vb
Public Shared Function INSERT_IC_ACH_CHECK21_PAYMENT_RECORD(ByVal REQ As CTP.IC_ACH_Sale_Request, ByVal MISC As CTP.IC_Misc_Data, ByVal settledBatchID As Integer, ByVal paymentReference As String) As Integer
        Dim SQL As String = ""
        Dim PaymentID As Integer = 0
        ' Dim PaymentGuid As String = System.Guid.NewGuid.ToString()
        Dim ReceiptGUID As String = System.Guid.NewGuid.ToString()

        'INSERT PAYMENT RECORD
        SQL = "exec insPayments "
        SQL = SQL & "@PaymentGUID='" & REQ.PaymentGUID & "'"
        SQL = SQL & ",@InvoiceID=" & MISC.InvoiceID
        SQL = SQL & ",@CustomerID=" & MISC.CustomerID
        SQL = SQL & ",@LoginID=" & MISC.LoginID
        SQL = SQL & ",@BillerID=" & MISC.BillerID
        SQL = SQL & ",@InvoiceNumber='" & clsDatabase.SqlSafe(REQ.InvoiceNumber) & "'"
        SQL = SQL & ",@CustomerName='" & clsDatabase.SqlSafe(REQ.CustomerName) & "'"
        SQL = SQL & ",@Address='" & clsDatabase.SqlSafe(REQ.CustomerAddress) & "'"
        SQL = SQL & ",@City='" & clsDatabase.SqlSafe(REQ.CustomerCity) & "'"
        SQL = SQL & ",@State='" & clsDatabase.SqlSafe(REQ.CustomerState) & "'"
        SQL = SQL & ",@Zip='" & clsDatabase.SqlSafe(REQ.CustomerZip) & "'"
        SQL = SQL & ",@EmailAddress='" & clsDatabase.SqlSafe(REQ.CustomerEmailAddress) & "'"
        SQL = SQL & ",@PaymentAmount=" & REQ.TotalAmount
        SQL = SQL & ",@TransactionTypeID=1" 'Sale
        SQL = SQL & ",@PaymentTypeID=9" 'Check21
        SQL = SQL & ",@PaymentDate='" & Now.ToString & "'"
        SQL = SQL & ",@PaymentReference='" & paymentReference & "'"
        SQL = SQL & ",@PaymentMessage='PAYMENT PROCESSED " & clsUtilities.GenerateApprovalCode() & "'"
        SQL = SQL & ",@SecureAccountNumber='" & REQ.EncryptedBankAccountNumber & "'"
        'SQL = SQL & ",@SecureAccountNumber='"&  clsCryptoService.EncryptPaymentsBankAccountNumber(MISC.BillerGUID, PaymentGuid, REQ.BankAccountNumber) & "'"
        SQL = SQL & ",@PaymentDescription='Checking Account ending in " & Right(REQ.BankAccountNumber, 4) & "'"
        SQL = SQL & ",@RTE='" & clsDatabase.SqlSafe(REQ.BankRTE) & "'"
        SQL = SQL & ",@AccountNumber='" & clsUtilities.MaskBankAccount(REQ.BankAccountNumber) & "'"
        SQL = SQL & ",@Checking=1"
        SQL = SQL & ",@BankAccountTypeID=1"
        SQL = SQL & ",@Approved=1"
        SQL = SQL & ",@CloudPortals=" & Convert.ToInt16(MISC.CloudPortals)
        SQL = SQL & ",@Offline=" & Convert.ToInt16(MISC.Offline)
        SQL = SQL & ",@PaymentSourceID=9" ' Check21
        SQL = SQL & ",@RemoteIP='" & clsDatabase.SqlSafe(MISC.RemoteIP) & "'"
        SQL = SQL & ",@UserID=" & MISC.UserID
        SQL = SQL & ",@ReceiptGUID='" & ReceiptGUID & "'"
        SQL = SQL & ",@SettledBatchID=" & settledBatchID.ToString
        SQL = SQL & ",@RejectReference='" & REQ.RejectReference & "'"
        SQL = SQL & ",@TermID=" & REQ.TerminalID.ToString
        SQL = SQL & ",@TraceNumber='" & REQ.TraceNumber & "'"
        PaymentID = Convert.ToInt32(clsDatabase.EXECUTE_COMMAND_SINGLE_RESULT(SQL, MISC.BillerID))
        Return PaymentID
    End Function
This function inserts a Check21 ACH payment record into the database and returns the new payment ID.
Step-by-step explanation:
Build SQL Command:
•	Constructs a SQL command to call the stored procedure insPayments with all required payment details.
•	Uses data from the request (REQ) and miscellaneous info (MISC), such as invoice/customer IDs, payment amount, bank account info, and other metadata.
•	Sets PaymentTypeID=9 to indicate a Check21 payment.
•	Includes security features like encrypted bank account number and masked account number.
•	Adds additional info: approval code, payment description, batch ID, terminal ID, trace number, etc.
Execute SQL Command:
•	Runs the SQL command using clsDatabase.EXECUTE_COMMAND_SINGLE_RESULT, which inserts the payment record and returns the new PaymentID.
Return Payment ID:
•	Returns the integer ID of the newly inserted payment record.
App_code/
CloudTransactionProcessing.vb
Public Shared Function INSERT_IC_ACH_OBD_PAYMENT_RECORD(ByVal REQ As CTP.IC_ACH_Sale_Request, ByVal MISC As CTP.IC_Misc_Data, ByVal settledBatchID As Integer, ByVal paymentReference As String) As Integer
        Dim SQL As String = ""
        Dim PaymentID As Integer = 0
        ' Dim PaymentGuid As String = System.Guid.NewGuid.ToString()
        Dim ReceiptGUID As String = System.Guid.NewGuid.ToString()

        'INSERT PAYMENT RECORD
        SQL = "exec insPayments "
        SQL = SQL & "@PaymentGUID='" & REQ.PaymentGUID & "'"
        SQL = SQL & ",@InvoiceID=" & MISC.InvoiceID
        SQL = SQL & ",@CustomerID=" & MISC.CustomerID
        SQL = SQL & ",@LoginID=" & MISC.LoginID
        SQL = SQL & ",@BillerID=" & MISC.BillerID
        SQL = SQL & ",@InvoiceNumber='" & clsDatabase.SqlSafe(REQ.InvoiceNumber) & "'"
        SQL = SQL & ",@CustomerName='" & clsDatabase.SqlSafe(REQ.CustomerName) & "'"
        SQL = SQL & ",@Address='" & clsDatabase.SqlSafe(REQ.CustomerAddress) & "'"
        SQL = SQL & ",@City='" & clsDatabase.SqlSafe(REQ.CustomerCity) & "'"
        SQL = SQL & ",@State='" & clsDatabase.SqlSafe(REQ.CustomerState) & "'"
        SQL = SQL & ",@Zip='" & clsDatabase.SqlSafe(REQ.CustomerZip) & "'"
        SQL = SQL & ",@EmailAddress='" & clsDatabase.SqlSafe(REQ.CustomerEmailAddress) & "'"
        SQL = SQL & ",@PaymentAmount=" & REQ.TotalAmount
        SQL = SQL & ",@TransactionTypeID=1" 'Sale
        SQL = SQL & ",@PaymentTypeID=11" 'Online Bank Direct
        SQL = SQL & ",@PaymentDate='" & Now.ToString & "'"
        SQL = SQL & ",@PaymentReference='" & paymentReference & "'"
        SQL = SQL & ",@PaymentMessage='PAYMENT PROCESSED " & clsUtilities.GenerateApprovalCode() & "'"
        SQL = SQL & ",@SecureAccountNumber='" & REQ.EncryptedBankAccountNumber & "'"
        ' SQL = SQL & ",@SecureAccountNumber='" & clsCryptoService.EncryptPaymentsBankAccountNumber(MISC.BillerGUID, PaymentGuid, REQ.BankAccountNumber) & "'"
        SQL = SQL & ",@PaymentDescription='Checking Account ending in " & Right(REQ.BankAccountNumber, 4) & "'"
        SQL = SQL & ",@RTE='" & clsDatabase.SqlSafe(REQ.BankRTE) & "'"
        SQL = SQL & ",@AccountNumber='" & clsUtilities.MaskBankAccount(REQ.BankAccountNumber) & "'"
        SQL = SQL & ",@Checking=1"
        SQL = SQL & ",@BankAccountTypeID=1"
        SQL = SQL & ",@Approved=1"
        SQL = SQL & ",@CloudPortals=" & Convert.ToInt16(MISC.CloudPortals)
        SQL = SQL & ",@Offline=" & Convert.ToInt16(MISC.Offline)
        SQL = SQL & ",@PaymentSourceID=7"
        SQL = SQL & ",@RemoteIP='" & clsDatabase.SqlSafe(MISC.RemoteIP) & "'"
        SQL = SQL & ",@UserID=" & MISC.UserID
        SQL = SQL & ",@ReceiptGUID='" & ReceiptGUID & "'"
        SQL = SQL & ",@SettledBatchID=" & settledBatchID.ToString
        SQL = SQL & ",@TermID=" & REQ.TerminalID.ToString
        SQL = SQL & ",@TraceNumber='" & REQ.TraceNumber & "'"
        PaymentID = Convert.ToInt32(clsDatabase.EXECUTE_COMMAND_SINGLE_RESULT(SQL, MISC.BillerID))
        AzureQueueStorage.AddToPaymentCostQueue(MISC.BillerID, PaymentID)
        Return PaymentID
    End Function

This function inserts an Online Bank Direct (OBD) ACH payment record into the database and returns the new payment ID.
Step-by-step explanation:
Build SQL Command:
•	Constructs a SQL command to call the stored procedure insPayments with all required payment details.
•	Uses data from the request (REQ) and miscellaneous info (MISC), such as invoice/customer IDs, payment amount, bank account info, and other metadata.
•	Sets PaymentTypeID=11 to indicate an Online Bank Direct payment.
•	Includes security features like encrypted bank account number and masked account number.
•	Adds additional info: approval code, payment description, batch ID, terminal ID, trace number, etc.
Execute SQL Command:
•	Runs the SQL command using clsDatabase.EXECUTE_COMMAND_SINGLE_RESULT, which inserts the payment record and returns the new PaymentID.
Queue Payment Cost Calculation:
•	Adds the new payment to an Azure queue (AzureQueueStorage.AddToPaymentCostQueue) for further cost processing.
Return Payment ID:
•	Returns the integer ID of the newly inserted payment record.
App_code/
CloudTransactionProcessing.vb
 Public Shared Function INSERT_IC_ACH_SALE_DISCOUNT_RECORD(ByVal REQ As CTP.IC_ACH_Sale_Request, ByVal RES As CTP.IC_ACH_Sale_Response, ByVal MISC As CTP.IC_Misc_Data) As Integer
        Dim SQL As String = ""
        Dim PaymentID As Integer = 0
        Dim Biller As New clsBillers
        Biller = Biller.LoadBillerByBillerID(MISC.BillerID)
        If Convert.ToBoolean(Convert.ToInt16(Biller.BillerOptions(30).Values.BillerValue)) = True Then
            SQL = "exec insPayments "
            SQL = SQL & "@PaymentGUID='" & System.Guid.NewGuid().ToString & "'"
            SQL = SQL & ",@InvoiceID=" & MISC.InvoiceID
            SQL = SQL & ",@CustomerID=" & MISC.CustomerID
            SQL = SQL & ",@LoginID=" & MISC.LoginID
            SQL = SQL & ",@BillerID=" & MISC.BillerID
            SQL = SQL & ",@InvoiceNumber='" & clsDatabase.SqlSafe(REQ.InvoiceNumber) & "'"
            SQL = SQL & ",@CustomerName='" & clsDatabase.SqlSafe(REQ.CustomerName) & "'"
            SQL = SQL & ",@Address='" & clsDatabase.SqlSafe(REQ.CustomerAddress) & "'"
            SQL = SQL & ",@City='" & clsDatabase.SqlSafe(REQ.CustomerCity) & "'"
            SQL = SQL & ",@State='" & clsDatabase.SqlSafe(REQ.CustomerState) & "'"
            SQL = SQL & ",@Zip='" & clsDatabase.SqlSafe(REQ.CustomerZip) & "'"
            SQL = SQL & ",@EmailAddress='" & clsDatabase.SqlSafe(REQ.CustomerEmailAddress) & "'"
            SQL = SQL & ",@TransactionTypeID=1"
            SQL = SQL & ",@PaymentAmount='" & REQ.PromptPaymentDiscountAmount & "'"
            SQL = SQL & ",@PaymentTypeID=7"
            SQL = SQL & ",@PaymentDate='" & Now.ToString & "'"
            SQL = SQL & ",@PaymentReference='" & clsUtilities.GenerateReference & "'"
            SQL = SQL & ",@PaymentMessage='Prompt Payment Discount'"
            SQL = SQL & ",@PaymentDescription='Prompt Payment Discount'"
            SQL = SQL & ",@Approved=1"
            SQL = SQL & ",@CloudPortals=" & Convert.ToInt16(MISC.CloudPortals)
            SQL = SQL & ",@Offline=" & Convert.ToInt16(MISC.Offline)
            SQL = SQL & ",@PaymentSourceID=" & MISC.PaymentSourceID
            SQL = SQL & ",@RemoteIP='" & clsDatabase.SqlSafe(MISC.RemoteIP) & "'"
            SQL = SQL & ",@UserID=" & MISC.UserID
            SQL = SQL & ",@TraceNumber='" & REQ.TraceNumber & "'"
            PaymentID = Convert.ToInt32(clsDatabase.EXECUTE_COMMAND_SINGLE_RESULT(SQL, MISC.BillerID))
        End If
        Return PaymentID
    End Function
This function inserts a prompt payment discount record for an ACH sale into the database and returns the new payment ID.
Step-by-step explanation:
Check Biller Option:
•	Loads the biller by BillerID and checks if the biller allows prompt payment discounts (option 30).
If Discount Allowed:
•	Builds a SQL command to call the stored procedure insPayments with all required payment details.
•	Sets PaymentTypeID=7 to indicate a payment discount.
•	Uses the discount amount from the request (REQ.PromptPaymentDiscountAmount).
•	Includes customer, invoice, and payment metadata.
Execute SQL Command:
•	Runs the SQL command using clsDatabase.EXECUTE_COMMAND_SINGLE_RESULT, which inserts the discount record and returns the new PaymentID.
Return Payment ID:
•	Returns the integer ID of the newly inserted discount payment record (or 0 if not allowed).
BillerPortal.Business.VisualBasic
.
CloudTransactionProcessing
 Public Shared Function INSERT_IC_ACH_CHECK21_PAYMENT_RECORD(ByVal REQ As CTP.IC_ACH_Sale_Request, ByVal MISC As CTP.IC_Misc_Data, ByVal settledBatchID As Integer, ByVal paymentReference As String) As Integer
        Dim SQL As String = ""
        Dim PaymentID As Integer = 0
        ' Dim PaymentGuid As String = System.Guid.NewGuid.ToString()
        Dim ReceiptGUID As String = System.Guid.NewGuid.ToString()

        'INSERT PAYMENT RECORD
        SQL = "exec insPayments "
        SQL = SQL & "@PaymentGUID='" & REQ.PaymentGUID & "'"
        SQL = SQL & ",@InvoiceID=" & MISC.InvoiceID
        SQL = SQL & ",@CustomerID=" & MISC.CustomerID
        SQL = SQL & ",@LoginID=" & MISC.LoginID
        SQL = SQL & ",@BillerID=" & MISC.BillerID
        SQL = SQL & ",@InvoiceNumber='" & Database.SqlSafe(REQ.InvoiceNumber) & "'"
        SQL = SQL & ",@CustomerName='" & Database.SqlSafe(REQ.CustomerName) & "'"
        SQL = SQL & ",@Address='" & Database.SqlSafe(REQ.CustomerAddress) & "'"
        SQL = SQL & ",@City='" & Database.SqlSafe(REQ.CustomerCity) & "'"
        SQL = SQL & ",@State='" & Database.SqlSafe(REQ.CustomerState) & "'"
        SQL = SQL & ",@Zip='" & Database.SqlSafe(REQ.CustomerZip) & "'"
        SQL = SQL & ",@EmailAddress='" & Database.SqlSafe(REQ.CustomerEmailAddress) & "'"
        SQL = SQL & ",@PaymentAmount=" & REQ.TotalAmount
        SQL = SQL & ",@TransactionTypeID=1" 'Sale
        SQL = SQL & ",@PaymentTypeID=9" 'Check21
        SQL = SQL & ",@PaymentDate='" & Now.ToString & "'"
        SQL = SQL & ",@PaymentReference='" & paymentReference & "'"
        SQL = SQL & ",@PaymentMessage='PAYMENT PROCESSED " & Utilities.GenerateApprovalCode() & "'"
        SQL = SQL & ",@SecureAccountNumber='" & REQ.EncryptedBankAccountNumber & "'"
        'SQL = SQL & ",@SecureAccountNumber='"&  clsCryptoService.EncryptPaymentsBankAccountNumber(MISC.BillerGUID, PaymentGuid, REQ.BankAccountNumber) & "'"
        SQL = SQL & ",@PaymentDescription='Checking Account ending in " & Right(REQ.BankAccountNumber, 4) & "'"
        SQL = SQL & ",@RTE='" & Database.SqlSafe(REQ.BankRTE) & "'"
        SQL = SQL & ",@AccountNumber='" & Utilities.MaskBankAccount(REQ.BankAccountNumber) & "'"
        SQL = SQL & ",@Checking=1"
        SQL = SQL & ",@BankAccountTypeID=1"
        SQL = SQL & ",@Approved=1"
        SQL = SQL & ",@CloudPortals=" & Convert.ToInt16(MISC.CloudPortals)
        SQL = SQL & ",@Offline=" & Convert.ToInt16(MISC.Offline)
        SQL = SQL & ",@PaymentSourceID=9" ' Check21
        SQL = SQL & ",@RemoteIP='" & Database.SqlSafe(MISC.RemoteIP) & "'"
        SQL = SQL & ",@UserID=" & MISC.UserID
        SQL = SQL & ",@ReceiptGUID='" & ReceiptGUID & "'"
        SQL = SQL & ",@SettledBatchID=" & settledBatchID.ToString
        SQL = SQL & ",@RejectReference='" & REQ.RejectReference & "'"
        SQL = SQL & ",@TermID=" & REQ.TerminalID.ToString
        SQL = SQL & ",@TraceNumber='" & REQ.TraceNumber & "'"
        PaymentID = Convert.ToInt32(Database.EXECUTE_COMMAND_SINGLE_RESULT(SQL, MISC.BillerID))
        Return PaymentID
    End Function
The function INSERT_IC_ACH_CHECK21_PAYMENT_RECORD inserts a payment record into the database for an ACH (Automated Clearing House) Check21 transaction. It builds a SQL command to call the stored procedure insPayments with all relevant payment details.
Step-by-Step Breakdown
Parameters
•	REQ: Contains payment request details (customer info, bank info, etc.).
•	MISC: Contains miscellaneous data (invoice, user, etc.).
•	settledBatchID: The batch ID for settled payments.
•	paymentReference: A reference string for the payment.
Variables
•	SQL: Used to build the SQL command.
•	PaymentID: Will store the ID returned after inserting the payment.
•	ReceiptGUID: A new GUID for the payment receipt.
SQL Command Construction
•	The function builds a SQL string to execute the stored procedure insPayments.
•	It appends all required parameters, pulling values from REQ, MISC, and the function arguments.
•	Sensitive data (like account numbers) is masked or encrypted.
•	Utility functions are used for safe SQL values and formatting.
Database Execution
•	The constructed SQL command is executed using Database.EXECUTE_COMMAND_SINGLE_RESULT.
•	The result (presumably the new payment record’s ID) is stored in PaymentID.
Return Value
•	The function returns the PaymentID generated by the database.
What It Actually Does
•	Creates a payment record in the database for a Check21 transaction.
•	Passes all relevant payment and customer details to the stored procedure.
•	Returns the unique ID of the newly created payment record.
Key Points
The function is tightly coupled to the database schema and the insPayments stored procedure.
It uses string concatenation for SQL, which can be risky (SQL injection) unless all inputs are properly sanitized.
Utility and helper functions are used for data safety and formatting.
BillerPortal.Business.VisualBasic
.
CloudTransactionProcessing
Public Shared Function INSERT_IC_ACH_OBD_PAYMENT_RECORD(ByVal REQ As CTP.IC_ACH_Sale_Request, ByVal MISC As CTP.IC_Misc_Data, ByVal settledBatchID As Integer, ByVal paymentReference As String) As Integer
        Dim SQL As String = ""
        Dim PaymentID As Integer = 0
        ' Dim PaymentGuid As String = System.Guid.NewGuid.ToString()
        Dim ReceiptGUID As String = System.Guid.NewGuid.ToString()

        'INSERT PAYMENT RECORD
        SQL = "exec insPayments "
        SQL = SQL & "@PaymentGUID='" & REQ.PaymentGUID & "'"
        SQL = SQL & ",@InvoiceID=" & MISC.InvoiceID
        SQL = SQL & ",@CustomerID=" & MISC.CustomerID
        SQL = SQL & ",@LoginID=" & MISC.LoginID
        SQL = SQL & ",@BillerID=" & MISC.BillerID
        SQL = SQL & ",@InvoiceNumber='" & Database.SqlSafe(REQ.InvoiceNumber) & "'"
        SQL = SQL & ",@CustomerName='" & Database.SqlSafe(REQ.CustomerName) & "'"
        SQL = SQL & ",@Address='" & Database.SqlSafe(REQ.CustomerAddress) & "'"
        SQL = SQL & ",@City='" & Database.SqlSafe(REQ.CustomerCity) & "'"
        SQL = SQL & ",@State='" & Database.SqlSafe(REQ.CustomerState) & "'"
        SQL = SQL & ",@Zip='" & Database.SqlSafe(REQ.CustomerZip) & "'"
        SQL = SQL & ",@EmailAddress='" & Database.SqlSafe(REQ.CustomerEmailAddress) & "'"
        SQL = SQL & ",@PaymentAmount=" & REQ.TotalAmount
        SQL = SQL & ",@TransactionTypeID=1" 'Sale
        SQL = SQL & ",@PaymentTypeID=11" 'Online Bank Direct
        SQL = SQL & ",@PaymentDate='" & Now.ToString & "'"
        SQL = SQL & ",@PaymentReference='" & paymentReference & "'"
        SQL = SQL & ",@PaymentMessage='PAYMENT PROCESSED " & Utilities.GenerateApprovalCode() & "'"
        SQL = SQL & ",@SecureAccountNumber='" & REQ.EncryptedBankAccountNumber & "'"
        ' SQL = SQL & ",@SecureAccountNumber='" & clsCryptoService.EncryptPaymentsBankAccountNumber(MISC.BillerGUID, PaymentGuid, REQ.BankAccountNumber) & "'"
        SQL = SQL & ",@PaymentDescription='Checking Account ending in " & Right(REQ.BankAccountNumber, 4) & "'"
        SQL = SQL & ",@RTE='" & Database.SqlSafe(REQ.BankRTE) & "'"
        SQL = SQL & ",@AccountNumber='" & Utilities.MaskBankAccount(REQ.BankAccountNumber) & "'"
        SQL = SQL & ",@Checking=1"
        SQL = SQL & ",@BankAccountTypeID=1"
        SQL = SQL & ",@Approved=1"
        SQL = SQL & ",@CloudPortals=" & Convert.ToInt16(MISC.CloudPortals)
        SQL = SQL & ",@Offline=" & Convert.ToInt16(MISC.Offline)
        SQL = SQL & ",@PaymentSourceID=7"
        SQL = SQL & ",@RemoteIP='" & Database.SqlSafe(MISC.RemoteIP) & "'"
        SQL = SQL & ",@UserID=" & MISC.UserID
        SQL = SQL & ",@ReceiptGUID='" & ReceiptGUID & "'"
        SQL = SQL & ",@SettledBatchID=" & settledBatchID.ToString
        SQL = SQL & ",@TermID=" & REQ.TerminalID.ToString
        SQL = SQL & ",@TraceNumber='" & REQ.TraceNumber & "'"
        PaymentID = Convert.ToInt32(Database.EXECUTE_COMMAND_SINGLE_RESULT(SQL, MISC.BillerID))
        AzureQueueStorage.AddToPaymentCostQueue(MISC.BillerID, PaymentID)
        Return PaymentID
    End Function

This function inserts a payment record for an ACH Online Bank Direct (OBD) transaction into the database and then queues the payment for cost processing.
Step-by-Step Breakdown
Parameters
•	REQ: Contains payment request details (customer, bank, transaction info).
•	MISC: Contains miscellaneous data (invoice, user, biller info).
•	settledBatchID: The batch ID for settled payments.
•	paymentReference: A reference string for the payment.
Variables
•	SQL: Used to build the SQL command.
•	PaymentID: Will store the ID returned after inserting the payment.
•	ReceiptGUID: A new GUID for the payment receipt.
SQL Command Construction
•	Builds a SQL string to execute the stored procedure insPayments.
•	Appends all required parameters, pulling values from REQ, MISC, and function arguments.
•	Sensitive data (like account numbers) is masked or encrypted.
•	Utility functions are used for safe SQL values and formatting.
Database Execution
•	Executes the SQL command using Database.EXECUTE_COMMAND_SINGLE_RESULT.
•	Stores the result (the new payment record’s ID) in PaymentID.
Queue Payment for Cost Processing
•	Calls AzureQueueStorage.AddToPaymentCostQueue to add the payment to a queue for further cost processing.
Return Value
•	Returns the PaymentID generated by the database.
Summary
Inserts a payment record for an ACH Online Bank Direct transaction.
Passes all relevant payment and customer details to the stored procedure.
Queues the payment for cost processing in Azure.
Returns the unique ID of the newly created payment record.
BillerPortal.Business.VisualBasic
.
CloudTransactionProcessing
Public Shared Function INSERT_IC_ACH_SALE_DISCOUNT_RECORD(ByVal REQ As CTP.IC_ACH_Sale_Request, ByVal RES As CTP.IC_ACH_Sale_Response, ByVal MISC As CTP.IC_Misc_Data) As Integer
        Dim SQL As String = ""
        Dim PaymentID As Integer = 0
        Dim Biller As New Biller
        Biller = Biller.LoadBillerByBillerID(MISC.BillerID)
        If Convert.ToBoolean(Convert.ToInt16(Biller.BillerOptions(30).Values.BillerValue)) = True Then
            SQL = "exec insPayments "
            SQL = SQL & "@PaymentGUID='" & System.Guid.NewGuid().ToString & "'"
            SQL = SQL & ",@InvoiceID=" & MISC.InvoiceID
            SQL = SQL & ",@CustomerID=" & MISC.CustomerID
            SQL = SQL & ",@LoginID=" & MISC.LoginID
            SQL = SQL & ",@BillerID=" & MISC.BillerID
            SQL = SQL & ",@InvoiceNumber='" & Database.SqlSafe(REQ.InvoiceNumber) & "'"
            SQL = SQL & ",@CustomerName='" & Database.SqlSafe(REQ.CustomerName) & "'"
            SQL = SQL & ",@Address='" & Database.SqlSafe(REQ.CustomerAddress) & "'"
            SQL = SQL & ",@City='" & Database.SqlSafe(REQ.CustomerCity) & "'"
            SQL = SQL & ",@State='" & Database.SqlSafe(REQ.CustomerState) & "'"
            SQL = SQL & ",@Zip='" & Database.SqlSafe(REQ.CustomerZip) & "'"
            SQL = SQL & ",@EmailAddress='" & Database.SqlSafe(REQ.CustomerEmailAddress) & "'"
            SQL = SQL & ",@TransactionTypeID=1"
            SQL = SQL & ",@PaymentAmount='" & REQ.PromptPaymentDiscountAmount & "'"
            SQL = SQL & ",@PaymentTypeID=7"
            SQL = SQL & ",@PaymentDate='" & Now.ToString & "'"
            SQL = SQL & ",@PaymentReference='" & Utilities.GenerateReference & "'"
            SQL = SQL & ",@PaymentMessage='Prompt Payment Discount'"
            SQL = SQL & ",@PaymentDescription='Prompt Payment Discount'"
            SQL = SQL & ",@Approved=1"
            SQL = SQL & ",@CloudPortals=" & Convert.ToInt16(MISC.CloudPortals)
            SQL = SQL & ",@Offline=" & Convert.ToInt16(MISC.Offline)
            SQL = SQL & ",@PaymentSourceID=" & MISC.PaymentSourceID
            SQL = SQL & ",@RemoteIP='" & Database.SqlSafe(MISC.RemoteIP) & "'"
            SQL = SQL & ",@UserID=" & MISC.UserID
            SQL = SQL & ",@TraceNumber='" & REQ.TraceNumber & "'"
            PaymentID = Convert.ToInt32(Database.EXECUTE_COMMAND_SINGLE_RESULT(SQL, MISC.BillerID))
        End If
        Return PaymentID
    End Function

This function inserts a Prompt Payment Discount record into the database for an ACH sale, but only if the biller is configured to allow such discounts.
Step-by-Step Breakdown
Parameters
•	REQ: Contains ACH sale request details (customer info, discount amount, etc.).
•	RES: Contains ACH sale response details (not used in this function).
•	MISC: Contains miscellaneous data (invoice, user, biller info).
Load Biller Configuration
•	Loads the biller’s configuration using Biller.LoadBillerByBillerID(MISC.BillerID).
Check Discount Option
•	Checks if the biller’s option at index 30 (Biller.BillerOptions(30).Values.BillerValue) is enabled (i.e., set to True).
•	If not enabled, the function returns 0 (no record inserted).
Build SQL Command
•	If the discount option is enabled, builds a SQL command to execute the insPayments stored procedure.
•	Sets parameters for the payment record, including:
•	A new GUID for the payment.
•	Invoice, customer, and biller details.
•	The discount amount (REQ.PromptPaymentDiscountAmount) as the payment amount.
•	Payment type ID 7 (likely representing "Prompt Payment Discount").
•	Reference, message, and description indicating it’s a discount.
•	Other metadata (approval, portals, offline status, source, IP, user, trace number).
Execute SQL Command
•	Executes the SQL command using Database.EXECUTE_COMMAND_SINGLE_RESULT.
•	Stores the returned payment ID.
Return Value
•	Returns the payment ID if a record was inserted, or 0 if not.
Summary
Inserts a payment record for a prompt payment discount if the biller allows it.
Uses the discount amount from the request as the payment amount.
Returns the new payment record’s ID or 0 if no record was inserted.
CloudPaymentReview.aspx.vb
 Private Function InsertDebitAdjustmentRecord(ByVal amountToInsert As Double, ByVal ReceiptGUID As String, ByVal INV As clsInvoices) As String
        Dim SQL As String = String.Empty

        SQL = "insPayments "
        SQL = SQL & "@PaymentGUID='" & System.Guid.NewGuid().ToString & "'"
        SQL = SQL & ",@InvoiceID=" & INV.InvoiceID
        SQL = SQL & ",@InvoiceNumber='" & clsDatabase.SqlSafe(INV.InvoiceNumber) & "'"
        SQL = SQL & ",@CustomerID=" & INV.CustomerID
        SQL = SQL & ",@BillerID=" & INV.BillerID
        SQL = SQL & ",@PaymentAmount='" & (amountToInsert * -1) & "'"
        SQL = SQL & ",@PaymentDescription='Offline Debit Adj'"
        SQL = SQL & ",@PaymentTypeID=8"

        SQL = SQL & ",@CustomerName='" & clsDatabase.SqlSafe(CurrentSession.BillingInformation.Name) & "'"
        SQL = SQL & ",@Address='" & clsDatabase.SqlSafe(CurrentSession.BillingInformation.Address) & "'"
        SQL = SQL & ",@City='" & clsDatabase.SqlSafe(CurrentSession.BillingInformation.City) & "'"
        SQL = SQL & ",@State='" & clsDatabase.SqlSafe(CurrentSession.BillingInformation.State) & "'"
        SQL = SQL & ",@Zip='" & clsDatabase.SqlSafe(CurrentSession.BillingInformation.Zip) & "'"
        SQL = SQL & ",@EmailAddress='" & clsDatabase.SqlSafe(CurrentSession.BillingInformation.EmailAddress.Trim()) & "'"

        SQL = SQL & ",@PaymentDate='" & Now.ToString & "'"
        SQL = SQL & ",@PaymentReference=''"
        SQL = SQL & ",@PaymentMessage='Debit Adj Applied'"
        SQL = SQL & ",@Approved=1"
        SQL = SQL & ",@Offline=1"
        SQL = SQL & ",@CloudPortals=1"
        SQL = SQL & ",@BillerReference=''"
        SQL = SQL & ",@ConvenienceFee=0"
        SQL = SQL & ",@PaymentSourceID=3"
        SQL = SQL & ",@TermID=0"
        SQL = SQL & ",@ReceiptGUID='" & ReceiptGUID & "'"
        'SQL = SQL & ",@RemoteIP='" & System.Web.HttpContext.Current.Request.ServerVariables("REMOTE_ADDR") & "'"
        SQL = SQL & ",@RemoteIP='" & clsUtilities.GetRemoteIP() & "'"
        SQL = SQL & ",@UserID=" & INV.Customer.CustomerID

        Return "exec " & SQL
    End Function
This function builds a SQL command to insert a debit adjustment record for an invoice into the payments table. The adjustment is recorded as a negative payment (debit) and is marked as an offline transaction.
Step-by-Step Breakdown
Parameters
•	amountToInsert: The amount to be adjusted (will be stored as a negative value).
•	ReceiptGUID: A unique identifier for the receipt.
•	INV: An invoice object (clsInvoices) containing invoice and customer details.
SQL Command Construction
•	Starts building a SQL command for the stored procedure insPayments.
•	Sets various parameters:
•	PaymentGUID: Generates a new GUID for this payment record.
•	Invoice Details: Uses values from the INV object (InvoiceID, InvoiceNumber, CustomerID, BillerID).
•	PaymentAmount: Inserts the negative of amountToInsert (i.e., a debit).
•	PaymentDescription: Sets to 'Offline Debit Adj'.
•	PaymentTypeID: Sets to 8 (likely representing a debit adjustment).
•	Customer Details: Uses values from the current session’s billing information.
•	PaymentDate: Sets to the current date and time.
•	PaymentReference: Empty string.
•	PaymentMessage: 'Debit Adj Applied'.
•	Approved, Offline, CloudPortals: All set to 1 (true).
•	BillerReference, ConvenienceFee: Empty or zero.
•	PaymentSourceID: Set to 3 (source type for debit adjustment).
•	TermID: Set to 0.
•	ReceiptGUID: Uses the provided receipt GUID.
•	RemoteIP: Gets the remote IP address using a utility function.
•	UserID: Uses the customer’s ID from the invoice.
Return Value
•	Returns the full SQL command as a string, prefixed with "exec ".
CloudPaymentReview.aspx.vb
 Private Function InsertCreditAdjustmentRecord(ByVal amountToInsert As Double, ByVal ReceiptGUID As String, ByVal INV As clsInvoices) As String
        Dim SQL As String = String.Empty

        SQL = "insPayments "
        SQL = SQL & "@PaymentGUID='" & System.Guid.NewGuid().ToString & "'"
        SQL = SQL & ",@InvoiceID=" & INV.InvoiceID
        SQL = SQL & ",@InvoiceNumber='" & clsDatabase.SqlSafe(INV.InvoiceNumber) & "'"
        SQL = SQL & ",@CustomerID=" & INV.CustomerID
        SQL = SQL & ",@BillerID=" & INV.BillerID
        SQL = SQL & ",@PaymentAmount='" & amountToInsert & "'"
        SQL = SQL & ",@PaymentDescription='Offline Credit Adj'"
        SQL = SQL & ",@PaymentTypeID=3"

        SQL = SQL & ",@CustomerName='" & clsDatabase.SqlSafe(CurrentSession.BillingInformation.Name) & "'"
        SQL = SQL & ",@Address='" & clsDatabase.SqlSafe(CurrentSession.BillingInformation.Address) & "'"
        SQL = SQL & ",@City='" & clsDatabase.SqlSafe(CurrentSession.BillingInformation.City) & "'"
        SQL = SQL & ",@State='" & clsDatabase.SqlSafe(CurrentSession.BillingInformation.State) & "'"
        SQL = SQL & ",@Zip='" & clsDatabase.SqlSafe(CurrentSession.BillingInformation.Zip) & "'"
        SQL = SQL & ",@EmailAddress='" & clsDatabase.SqlSafe(CurrentSession.BillingInformation.EmailAddress.Trim()) & "'"

        SQL = SQL & ",@PaymentDate='" & Now.ToString & "'"
        SQL = SQL & ",@PaymentReference=''"
        SQL = SQL & ",@PaymentMessage='Credit Adj Applied'"
        SQL = SQL & ",@Approved=1"
        SQL = SQL & ",@Offline=1"
        SQL = SQL & ",@CloudPortals=1"
        SQL = SQL & ",@BillerReference=''"
        SQL = SQL & ",@ConvenienceFee=0"
        SQL = SQL & ",@PaymentSourceID=3"
        SQL = SQL & ",@TermID=0"
        SQL = SQL & ",@ReceiptGUID='" & ReceiptGUID & "'"
        'SQL = SQL & ",@RemoteIP='" & System.Web.HttpContext.Current.Request.ServerVariables("REMOTE_ADDR") & "'"
        SQL = SQL & ",@RemoteIP='" & clsUtilities.GetRemoteIP() & "'"
        SQL = SQL & ",@UserID=" & INV.Customer.CustomerID

        Return "exec " & SQL
    End Function
This function builds a SQL command to insert a credit adjustment record for an invoice into the payments table. The adjustment is recorded as a positive payment (credit) and is marked as an offline transaction.
Step-by-Step Breakdown
Parameters
•	amountToInsert: The amount to be credited (positive value).
•	ReceiptGUID: A unique identifier for the receipt.
•	INV: An invoice object (clsInvoices) containing invoice and customer details.
SQL Command Construction
•	Starts building a SQL command for the stored procedure insPayments.
•	Sets various parameters:
•	PaymentGUID: Generates a new GUID for this payment record.
•	Invoice Details: Uses values from the INV object (InvoiceID, InvoiceNumber, CustomerID, BillerID).
•	PaymentAmount: Uses the positive value of amountToInsert (i.e., a credit).
•	PaymentDescription: Sets to 'Offline Credit Adj'.
•	PaymentTypeID: Sets to 3 (likely representing a credit adjustment).
•	Customer Details: Uses values from the current session’s billing information.
•	PaymentDate: Sets to the current date and time.
•	PaymentReference: Empty string.
•	PaymentMessage: 'Credit Adj Applied'.
•	Approved, Offline, CloudPortals: All set to 1 (true).
•	BillerReference, ConvenienceFee: Empty or zero.
•	PaymentSourceID: Set to 3 (source type for credit adjustment).
•	TermID: Set to 0.
•	ReceiptGUID: Uses the provided receipt GUID.
•	RemoteIP: Gets the remote IP address using a utility function.
•	UserID: Uses the customer’s ID from the invoice.
Return Value
•	Returns the full SQL command as a string, prefixed with "exec ".
Summary
Builds a SQL command to insert a positive payment (credit adjustment) for an invoice.
Populates all required fields for the payment record, including invoice, customer, and session details.
Returns the SQL command as a string (does not execute it directly).
CloudPaymentReview.aspx.vb
 Private Function InsertPaymentDisountRecord(ByVal amountToInsert As Double, ByVal ReceiptGUID As String, ByVal INV As clsInvoices) As String
        Dim SQL As String = ""
        SQL = "insPayments "
        SQL = SQL & "@PaymentGUID='" & System.Guid.NewGuid().ToString & "'"
        SQL = SQL & ",@InvoiceID=" & INV.InvoiceID
        SQL = SQL & ",@CustomerID=" & INV.CustomerID
        SQL = SQL & ",@BillerID=" & INV.BillerID
        SQL = SQL & ",@InvoiceNumber='" & clsDatabase.SqlSafe(INV.InvoiceNumber) & "'"

        SQL = SQL & ",@CustomerName='" & clsDatabase.SqlSafe(CurrentSession.BillingInformation.Name) & "'"
        SQL = SQL & ",@Address='" & clsDatabase.SqlSafe(CurrentSession.BillingInformation.Address) & "'"
        SQL = SQL & ",@City='" & clsDatabase.SqlSafe(CurrentSession.BillingInformation.City) & "'"
        SQL = SQL & ",@State='" & clsDatabase.SqlSafe(CurrentSession.BillingInformation.State) & "'"
        SQL = SQL & ",@Zip='" & clsDatabase.SqlSafe(CurrentSession.BillingInformation.Zip) & "'"
        SQL = SQL & ",@EmailAddress='" & clsDatabase.SqlSafe(CurrentSession.BillingInformation.EmailAddress.Trim()) & "'"

        SQL = SQL & ",@TransactionTypeID=1"
        SQL = SQL & ",@PaymentAmount='" & amountToInsert & "'"
        SQL = SQL & ",@PaymentTypeID=7"
        SQL = SQL & ",@PaymentDate='" & Now.ToString & "'"
        SQL = SQL & ",@PaymentReference='" & clsUtilities.GenerateReference & "'"
        SQL = SQL & ",@PaymentMessage='Prompt Payment Discount'"
        SQL = SQL & ",@PaymentDescription='Prompt Payment Discount'"
        SQL = SQL & ",@Approved=1"
        SQL = SQL & ",@CloudPortals=1"
        SQL = SQL & ",@Offline=1"
        SQL = SQL & ",@PaymentSourceID=3"
        'SQL = SQL & ",@RemoteIP='" & System.Web.HttpContext.Current.Request.ServerVariables("REMOTE_ADDR") & "'"
        SQL = SQL & ",@RemoteIP='" & clsUtilities.GetRemoteIP() & "'"
        SQL = SQL & ",@UserID=" & INV.Customer.CustomerID

        Return "exec " & SQL
    End Function

This function builds a SQL command string to insert a payment record representing a "Prompt Payment Discount" for a specific invoice. The record is intended to be stored in the payments table via the insPayments stored procedure.
Step-by-Step Breakdown
Parameters
•	amountToInsert: The discount amount to be recorded.
•	ReceiptGUID: A unique identifier for the receipt (not used in this function).
•	INV: An invoice object (clsInvoices) containing invoice and customer details.
SQL Command Construction
•	Begins with the stored procedure name: insPayments.
•	Appends parameters for the payment record:
•	PaymentGUID: Generates a new GUID for this payment.
•	Invoice Details: Uses values from the INV object (InvoiceID, CustomerID, BillerID, InvoiceNumber).
•	Customer Details: Uses values from the current session’s billing information (Name, Address, City, State, Zip, Email).
•	TransactionTypeID: Set to 1 (likely indicates a sale or payment).
•	PaymentAmount: The discount amount provided.
•	PaymentTypeID: Set to 7 (likely represents a discount type).
•	PaymentDate: Current date and time.
•	PaymentReference: Generated using a utility function.
•	PaymentMessage/Description: Both set to 'Prompt Payment Discount'.
•	Approved, CloudPortals, Offline: All set to 1 (true).
•	PaymentSourceID: Set to 3 (source type for discount).
•	RemoteIP: Gets the remote IP address using a utility function.
•	UserID: Uses the customer’s ID from the invoice.
Return Value
•	Returns the full SQL command as a string, prefixed with "exec ".
Summary
Builds a SQL command to insert a payment record for a prompt payment discount.
Populates all required fields for the payment record, including invoice, customer, and session details.
Returns the SQL command as a string (does not execute it directly).
MYIIS
PayEase.vb
https://dev.azure.com/invoicecloud/Src/_git/MyIIS?path=/MyIIS/App_Code/PayEase.vb&version=GBrelease&_a=contents&line=1475&lineStyle=plain&lineEnd=1683&lineStartColumn=3&lineEndColumn=1
The CASH_Sale function processes a cash payment for an invoice, typically from a kiosk or similar device. It validates the partner, biller, invoice, and customer, records the payment in the database, updates the invoice balance, and returns a response indicating the result.
Step-by-Step Breakdown
Start Logging and Timer
•	Begins timing the operation and prepares log data for debugging and audit purposes.
Partner Authentication
•	Checks if the provided PartnerGUID and PartnerKey are valid using ValidPartner.
•	If invalid, returns a response indicating authentication failure.
Biller Validation
•	Loads the biller using the BillerGUID from the request.
•	If the biller is not found, returns a response indicating biller authentication failure.
System Availability Check
•	Checks if payments are available for the biller (e.g., not in maintenance mode).
•	If unavailable, returns a response indicating system maintenance.
Duplicate Payment Check (Trace Number)
•	If a trace number is provided, searches for a previous payment with the same trace number.
•	If found, returns the details of the previous payment to prevent duplicate processing.
Invoice Validation
•	Loads the invoice using the InvoiceGUID and biller ID.
•	If the invoice is not found, returns a response indicating invoice not found.
Customer Validation
•	Loads the customer using the customer ID from the invoice.
•	If the customer is not found, returns a response indicating customer not found.
Payment Record Insertion
•	Builds a SQL command to insert the payment record into the database (insPayments stored procedure).
•	Includes all relevant details: payment GUID, invoice/customer/biller info, payment amount, description, type, date, reference, message, convenience fee, source, remote IP, etc.
•	Executes the SQL command and retrieves the new payment ID.
Update Invoice Balance
•	If the payment was successfully inserted, recalculates the invoice balance by executing another stored procedure (spRecalculateBalance).
Prepare and Return Response
•	Sets the response fields (ApprovalIndicator, Code, Message, PaymentGUID) based on the outcome.
•	Logs the operation and writes debug information to a file.
•	Returns the response object.
Error Handling
•	If any exception occurs, logs the error, sets the response to indicate an unknown error, and returns it.
Summary
Validates all entities (partner, biller, invoice, customer).
Prevents duplicate payments using trace number logic.
Inserts a cash payment record into the database.
Updates the invoice balance after payment.
Returns a detailed response indicating success or the reason for failure.
Logs all steps and errors for auditing and troubleshooting.
MYIIS
PayEase.vb
https://dev.azure.com/invoicecloud/Src/_git/MyIIS?path=/MyIIS/App_Code/PayEase.vb&version=GBrelease&_a=contents&line=3210&lineStyle=plain&lineEnd=3389&lineStartColumn=4&lineEndColumn=17
This function processes multiple cash payments for a list of invoices in a single request, typically from a kiosk or similar device. It validates the partner and biller, processes each invoice, records payments in the database, updates invoice balances, and returns a response for each invoice.
Step-by-Step Breakdown
Start Logging and Timer
•	Begins timing the operation and prepares log data for debugging and audit purposes.
Partner Authentication
•	Checks if the provided PartnerGUID and PartnerKey are valid.
•	If invalid, returns a response list with a single failure response.
Biller Validation
•	Loads the biller using the BillerGUID from the request.
•	If the biller is not found, returns a response list with a single failure response.
System Availability Check
•	Checks if payments are available for the biller (e.g., not in maintenance mode).
•	If unavailable, returns a response list with a single failure response.
Process Each Invoice
•	Iterates through each invoice in the InvoiceList.
•	For each invoice:
•	Loads the invoice using its GUID and the biller ID.
•	If the invoice is not found, adds a failure response for that invoice.
•	Loads the customer using the customer ID from the invoice.
•	If the customer is not found, adds a failure response for that invoice.
•	If both are found:
•	Generates unique payment identifiers and codes.
•	Builds a SQL command to insert the payment record into the database (insPayments stored procedure).
•	Executes the SQL command and retrieves the new payment ID.
•	If successful, adds a success response for that invoice.
•	Updates the invoice balance by executing another stored procedure (spRecalculateBalance).
•	If not successful, adds a response indicating the payment was not processed.
Error Handling
•	If any exception occurs, adds a failure response to the list and logs the error.
Logging
•	Logs all steps and errors for auditing and troubleshooting.
•	Writes debug information to a file.
Return Value
•	Returns a list of CASH_Sale_Response objects, one for each invoice processed, indicating success or the reason for failure.
Summary
Validates the partner and biller.
Processes each invoice in the list:
Validates invoice and customer.
Inserts a cash payment record for each invoice.
Updates invoice balance.
Returns a response for each invoice.
Handles errors and logs all operations.
Returns a list of responses indicating the result for each invoice.
MYIIS
BillerManualPmt.aspx.vb
https://dev.azure.com/invoicecloud/Src/_git/MyIIS?path=/BillerPortal/BillerManualPmt.aspx.vb&version=GBrelease&_a=contents&line=97&lineStyle=plain&lineEnd=200&lineStartColumn=1&lineEndColumn=12
This function is triggered when the user clicks the "Update" button on a payment form. It validates the form, constructs a SQL command to insert a payment record, updates the invoice balance, optionally sends a receipt, and then redirects the user.
Step-by-Step Breakdown
Form Validation
•	Calls ValidateForm() to ensure all required fields are filled and valid.
•	If validation fails, the function exits.
Session Data Retrieval
•	Retrieves the current biller, customer, and invoice objects from the session.
Payment Amount Handling
•	Gets the payment amount from the form.
•	If the payment type is "debit adjustment" (type 8), the amount is made negative.
SQL Command Construction
•	Builds a SQL command to execute the insPayments stored procedure.
•	Sets all relevant parameters:
•	Payment GUID, invoice/customer/biller info, payment amount, payment type, description, transaction type, customer details, payment date, reference, message, approval status, offline flag, portals, biller reference, convenience fee, payment source, remote IP, and user ID.
•	The payment description and transaction type are set based on the selected payment type.
Execute Payment Insert
•	Executes the SQL command to insert the payment record.
•	Retrieves the new payment ID.
Update Invoice Balance
•	Executes another SQL command to recalculate the invoice balance after payment.
Send Receipt (Optional)
•	If the "Send Receipt" checkbox is checked, adds the payment to the receipt queue for email confirmation.
Error Handling
•	If an exception occurs, displays an error message on the form.
Redirect
•	After successful processing, redirects the user to the invoice search page.
Summary
Validates the payment form.
Inserts a payment record into the database.
Updates the invoice balance.
Optionally sends a receipt to the customer.
Redirects the user to the invoice search page.
Handles errors and displays them on the form.
MYIIS
Payment.vb
https://dev.azure.com/invoicecloud/Src/_git/MyIIS?path=/IC.Common/Models/Payments/Payment.vb&version=GBrelease&_a=contents&line=50&lineStyle=plain&lineEnd=108&lineStartColumn=4&lineEndColumn=1
This function inserts a payment record into the database by building a SQL command for the insPayments stored procedure, using the current object's properties and any additional parameters.
Step-by-Step Breakdown
Validation
•	Calls Validate(). If validation fails, returns -1 (no payment inserted).
SQL Command Construction
•	Initializes a list to hold SQL parameter strings.
•	Adds all relevant payment, customer, and transaction details to the list, using the object's properties.
•	Uses clsDatabase.SqlSafe to sanitize string values for SQL safety.
•	Adds only non-empty or non-zero optional parameters (e.g., RejectReference, ReceiptGUID, CardHash, Files_PaymentsID, etc.).
•	Calls AdditionalSqlParameters(list) to allow for further customization or extension of the parameter list.
Database Execution
•	Joins all parameters into a single SQL command string for the insPayments stored procedure.
•	Executes the command using clsDatabase.EXECUTE_COMMAND_SINGLE_RESULT, passing the biller ID for context.
•	Converts the result to an integer, which is typically the new payment record’s ID.
Return Value
•	Returns the payment ID generated by the database.
Summary
Validates the payment data.
Builds a SQL command with all necessary and optional parameters for the payment.
Executes the command to insert the payment record.
Returns the new payment ID or -1 if validation fails.
MYIIS
CloudCashProcessing.vb
https://dev.azure.com/invoicecloud/Src/_git/MyIIS?path=/MyIIS/App_Code/CloudCashProcessing.vb&version=GBrelease&_a=contents&line=61&lineStyle=plain&lineEnd=283&lineStartColumn=4&lineEndColumn=1
The Cash_Sale function processes a cash payment for an invoice. It validates the request, authenticates the biller, creates an invoice if needed, records the payment, updates the invoice balance, and returns a response indicating the result.
Step-by-Step Explanation
Input Validation
•	Checks if the BillerGUID and WebServiceKey in the request are valid GUIDs.
•	If not, returns a response with an error code and message.
Biller Authentication
•	Authenticates the biller using the provided GUID and key.
•	If authentication fails, returns a response with an error code and message.
•	If payments are unavailable (e.g., system maintenance), returns a response indicating this.
Log Web Method Call
•	Logs the web method call for auditing.
Amount and Invoice Type Validation
•	Validates the total payment amount.
•	Checks if the invoice type ID is valid for the biller.
Invoice Creation
•	If the invoice does not already exist, creates a new invoice record in the database.
•	If invoice creation fails, returns a response with an error code and message.
Payment Record Insertion
•	Loads the invoice object.
•	Builds a SQL command to insert the payment record (insPayments stored procedure).
•	Sets all relevant payment and customer details.
•	Executes the SQL command and retrieves the new payment ID.
•	If successful, updates the invoice balance by recalculating it in the database.
Response Preparation
•	Sets the response fields (ApprovalIndicator, Code, Message, PaymentGUID) based on the outcome.
•	If payment posting fails, returns a response with an error code and message.
Error Handling
•	Catches exceptions and returns a response with a generic error code and message.
Return
•	Returns a Cash_Sale_Response object with the result of the operation.
Summary
Exposed as a web service method for external integration.
Validates and authenticates the request and biller.
Creates an invoice if needed.
Posts a cash payment to the database.
Updates the invoice balance.
Returns a detailed response indicating success or failure.
MYIIS
OnlineBankDirectReversal.aspx.vb
Check21Reversal.aspx.vb
ReturnOnlineBankDirectEntry.aspx.vb
https://dev.azure.com/invoicecloud/Src/_git/MyIIS?path=/BillerPortal/Dialogs/OnlineBankDirectReversal.aspx.vb&version=GBrelease&_a=contents&line=154&lineStyle=plain&lineEnd=192&lineStartColumn=5&lineEndColumn=17
https://dev.azure.com/invoicecloud/Src/_git/MyIIS?path=/BillerPortal/Dialogs/Check21Reversal.aspx.vb&version=GBrelease&_a=contents&line=97&lineStyle=plain&lineEnd=135&lineStartColumn=4&lineEndColumn=17
https://dev.azure.com/invoicecloud/Src/_git/MyIIS?path=/BillerPortal/Dialogs/ReturnOnlineBankDirectEntry.aspx.vb&version=GBrelease&_a=contents&line=122&lineStyle=plain&lineEnd=160&lineStartColumn=4&lineEndColumn=17
This function builds and returns a SQL command string to insert a debit adjustment payment record for a specific invoice and customer. The adjustment is recorded as a negative payment (debit) and is marked as an offline transaction.
Step-by-Step Breakdown
Fetch Invoice and Customer Data
•	Executes two SQL queries:
•	selInvoices to get invoice details for the given releventInvoiceID.
•	selCustomers to get customer details for the given releventCustomerID.
•	Stores the results in a DataSet with two tables: "invoice" and "customer".
Build SQL Command
•	Constructs a SQL command for the insPayments stored procedure.
•	Sets parameters using data from the fetched invoice and customer records:
•	PaymentGUID: Generates a new GUID for this payment.
•	Invoice and Customer Details: Uses values from the dataset.
•	PaymentAmount: Inserts the negative of amountToInsert (i.e., a debit adjustment).
•	PaymentDescription: 'Offline Debit Adj'.
•	PaymentTypeID: 8 (likely represents a debit adjustment).
•	Other Metadata: Payment date, reference, message, approval status, offline flag, portals, source, term, receipt GUID, remote IP, and user ID.
Return Value
•	Returns the full SQL command as a string, prefixed with "exec " and suffixed with a semicolon.
Summary
Fetches invoice and customer details from the database.
Builds a SQL command to insert a negative payment (debit adjustment) for the invoice.
Returns the SQL command as a string (does not execute it directly).
CTP
SaleProcessor.vb
        Private Function GetInsPaymentConfiguration(billerId As Integer, integerParameters As List(Of IIntegerParameter),
                                                   stringParameters As List(Of IStringParameter),
                                                   decimalParameters As List(Of IDecimalParameter)) As AdvancedConfiguration
            Dim config As New AdvancedConfiguration With {
                                .ApplicationName = "CTP",
                                .BillerID = billerId,
                                .CommandType = DatabaseCommandType.StoredProcedure,
                                .Database = DatabaseName.DBLive,
                                .IntegerParameters = integerParameters,
                                .StringParameters = stringParameters,
                                .DecimalParameters = decimalParameters,
                                .CommandText = "insPayments"
                            }
            Return config
        End Function
Reference methods that are using this configuration to insert payments:
ref:GetInsPaymentConfiguration - Search Code - Search
 INSERT_IC_ACH_SALE_PAYMENT_RECORD(ByVal ReceiptGUID As String, ByVal REQ As IC_ACH_Sale_Request, ByVal RES As IC_ACH_Sale_Response, ByVal MISC As IC_Misc_Data) As Integer
 INSERT_IC_ACH_DEBIT_ADJUSTMENT_RECORD(ByVal ReceiptGUID As String, ByVal REQ As IC_ACH_Sale_Request, ByVal RES As IC_ACH_Sale_Response, ByVal MISC As IC_Misc_Data) As Integer
 INSERT_IC_CNP_DEBIT_ADJUSTMENT_RECORD(ByVal ReceiptGUID As String, ByVal REQ As IC_CNP_Sale_Request, ByVal RES As IC_CNP_Sale_Response, ByVal MISC As IC_Misc_Data) As Integer

This function creates and returns an AdvancedConfiguration object that is set up to execute the insPayments stored procedure in the database, using the provided biller ID and lists of parameters.
Step-by-Step Breakdown
Parameters
•	billerId: The ID of the biller for whom the payment configuration is being created.
•	integerParameters: A list of integer-type parameters to be passed to the stored procedure.
•	stringParameters: A list of string-type parameters to be passed to the stored procedure.
•	decimalParameters: A list of decimal-type parameters to be passed to the stored procedure.
Configuration Object Creation
•	Instantiates a new AdvancedConfiguration object.
•	Sets its properties:
•	ApplicationName: "CTP" (the application context).
•	BillerID: The provided biller ID.
•	CommandType: Set to StoredProcedure (indicates a database stored procedure will be executed).
•	Database: Set to DBLive (the live/production database).
•	IntegerParameters: The provided list of integer parameters.
•	StringParameters: The provided list of string parameters.
•	DecimalParameters: The provided list of decimal parameters.
•	CommandText: "insPayments" (the name of the stored procedure to execute).
Return Value
•	Returns the fully configured AdvancedConfiguration object.
CTP
SaleProcessor.vb
        Private Function InsPaymentsAch(ByVal currentRequestItem As IC_ACH_Sale_Request, ByVal currentMiscItem As IC_Misc_Data, ByVal convenienceMasterReq As IC_ACH_Sale_Request, ByVal response As IC_ACH_Sale_Response, ByVal receiptGuid As String, ByVal accountDetails As (MaskedAccountNumber As String, BankRTE As String, EncryptedBankAccount As String, PaymentDescription As String, BankAccountTypeID As Integer, IsChecking As Boolean), ByRef advConfig As AdvancedConfiguration) As Integer

            Dim integerParameters As New List(Of IIntegerParameter) From {
                New IntegerParameter With {.Name = "@InvoiceID", .Value = currentMiscItem.InvoiceID},
                New IntegerParameter With {.Name = "@CustomerID", .Value = currentMiscItem.CustomerID},
                New IntegerParameter With {.Name = "@LoginID", .Value = currentMiscItem.LoginID},
                New IntegerParameter With {.Name = "@BillerID", .Value = currentMiscItem.BillerID},
                New IntegerParameter With {.Name = "@BankAccountTypeID", .Value = accountDetails.BankAccountTypeID},
                New IntegerParameter With {.Name = "@Checking", .Value = Convert.ToInt32(accountDetails.IsChecking)},
                New IntegerParameter With {.Name = "@TransactionTypeID", .Value = 1},
                New IntegerParameter With {.Name = "@Approved", .Value = Convert.ToInt32(response.ApprovalIndicator)},
                New IntegerParameter With {.Name = "@CloudPortals", .Value = Convert.ToInt32(currentMiscItem.CloudPortals)},
                New IntegerParameter With {.Name = "@Offline", .Value = Convert.ToInt32(currentMiscItem.Offline)},
                New IntegerParameter With {.Name = "@PaymentSourceID", .Value = currentMiscItem.PaymentSourceID},
                New IntegerParameter With {.Name = "@UserID", .Value = currentMiscItem.UserID},
                New IntegerParameter With {.Name = "@TermID", .Value = convenienceMasterReq.TerminalID},
                New IntegerParameter With {.Name = "@Paperless", .Value = Convert.ToInt32(clsCustomers.GetPaperlessValueInPaymentContext(currentMiscItem.CustomerID, currentRequestItem.InvoiceTypeID, currentMiscItem.BillerID, currentMiscItem.PaymentSourceID))},
                New IntegerParameter With {.Name = "@PaymentMethodOriginId", .Value = currentRequestItem.PaymentMethodOriginId}
            }

            If currentRequestItem.EasyPay Then
                integerParameters.Add(New IntegerParameter With {.Name = "@PaymentTypeID", .Value = 4}) 'EasyPay/EFT
            Else
                integerParameters.Add(New IntegerParameter With {.Name = "@PaymentTypeID", .Value = 2}) 'EFT
            End If

            If clsUtilities.IsFeatureOn(IC.PlatformFeatures.Models.Features.PlatformFeatureType.SeparateInsPaymentsDatapump, currentMiscItem.BillerID) AndAlso convenienceMasterReq.PreventDataPumpInsert Then
                integerParameters.Add(New IntegerParameter With {.Name = "@InsertToDataPump", .Value = 0})
            End If

            Dim stringParameters As New List(Of IStringParameter) From {
                New StringParameter With {.Name = "PaymentGUID", .Value = currentRequestItem.PaymentGUID.ToString()},
                New StringParameter With {.Name = "InvoiceNumber", .Value = currentRequestItem.InvoiceNumber},
                New StringParameter With {.Name = "CustomerName", .Value = currentRequestItem.CustomerName},
                New StringParameter With {.Name = "Address", .Value = currentRequestItem.CustomerAddress},
                New StringParameter With {.Name = "City", .Value = currentRequestItem.CustomerCity},
                New StringParameter With {.Name = "State", .Value = currentRequestItem.CustomerState},
                New StringParameter With {.Name = "Zip", .Value = currentRequestItem.CustomerZip},
                New StringParameter With {.Name = "EmailAddress", .Value = If(String.IsNullOrEmpty(currentRequestItem.CustomerEmailAddress), Nothing, currentRequestItem.CustomerEmailAddress)},
                New StringParameter With {.Name = "PaymentAmount", .Value = currentRequestItem.ConvenienceFeeAmount.ToString()},
                New StringParameter With {.Name = "PaymentDescription", .Value = accountDetails.PaymentDescription},
                New StringParameter With {.Name = "PaymentDate", .Value = Now.ToString()},
                New StringParameter With {.Name = "PaymentMessage", .Value = response.Message.Replace("'", "")},
                New StringParameter With {.Name = "SecureAccountNumber", .Value = accountDetails.EncryptedBankAccount},
                New StringParameter With {.Name = "RTE", .Value = accountDetails.BankRTE},
                New StringParameter With {.Name = "AccountNumber", .Value = accountDetails.MaskedAccountNumber},
                New StringParameter With {.Name = "CheckNumber", .Value = If(String.IsNullOrEmpty(currentRequestItem.CheckNumber), String.Empty, currentRequestItem.CheckNumber)},
                New StringParameter With {.Name = "BillerReference", .Value = If(String.IsNullOrEmpty(currentMiscItem.BillerReference), String.Empty, currentMiscItem.BillerReference)},
                New StringParameter With {.Name = "ConvenienceFee", .Value = currentRequestItem.ConvenienceFeeAmount.ToString()}, '
                New StringParameter With {.Name = "RemoteIP", .Value = If(String.IsNullOrEmpty(currentMiscItem.RemoteIP), String.Empty, currentMiscItem.RemoteIP)},
                New StringParameter With {.Name = "PaymentIndex", .Value = If(String.IsNullOrEmpty(response.PaymentIndex), String.Empty, response.PaymentIndex)},
                New StringParameter With {.Name = "ReceiptGUID", .Value = receiptGuid},
                New StringParameter With {.Name = "PaymentReference", .Value = response.UniqueIdentifier},
                New StringParameter With {.Name = "RejectReference", .Value = If(String.IsNullOrEmpty(convenienceMasterReq.RejectReference), String.Empty, convenienceMasterReq.RejectReference)},
                New StringParameter With {.Name = "TraceNumber", .Value = If(String.IsNullOrEmpty(convenienceMasterReq.TraceNumber), String.Empty, convenienceMasterReq.TraceNumber)}
            }

            With advConfig
                .ApplicationName = "CTP"
                .BillerID = currentMiscItem.BillerID
                .CommandType = DatabaseCommandType.StoredProcedure
                .Database = DatabaseName.DBLive
                .IntegerParameters = integerParameters
                .StringParameters = stringParameters
                .CommandText = "insPayments"
            End With

            Return Convert.ToInt32(clsDatabase.EXECUTE_COMMAND_SINGLE_RESULT_ADVANCED(advConfig))
        End Function
This function inserts an ACH (Automated Clearing House) payment record into the database by preparing all necessary parameters and executing the insPayments stored procedure using an advanced configuration object.
Step-by-Step Breakdown
Parameter Preparation
•	Integer Parameters:
Collects various integer values (IDs, flags, types) from the request, miscellaneous data, and account details.
•	Includes invoice, customer, biller, account type, transaction type, approval status, and more.
•	Sets payment type based on whether the payment is EasyPay or regular EFT.
•	Optionally adds a flag to control data pump insertion if certain features are enabled.
•	String Parameters:
Collects string values (names, addresses, payment details, references) from the request, miscellaneous data, response, and account details.
•	Includes GUIDs, invoice numbers, customer info, payment amounts, descriptions, dates, messages, encrypted account numbers, and more.
Advanced Configuration Setup
•	Populates the advConfig object with:
•	Application name (CTP)
•	Biller ID
•	Command type (stored procedure)
•	Database name (DBLive)
•	All prepared integer and string parameters
•	The command text (insPayments), which is the name of the stored procedure to execute
Database Execution
•	Calls clsDatabase.EXECUTE_COMMAND_SINGLE_RESULT_ADVANCED(advConfig) to execute the stored procedure with all the provided parameters.
•	Converts the result to an integer, which is typically the new payment record’s ID.
Return Value
•	Returns the payment record ID generated by the database.
Summary
Prepares all required data for an ACH payment record.
Configures and executes the insPayments stored procedure using an advanced configuration object.
Returns the unique ID of the newly inserted payment record.
CTP
SaleProcessor.vb
 Private Function InsPaymentsCreditCard(ByVal currentRequestItem As IC_CNP_Sale_Request, ByVal currentMiscItem As IC_Misc_Data, ByVal convenienceMasterReq As IC_CNP_Sale_Request, ByVal response As IC_CNP_Sale_Response, ByVal receiptGuid As String, ByRef advConfig As AdvancedConfiguration) As Integer

            Dim cardDetails = DetermineMaskedCardDetailsCreditCard(convenienceMasterReq, currentRequestItem)

            Dim integerParameters As New List(Of IIntegerParameter) From {
                New IntegerParameter With {.Name = "@InvoiceID", .Value = currentMiscItem.InvoiceID},
                New IntegerParameter With {.Name = "@CustomerID", .Value = currentMiscItem.CustomerID},
                New IntegerParameter With {.Name = "@LoginID", .Value = currentMiscItem.LoginID},
                New IntegerParameter With {.Name = "@BillerID", .Value = currentMiscItem.BillerID},
                New IntegerParameter With {.Name = "@TransactionTypeID", .Value = 1}, 'Sale
                New IntegerParameter With {.Name = "@PaymentTypeID", .Value = 1}, 'Credit Card
                New IntegerParameter With {.Name = "@Approved", .Value = Convert.ToInt16(response.ApprovalIndicator)},
                New IntegerParameter With {.Name = "@CloudPortals", .Value = Convert.ToInt16(currentMiscItem.CloudPortals)},
                New IntegerParameter With {.Name = "@Offline", .Value = Convert.ToInt16(currentMiscItem.Offline)},
                New IntegerParameter With {.Name = "@PaymentSourceID", .Value = currentMiscItem.PaymentSourceID},
                New IntegerParameter With {.Name = "@UserID", .Value = currentMiscItem.UserID},
                New IntegerParameter With {.Name = "@TermID", .Value = convenienceMasterReq.TerminalID},
                New IntegerParameter With {.Name = "@Paperless", .Value = Convert.ToInt16(clsCustomers.GetPaperlessValueInPaymentContext(currentMiscItem.CustomerID, currentRequestItem.InvoiceTypeID, currentMiscItem.BillerID, currentMiscItem.PaymentSourceID))},
                New IntegerParameter With {.Name = "@PinlessDebit", .Value = Convert.ToInt16(response.PinlessDebit)},
                New IntegerParameter With {.Name = "@PaymentMethodOriginId", .Value = currentRequestItem.PaymentMethodOriginId},
                New IntegerParameter With {.Name = "@ExpMonth", .Value = currentRequestItem.CardExpMonth},
                New IntegerParameter With {.Name = "@ExpYear", .Value = currentRequestItem.CardExpYear}
            }

            If clsUtilities.IsFeatureOn(IC.PlatformFeatures.Models.Features.PlatformFeatureType.SeparateInsPaymentsDatapump, currentMiscItem.BillerID) AndAlso convenienceMasterReq.PreventDataPumpInsert Then
                integerParameters.Add(New IntegerParameter With {.Name = "@InsertToDataPump", .Value = 0})
            End If

            Dim stringParameters As New List(Of IStringParameter) From {
                New StringParameter With {.Name = "PaymentGUID", .Value = currentRequestItem.PaymentGUID.ToString()},
                New StringParameter With {.Name = "InvoiceNumber", .Value = clsDatabase.SqlSafe(currentRequestItem.InvoiceNumber)},
                New StringParameter With {.Name = "CustomerName", .Value = clsDatabase.SqlSafe(currentRequestItem.CustomerName)},
                New StringParameter With {.Name = "Address", .Value = clsDatabase.SqlSafe(currentRequestItem.CustomerAddress)},
                New StringParameter With {.Name = "City", .Value = clsDatabase.SqlSafe(currentRequestItem.CustomerCity)},
                New StringParameter With {.Name = "State", .Value = clsDatabase.SqlSafe(currentRequestItem.CustomerState)},
                New StringParameter With {.Name = "Zip", .Value = clsDatabase.SqlSafe(currentRequestItem.CustomerZip)},
                New StringParameter With {.Name = "EmailAddress", .Value = clsDatabase.SqlSafe(currentRequestItem.CustomerEmailAddress)},
                New StringParameter With {.Name = "PaymentAmount", .Value = currentRequestItem.ConvenienceFeeAmount.ToString()},
                New StringParameter With {.Name = "PaymentDescription", .Value = "Credit Card ending in " & cardDetails.CardLastFour},
                New StringParameter With {.Name = "PaymentDate", .Value = Now.ToString()},
                New StringParameter With {.Name = "PaymentReference", .Value = response.UniqueIdentifier},
                New StringParameter With {.Name = "PaymentMessage", .Value = response.Message.Replace("'", "''")}, ' SQL Encode Message
                New StringParameter With {.Name = "SecureCardnumber", .Value = currentRequestItem.EncryptedCreditCard},
                New StringParameter With {.Name = "Cardnumber", .Value = cardDetails.MaskedCardNumber},
                New StringParameter With {.Name = "AVSCode", .Value = response.AVSCode},
                New StringParameter With {.Name = "CVVCode", .Value = response.CVVCode},
                New StringParameter With {.Name = "BillerReference", .Value = clsDatabase.SqlSafe(currentMiscItem.BillerReference)},
                New StringParameter With {.Name = "ConvenienceFee", .Value = currentRequestItem.ConvenienceFeeAmount.ToString()},
                New StringParameter With {.Name = "RemoteIP", .Value = clsDatabase.SqlSafe(currentMiscItem.RemoteIP)},
                New StringParameter With {.Name = "PaymentIndex", .Value = response.PaymentIndex},
                New StringParameter With {.Name = "ReceiptGUID", .Value = receiptGuid},
                New StringParameter With {.Name = "RejectReference", .Value = clsDatabase.SqlSafe(convenienceMasterReq.RejectReference)},
                New StringParameter With {.Name = "TraceNumber", .Value = convenienceMasterReq.TraceNumber}
            }

            With advConfig
                .ApplicationName = "CTP"
                .BillerID = currentMiscItem.BillerID
                .CommandType = DatabaseCommandType.StoredProcedure
                .Database = DatabaseName.DBLive
                .IntegerParameters = integerParameters
                .StringParameters = stringParameters
                .CommandText = "insPayments"
            End With

            Return Convert.ToInt32(clsDatabase.EXECUTE_COMMAND_SINGLE_RESULT_ADVANCED(advConfig))
        End Function
This function inserts a credit card payment record into the database by preparing all necessary parameters and executing the insPayments stored procedure using an advanced configuration object.
Step-by-Step Breakdown
Card Details Preparation
•	Calls DetermineMaskedCardDetailsCreditCard to get masked card info (e.g., last four digits, masked number) for the payment description and security.
Integer Parameters
•	Collects various integer values (IDs, flags, types) from the request, miscellaneous data, and card details.
•	Includes invoice, customer, biller, transaction type, payment type, approval status, portal flags, payment source, user, terminal, paperless status, pinless debit, payment method origin, and card expiration month/year.
•	Optionally adds a flag to control data pump insertion if certain features are enabled.
String Parameters
•	Collects string values (names, addresses, payment details, references) from the request, miscellaneous data, response, and card details.
•	Includes GUIDs, invoice numbers, customer info, payment amounts, descriptions, dates, messages, encrypted card numbers, masked card numbers, AVS/CVV codes, references, convenience fee, remote IP, payment index, receipt GUID, reject reference, and trace number.
Advanced Configuration Setup
•	Populates the advConfig object with:
•	Application name (CTP)
•	Biller ID
•	Command type (stored procedure)
•	Database name (DBLive)
•	All prepared integer and string parameters
•	The command text (insPayments), which is the name of the stored procedure to execute
Database Execution
•	Calls clsDatabase.EXECUTE_COMMAND_SINGLE_RESULT_ADVANCED(advConfig) to execute the stored procedure with all the provided parameters.
•	Converts the result to an integer, which is typically the new payment record’s ID.
Return Value
•	Returns the payment record ID generated by the database.
Summary
Prepares all required data for a credit card payment record.
Configures and executes the insPayments stored procedure using an advanced configuration object.
Returns the unique ID of the newly inserted payment record.
CTP
BluefinEmv.vb
 ''' <summary>
    ''' Inserts a payment record that was processed via EMV transaction
    ''' This can be in the form of a sale, convenience fee sale or credit
    ''' </summary>
    ''' <param name="emvPayment"></param>
    ''' <returns>PaymentID as integer</returns>
    Public Function InsertPaymentRecord(emvPayment As BluefinEmvPayment) As Integer
        Dim PaymentID As Integer = 0

        Dim integerParameters As New List(Of IIntegerParameter)
        Dim stringParameters As New List(Of IStringParameter)
        Dim decimalParameters As New List(Of IDecimalParameter)

        stringParameters.Add(New StringParameter With {.Name = "@PaymentGUID", .Value = emvPayment.PaymentGUID.ToString})
        integerParameters.Add(New IntegerParameter With {.Name = "@InvoiceID", .Value = emvPayment.InvoiceID})
        integerParameters.Add(New IntegerParameter With {.Name = "@CustomerID", .Value = emvPayment.CustomerID})
        integerParameters.Add(New IntegerParameter With {.Name = "@LoginID", .Value = emvPayment.LoginID})
        integerParameters.Add(New IntegerParameter With {.Name = "@BillerID", .Value = emvPayment.BillerID})
        stringParameters.Add(New StringParameter With {.Name = "@InvoiceNumber", .Value = clsDatabase.SqlSafe(emvPayment.InvoiceNumber)})

        'Customer Information
        stringParameters.Add(New StringParameter With {.Name = "@EmailAddress", .Value = clsDatabase.SqlSafe(emvPayment.EmailAddress)})
        stringParameters.Add(New StringParameter With {.Name = "@CustomerName", .Value = clsDatabase.SqlSafe(emvPayment.CustomerName)})
        stringParameters.Add(New StringParameter With {.Name = "@Address", .Value = clsDatabase.SqlSafe(emvPayment.Address)})
        stringParameters.Add(New StringParameter With {.Name = "@City", .Value = clsDatabase.SqlSafe(emvPayment.City)})
        stringParameters.Add(New StringParameter With {.Name = "@State", .Value = clsDatabase.SqlSafe(emvPayment.State)})
        stringParameters.Add(New StringParameter With {.Name = "@Zip", .Value = clsDatabase.SqlSafe(emvPayment.Zip)})

        'Payment Information
        integerParameters.Add(New IntegerParameter With {.Name = "@TransactionTypeID", .Value = emvPayment.TransactionTypeID})
        decimalParameters.Add(New DecimalParameter With {.Name = "@PaymentAmount", .Value = If(emvPayment.TransactionTypeID = TransactionType.Credit, (emvPayment.TotalAmount * -1), emvPayment.TotalAmount)})
        integerParameters.Add(New IntegerParameter With {.Name = "@PaymentTypeID", .Value = emvPayment.PaymentTypeID})
        stringParameters.Add(New StringParameter With {.Name = "@PaymentDate", .Value = Now.ToString})
        stringParameters.Add(New StringParameter With {.Name = "@PaymentMessage", .Value = clsDatabase.SqlSafe(emvPayment.PaymentMessage)})
        stringParameters.Add(New StringParameter With {.Name = "@PaymentDescription", .Value = clsDatabase.SqlSafe(emvPayment.PaymentDescription)})
        stringParameters.Add(New StringParameter With {.Name = "@Cardnumber", .Value = emvPayment.MaskedCardNumber})
        integerParameters.Add(New IntegerParameter With {.Name = "@ExpMonth", .Value = emvPayment.ExpirationMonth})
        integerParameters.Add(New IntegerParameter With {.Name = "@ExpYear", .Value = emvPayment.ExpirationYear})
        integerParameters.Add(New IntegerParameter With {.Name = "@Approved", .Value = Convert.ToInt16(emvPayment.Approved)})
        integerParameters.Add(New IntegerParameter With {.Name = "@CloudPortals", .Value = Convert.ToInt16(emvPayment.CloudPortals)})
        integerParameters.Add(New IntegerParameter With {.Name = "@Offline", .Value = Convert.ToInt16(emvPayment.Offline)})
        integerParameters.Add(New IntegerParameter With {.Name = "@PaymentSourceID", .Value = emvPayment.PaymentSourceID})
        stringParameters.Add(New StringParameter With {.Name = "@RemoteIP", .Value = clsDatabase.SqlSafe(emvPayment.RemoteIP)})
        stringParameters.Add(New StringParameter With {.Name = "@PaymentIndex", .Value = emvPayment.PaymentIndex})
        integerParameters.Add(New IntegerParameter With {.Name = "@UserID", .Value = emvPayment.UserID})
        stringParameters.Add(New StringParameter With {.Name = "@TraceNumber", .Value = emvPayment.TraceNumber})
        stringParameters.Add(New StringParameter With {.Name = "@ReceiptGUID", .Value = emvPayment.ReceiptGUID.ToString})
        integerParameters.Add(New IntegerParameter With {.Name = "@CreditPaymentID", .Value = emvPayment.CreditPaymentID})
        integerParameters.Add(New IntegerParameter With {.Name = "@TermID", .Value = emvPayment.TerminalID})
        integerParameters.Add(New IntegerParameter With {.Name = "@PaymentMethodOriginId", .Value = emvPayment.PaymentMethodOriginID})
        stringParameters.Add(New StringParameter With {.Name = "@RejectReference", .Value = clsDatabase.SqlSafe(emvPayment.RejectReference)})

        If emvPayment.ConvenienceFee > 0 Then
            decimalParameters.Add(New DecimalParameter With {.Name = "@ConvenienceFee", .Value = emvPayment.ConvenienceFee})
        End If

        If Not String.IsNullOrWhiteSpace(emvPayment.PaymentReference) Then
            stringParameters.Add(New StringParameter With {.Name = "@PaymentReference", .Value = clsDatabase.SqlSafe(emvPayment.PaymentReference)})
        End If

        If Not String.IsNullOrWhiteSpace(emvPayment.BillerReference) Then
            stringParameters.Add(New StringParameter With {.Name = "@BillerReference", .Value = clsDatabase.SqlSafe(emvPayment.BillerReference)})
        End If

        Dim config As New AdvancedConfiguration With {
            .ApplicationName = "CTP",
            .BillerID = emvPayment.BillerID,
            .CommandType = DatabaseCommandType.StoredProcedure,
            .Database = DatabaseName.DBLive,
            .IntegerParameters = integerParameters,
            .StringParameters = stringParameters,
            .DecimalParameters = decimalParameters,
            .CommandText = "insPayments"
        }

        Try
            Dim ds As DataTable = clsDatabase.GET_DATASET_ADVANCED(config).Tables(0)
            'Dim ds = clsDatabase.GET_DATASET_ADVANCED(config)
            If ds IsNot Nothing AndAlso ds.Rows.Count > 0 AndAlso ds.Rows(0)("PaymentsID") IsNot DBNull.Value Then
                PaymentID = ds.Rows(0).Item("PaymentsID")
            Else
                Serilog.Log.Error("InsertPaymentRecord: GET_DATASET_ADVANCED returned null or incomplete dataset. BillerId: {BillerId}, PaymentReference: {PaymentReference}, InvoiceNumber: {InvoiceNumber}, TerminalId: {TerminalId}, PaymentMethodOrigin: {PaymentMethodOriginID}",
                                  emvPayment.BillerID,
                                  emvPayment.PaymentReference,
                                  emvPayment.InvoiceNumber,
                                  emvPayment.TerminalID,
                                  emvPayment.PaymentMethodOriginID)
            End If
        Catch ex As Exception
            Serilog.Log.Error(ex, "Failed in InsertPaymentRecord(). Triggered by {Event}. BillerId: {BillerId}. PaymentReference: {PaymentReference}. InvoiceNumber: {InvoiceNumber}. TerminalId: {TerminalId}.PaymentMethodOrigin:{PaymentMethodOriginID}.",
                                            NameOf(InsertPaymentRecord),
                                            emvPayment.BillerID,
                                            emvPayment.PaymentReference,
                                            emvPayment.InvoiceNumber,
                                            emvPayment.TerminalID,
                                            emvPayment.PaymentMethodOriginID)
        End Try

        Return PaymentID

    End Function

This function inserts a payment record for an EMV (chip card) transaction into the database. It handles sales, convenience fee sales, and credits, and returns the new payment record’s ID.
Step-by-Step Breakdown
Parameter Collection
•	Accepts a BluefinEmvPayment object containing all relevant payment, customer, and transaction details.
Builds Parameter Lists
•	Integer Parameters: Includes IDs (invoice, customer, biller, etc.), transaction type, payment type, approval status, and other numeric flags.
•	String Parameters: Includes GUIDs, invoice number, customer info, payment details, card info, references, and more.
•	Decimal Parameters: Includes payment amount (negative for credits), and convenience fee if present.
Advanced Configuration
•	Creates an AdvancedConfiguration object, specifying:
•	Application name (CTP)
•	Biller ID
•	Command type (stored procedure)
•	Database name (DBLive)
•	All prepared parameters
•	The command text (insPayments), which is the stored procedure to execute
Database Execution
•	Calls clsDatabase.GET_DATASET_ADVANCED(config) to execute the stored procedure with all parameters.
•	Checks the returned dataset for a valid payment record ID (PaymentsID).
Error Handling
•	If the dataset is missing or incomplete, logs an error with details.
•	If an exception occurs, logs the exception and relevant payment details.
Return Value
•	Returns the payment record ID if successful, or 0 if not.
Summary
Prepares all required data for an EMV payment record.
Executes the insPayments stored procedure to insert the payment into the database.
Handles errors and logs issues if the operation fails.
Returns the unique ID of the newly inserted payment record.
CTP
clsPayments.vb
https://dev.azure.com/invoicecloud/Src/_git/CTP?path=/CloudTransactionProcessingSOAP/Models/clsPayments.vb&version=GBmain&_a=contents&line=233&lineStyle=plain&lineEnd=321&lineStartColumn=5&lineEndColumn=1
This function inserts a payment record for an ACH transaction that failed validation into the database. It collects all relevant payment, customer, and transaction details, marks the payment as not approved, and logs the operation.
Step-by-Step Breakdown
Parameter Preparation
•	Accepts details about the payment, customer, bank account, and miscellaneous transaction context.
•	Masks the bank account number for security and description.
Builds Parameter Lists
•	Integer Parameters: Includes IDs (invoice, customer, biller, etc.), transaction type, payment type, approval status (set to 0 for failed validation), and other numeric flags.
•	String Parameters: Includes GUIDs, invoice number, customer info, payment details, masked/encrypted account numbers, references, trace number, and payment description.
•	Decimal Parameters: Includes the payment amount.
Bank Account Type Handling
•	Sets the payment description and checking flag based on the bank account type (personal checking, savings, or commercial).
Advanced Configuration
•	Creates an AdvancedConfiguration object, specifying:
•	Application name (CTP)
•	Biller ID
•	Command type (stored procedure)
•	Database name (DBLive)
•	All prepared parameters
•	The command text (insPayments), which is the stored procedure to execute
Database Execution
•	Executes the stored procedure using clsDatabase.EXECUTE_COMMAND_SINGLE_RESULT_ADVANCED(advConfig).
•	Converts the result to an integer, which is typically the new payment record’s ID.
Logging
•	Logs the result of the operation (success or error) using Serilog for auditing and troubleshooting.
Error Handling
•	If any exception occurs, logs the error and rethrows it.
Return Value
•	Returns the payment record ID generated by the database.
Summary
Prepares all required data for a failed ACH payment record.
Configures and executes the insPayments stored procedure using an advanced configuration object.
Marks the payment as not approved (failed validation).
Logs the operation for auditing and troubleshooting.
Returns the unique ID of the newly inserted payment record.
CTP
clsPayments.vb
https://dev.azure.com/invoicecloud/Src/_git/CTP?path=/CloudTransactionProcessingSOAP/Models/clsPayments.vb&version=GBmain&_a=contents&line=322&lineStyle=plain&lineEnd=395&lineStartColumn=4&lineEndColumn=17
This function inserts a payment record for a credit card transaction that failed validation into the database. It collects all relevant payment, customer, and transaction details, marks the payment as not approved, and returns the new payment record’s ID.
Step-by-Step Breakdown
Parameter Preparation
•	Accepts details about the payment, customer, card, and miscellaneous transaction context.
•	Computes a hash of the card number for security/auditing.
Builds Parameter Lists
•	Integer Parameters: Includes IDs (invoice, customer, biller, etc.), transaction type, payment type (set to 1 for credit card), approval status (0 for failed validation), and other numeric flags.
•	String Parameters: Includes GUIDs, invoice number, customer info, payment details, masked/encrypted card numbers, expiration, trace number, references, and card hash.
•	Decimal Parameters: Includes the payment amount.
Advanced Configuration
•	Creates an AdvancedConfiguration object, specifying:
•	Application name (CTP)
•	Biller ID
•	Command type (stored procedure)
•	Database name (DBLive)
•	All prepared parameters
•	The command text (insPayments), which is the stored procedure to execute
Database Execution
•	Executes the stored procedure using clsDatabase.EXECUTE_COMMAND_SINGLE_RESULT_ADVANCED(advConfig).
•	Converts the result to an integer, which is typically the new payment record’s ID.
Error Handling
•	If any exception occurs, logs the error and rethrows it.
Return Value
•	Returns the payment record ID generated by the database.
Summary
Prepares all required data for a failed credit card payment record.
Configures and executes the insPayments stored procedure using an advanced configuration object.
Marks the payment as not approved (failed validation).
Returns the unique ID of the newly inserted payment record.
CTP
CreditProcessor.vb
https://dev.azure.com/invoicecloud/Src/_git/CTP?path=/CloudTransactionProcessingSOAP/Services/Processors/Implementations/CreditProcessor.vb&version=GBmain&_a=contents&line=862&lineStyle=plain&lineEnd=976&lineStartColumn=8&lineEndColumn=21
This function inserts an ACH credit payment record into the database. It prepares all necessary payment, customer, and bank account details, executes the database operation, and updates the response object with the results.
Step-by-Step Breakdown
Bank Account Data Selection
•	If the request (REQ) contains NOC (Notification of Change) data, it uses the original bank account details from NOC.
•	Otherwise, it uses the standard bank account details from the request.
Bank Account Masking and Description
•	Masks the bank account number for security and display.
•	Sets the payment description and checking flag based on the BankAccountTypeID (commercial checking, savings, or personal checking).
Parameter Preparation
•	Integer Parameters: Includes invoice, customer, biller, account type, checking flag, transaction type, approval status, portal flags, user, terminal, payment source, credit payment ID, payment type, and method origin.
•	String Parameters: Includes GUIDs, invoice number, customer info, payment amount (as a negative value for credit), payment description, date, reference, message, encrypted account number, masked account number, biller reference, remote IP, payment index, receipt GUID, reject reference, trace number, and bank RTE.
Configuration Object
•	Creates an AdvancedConfiguration object with all parameters, specifying the stored procedure (insPayments) to execute.
Database Execution
•	Executes the stored procedure using clsDatabase.EXECUTE_COMMAND_SINGLE_RESULT_ADVANCED(config).
•	Retrieves the new payment record’s ID.
Response Update
•	Updates the response object (RES) with the payment GUID, payment ID, and receipt GUID.
Error Handling
•	Logs any errors and rethrows exceptions for further handling.
Return Value
•	Returns the payment record ID generated by the database.
Summary
Prepares all required data for an ACH credit payment.
Executes the database operation to insert the payment record.
Updates the response object with identifiers for tracking.
Returns the new payment ID for further processing.
CTP
CreditProcessor.vb
https://dev.azure.com/invoicecloud/Src/_git/CTP?path=/CloudTransactionProcessingSOAP/Services/Processors/Implementations/CreditProcessor.vb&version=GBmain&_a=contents&line=1203&lineStyle=plain&lineEnd=1280&lineStartColumn=8&lineEndColumn=21
This function inserts a credit card payment record for a credit transaction into the database. It prepares all necessary payment, customer, and card details, executes the database operation, and updates the response object with the results.
Step-by-Step Breakdown
Receipt GUID Generation
•	Creates a new unique identifier (ReceiptGUID) for the payment receipt.
Parameter Preparation
•	Integer Parameters:
Includes invoice, customer, biller, transaction type (set to 6 for credit), approval status, portal flags, user, terminal, payment source, credit payment ID, payment type (set to 1 for credit card), payment method origin, and pinless debit flag.
•	String Parameters:
Includes GUIDs, invoice number, customer info, payment amount (as a negative value for credit), payment description (last 4 digits of card), date, reference, message, encrypted card number, masked card number, expiration, AVS/CVV codes, biller reference, remote IP, payment index, receipt GUID, reject reference, and trace number.
Configuration Object
•	Creates an AdvancedConfiguration object with all parameters, specifying the stored procedure (insPayments) to execute.
Database Execution
•	Executes the stored procedure using clsDatabase.EXECUTE_COMMAND_SINGLE_RESULT_ADVANCED(config).
•	Retrieves the new payment record’s ID.
Response Update
•	Updates the response object (RES) with the payment GUID, payment ID, and receipt GUID.
Error Handling
•	Logs any errors and rethrows exceptions for further handling.
Return Value
•	Returns the payment record ID generated by the database.
CTP
Payment.vb
https://dev.azure.com/invoicecloud/Src/_git/CTP?path=/CloudTransactionProcessingSOAP/Models/Payments/Payment.vb&version=GBmain&_a=contents&line=53&lineStyle=plain&lineEnd=157&lineStartColumn=4&lineEndColumn=17
This function inserts a payment record into the database using the insPayments stored procedure. It collects all relevant payment, customer, and transaction details, validates the data, and returns the new payment record’s ID.
Step-by-Step Breakdown
Validation
•	Calls Validate(). If validation fails, returns -1 (no payment inserted).
Parameter Preparation
•	Creates lists for integer, string, and decimal parameters.
•	Adds all required payment, customer, and transaction details to these lists.
•	Uses clsDatabase.SqlSafe to sanitize string values for SQL safety.
•	Adds optional parameters only if they are present or greater than zero (e.g., RejectReference, BillerReference, ReceiptGUID, CardHash, Files_PaymentsID, CreditPaymentID, ConvenienceFee, etc.).
Configuration Object
•	Creates an AdvancedConfiguration object with all parameters, specifying:
•	Application name (CTP)
•	Biller ID
•	Command type (stored procedure)
•	Database name (DBLive)
•	All prepared parameters
•	The command text (insPayments), which is the stored procedure to execute
Database Execution
•	Executes the stored procedure using clsDatabase.EXECUTE_COMMAND_SINGLE_RESULT_ADVANCED(advConfig).
•	Converts the result to an integer, which is typically the new payment record’s ID.
Logging
•	Logs the result of the operation (success or error) using Serilog for auditing and troubleshooting.
Return Value
•	Returns the payment record ID generated by the database.
MC_RPPS
ImportRppsFile.vb
https://dev.azure.com/invoicecloud/Src/_git/MC_RPPS?path=/MC_RPPS/ImportRppsFile.vb&version=GBmain&_a=contents&line=819&lineStyle=plain&lineEnd=867&lineStartColumn=5&lineEndColumn=17
This function inserts a payment record for an ACH Online Bank Direct (OBD) transaction into the database, queues the payment for cost processing, recalculates the invoice balance, and returns the new payment record’s ID.
Step-by-Step Breakdown
Parameter Preparation
•	Accepts payment request (REQ), miscellaneous data (MISC), batch ID, and payment reference.
•	Generates new GUIDs for the payment and receipt.
SQL Command Construction
•	Builds a SQL command to execute the insPayments stored procedure.
•	Sets all relevant parameters:
•	Payment GUID, invoice/customer/biller info, payment amount, payment type (OBD), payment date, reference, message, encrypted account number, payment description, routing number, masked account number, checking flag, account type, approval status, portal flags, offline flag, payment source, remote IP, user ID, receipt GUID, settled batch ID, terminal ID.
Database Execution
•	Executes the SQL command to insert the payment record.
•	Retrieves the new payment ID.
Queue Payment for Cost Processing
•	Adds the payment to the cost processing queue using clsAzureQueueStorage.AddToPaymentCostQueue.
Recalculate Invoice Balance
•	Executes a command to recalculate the invoice balance after payment.
Logging
•	Logs the balance recalculation event for auditing.
Return Value
•	Returns the payment ID generated by the database.
MC_RPPS
ImportRppsFile.vb
https://dev.azure.com/invoicecloud/Src/_git/MC_RPPS?path=/MC_RPPS/ImportRppsFile.vb&version=GBmain&_a=contents&line=868&lineStyle=plain&lineEnd=919&lineStartColumn=4&lineEndColumn=17
This function inserts a debit adjustment payment record into the database for an invoice, typically representing a negative adjustment (such as a refund or correction). It also queues the payment for cost processing and recalculates the invoice balance.
Step-by-Step Breakdown
SQL Command Construction
•	Builds a SQL command to execute the insPayments stored procedure.
•	Sets all relevant parameters using properties from the debit object:
•	Payment GUID, invoice/customer/biller info, payment amount, transaction and payment type, payment date, reference, message, description, routing number, masked account number, checking flag, account type, approval status, portal flags, biller reference, convenience fee, offline flag, payment source, remote IP, user ID, receipt GUID, settled batch ID, and terminal ID.
•	The terminal ID is set to 0 if isOnCassSystem is True, otherwise it uses the value from debit.TermID.
Database Execution
•	Executes the SQL command to insert the debit adjustment record.
•	Retrieves the new payment ID.
Logging
•	Prints the SQL command and timestamp to the console for debugging.
Queue Payment for Cost Processing
•	Adds the payment to the cost processing queue using clsAzureQueueStorage.AddToPaymentCostQueue.
Recalculate Invoice Balance
•	Executes a command to recalculate the invoice balance after the adjustment.
Audit Logging
•	Logs the balance recalculation event using Serilog.
Return Value
•	Returns the payment ID generated by the database.
MC_RPPS
RPPSMatcher.vb
https://dev.azure.com/invoicecloud/Src/_git/MC_RPPS?path=/MC_RPPS/RPPSMatcher.vb&version=GBmain&_a=contents&line=671&lineStyle=plain&lineEnd=717&lineStartColumn=4&lineEndColumn=1
This function inserts a payment record for a prompt payment discount into the database for an ACH sale, but only if the biller is configured to allow such discounts (option 30 enabled). It also recalculates the invoice balance after the discount is applied.
Step-by-Step Breakdown
Get Biller Options
•	Retrieves biller options from the database for the given biller ID.
•	Checks if option 30 (applyPromptPayForRealTimePayments) is enabled for the biller.
Conditional Discount Application
•	If option 30 is enabled:
•	Builds a SQL command to execute the insPayments stored procedure.
•	Sets all relevant parameters:
•	Payment GUID, invoice/customer/biller info, prompt payment discount amount, payment type (discount), payment date, reference, message, description, approval status, portal flags, offline flag, payment source, remote IP, and user ID.
•	Executes the SQL command to insert the payment record.
•	Retrieves the new payment ID.
Recalculate Invoice Balance
•	Executes a command to recalculate the invoice balance after the discount is applied.
Logging
•	Logs the balance recalculation event for auditing.
Return Value
•	Returns the payment ID generated by the database (or 0 if the discount was not applied).
DemoPortals
clsInsuranceStage.cs
clsUtilityStage.cs
clsTaxBase.cs
c#
 private void InsertBalanceForwardPayment(string AccountNumber, Int32 CustomerID, Int32 InvoiceID, string InvoiceNumber, double Amount, DateTime PaymentDate)
        {
            Console.WriteLine(DateTime.Now.ToString() + " : InsertBalanceForwardPayment");
            clsDatabase db = new clsDatabase();
            string Sql = "";

            DataTable dt = GetCustomer(AccountNumber);

            Sql = "insPayments ";
            Sql += "@BillerID=" + pBillerID.ToString();
            Sql += ",@CustomerID=" + CustomerID.ToString();
            Sql += ",@InvoiceID=" + InvoiceID.ToString();
            Sql += ",@InvoiceNumber='" + InvoiceNumber + "'";
            Sql += ",@CustomerName='" + dt.Rows[0]["CustomerName"] + "'";
            Sql += ",@Address='" + dt.Rows[0]["Address1"] + "'";
            Sql += ",@City='" + dt.Rows[0]["City"] + "'";
            Sql += ",@State='" + dt.Rows[0]["State"] + "'";
            Sql += ",@Zip='" + dt.Rows[0]["Zip"] + "'";
            Sql += ",@PaymentAmount=" + Amount.ToString(); ;
            Sql += ",@PaymentDescription='Balance Forward'";
            Sql += ",@TransactionTypeID=0";
            Sql += ",@PaymentTypeID=10";
            Sql += ",@PaymentDate='" + PaymentDate.ToShortDateString() + "'";
            Sql += ",@PaymentMessage='New Invoice - Balance Forward'";
            Sql += ",@Approved=1";
            Sql += ",@CloudPortals=1";
            Sql += ",@Offline=0";
            db.ExecuteSql(Sql, pBillerID);


        }

This function inserts a payment record for a "Balance Forward" transaction into the database. It is typically used to record an opening balance or carry-forward amount for a customer’s invoice.
Step-by-Step Breakdown
Logging
•	Writes a timestamped message to the console indicating the start of the operation.
Customer Data Retrieval
•	Calls GetCustomer(AccountNumber) to fetch customer details (name, address, city, state, zip) from the database.
SQL Command Construction
•	Builds a SQL command string for the insPayments stored procedure.
•	Sets all relevant parameters:
•	BillerID: The biller’s ID.
•	CustomerID: The customer’s ID.
•	InvoiceID: The invoice’s ID.
•	InvoiceNumber: The invoice number.
•	Customer Details: Name, address, city, state, zip (from the customer data table).
•	PaymentAmount: The amount to be recorded.
•	PaymentDescription: Set to 'Balance Forward'.
•	TransactionTypeID: Set to 0 (likely indicates a balance forward transaction).
•	PaymentTypeID: Set to 10 (likely a code for balance forward).
•	PaymentDate: The date of the payment.
•	PaymentMessage: Set to 'New Invoice - Balance Forward'.
•	Approved: Set to 1 (approved).
•	CloudPortals: Set to 1.
•	Offline: Set to 0.
Database Execution
•	Executes the SQL command using db.ExecuteSql(Sql, pBillerID) to insert the payment record into the database.
Summary
Fetches customer details using the account number.
Builds and executes a SQL command to insert a "Balance Forward" payment record for the specified invoice and customer.
Records the payment as approved and online.
No return value; the function performs the database operation and logs the action.
DemoPortals
clsInsuranceStage.cs
clsUtilityStage.cs
clsTaxBase.cs
https://dev.azure.com/invoicecloud/Src/_git/DemoPortals?path=/DemoPortals/clsInsuranceStage.cs&version=GBmain&_a=contents&line=852&lineStyle=plain&lineEnd=1025&lineStartColumn=8&lineEndColumn=10
CreateOBDPayment
•	Purpose: Inserts an Online Bank Direct (OBD) payment for a specific account and invoice.
•	How it works:
•	Retrieves customer details using the account number.
•	Gets the customer ID and invoice ID.
•	Calls InsertPayment to insert the payment record with type 11 (OBD) and source 7.
•	Returns the new payment ID.
CreateCustomer
•	Purpose: Inserts a new customer record into the database.
•	How it works:
•	Builds a SQL command for the insCustomers stored procedure with the provided customer details.
•	Executes the SQL to insert the customer.
•	Calls InsertPolicy to associate a policy with the new customer.
GetCustomerID
•	Purpose: Retrieves the customer ID for a given account number.
•	How it works:
•	Calls GetCustomer to fetch customer details.
•	Returns the customer ID from the first row of the result.
GetCustomer
•	Purpose: Fetches customer details for a given account number.
•	How it works:
•	Builds and executes a SQL query (selCustomers) to get customer data.
•	Returns the result as a DataTable.
GetInvoiceID
•	Purpose: Retrieves the invoice ID for a given customer and invoice number.
•	How it works:
•	Builds and executes a SQL query (selInvoices) to get invoice data.
•	Returns the invoice ID from the first row of the result.
InsertInvoice
•	Purpose: Inserts a new invoice and related payment records, optionally including balance forward, credit card, and ACH payments.
•	How it works:
•	Fetches customer details.
•	Builds and executes a SQL command to insert the invoice (insInvoices).
•	Inserts invoice details (insInvoiceDetail).
•	Randomly determines payment source and service fees.
•	If BalanceForward is true, inserts a balance forward payment.
•	If RandomCCPayment is true, inserts a credit card payment with calculated service fee.
•	If RandomACHPayment is true, inserts an ACH payment with calculated service fee.
AutoPaymentProcessing 
clsUtilities.vb
Private Shared Function InsertFakePayment(ByVal autoPayPayment As AutoPayPaymentDetail) As Boolean
        Dim params As New List(Of String)
        params.Add("@InvoiceID=" & autoPayPayment.InvoiceID)
        params.Add("@CustomerID=" & autoPayPayment.CustomerID)
        params.Add("@BillerID=" & autoPayPayment.BillerID)
        params.Add("@InvoiceNumber='" & autoPayPayment.InvoiceNumber & "'")
        params.Add("@TransactionTypeID=1")
        params.Add("@PaymentAmount='" & autoPayPayment.BalanceDue & "'")
        params.Add("@PaymentTypeID=" & autoPayPayment.PaymentTypeID)
        params.Add("@PaymentDate='" & Now.ToCST().ToString & "'")
        params.Add("@PaymentReference='" & GenerateReference() & "'")
        params.Add("@PaymentMessage='NO DEFAULT PAYMENT METHOD'")
        params.Add("@Approved=0")
        params.Add("@CloudPortals=0")
        params.Add("@Offline=0")
        params.Add("@PaymentSourceID=15")
        params.Add("@RemoteIP='127.0.0.1'")
        params.Add("@UserID=0")

        Try
            Dim insPaymentsSql As String = "insPayments " & String.Join(",", params.ToArray())
            Database.ExecuteCommandNonQuery(insPaymentsSql, autoPayPayment.BillerID)
            Return True
        Catch ex As Exception
            Serilog.Log.Error(ex, $"BillerID: {Module1.BillerID} - InvoiceID: {autoPayPayment.InvoiceID}")
            Return False
        End Try
    End Function
This function inserts a "fake" or placeholder payment record into the database for an invoice, typically used when there is no default payment method available for an AutoPay operation.
Step-by-Step Breakdown
Parameter Preparation
•	Collects all necessary payment and invoice details from the autoPayPayment object.
•	Sets specific values:
•	TransactionTypeID=1 (likely indicates a sale/payment).
•	PaymentMessage='NO DEFAULT PAYMENT METHOD' (marks this as a placeholder).
•	Approved=0 (not approved).
•	CloudPortals=0, Offline=0 (flags for system context).
•	PaymentSourceID=15 (source type for AutoPay/fake payment).
•	RemoteIP='127.0.0.1' (local IP, not a real transaction).
•	UserID=0 (system user).
SQL Command Construction
•	Builds a SQL command string for the insPayments stored procedure, joining all parameters.
Database Execution
•	Executes the SQL command using Database.ExecuteCommandNonQuery.
•	If successful, returns True.
Error Handling
•	If an exception occurs, logs the error with Serilog and returns False.
Summary
Inserts a placeholder payment record for an invoice when no default payment method is available.
Marks the payment as not approved and sets a specific message.
Returns True if successful, False if there is an error.
Logs errors for troubleshooting.
CloudConnectWS
CloudConnect.asmx.vb
https://dev.azure.com/invoicecloud/Src/_git/CloudConnectWS?path=/CloudConnectWS/CloudConnect.asmx.vb&version=GBmain&_a=contents&line=492&lineStyle=plain&lineEnd=564&lineStartColumn=4&lineEndColumn=17
This function creates an offline payment record for a credit card EMV transaction. It does not process the transaction itself, but logs the payment details in the database because the actual transaction is handled externally (by Bridgepay).
Step-by-Step Breakdown
Web Service Exposure
•	The function is marked with <WebMethod()>, making it a SOAP web service endpoint.
Biller Validation
•	Loads the biller using the provided BillerGUID and WebServiceKey.
•	If the biller cannot be loaded, logs an error and returns a response indicating failure.
SQL Command Construction
•	Builds a SQL command for the insPayments stored procedure.
•	Sets all relevant parameters using the request (REQ) data:
•	Payment GUID, biller ID, invoice/customer info (set to 0 for offline), payment amount, description (last 4 digits of card), transaction type, payment type (credit card), payment date, reference, message, masked card number, expiration, AVS/CVV codes, approval status, convenience fee, payment source, remote IP, and other metadata.
•	Marks the payment as offline (@Offline=1), since the transaction is processed by Bridgepay.
Database Execution
•	Executes the SQL command to insert the payment record into the database.
Response Preparation
•	Returns a CC_EMV_Response object with the payment GUID and a success indicator.
Summary
Does not process the transaction itself; only logs it as an offline record.
Inserts a payment record for the EMV transaction in the database.
Returns a response with the payment GUID and success status.
Logs errors if the biller cannot be loaded.
ICFramework.Business.Data
PaymentRecord.cs
c#
/// <summary>
        /// Converts PaymentRecord to an insert sql string for use against database
        /// </summary>
        public string ToInsertSql()
        {
            List<string> parameters = new List<string>();
            string sql;

            // stored procedure
            sql = "exec insPayments ";

            // parameters
            parameters.Add("@PaymentGUID='" + this.PaymentGUID + "'");
            parameters.Add("@InvoiceID=" + this.InvoiceID.ToString());
            parameters.Add("@InvoiceNumber='" + this.InvoiceNumber + "'");
            parameters.Add("@CustomerID=" + this.CustomerID.ToString());
            parameters.Add("@BillerID=" + this.BillerID.ToString());
            parameters.Add("@PaymentAmount='" + this.PaymentAmount.ToString() + "'");
            parameters.Add("@PaymentDescription='" + this.PaymentDescription + "'");
            parameters.Add("@PaymentTypeID=" + this.PaymentTypeID.ToString());
            parameters.Add("@CustomerName='" + this.CustomerName + "'");
            parameters.Add("@Address='" + this.CustomerAddress + "'");
            parameters.Add("@City='" + this.CustomerCity + "'");
            parameters.Add("@State='" + this.CustomerState + "'");
            parameters.Add("@Zip='" + this.CustomerZip + "'");
            parameters.Add("@PaymentDate='" + this.PaymentDate + "'");
            parameters.Add("@PaymentReference='" + this.PaymentReference + "'");
            parameters.Add("@PaymentMessage='" + this.PaymentMessage + "'");
            parameters.Add("@Approved=" + Convert.ToInt16(this.Approved).ToString());
            parameters.Add("@Offline=" + Convert.ToInt16(this.Offline).ToString());
            parameters.Add("@CloudPortals=" + Convert.ToInt16(this.CloudPortals).ToString());
            parameters.Add("@BillerReference='" + this.BillerReference + "'");
            parameters.Add("@ConvenienceFee=" + this.ConvenienceFee.ToString());
            parameters.Add("@PaymentSourceID=" + this.PaymentSourceID.ToString());
            parameters.Add("@TermID=" + this.TermID.ToString());
            parameters.Add("@ReceiptGUID='" + this.ReceiptGUID + "'");
            parameters.Add("@RemoteIP='" + this.RemoteIP + "'");
            parameters.Add("@UserID=" + this.UserID);

            return sql + string.Join(",", parameters.ToArray()) + ";";
        }
This method generates a SQL command string to insert a payment record into the database using the insPayments stored procedure. It converts the properties of a PaymentRecord object into SQL parameters.
Step-by-Step Breakdown
Initialize SQL Command
•	Starts with the stored procedure call: exec insPayments.
Build Parameter List
•	Adds each property of the PaymentRecord object as a parameter to the SQL command.
•	Includes payment GUID, invoice/customer/biller info, payment amount, description, type, customer details, payment date, reference, message, approval status, flags, convenience fee, source, term, receipt GUID, remote IP, and user ID.
Format SQL String
•	Joins all parameters into a single comma-separated string.
•	Appends the parameters to the stored procedure call.
Return Value
•	Returns the complete SQL command string, ready to be executed against the database.
ICKioskAPI
Database.Transaction.vb
https://dev.azure.com/invoicecloud/Src/_git/ICKioskAPI?path=/ICKioskAPI/Models/Repository/Database.Transaction.vb&version=GBmain&_a=contents&line=6&lineStyle=plain&lineEnd=99&lineStartColumn=4&lineEndColumn=17
This function processes a cash payment for an invoice (typically from a kiosk), inserts the payment record into the database, updates the invoice balance, sends receipts, and returns a response indicating the result.
Step-by-Step Breakdown
Logging Start
•	Logs the start of the cash payment process with key details (biller, invoice, payment type, amount, etc.).
Payment Data Preparation
•	Generates unique identifiers for the payment (GUID, reference, approval code).
•	Prepares a payment message indicating approval.
SQL Command Construction
•	Builds a SQL command for the insPayments stored procedure.
•	Sets all relevant parameters:
•	Payment GUID, invoice/customer/biller info, payment amount, description, transaction type (cash), payment type, date, reference, message, approval status, convenience fee, payment source, remote IP, and user ID.
Database Execution
•	Executes the SQL command to insert the payment record.
•	Retrieves the new payment ID.
Response Preparation
•	If the payment was successfully inserted:
•	Sets the response as approved, with the payment code, message, and GUID.
•	Updates the invoice balance by executing spRecalculateBalance.
•	Adds the payment to the receipt queue for sending receipts to the provided emails.
•	Logs the successful payment.
•	If the payment failed:
•	Sets the response as not approved, with an error code and message.
•	Logs the failure.
Return Value
•	Returns a SaleResponse object indicating the result of the payment operation.
Summary
Inserts a cash payment record for an invoice.
Updates the invoice balance after payment.
Sends receipts to specified email addresses.
Logs all operations for auditing and troubleshooting.
Returns a response indicating success or failure.
ICRESTAPI
PayNearMeHandler.vb
https://dev.azure.com/invoicecloud/Src/_git/ICRESTAPI?path=/ICRESTAPI/Models/PayNearMeHandler.vb&version=GBmain&_a=contents&line=616&lineStyle=plain&lineEnd=784&lineStartColumn=5&lineEndColumn=17
This function processes a payment confirmation from PayNearMe, records the payment in the database, handles duplicate and declined payments, logs the process, and cleans up related records.
Step-by-Step Breakdown
Logging
•	Writes key details (invoice, site, status, amount, timestamp) to a local file for audit/debugging.
Biller Lookup
•	Retrieves the biller ID using the site identifier.
•	Assumes the biller exists if the payment was authorized.
Invoice and Customer Data Retrieval
•	Gets invoice and customer details for the payment using the PayNearMe order ID and biller ID.
Duplicate Payment Check
•	Checks if a payment record for this PayNearMe order ID already exists.
•	If found, returns True (no further action needed).
Record PayNearMe Order
•	If not a duplicate, inserts a record into the PayNearMe orders table with payment details.
Terminal Handling
•	Checks if a terminal for PayNearMe payments exists for the biller.
•	If not, inserts a new terminal and retrieves its ID.
Insert Payment Records
•	For each invoice/customer record:
•	Builds a SQL command to insert a payment record (insPayments stored procedure).
•	Sets all relevant parameters: payment GUID, invoice/customer/biller info, payment amount, description, type, date, reference, message, approval status, source, terminal, receipt GUID, etc.
•	Executes the SQL command to insert the payment.
Cleanup
•	Deletes related records from the PayNearMeOrderInvoice table to prevent reprocessing.
Return Value
•	Returns True to indicate the process completed (even if some steps were skipped due to duplicates or missing data).
Summary
Logs the payment confirmation details.
Checks for duplicate payments and avoids double processing.
Inserts payment records for each invoice/customer involved.
Handles terminal setup for PayNearMe payments.
Cleans up related records after processing.
Returns True to indicate completion.
ScheduledPaymentProcessing
clsUtilities.vb
 Private Shared Function GenerateFakePayment(ByVal scheduledPayment As ScheduledPaymentDetail, ByVal PaymentMessage As String) As Boolean
        Dim params As New List(Of String)
        params.Add("@InvoiceID=" & scheduledPayment.InvoiceID.ToString)
        params.Add("@CustomerID=" & scheduledPayment.CustomerID.ToString)
        params.Add("@BillerID=" & scheduledPayment.BillerID)
        params.Add("@InvoiceNumber='" & scheduledPayment.InvoiceNumber & "'")
        params.Add("@TransactionTypeID=1")
        params.Add("@PaymentAmount='" & scheduledPayment.Amount.ToString & "'")
        params.Add("@PaymentTypeID=1")
        params.Add("@PaymentDate='" & Now.ToCST().ToString & "'")
        params.Add("@PaymentReference='" & GenerateReference() & "'")
        params.Add("@PaymentMessage='" & PaymentMessage & "'")
        params.Add("@Approved=0")
        params.Add("@CloudPortals=0")
        params.Add("@Offline=0")
        params.Add("@PaymentSourceID=16")
        params.Add("@RemoteIP='127.0.0.1'")
        params.Add("@UserID=0")

        'Insert into the database
        Try
            'try to insert
            Dim insPaymentsSql As String = "insPayments " & String.Join(",", params.ToArray())
            Database.ExecuteCommandNonQuery(insPaymentsSql, scheduledPayment.BillerID)

            Return True
        Catch ex As Exception
            Logger.Error(ex, "GenerateFakePayment failed")
            Return False
        End Try
    End Function
This function inserts a "fake" or placeholder payment record into the database for a scheduled payment. It is typically used for logging or simulating a payment when no real transaction occurs.
Step-by-Step Breakdown
Parameter Preparation
•	Collects all necessary payment and invoice details from the scheduledPayment object.
•	Sets specific values:
•	TransactionTypeID=1 (likely indicates a sale/payment).
•	PaymentTypeID=1 (usually credit card or generic payment).
•	Approved=0 (not approved, since it's a fake payment).
•	CloudPortals=0, Offline=0 (system flags).
•	PaymentSourceID=16 (source type for scheduled/fake payment).
•	RemoteIP='127.0.0.1' (local IP, not a real transaction).
•	UserID=0 (system user).
SQL Command Construction
•	Builds a SQL command string for the insPayments stored procedure, joining all parameters.
Database Execution
•	Attempts to execute the SQL command using Database.ExecuteCommandNonQuery.
•	If successful, returns True.
Error Handling
•	If an exception occurs, logs the error and returns False.
Summary
Inserts a placeholder payment record for a scheduled payment.
Marks the payment as not approved and sets a custom message.
Returns True if successful, False if there is an error.
Logs errors for troubleshooting.
Functional flow for Dependent  Repo’s:
Biller Portal Payments Flow:
open a biller portal and go to search and click on invoices
it will redirect to the billerInvoices.aspx page and search for invoices
Click on '$' symbol to pay the invoice. it will redirect to the biller payment options page.
select the appropriate payment option like Real-Time Transaction and offline posting adjustments
select appropriate payment method and click pay now, it will redirect to the biller manual payment info 
Click next it will redirect to the billerpaymentselect.aspx page  , click check box based on payment that you are doing.
 click process payment , once payment is done it will redirect to the payment confirmation page.
payment record is getting inserted into the payments table through INCPayments stored proc 
it is an approveed payment so record getting inserted in to the datapump table
ACH/EFT transactions from Biller portal
Record inserted in payments
but record not inserted in to datapump 
 
checking for check payment 
 
it was redirected to billerManualPmt.aspx page 
click on post payment it redirected to the below popup and click check payment was posted from biller portal 
Record is inserted in to the payments table 
 
record not inserted in to the datapump table 
Chcking for credit/Debit 
Record in Payments table:
Datapump table(record not inserted)
offline cash payment:
credit adjustment 
 
Auto payment Processing 
,scheduled payment processing.
LogAndGenerateFakePayment Method
This method is designed to handle a scenario where an AutoPay payment cannot be processed because there is no default payment method on record for a customer. It performs the following actions:
Log the Start of Fake Payment Creation
•	Adds a log entry with the current elapsed time from miscWatch indicating the start of the fake payment creation.
Create a Fake Payment
•	Calls InsertFakePayment, passing the autoPayPayment details. This simulates a payment record in the database with a special message ("NO DEFAULT PAYMENT METHOD").
•	Logs the end of the fake payment creation.
Add a Processing Note
•	Logs the start of adding a processing note.
•	Calls AddProcessingNote to record in the payment history that the AutoPay failed due to no default payment method.
•	Logs the end of adding the processing note.
Queue a Declined Email
•	Logs the start of adding a declined email to the queue.
•	Uses emailHelper.AddToDeclinedEmailQueue to notify the customer (via email) that their payment could not be processed.
•	Logs the end of the email queue operation.
Update Application Log
•	Appends a message to appLog indicating whether the fake payment was successfully created or if there was an error.
Summary
Purpose:
This code is a fallback mechanism for failed AutoPay attempts due to missing payment methods. It logs the event, creates a "fake" payment record for auditing, adds a note to the payment history, and notifies the customer via email.
Key Actions:
Simulates a payment in the database.
Logs all steps for traceability.
Notifies the customer of the failure.
Let me know if you need details on any specific part or related methods!
wide
760
 Public Shared Sub LogAndGenerateFakePayment(ByVal autoPayPayment As AutoPayPaymentDetail, ByVal loginID As Integer, ByRef appLog As StringBuilder, ByRef miscLog As StringBuilder, ByRef miscWatch As Stopwatch, ByRef emailHelper As EmailHelper)
        ' create the fake payment
        miscLog.AppendLine(miscWatch.Elapsed.ToString & " -  Starting to add fake payment")
        Dim isFakePaymentCreated As Boolean = InsertFakePayment(autoPayPayment)
        miscLog.AppendLine(miscWatch.Elapsed.ToString & " -  Ending add fake payment")

        ' insert into scheduled payment history
        miscLog.AppendLine(miscWatch.Elapsed.ToString & " -  Starting to add processing note")
        AddProcessingNote(autoPayPayment.InvoiceID, "AutoPay payment was not possible due to no default payment method on record", autoPayPayment.BillerID)
        miscLog.AppendLine(miscWatch.Elapsed.ToString & " -  Ending processing note")

        ' send declined email
        miscLog.AppendLine(miscWatch.Elapsed.ToString & " -  Starting to add decline emailqueue")
        emailHelper.AddToDeclinedEmailQueue(autoPayPayment.BillerID, autoPayPayment.CustomerID, loginID, autoPayPayment.InvoiceID, "NO DEFAULT PAYMENT METHOD AVAILABLE", miscLog)
        miscLog.AppendLine(miscWatch.Elapsed.ToString & " -  Ending decline emailqueue")

        appLog.AppendLine(If(isFakePaymentCreated, "Fake Payment was created!", "Error Creating Fake Payment!"))
    End Sub

    Private Shared Function InsertFakePayment(ByVal autoPayPayment As AutoPayPaymentDetail) As Boolean
        Dim params As New List(Of String)
        params.Add("@InvoiceID=" & autoPayPayment.InvoiceID)
        params.Add("@CustomerID=" & autoPayPayment.CustomerID)
        params.Add("@BillerID=" & autoPayPayment.BillerID)
        params.Add("@InvoiceNumber='" & autoPayPayment.InvoiceNumber & "'")
        params.Add("@TransactionTypeID=1")
        params.Add("@PaymentAmount='" & autoPayPayment.BalanceDue & "'")
        params.Add("@PaymentTypeID=" & autoPayPayment.PaymentTypeID)
        params.Add("@PaymentDate='" & Now.ToCST().ToString & "'")
        params.Add("@PaymentReference='" & GenerateReference() & "'")
        params.Add("@PaymentMessage='NO DEFAULT PAYMENT METHOD'")
        params.Add("@Approved=0")
        params.Add("@CloudPortals=0")
        params.Add("@Offline=0")
        params.Add("@PaymentSourceID=15")
        params.Add("@RemoteIP='127.0.0.1'")
        params.Add("@UserID=0")

        Try
            Dim insPaymentsSql As String = "insPayments " & String.Join(",", params.ToArray())
            Database.ExecuteCommandNonQuery(insPaymentsSql, autoPayPayment.BillerID)
            Return True
        Catch ex As Exception
            Serilog.Log.Error(ex, $"BillerID: {Module1.BillerID} - InvoiceID: {autoPayPayment.InvoiceID}")
            Return False
        End Try
    End Function
Cloud Connect WS:
CloudConnectWS - API layer for our desktop application named POS Connect / Pay
his function, Credit_Card_EMV, is a web service method that records an EMV (chip card) credit card transaction as an offline payment in the database. It does not process the transaction itself; instead, it creates a payment record because the actual transaction is handled externally (by Bridgepay).
Key steps:
Authenticates the biller using the provided GUID and WebServiceKey.
If authentication fails, logs an error and returns a failed response.
If successful, builds a SQL command to insert a payment record with details from the request (customer info, masked card number, amount, etc.).
Marks the payment as offline.
Executes the SQL to save the record.
Returns a response with a new PaymentGUID and a success indicator.
Summary:
This code logs an EMV payment as an offline transaction for reporting and reconciliation, but does not interact with payment gateways or process the card itself.
MC_RPPS:
MC_RPPS is a console application that runs daily at 5:30am CST. It takes the imported payment files received from Fiserv and Mastercard via FTP and tries to match the payments to an invoice within our system. If a payment matches it will create a payment record in IC. If no invoice is matched, it will provide a top 4 best matches for the biller to select and apply payment in the biller portal. It also handles the creation of return files, reversals, and moves the imported entries over to the IC payment gateway during Cass processing at 10:30am CST.
The solution consists of an application, business library, and a test project. It builds and deploys with the 2.0 pipeline.
Please do not push feature branches beyond devtest (i.e., into regression etc.) unless special circumstances apply.
MC_RPPS - Pulls and processes "bank bill pay" data from multiple providers as part of our Online Bank Direct product.
MC_RPPS_Import 
5:00AM CST
9:00 AM CST
Everyday
Downloads Fiserv and MasterCard files and imports them into the folders that MC_RPPS reads from and uploads them into azure blob storage. 
MC_RPPS 
5:00AM CST
9:00 AM CST
Everyday
Runs after MC_RPPS_Import
Processes Fiserv and MasterCard payments, returns and rejects.
INSERT_IC_ACH_OBD_PAYMENT_RECORD
InsertDebitAdjustmentRecord
INSERT_IC_ACH_SALE_DISCOUNT_RECORD
Here is a step-by-step breakdown of the job flow:
Job Initialization
•	Job starts with metadata (name, ID, description, parameters, environment, agent info, etc.).
•	The process is launched using a command-line tool (RobotTermSocket64.exe).
Environment Setup
•	The agent changes directories to the application folder.
•	The main executable (MC_RPPS.exe) is started.
Health Checks
•	System checks for logins and performs a health check (logs success).
Database Logging
•	Job details are logged in the database (insert/update job records).
Shard Map and Billers Loading
•	Loads shard map manager and retrieves billers that support RPPS.
Processing Billers
•	For each biller:
•	Loads biller data and RPPS product info.
•	Loads terminals and RPPS entries for the biller.
•	If there are no entries, logs and moves to the next biller.
•	If entries exist, processes them:
•	Pre-processes entries using stored procedures (spRPPSpreProcess_LocatorBulk, spRPPSpreProcessBulk).
•	Retrieves and scores entries.
•	Attempts to match entries (auto-match options, scoring, etc.).
•	If matches are found, processes them; if not, logs "no perfect match found".
•	Marks all importing entries as pending.
Post-Processing
•	After processing all billers, notifies billers of upcoming returns via email.
•	Marks all importing entries as pending across shards.
Finalization
•	Checks for unprocessed files in input directories.
•	Logs totals (billers, entries, duplicates).
•	Job ends and process exits with success.
Summary:
The job automates RPPS biller entry processing: it loads billers, checks for entries, attempts to match and process them, updates statuses, logs results, and sends notifications. If no entries are found for a biller, it skips processing for that biller. The job completes with a clean exit.
ICFramework.Businsess.Data:
Used to manage Biller Optionsthere is Toinsertsql method inside this framework this used to insert payment record to the payments table in the database. currently no references for this method in repositories
IC KoiskAPI:
It's a Rest API application that allows kiosk vendors (KIS, Dynatouch) to pull the supplied billers invoices from the Invoice Cloud system. After selecting an invoice on the Kiosk machine, it allows transaction calls to the API to complete the payment of the invoice(s) (Cash, EFT and CC).
The solution consists of an application, business library, and a test project. It builds and deploys with the 2.0 pipeline.
Please do not push feature branches beyond devtest (i.e., into regression etc.) unless special circumstances apply.
ICRESTAPI:
This code file defines the PayNearMeHandler class, which manages PayNearMe payment processing for invoices in a billing system.
Summary of Main Responsibilities:
AuthorizeRequest: Validates and authorizes incoming payment requests, determines which invoices can be paid, and splits payments across multiple invoices if needed.
ConfirmationResponse: Handles payment confirmation, records payments, and updates invoice/payment records in the database.
Signature Verification: Verifies the authenticity of incoming requests using a secret key and MD5 hashing.
Helper Methods: Includes functions for saving, retrieving, and deleting payment records, as well as logging exceptions.
Key Concepts:
Uses SQL stored procedures to interact with the database for invoice and customer data.
Handles partial payments, overpayments, and grouped invoices.
Ensures payments are only accepted for eligible invoices and customers.
This code defines a Web API controller for handling PayNearMe payment requests in a Visual Basic .NET (
http://VB.NET
 ) project. Here’s a breakdown of what it does and how you might test it:
What the Code Does
Controller Purpose:
The PayNearMeController exposes endpoints for authorizing and confirming PayNearMe payments.
Key Endpoints:
GET v1/paynearme/authorize/{id?}: Checks if a payment can be accepted.
GET v1/paynearme/confirm/{id?}: Confirms the status of a payment.
Selected Method (ConfirmPayNearMe):
Receives payment details as query parameters.
Verifies the request signature for security.
Calls a handler (PayNearMeHandler.ConfirmationResponse) to process the confirmation.
Returns a custom response object (PayNearMeConfirmResponse) indicating approval status.
Paperless Payments Flow
Overview
The paperless payments flow involves several steps to ensure a seamless and efficient payment process without the use of paper checks. This process is facilitated by InvoiceCloud's Online Bank Direct (OBD) and Cloud Payments v2 platforms.
Steps Involved
1. Invoice Creation and Linking
Invoice Creation
: Invoices can be created dynamically for new or existing customer accounts. This can be done using the Cloud Payments v2 platform, which generates a URL for direct access to the payment route .
Linking
: InvoiceCloud matches electronic payments information with open invoices, reducing manual effort in matching customer names and bill amounts .
2. Payment Options
Selection
: On the payment options page, users can select an available payment method and billing option (e.g., Pay Full Invoice, Pay Minimum, Pay Other Amount) .
Billing Information
: Users enter required billing information, including a mandatory email address for the payment receipt .
3. Payment Processing
Authorization
: The payment process involves creating an authorization, which, once successful, confirms the payment ​.
Declined Payments
: If a payment is declined, the system displays a decline screen and processes the transaction again as needed .
4. Confirmation and Receipt
Confirmation
: A successful payment displays a payment confirmation. Users can opt to print a receipt directly from the device or have it displayed on the card reader ​.
Return to Home Page
: Users can click the "Return to home page" button to be redirected to the ReturnURL if supplied in the POST request .
Benefits
Efficiency
: Eliminates paper checks issued by online banking sites and matches electronic payments with open invoices automatically .
Reduced Manual Effort
: Greatly reduces the manual effort of matching customer names and bill amounts, with partial matches viewable through an easy-to-use interface .
Quick Deposits
: All online bank payments are reported the next day and deposited within 48 hours, provided batches are closed and the Nacha file has been processed .
Challenges
Declined Transactions
: Handling declined transactions, especially in a split fee model, where both the payment amount and fee transactions need to be successful .
Customization
: Ensuring the payment route page matches the customer portal's style using cascading style sheets (CSS) .
By following these steps, the paperless payments flow ensures a streamlined and efficient process for both customers and billers, leveraging the capabilities of InvoiceCloud's platforms.
Stored Procedure References:
insCustomerPaperless
updCustomerPaperless
selCustomerPaperless
Reference for 
insCustomerPaperless
,
Repo Name
Class name
code reference
ICRestAPI
CustomerPortalV2Controller.vb
https://dev.azure.com/invoicecloud/Src/_git/ICRESTAPI?path=/ICRESTAPI/Controllers/CustomerPortalV2Controller.vb&_a=contents&version=GBmain
 
tulare account linking 
clsSQL.vb
https://dev.azure.com/invoicecloud/Src/_git/TulareAccountLinking?path=/TulareAccountLinking/Database/Sql/clsSQL.vb&_a=contents&version=GBmain
 
Demoportals
clsInsuranceStage.cs
,
clsUtilityStage.cs
,
clsTaxBase.cs
https://dev.azure.com/invoicecloud/Src/_git/DemoPortals?path=/DemoPortals/clsInsuranceStage.cs&_a=contents&version=GBmain
 
https://dev.azure.com/invoicecloud/Src/_git/DemoPortals?path=/DemoPortals/clsTaxBase.cs&_a=contents&version=GBmain
 
https://dev.azure.com/invoicecloud/Src/_git/DemoPortals?path=/DemoPortals/clsUtilityStage.cs&_a=contents&version=GBmain
 
MYIIS
insCustomerPaperless - Search Code - Search
Motor Vehicle linking
Business.vb
https://dev.azure.com/invoicecloud/Src/_git/MotorVehicleLinking?path=/MotorVehicleLinking/objects/Business.vb&_a=contents&version=GBmain
 
Register Paperless
Module1.vb
https://dev.azure.com/invoicecloud/Src/_git/RegisterPaperless?path=/RegisterPaperless/Module1.vb&_a=contents&version=GBmain
 
Source repos for datapumptype paperless async for inserting data into the datapump table
ICRESTAPI
MyIIS
Remote Authentication
RegisterPaperless
Reference confluence Documents:
MC_RPPS(Mastercard Remote Payment and Presentment Service ) - Development Support - Confluence
BillerPortal - Make Payment - Search by Payment - SRE - Confluence
Spike for PRISM-97: Paperless choice in the IVR - Product Engineering - Confluence
High Level Payment Flow - SRE - Confluence
Paperless Registration - Payer Portal - SRE - Confluence
Paperless at the User Level - Product - Confluence
 URL:/spaces/PE/pages/4515922023/SPIKE+DataPump+discovery+to+evaluate+dependencies+and+identify+use+cases+across+external+repositories+for+Payment+Processing+and+Paperless+Sync