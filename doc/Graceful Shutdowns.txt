When a Kubernetes pod receives a 
SIGTERM
 signal (typically during a graceful shutdown), it 
should start failing its readiness probe
‚Äîi.e., responding with a 
non-2XX status code
‚Äîto indicate to Kubernetes that it is no longer ready to serve traffic.
1
6
false
none
list
true
 Why this is important
SIGTERM is sent before termination
: Kubernetes sends a SIGTERM to the container to allow it to gracefully shut down.
Readiness probe failing removes the pod from service
: If the pod starts failing its readiness probe, Kubernetes will stop sending traffic to it via the service.
Graceful shutdown
: This gives the pod time to finish in-flight requests and clean up resources without receiving new traffic.
‚úÖBest Practice Flow
SIGTERM received.
Application begins shutdown logic.
Readiness probe starts failing (e.g., returns HTTP 503).
Kubernetes removes pod from endpoints.
Pod completes shutdown and exits.
 
  Example: Kubernetes Deployment YAML with Graceful Shutdown
apiVersion: apps/v1
kind: Deployment
metadata:
  name: graceful-app
spec:
  replicas: 3
  selector:
    matchLabels:
      app: graceful-app
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: 1
      maxSurge: 1
  template:
    metadata:
      labels:
        app: graceful-app
    spec:
      terminationGracePeriodSeconds: 30  # Time to gracefully shut down
      containers:
        - name: app-container
          image: your-app-image:latest
          ports:
            - containerPort: 3000
          readinessProbe:
            httpGet:
              path: /health/ready
              port: 3000
            initialDelaySeconds: 5
            periodSeconds: 10
            failureThreshold: 3
          lifecycle:
            preStop:
              exec:
                command: ["/bin/sh", "-c", "sleep 10"]  # Optional delay before SIGTERM

üîç Key Components
terminationGracePeriodSeconds
: Gives the pod time to shut down gracefully (default is 30 seconds).
readinessProbe
: Should return a non-2XX response during shutdown to stop receiving traffic.
preStop
 hook
: Optional command that runs before the container is terminated. Useful for cleanup or delaying shutdown.
  Example: Graceful Shutdown with Readiness Probe
const express = require('express');
const app = express();
const port = 3000;

let isShuttingDown = false;

// Readiness probe endpoint
app.get('/health/ready', (req, res) => {
  if (isShuttingDown) {
    return res.status(503).send('Shutting down');
  }
  res.status(200).send('OK');
});

// Liveness probe endpoint (optional)
app.get('/health/live', (req, res) => {
  res.status(200).send('Alive');
});

// Main app endpoint
app.get('/', (req, res) => {
  res.send('Hello from the pod!');
});

// Handle SIGTERM for graceful shutdown
process.on('SIGTERM', () => {
  console.log('SIGTERM received: starting shutdown');
  isShuttingDown = true;

  // Optional: wait for a few seconds to let Kubernetes remove the pod from service
  setTimeout(() => {
    console.log('Exiting process');
    process.exit(0);
  }, 10000); // 10 seconds
});

app.listen(port, () => {
  console.log(`App listening on port ${port}`);
});

üõ†Ô∏è Kubernetes Readiness Probe Example
readinessProbe:
  httpGet:
    path: /health/ready
    port: 3000
  initialDelaySeconds: 5
  periodSeconds: 10
  failureThreshold: 3

üîç What This Does
When the pod receives a 
SIGTERM
, it sets 
isShuttingDown = true
.
The readiness probe (
/health/ready
) starts returning 
503
, so Kubernetes removes the pod from the service endpoints.
After a delay (e.g., 60 seconds), the app exits, allowing in-flight requests to complete.
 Horizontal Pod Autoscaling Scale In
The 
HorizontalPodAutoscaler (HPA)
 itself does 
not provide a graceful shutdown period
. Instead, it 
respects the pod's lifecycle configuration
, specifically the 
terminationGracePeriodSeconds
 defined in the pod spec.
 Here's how it works
When HPA scales down a deployment (e.g., from 5 pods to 3), Kubernetes selects pods to terminate.
For each selected pod:
Kubernetes sends a 
SIGTERM
 signal.
The pod has up to 
terminationGracePeriodSeconds
 (default is 30 seconds) to shut down gracefully.
During this time, the pod can:
Fail its 
readiness probe
 to stop receiving traffic.
Complete in-flight requests.
Clean up resources.
After the grace period, if the pod hasn‚Äôt exited, Kubernetes sends a 
SIGKILL
 to force termination.
‚úÖ Best Practices
Set 
terminationGracePeriodSeconds
 appropriately in your pod spec.
Ensure your app handles 
SIGTERM
 and fails readiness probes during shutdown.
Avoid long shutdown logic that exceeds the grace period.
 Example: Deployment with Graceful Shutdown
apiVersion: apps/v1
kind: Deployment
metadata:
  name: my-app
spec:
  replicas: 3
  selector:
    matchLabels:
      app: my-app
  template:
    metadata:
      labels:
        app: my-app
    spec:
      terminationGracePeriodSeconds: 30  # Graceful shutdown period
      containers:
        - name: my-app-container
          image: my-app-image:latest
          ports:
            - containerPort: 3000
          readinessProbe:
            httpGet:
              path: /health/ready
              port: 3000
            initialDelaySeconds: 5
            periodSeconds: 10
            failureThreshold: 3

üîç Key Points
terminationGracePeriodSeconds: 30
: Gives the pod 30 seconds to shut down gracefully after receiving a 
SIGTERM
.
readinessProbe
: Should return a non-2XX status (e.g., 503) during shutdown to signal Kubernetes to stop routing traffic to the pod.
 Long Graceful Shutdowns Needed for Proxy Services
 ICDatabaseService
The 
terminationGracePeriodSeconds
 is needed for up to 50 minutes (3000 seconds) for long running multi-shard (Biller Databases) database queries.
 ICBusinessService
The 
terminationGracePeriodSeconds
 is needed for up to 30 minutes for (1800 seconds) for long running operations.
 ICRTDRService
is needed for up to 50 minutes (3000 seconds) for long running operations.
 ICCryptoService
The 
terminationGracePeriodSeconds
 is needed for up to 10 minutes for (600 seconds) for long running operations.
 URL:/spaces/platform/pages/4522934336/Graceful+Shutdowns