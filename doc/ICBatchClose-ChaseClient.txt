This document outlines the internal flow, logic, stored procedures, and external API interactions of the 
Chase Client
 responsible for closing credit card (CC) and ACH (Automated Clearing House) payment batches using 
Chase Paymentech
.
‚öôÔ∏è Overview
Primary Method
: 
CloseBatchChaseTerminal()
Purpose
: Automates batch bundling, API submission, and finalization of payment batches (both CC and ACH) for a given biller and terminal.
Integration
: Uses 
ICChaseProcessor
 to communicate with 
Paymentech Gateway
.
¬†
Flow of the Chase Client:
The CloseBatchChaseTerminal function orchestrates the end-to-end process of closing and settling payment batches‚Äîspecifically for credit card (CC) and ACH (Automated Clearing House) transactions‚Äîfor a given biller using Chase Paymentech.
¬†
¬†
üîÑ 1. Initialization & Logging
Setup:
 Initializes variables to track batch details like item counts and net amounts for both CC and ACH.
Logging:
 Utilizes a DualProcessMetric object to log the process flow and metrics for monitoring and debugging purposes.
üí≥ 2. Credit Card (CC) Batch Processing
Terminal Retrieval:
 Fetches the CC terminal associated with the biller and module parameters.
Batch Bundling:
 If a terminal is found, it bundles the CC transactions into a batch.
Metrics Calculation:
 Calculates the total number of items and net volume for the CC batch.
Logging:
 Logs the CC batch summary, including item count and net volume.
üè¶ 3. ACH Batch Processing
Terminal Retrieval:
 Fetches the ACH terminal associated with the biller and module parameters.
Batch Bundling:
 If a terminal is found, it bundles the ACH transactions into a batch.
Metrics Calculation:
 Calculates the total number of items and net volume for the ACH batch.
Logging:
 Logs the ACH batch summary, including item count and net volume.
üì§ 4. Batch Closure via Paymentech
Condition Check:
 Proceeds only if there are items in either CC or ACH batches.
Request Preparation:
 Prepares a batch close request with relevant module parameters.
API Call:
 Sends the batch close request to Paymentech and logs the response.
‚úÖ 5. Settlement & Finalization
Approval Handling:
 If Paymentech approves the batch close:
CC Settlement:
 If CC batch exists, records the settlement details, inserts email notifications, and finalizes the batch.
ACH Settlement:
 If ACH batch exists, records the settlement details, inserts email notifications, and finalizes the batch.
Failure Handling:
 If Paymentech does not approve:
Rollback:
 Rolls back both CC and ACH batches.
Notification:
 Sends an error email with detailed information about the failure.
üßæ 6. Finalization
Metrics Posting:
 Posts all collected metrics for auditing and monitoring purposes.
Return Value:
 Returns True if both CC and ACH batches were successfully closed and settled; otherwise, returns False
¬†
Convinece Fee Batch close:
Step
Action
1
Initialize variables and logging
2
Get Terminal ID & Parameters
3
Get Uncommitted CC & ACH Batches
4
Exit early if batch item count = 0
5
Call Paymentech_BatchClose()
6
If approved: Commit CC batch
7
If approved: Commit ACH batch
8
If failed: Rollback CC batch
9
Return combined success flag
¬†
Stored Procs Used for Chase batch close:
From this Chaseclient, we can identify several 
stored procedures (stored procs)
 being called, along with their 
Example
 
parameters and purposes
.
SpDistinctTerminalsForCPClose
Called with:
@billerID=3451
Purpose:
Return a list of unique terminal configurations (ModuleParameters) for a specific biller, specifically for use during the Chase Paymentech batch close process.
SelTerminalsAutoClose
Called multiple times with parameters like:
BillerID:3451
PaymentTypeID:1 (Credit Card) or 2 (ACH)
ModuleParameters: mid, tid, bin, industrytype, live
Purpose:
Selects the appropriate terminal to process the auto-close batch based on the biller and payment type.
MID/TID
 values relate to specific merchant accounts and terminals.
¬†
Note
: Once we get the terminals for each terminal batch close will be done.
SpBundleBillerCreditCardBatch
Called with:
BillerID:3451, TerminalID:37 (or others)
Purpose:
The stored procedure 
[dbo].[spBundleBillerCreditCardBatch]
 bundles all 
approved, unsettled credit card payments
 for a given 
BillerID
 and 
TerminalID
, marks them as pending settlement, and returns a summary of the batch including item count and transaction volumes (sales and credits).
Here settled batch id updated as -1.
¬†
Note
: Here SelTerminalsAutoClose again called for getting the ACH terminal. Then SpBundleBillerAchBatch will be called for ACH batch bundling.
SpBundleBillerAchBatch
Called with:
BillerID:3451, TerminalID:2 (or others)
Purpose:
¬∑¬†¬†¬†¬†¬† The stored procedure 
[dbo].[spBundleBillerAchBatch]
 is designed to 
bundle approved, unsettled ACH payments
 (types 2 and 4) for a given 
BillerID
 and 
TerminalID
, flag them for settlement, and return a 
summary
 of the batch including 
item counts and transaction volumes (sales and credits)
.
¬∑¬†¬†¬†¬†¬† Here settled batch id updated as -2.
¬†
Batch Close
By checking the item count of ACH and credit card batch this will sent to Paymentech batch close API.There is an ICChaseProcessor in this we are calling the 
EndofDayElement
 Endpoint for batchclose.
Api url: 
https://wsvar.paymentech.net/PaymentechGateway/wsdl/PaymentechGateway.wsdl
Processor Posting Step
This part:
Posting to PaymentTech.
Module Parameters: mid=407225&tid=001&bin=000001&industrytype=EC&live=0
Response: Approval Indicator: True/False
Purpose:
Actually sends the batch to 
Chase Paymentech
 for processing.
The 
response code and message
 tell whether the batch was approved.
¬†
Below are the parameters of Request and Response for the EndofDayElement
üì° 
Paymentech API Integration
API Endpoint
bash
https://wsvar.paymentech.net/PaymentechGateway/wsdl/PaymentechGateway.wsdl 
Posting Parameters
Parameter
Example
mid
407225
tid
001
bin
000001
industrytype
EC
live
0
WSDL: EndOfDayElement Request
xml
<EndOfDayElement>   <bin>000001</bin>   <merchantID>407225</merchantID>   <terminalID>001</terminalID> </EndOfDayElement> 
Response Example
json
{   "ERROR_CODE": 0,   "MESSAGE": "OK",   "DATA": {     "bin": "000001",     "merchantID": "407225",     "terminalID": "001",     "procStatus": "0",     "batchSeqNum": "35C463C471E2F3C3E06373F37A0AFA97",     "procStatusMessage": ""   } } 
Once the parameters sent to the API response will look like as shown below
InsSettledBatches
Parameters include:
BillerID, SettledBatchGuid, PaymentType, NetworkReference, ItemCount, NetVolume, SettledDate, TerminalID
Purpose:
Records the completed (settled) batch in the database, marking it as finished for reporting/auditing.
InsSettledBatchQ
Used after InsSettledBatches. Parameters include:
SettledBatchID, BillerID, TerminalID, PaymentTypeID, EmailQueueTypeID, Reference
Purpose:
Queues an email notification or log entry related to the batch settlement.
If Batch close fails:
SpRollbackBillerAchBatch, SpRollbackBillerCreditCardBatch will rollback the settled batches.And sent email with subject Custom Batch Close Failure.
Convenience Fee Batch Close
First 
SelTerminals 
stored proc will called for terminals data based on the billerid,payment type,moudleid
¬†
Again SpBundleBillerCreditCardBatch, SpBundleBillerAchBatch will caleed for batch bundling of convenience fee terminal.
Batch close request Sent to API.
¬†
SpCommitBillerCreditCardBatch and SpCommitBillerAchBatch
Called with:
BillerID, TerminalID, SettledBatchID
Purpose:
Commits the batch by finalizing the transactions and updating necessary records.
selComputedBatchVolumeBreakDown and updSettledBatchVolumeBreakDown
Used in sequence with:
@SettledBatchID, @BillerID, @PaymentTypeID
Purpose:
Computes and updates the detailed breakdown of batch volume by card type or payment method (Visa, MC, EFT, etc.).
Useful for reconciliation, reporting, and analytics.
The stored procedure 
[dbo].[selComputedBatchVolumeBreakDown]
 calculates 
transaction volume and count breakdowns
 for a 
single settled batch
 based on its 
payment type
.
The stored procedure 
[dbo].[updSettledBatchVolumeBreakDown]
 is used to 
update detailed volume and transaction count breakdowns
 for a specific 
settled batch
 (SettledBatchID) in the SettledBatches table.
¬†
Summary Table
Stored Procedure
Purpose
Key Parameters
SpDistinctTerminalsForCPClose
Fetch terminals for chase paymentech
BillerID
SelTerminalsAutoClose
Get CC/ACH terminal info
BillerID, PaymentTypeID, ModuleParameters
SpBundleBillerCreditCardBatch
Bundle CC payments
BillerID, TerminalID
SpBundleBillerAchBatch
Bundle ACH payments
BillerID, TerminalID
InsSettledBatches
Record completed batch
All batch meta info
InsSettledBatchQ
Queue batch-related email/logs
SettledBatchID, EmailQueueTypeID, etc.
SpCommitBillerCreditCardBatch
Finalize CC batch
BillerID, TerminalID, SettledBatchID
SpCommitBillerAchBatch
Finalize ACH batch
BillerID, TerminalID, SettledBatchID
selComputedBatchVolumeBreakDown
Analyze batch volume breakdown
SettledBatchID, PaymentTypeID
updSettledBatchVolumeBreakDown
Store breakdown analytics
VisaVol, MCVol, EFTVol, etc.
¬†
 URL:/spaces/PE/pages/4350935770/ICBatchClose-ChaseClient