Drivers
Changes were made in EmailQueueProcessing (skybot job) that introduced New Relic dependencies within IC.EmailQueue inside this repo.  ICEmailQueueProcessor (az function) also uses IC.EmailQueue.  These changes introduced problems with ICEmailQueueProcessor that were not addressed.
Jan (
PR link
) - Logs started to go missing inside ICEmailQueueProcessor because IC.EmailQueue now forces them through NR and NR does not work in Az Func environments
March (
PR link
) - Breaking change to ICEmailQueueProcessor when adding latest IC.EmailQueue.  
vbnet
System.IO.FileNotFoundException: Could not load file or assembly 'NewRelic.Api.Agent, Version=10.0.0.0, Culture=neutral, PublicKeyToken=06552fced0b33d87' or one of its dependencies. The system cannot find the file specified.
File name: 'NewRelic.Api.Agent, Version=10.0.0.0, Culture=neutral, PublicKeyToken=06552fced0b33d87'
   at IC.EmailQueue.EmailQueueBase._Lambda$__120-0()
   at IC.EmailQueue.EmailQueueBase.ProcessMetric(Action Method) in C:\Users\X-CarlosDeJesusHurta\Source\Repos\EmailQueueProcessing\IC.EmailQueue\EmailQueueBase.vb:line 2115
   at IC.EmailQueue.EmailQueueBase.Run() in C:\Users\X-CarlosDeJesusHurta\Source\Repos\EmailQueueProcessing\IC.EmailQueue\EmailQueueBase.vb:line 651
   at EmailQueueProcessor.SendTestEmail.Run(String myQueueItem, TraceWriter log, ExecutionContext context)
ICEmailQueueProcessor blocked from additional changes because of the breaking change introduced above
IC.EmailQueue was originally intended to host the framework that runs all email queues but started drifting over time to be more of a “business” class for EmailQueueProcessor.  This started becoming a problem for ICEmailQueueProcessor which was a user of IC.EmailQueue
Summary of Changes
PR Link
Original project state of EmailQueueProcessing
Original project state of ICEmailQueueProcessor
After changes
IC.EmailQueue project was eliminated, broken out into 2 new projects.  First project EmailQueueProcessing.Business was added to EmailQueueProcessing solution.
Any classes from IC.EmailQueue that were not core to the Framework were moved to the new project.  
Project organization was kept the same (same folders, etc).  
New Relic dependencies were kept intact
Second project was IC.EmailQueueFramework and is hosted in a new solution and repository.  
Any classes from IC.EmailQueue that were core to the Framework or were the Framework were moved to this project
Project organization was kept the same (same folders, etc)
New Relic dependencies were REMOVED and NR log lines were replaced with injected ILog logs
Available in our ICPackages nuget repository
EmailQueueProcessing project now references both projects, with IC.EmailQueueFramework referenced through the nuget package
ICEmailQueueProcessor took on classes from IC.EmailQueue as well that were only used by ICEmailQueueProcessor.  They were 
VB.NET
 classes so instead of converting them (susceptible to human error) I created a new project (EmailQueueProcessor.EmailQueues) and added them there.  I also moved over any pertinent unit tests from the EmailQueueProcessing project that referenced these classes and added them to another new project for 
VB.NET
 tests
EmailQueueProcessor projects now references the new project EmailQueueProcessor.Queues plus has a reference to the new IC.EmailQueueFramework nuget package
A bit more detail
New Relic dependency removed from EmailQueueFramework
ICEmailQueueProcessor, which uses the Framework, runs as an Azure Function.  The Azure Function environment is known to not support our implementation of New Relic logging.  Therefore the Framework cannot have any dependencies on that implementation to allow it to be used across multiple repositories as it is intended.  The New Relic dependency was introduced in Jan and many log lines that were using the injected ILog implementation were replaced with NR log lines.  All those were reverted back to use the ILog injected implementation.  Additionally the <Trace> attribute was added to many methods.  Those too are not functional in an Az Function environment.  Those were removed as well.
Trace attribute removed
Revert to using ILog for logging
Keeping the value of custom instrumentation offered by <Trace>
<Trace> was sprinkled on a lot of methods in the Framework that instrumented them on New Relic APM transactions.  We had to remove these attributes from the Framework but still enable the Framework to be instrument-able.  Many of the methods on the Framework were already overridable enabling devs to override and instrument those.  This approach was not followed and instead the methods inside the Framework had the attributes.  In addition to removing the <Trace> attribute from the Framework methods, all methods that were previously not overridable but had the <Trace> attribute were updated to be overridable.  There were a number of methods that I don’t think should have been overridable but keeping with the spirit getting this completed in a short time they were made overridable and in the future they can get scaled back as needed.  
Shows EmailQueueProcessing.EmailQueueBaseProxy class overriding IC.EmailQueueFramework.EmailQueueBase methods with <Trace> attributes
More New Relic functionality moved out from EmailQueueFramework
The Framework also had functionality where it would post custom metrics up to New Relic.  With the New Relic dependency removed this could not longer exist in the Framework but instead moved out to the derived class EmailQueueProcessing.EmailQueueBaseProxy.  This work was carefully migrated to this class and hooked into the proper overriden methods to give it the same functionality it had when it lived inside the Framework.
Previous NR function called from an overriden method
The NR function living in that derived class
Consistency in folder organization and classes
To aid in absorbing the many changes, the folder structure and class names were kept the same.  The functionality within each is also the same with some minor exceptions like updating references to new projects
IC.EmailQueue before the changes
EmailQueueProcessing.Business after changes
IC.EmailQueueFramework after changes
Taking only what is needed
IC.EmailQueue was not duplicated and renamed to new projects.  Each new project was created from scratch.  Classes were copied in from IC.EmailQueue based on need.  For example, IC.EmailQueue.EmailQueueBase library is the core of the Framework.  It was copied over to IC.EmailQueueFramework, and then any referenced classes were copied over as well, as well adding library references.  
IC.EmailQueue before changes
IC.EmailQueueFramework after changes
EmailQueueProcessing.Business after changes
Some duplication was needed
There were a couple cases where the same class existed in multiple projects BEFORE changes.  There were also a couple cases where a project was referencing a class in another project that just didn’t make sense to keep the tie which could’ve led to unnecessary constant changes to the Framework.  Framework should see little changes.  Extensions are an example.  Duplicated classes were not large classes.
EmailQueueProcessing after changes
IC.EmailQueueFramework after changes
Email Queues that were only called from ICEmailQueueProcessor
Early on in the development of IC.EmailQueue we started adding the Test Email Queues there as it made it easy to migrate them one by one to a project inside where they previously existed and then add a reference to that library from ICEmailQueueProcessor.  It makes development and testing of these a bit more difficult because you change them in one place but then host them somewhere else.  All of these were now moved to EmailQueueProcessor.EmailQueues project in ICEmailQueueProcessor repo.
IC.EmailQueue before changes
EmailQueueProcessor after changes
Test Results
Existing test environment setups were used to test these changes.  68 email queues were manually tested and verified to be working.  The remaining can be safely assumed to be working as there were no functional changes to any of them.  Either way they all will be monitored post deployment to ensure no issues.
This document itemizes the queues tested.  
EmailQueueFramework - Test Results.xlsx
 URL:/spaces/EA/pages/3620175877/Breaking+out+EmailQueueFramework+from+EQP