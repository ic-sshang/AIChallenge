Payment processing
Steps to process AP with PAC donation add on
Need 
new 
stored procedure 
tps.selAutoPayProcessingListV5
 to include:
new field for adding donation invoices(or not). This also support to know which invoice type has applied PAC – 
HasDonation/IsEnrolledForDonation
, 
DonationInvoiceTypeID
 , 
DonationAmount
 (can be $0.00 by default), retrieves amount from primary invoice record or CRM fixed amount based on config
Process AP on primary invoices (
existing processes
)
Calculate service fee
Calls CTP to process payment
Sends approval (transactionreceiptqueue) /declined (autopaydeclinenotificationqueue) email per invoice
Insert new donation invoice to Invoices table (
new processes
). Make sure that donation invoices do not show up on the grid (customer portal)
insert 1 donation invoice per primary invoice (not bundle invoices) belong to invoice type has signed up AP with PAC. CustomerID should be 0 for donation invoice
Process AP for new donation invoice
Calculates service fee
Calls CTP
Sends receipt email. Use the CloudPaymentReceiptQueue for approval payment, do not send the declined email
Diagram for AP with PAC add on
2
1
0
0
4491706454
4488396921
1
Untitled Diagram-1752253112462.drawio
3
3
https://invoicecloud.atlassian.net/wiki
Untitled Diagram-1752253112462.drawio
0
667
911
Database
Changes:
Tables
CustomerAutoPay
New column for 
IsDonationActive
 - nullable bool
New column for 
DonationInvoiceTypeID
- nullable int
New column for Contributor type 
EntityTypeID
 - nullable int
Maps an ID to the tblEntityType
New reference table 
tblEntityType
Personal
Corporate
LLC
Stored Procedures
New SP mcl.selCustomerAutoPayWithDonation
Update the standard CustomerAutoPay SP’s with optional parameters for the 2 new columns
mcl.selCustomerAutoPay
return the new columns
mcl.updCustomerAutoPay
accept new columns as optional params
mcl.insCustomerAutoPay
accept new columns as optional params
Data Pump
We will be using the existing AutoPay DataPump type with a small tweak
 The insDataPump call will also include the 
CustomerAutoPayID
 from the CustomerAutoPay table in the OptionalDesc field
As a payer, when I have a change in autopay status, I expect to see my AutoPayId in the OptionalDesc column in the database.
clsRealTimeDataRefreshTests.SyncAutoPayStatus_EnrollAutoPay_EnrollPAC_ReturnsTrue
Changes
clsRealTimeDataRefresh.vb
SyncAutoPay method
Make a change to the parameters of the SyncAutoPay method to include one for the OptionalDesc
This new OptionalDesc parameter should be optional
Note: The SyncAutoPay method is called from 5 other spots that we may not want to update yet. I am listing the files and methods where it is called below
clsCustomers.vb - UnenrollCustomerFromAutoPay
clsAutoPay.vb - RemoveAutoPay
CloudManagement - ConveyCustomer
AutoPayBankEnrollmentProcessor - UpdateAutoPayStatus
AutoPayCreditCardEnrollmentProcessor - UpdateAutoPayStatus
Make a change to include the new OptionalDesc parameter in the call to InsertDataPump
AutoPay.aspx.vb
Make a call to SyncAutoPay for the AutoPay Donation Add On record for the following
 Enrolling/Unenrolling in AutoPay with a Donation Add-On – “AutoPay Add-On For Political Contributions”
 Enrolling/Unenrolling for a Donation Add-On on an existing AutoPay setup
when the status of the specific AutoPay record changes, it must be DataPumped
not enrolled in primary AP → enrolled
not enrolled in add-on AP → enrolled
enrolled in primary AP → unenrolled (this will trigger unenrolling in add-on AP)
enrolled in add-on AP → unenrolled
When the payment method changes for the parent (main InvoiceType record)
We call DatapumpAutopayMethodChange
 We should call this method for the donation add-on record as well
The payment method on the child(autopay donation record) should also change
Validation:
Flow of the AutoPay setup process in the Customer Portal with donations Add-On
This diagram is obsolete since we now only need to make 1 DataPump call
2
1
0
0
4492427547
4488396921
1
Untitled Diagram-1752259196844.drawio
2
2
https://invoicecloud.atlassian.net/wiki
Untitled Diagram-1752259196844.drawio
0
711
1051
In AutoPay.aspx:
in OnLoad method,
If the contribution amount is dynamic and maps to a column (e.g., Doctors), then populate DOCPAC contribution with value from invoice of the parent invoice type with the closest upcoming AutoPayCollectionDate (if multiple invoices have the same date, then the amount is not displayed)
The displayed panel would look like:
Set 
Include DOCPAC contribution
 to default value (I wish to support DOCPAC)
The contribution type radio button will not be pre-selected but is required before saving. It should have a value posted back to the server.
If the contribution amount is fixed (e.g., TFB), then use the fixed amount from the CRM.
The displayed panel would look like:
Set Include AGFUND in AutoPay to yes (default)
If no value is in the mapped column for the contribution amount, do not show the contribution amount area/panel on the page.
Saving:
We will create 
ICRestApi 
v3.2 for this including a CustomerPortalV3_2Controller.  Request v3.2 will contain the following new parameters:
DonationTypeID - integer
EntityTypeID - integer
Personal
Corporate
LLC
IsDonationActive - boolean
ICREstAPI Stories
SPAM-49
 - For saving inputs
SPAM-345
 - For enroll/unenroll emails
Example user story – this can be removed once stories are created – 
PLEASE LINK STORIES HERE
User Story
As a user managing AutoPay contribution settings, I want the system to dynamically display and populate the contribution amount based on whether the contribution type is dynamic (e.g., mapped to a column like Doctors) or fixed (e.g., TFB), so that I can accurately include the correct contribution in AutoPay and ensure compliance with business rules.
Acceptance Criteria
Dynamic Contribution Amount (e.g., Doctors)
When the contribution amount is dynamic and mapped to a column, the system must:
Populate the DOCPAC contribution amount with the value from the parent invoice type invoice that has the closest upcoming AutoPayCollectionDate.
If multiple invoices have the same closest AutoPayCollectionDate, do not display the contribution amount panel.
The panel should display:
"Set Include DOCPAC contribution to default value (I wish to support DOCPAC)"
Contribution type radio button is required before saving, is not pre-selected, and its value must be posted back to the server.
Fixed Contribution Amount (e.g., TFB)
When the contribution amount is fixed, use the fixed amount from the CRM.
The panel should display:
"Set Include AGFUND in AutoPay to yes (default)"
No Contribution Value
If no value exists in the mapped column for the contribution amount, do not display the contribution amount area/panel on the page.
Validation
The contribution type radio button must be required and not pre-selected.
Attempting to save without selecting a contribution type should prevent submission and display a relevant error message.
Documentation
Update user documentation to explain:
How the contribution amounts are populated.
The behavior in cases of multiple invoices with the same collection date.
The required steps for users to select and save their contribution type.
Scenarios
Scenario 1: Dynamic Contribution with Single Closest Invoice
gherkin
wide
760
Given a parent invoice type with multiple invoices
And each invoice has an AutoPayCollectionDate
When the AutoPay configuration panel loads
And there is a single invoice with the closest upcoming AutoPayCollectionDate
Then the DOCPAC contribution amount is populated from that invoice's mapped column
And the panel displays "Set Include DOCPAC contribution to default value (I wish to support DOCPAC)"
And the contribution type radio button is not pre-selected and is required before saving

When the user selects a contribution type radio button and saves
Then the selected value is posted back to the server

When the user attempts to save without selecting a contribution type
Then an error message is displayed and the form is not submitted
Scenario 2: Dynamic Contribution with Multiple Closest Invoices
gherkin
wide
760
Given there are multiple invoices with the same closest upcoming AutoPayCollectionDate
When the AutoPay configuration panel loads
Then the DOCPAC contribution amount area/panel is not displayed
Scenario 3: Fixed Contribution Amount
gherkin
wide
760
Given the contribution amount type is fixed (e.g., TFB)
And there is a fixed amount defined in the CRM
When the AutoPay configuration panel loads
Then the panel displays "Set Include AGFUND in AutoPay to yes (default)"
And the fixed amount is displayed as the contribution value
Scenario 4: No Contribution Value Present
gherkin
wide
760
Given there is no value in the mapped column for the contribution amount
When the AutoPay configuration panel loads
Then the contribution amount area/panel is not displayed
Scenario 5: Documentation Verification
gherkin
wide
760
Given updated user documentation is available
When a user reviews the documentation
Then it explains how contribution amounts are determined and displayed
And it covers edge cases (e.g., multiple invoices, missing values)
And it details the required steps for saving contribution type
Story Point Estimate
3
Layercake
Major Enhancements | Investment to deliver material value within existing products | Payments & Presentment: SSO - Phase II; Payment Plans - Phase I; Payment Analytics with Vista Framework
Release Summary
This release introduces logic to dynamically populate and display contribution amounts on the AutoPay configuration panel based on invoice data or CRM configuration. It enhances usability by enforcing contribution type selection and improves compliance with business rules. Documentation is updated to reflect new behaviors.
Deployment Checks
Verify that the DOCPAC contribution panel appears only when there is a single closest invoice with a mapped contribution value.
Confirm that the contribution type radio button is required and not pre-selected.
Confirm that saving without selecting a contribution type is prevented with an appropriate error.
Ensure the AGFUND panel displays the fixed amount correctly when applicable.
Validate that the contribution amount panel does not display when no value exists in the mapped column.
Review updated documentation for completeness and clarity.
 URL:/spaces/PE/pages/4488396921/AutoPay+Donations+DOCPAC+Contributions