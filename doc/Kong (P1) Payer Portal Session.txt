Kong will be used to move the bearer token to and from a HTTP only cookie and the authorization header.
BFF Token API Transformers (Token → Cookie)
Below are the plugins and settings used to move the JWT token from the response header 
X-Token
 to a HTTP only cookie 
api-session
Route
/payer/ui/auth/v1/tokens
Request Transformer
config.replace.url
/payer0/otp/api/v1/payertokens
Response Transformer
config.remove.json
token
 
Post Function
config.header_filter
local token =  kong.response.get_header("x-token") local expiresIn =  kong.response.get_header("x-expiresin") if token then kong.response.set_header("Set-Cookie", "api-session=" .. token .. "; Mag-Age=" .. expiresIn .. "; Domain=invoicecloud.com; Secure; HttpOnly") kong.response.clear_header("X-Token") end
BFF API Request Transformers (Cookie → Authorization Header)
Below are the plugins and settings used to move a request cookie JWT token to the authorization header bearer scheme.
Route
~/payer/ui/branding/$(?<path>.+)
Request Transformer 
config.add.headers
Authorization:$((function() local value = headers["cookie"] if value then return "bearer " .. value:sub(13) end return "" end)())
config.removeheaders
cookie
config.replace.url
/payer0/pyrbrnd/$(uri_captures['path'])
HTTP Client Logs
Authentication API Trace
The request is proxied to the backend API, the response is transformed, and returned to the client.  The JWT token is removed from the JSON body and sent as a response cookie.
POST /payer/ui/auth/v1/tokens HTTP/1.1
Content-Type: application/json
Accept: text/plain
User-Agent: PostmanRuntime/7.32.3
Cache-Control: no-cache
Postman-Token: 0f60607b-0ea5-4505-b28d-9c491fe4e3e3
Host: api.dev.invoicecloud.com
Accept-Encoding: gzip, deflate, br
Connection: keep-alive
Content-Length: 207
 
{
"billerGuid": "B8F1FA83-2719-4CDA-A7C6-BAF5DA55DD33",
"userGuid": "3871ED85-5FD6-4C94-943D-D96AF3C8CB11",
"timestamp": "1692713472",
"hmac": "NXWObztXWEoCwikOvwl+ysCUsijmNVi4N9veruIYZoE="
}
 
HTTP/1.1 200 OK
Content-Type: application/json; charset=utf-8
Transfer-Encoding: chunked
Connection: keep-alive
Date: Tue, 22 Aug 2023 14:11:31 GMT
X-Expires: 1692715291
X-ExpiresIn: 1800
Strict-Transport-Security: max-age=15724800; includeSubDomains
Set-Cookie: api-session=eyJhbGciOiJSU0EtT0FFUCIsImVuYyI6IkEyNTZDQkMtSFM1MTIiLCJ0eXAiOiJKV1QiLCJjdHkiOiJKV1QifQ.rKFOworB520d3MFh9wkqsmyFL9PEQiL7Cz3Gr-qA3YSORgui6MiuONCM_7hwgQMYXjE9d4eSkF9Zz_WTnoLAKqazxiJdMnXTJaxvith-oHebUO9H4mjqQ-J04jpkJ2RHgvch3bfzt1_EwwTD32lqikTnyG_6Y1bGOUhmVdbxJDtP2HWvF_qjuP_IRJvf8XzOpESA88sCH13zSb_DfvO_TzWJ5Hh7QsVM55FupiAcxRbhcTSMUR5f8gvDwc5GKPfUGjI1v4WPxag5Zio0Nc3-JLD1KPJUfeJXINjRU_9Z1JLWhhqSiKfjQXQh2PuGKgW1y-JSL3byIAv1WqRdiBG2YQ.qYKCqNr4xhtdIYYwh9vSug.495pP-sxI3dVtVl_y7jeCvtZY6uVwJ0Lm1MxV-pc4SswiS3oz0EpS8ykd-GiDuXB8n2Mpao0fwHjdEyPIkEWMpgTQkjSOyxe8woYP52WvgKc-4Lz6DsTSidTpdLHVSmoyQlRnowdUVCFpbtNQBFRPo6xRmXDVZavd6-NeH5nV3078n8NmSI5iW3XczSeCKmwkwHWtBwwdBnP7PjdX73fqMnsdrEY_w06_j95bBslgKlMO0SdCevPQ5UW-XxnywlZVotU1rtm1FkWbDXBi5clYwuXZ2_vAQyz6cuKx7hrxM8dDUIA31Vyk2mPiPvIWHoTO6rDAKwLnlHFq_VIL-QNHQDWbTBAqf47MvdgNOf2WiaRql5EphGHT_IXOhpxLRBVMFZWGPd4-1ibzeorHD60Uv9KKxyuWYhe969RCUoba-nimJ8T2Wrz4H2ErH-xdmUQihhxvjrI3jfbTzsJSPVGpF0WYuRPvk6KUf6ZoSHYXMLPjWtuxUEoAD-4AJgmqLsVKdgMF1jDQvnPw-l3KcJxHG3Pvh5NdMGJG-VHesIm3mQOUgnof37iDuO8DI3O6--84ek2oC7KdCfWpk1kVOC3LoKq7aCApmYhua_P9CmYN5uookE11YYg1e3IcIeS_4gRCHbR-lkmH6TvQDpcTKE_-bC2cbbOxjGIYp_DcHP3Eu6J_lLjZqM5yQODkB-slwnUPNH6vEFr13jzJknvmTDtog7RlsMSzGFXwwOqbc9Me3xUT9WidPTOFystIS8i5wslocVMHvDidDT3XulcLdVeEsfvG7mCpWV1MM0AZu1FSm5ql7AUZJI_mpdo5zqNbnOyygTsdNGL9AGYlQTbPFKvbcWatQJCIz7cbxW9UVbP8RhcFCi1huCIaOOXO7Lvf9bqWg7kkPbF_YqQXM8Yr-G0iZbU7EtET4QPqqRACgzdtDA2s1WAjxYI-ilXIWyY7ecpedfIgtjmiie2w-qOEeiDZhqmQP0U8DFAykCJAUoZ8Hpgs8BRa3F0vHYmclL2xF5yDK_x6lYpchHlOJ4zgxPIAnnD8x2se9lZNGYAt0mjLd20StGX6K0mQnsZzswSQZbXpcnZGXR7DWZIUKXlRZgm8WK3ZvuXm4twcXJDQStBM39v0v46LNlf5YCsSV8llMUiROGgHG5oXp31IVPk_hkkDSGjqOq5HNt5Gg3f08NZb-IIe_D4Y_MWlssbhXBcKZYBk-DEBq3iU4qhnA2jkaTonQ_32h7rxqCOyuqzzPiqaN6q-o7dGnCNiv8RnbqFQ8DYeWSrdRkuU2aZj8TPEXLFkNOzolq315dEjjmJ9ExzD-U.3bhbAYBoZdDT4BdoKjgtf_q0JqGqK7f7kw2d7gMf2vs; Mag-Age=1800; Domain=invoicecloud.com; Secure; HttpOnly
 
{"expiresIn":1800,"expires":1692715291}

API (Non Auth) Trace
The request is sent,  request is transformed, and proxied to the backend API.   The cookie is removed and sent as the authorization header in the bearer scheme to the backend API.
GET /payer/ui/accounts/api/v1/accounts HTTP/1.1
Accept: text/plain
Cookie: api-session=eyJhbGciOiJSU0EtT0FFUCIsImVuYyI6IkEyNTZDQkMtSFM1MTIiLCJ0eXAiOiJKV1QiLCJjdHkiOiJKV1QifQ.k18_3gCFMvVEvdKlcwBtYw5kLMaPb0EF67nRae_1hJp0itpLUzxU1KMeaq2Yd9gVTiHDRnO8hnCNpSEzRcA596efzKGUzNb-jRog_eusWedfVzu4DO5ZgHdeobYVeFM6pH3khxqPqkupiZraztgYIknBR6LCkbQGEKwSgIS84Q6lTdTS_cMejUG_wWDC7LoG1jpr4pOG-XzjfrIsgimO3btpyl1HGV81A8a-BDy277qNM6Ior9ZjTwQbMUexIUEBXWwYYB0w3TMRNgiMOMg_n6-7yhasBfgmB3_ZnDs0kzybbLmQS0gqjghpGJJuGYfl2wpKXp9WJMFWFs1QYfXsJw.u1_vePrAQYFqDzcCTJqeFw.Z6sS60745WUO5nk6XiN6kkIXuq0g3LlyE4UeWoUpB3iiaUaqL27jNivo_JgBGO26y-xIyr1EO9UsZ-CHB_QkFZfeJsK-yz8rZLn-hBhTyKc8DLLnuIWEf_3wSzJ4T4JkjErwwWi7N1Mh98n1Aa1j1Rczm1HY4_RvYghjuAeVoUZUj_0Axhk3KQmdfl_rzyncMOjph6eBXFzRSGPnZdiBKhggLfHWN69ZxPN4pErLURiKOfzetulYGSEE1tDJkcVc8F-wQ1qMFoYOe5DYTYMr2nosQHiYM4vk8d-KcIBtUZbxH0TKG1qmPRvgcTQsebXH3FVv2uP9yqRFUgpBmzKA4g13DNjA_D8Pav7lQilEZLZVP72s7X_yMF9gnnVXhOWMETWQHOF984cY2Waiz2HtaPq5oVgd-4RTjyfJ88oGkR4If4PPeiXO2oz6BG9bxo5IGk7xLidN_Nx_gvb64THwE4f-1Qlz_wdKz5aImmrylWNPta8RkYtNy4jKbtsIhNgJQQiSwe9Q7wz3B9Vq_Rg1eVd1w_gnR4140UuZxczl8F_c4hWmMUlcauMHCTwSEMXBsCB46wkx9fz1qTVGGY9-k1pOttp9GmiVjxnBBQJHWs-qfI7Kydr-SWZC79CcQm0Io3fIF-cGx5pztkEwJpzLPIL7zdi3N0wS8D34-Y_Eu32VjDpNdRG8MpZQTLR7bGn1YE8Bph6rjrsIO3K1rtJFQvXJ1yv-Pk15QTmHBeq2rJAcIgvWuXfjchip80Nx1H68gMpHY1baeBocWH1Vdo9pbZrq7c8mtZkcNV0L6ZJL9GEoOqNzsiCrdD5zWYQhpLJ1W2Or9wpnwYBZb4FJuHH7iqQAOUo4h9geL-hPrWvduX3HY6_sTUOsd-V2SH7o5Atu8Z1iZgUl_u3W1-4_2gr_o4uXUrmokIL0wPLnSDXiS59T4BkFOS_HlwiQ8eH1BpoHAeeR1-_QTMBawGNNrTd9c_DgxPy-c9tSi4m4hkRRSwC7yKw9thlKZR8rrW4OEeLxburNkM5f3f0pAQm623T8TiaSX3u_wjNFWVvYPInNJk2vVOTYs_-sXmRf0v17ybeXRuMCBYmFVUcDnhFvcUHXhEz9ZAy-TVRKEoldjZ_n8pYRG9sZP1vnefPR2rNx0LodaRHjHJpYimGm5wSJFiQwloHa-aLimLgWrlTXsSaUZ5Yug2Gz6AL8LyMvJIJHEBMoG5g-ylqs6kZsatQNDc9REmWIaSCm_PwMFdDLp4pojhzJ_A9vOxPNoNGTAXyqrMH-5UIp8G7_lGoLQCHckz07e8_XGlF-pBM3ZOWaQAarVL8.TVO5PAzJFu0tpsbXHo4X0yg5k1Bszse2bQndzd_nhMw
User-Agent: PostmanRuntime/7.32.3
Cache-Control: no-cache
Postman-Token: 2c402210-6bf1-446d-bee0-b0cf78318612
Host: api.dev.invoicecloud.com
Accept-Encoding: gzip, deflate, br
Connection: keep-alive
 
HTTP/1.1 200 OK
Content-Type: application/json; charset=utf-8
Transfer-Encoding: chunked
Connection: keep-alive
Date: Tue, 22 Aug 2023 17:01:07 GMT
Strict-Transport-Security: max-age=15724800; includeSubDomains
 
[{"accountGuid":"41b41c5a-dfec-4234-9099-a34e3c493081","accountNumber":"1001","displayAccountNumber":"","name":"User1","address1":"Test123"},{"accountGuid":"564b3162-9909-4e80-be54-e65db6b9ada9","accountNumber":"032620210010","displayAccountNumber":"","name":"MilkMan Ten","address1":"Address 10"},{"accountGuid":"fd9c1bac-d260-4028-b778-bd67f448e771","accountNumber":"032620210006","displayAccountNumber":"","name":"MilkMan Six","address1":"Address 06"}]
 URL:/spaces/EN/pages/2764865563/Kong+P1+Payer+Portal+Session