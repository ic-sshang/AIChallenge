Description
Currently there is an ongoing issue in terms of timing performance for invoice file conversions due to “Apply Global Bif Customizations” being enabled. This does cause a slowdown with the overall process and can cause some large files to take a significantly longer time.
Research
Initial Studies
Something immediate to bring up about applying BIF customizations for invoice files is that file types that are built off of 
BifFileBase
 makes use of the 
clsIntegratorTools
 which contains its own logic of retrieving BIF Customizations 
and that table is required in order to write each line
. It is done by grabbing the 
dtCustom
 property that is populated b
y 
LoadCustomizations
 or 
LoadAllCustomizations
.
This is doubling the work being done and is redundant
. 
Adding more restrictions to file types that are built from 
BifFileBase
 will retain good functionality and the expected improved performance of similarly not having “Apply Bif Customizations” enabled.
Profiler Investigation
(Credits to 
)
Using a 12mb file (sampled from BIF-480), the timing can be seen in the profiler below that (in this instance0 5 minutes of process time is being applied to a file inheriting from BifFileBase.
Profile of 
clsBifCustomizations
 based off from Main
It was discovered that the main issue present is from the multiple calls with a 
DataView
’s 
ToTable
 function inside of For Loops. These redundant calls to convert a 
DataView
 to a 
DataTable
 are causing a significant slowdown.
ParseAndReSort
CustomizeCustomerRecord
CustomizeInvoiceRecord
CustomizeInvoiceDetailRecord
ParseAndResort
 is the most aggregious as it is called after every Customize(Invoice/Customer/InvoiceDetail)Record method calls, so it exacerbates the issue.
AsciiOnly
 also causes a good deal of slowdown due to its constant substrings to grab each character.
I went to confirm what could be done to improve this and had adjusted the functions that called 
dv.ToTable
 to instead do:
vbnet
wide
760
        For q = 0 To dv.Count - 1
            With dv(q)
And refactored AsciiOnly to instead do:
vbnet
wide
760
    Private Function AsciiOnly(ByVal tmp As String) As String
        Return New String(tmp.Where(Function(c) Asc(c) >= 32 AndAlso Asc(c) < 128).ToArray())
    End Function
After refactoring the function calls, it does cause for there to a better runtime of the 
CustomizeFile
 functionality like so:
Profile of 
clsBifCustomizations
 after some minor refactoring done for testing
It effectively cut the total processing time of customizing the file from 316.52s down to 98.66s.
Conclusions
Immediate Solution
We should conduct some minor refactor to the 
clsBifCustomization
 class as one of the main time killers is due to the multiple instances where 
ToTable
 is called inside of a For Loop. This causes a great deal of processing time to be applied. We would need to apply a change for this in these code segments:
ParseAndReSort
CustomizeCustomerRecord
CustomizeInvoiceRecord
CustomizeInvoiceDetailRecord
We should also look at a minor refactor to the 
AsciiOnly
 method, as the substring consumes a lot of time and can have its runtime improved by refactoring it with:
vbnet
wide
760
    Private Function AsciiOnly(ByVal tmp As String) As String
        Return New String(tmp.Where(Function(c) Asc(c) >= 32 AndAlso Asc(c) < 128).ToArray())
    End Function
Other Options
If we want to further look at removing redundant fall through into rerunning applying BIF Customizations, we could implement a check before calling 
clsBifCustomizaiton.CustomizeFile
 to see if the “
myBaseFile
” is populated as that is the interface used for 
BifFileBase
. If it is, skip the subsequent 
CustomizeFile
 call on 
line 6688
. Currently there are no other classes that are built on that interface. This would be applied effectively to the ~600 file types, out of ~860 total.
This wouldn’t be a perfect solution as there are custom “mod” classes present that make use of 
clsIntegratorTools
 (e.g 
modACS
) to apply BIF customizations.
 URL:/spaces/PE/pages/4665147394/BIF-282+-+clsBifCustomizations+Performance+Issue