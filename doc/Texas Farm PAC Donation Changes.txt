This document outlines the initial request from Texas Farm Bureau that required changes to Donations in AgentConnect and CloudPaymentsV2. It also describes the approach taken to implement these changes and the testing procedures employed.
Next Gen First Phase of Work- Guru Card: 
https://app.getguru.com/card/coqrj57i/Political-Donations
Worked On By:
Bruno Saenz (Assignee for CloudPaymentsV2)
Katelyn Espinoza (Assignee for AgentConnect)
Michael Thorpe (Data Services Engineer)
Manuel Hernandez Naya (Reporter)
Katelyn Espinoza (Test Engineer)
Rob Hoerning (Test Engineer)
Dolly Tyagi (QA)
H N Gagan (QA)
Related Items:
EBPP-19035
2278e126-27dc-36c8-aef9-a32d91bc7ad7
System Jira
 
EBPP-20054
2278e126-27dc-36c8-aef9-a32d91bc7ad7
System Jira
 
EBPP-20212
2278e126-27dc-36c8-aef9-a32d91bc7ad7
System Jira
 
 
EBPP-20213
2278e126-27dc-36c8-aef9-a32d91bc7ad7
System Jira
 
EBPP-20082
2278e126-27dc-36c8-aef9-a32d91bc7ad7
System Jira
 
EBPP-20215
2278e126-27dc-36c8-aef9-a32d91bc7ad7
System Jira
 
EBPP-20214
2278e126-27dc-36c8-aef9-a32d91bc7ad7
System Jira
At a Glance:
Texas Farm Bureau (BID: 4037 & Test BID: 3743)
 provides an option for payers to contribute to a PAC donation during the payment process. For this reason, Texas Farm requested that AgentConnect and CloudPaymentsV2 supported donations in the payment route. Previously, AgentConnect did not support Donations while CloudPaymentsV2 did. It was decided that we would create a new 
AllowDonations
 parameter for both CloudPaymentsV2 and AgentConnect that would give billers the option to disable or enable the Donations page. 
By default, the 
AllowDonations
 parameter is set to true in CloudPaymentsV2 and set to false for AgentConnect.
Prerequisites
NOTE: At this time, only one political donation is supported at a time.
Regular Donations
Have an active donation invoice type configured in the CRM
Regular Donation configured in the CRM
 
Have a terminal configured for the donation in the CRM
Donation terminal configured in the CRM
 
PAC Donations
Have ONE active political donation invoice type configured in the CRM
Political donation configured in the CRM
Have a terminal configured for the donation in the CRM
Donation terminal configured in the CRM
 
CloudPaymentsV2
EBPP-20054
Assignee: Bruno Saenz
Repo Changed: 
ICCloudPaymentsAPI
Database Subtask: 
EBPP-20252
2278e126-27dc-36c8-aef9-a32d91bc7ad7
System Jira
 
The database changes consisted of adding the new 
AllowDonations
 column in 
dbo.CloudPaymentRequests 
table. 
The parameter is on (1) by default since CloudPaymentsV2 originally did support donations
. The new parameter was then added to the following stored procedures:
dbo.insCloudPaymentRequests
dbo.selCloudPaymentRequests
dbo.updCloudPaymentRequests
The 
AllowDonations
 parameter was added to the 
ICCloudPaymentsAPI
 repository, 
Pull Request Link
Testing Procedure
The testing procedure for this item was simply calling the CloudPaymentV2 API and then confirming that the URL provided jumped to InvoiceCloud. Test cases included:
AllowDonations
 set to false
AllowDonations
 set to true
AllowDonations
 not included in request body
Endpoint used:
CloudPaymentV2 Endpoint:
https://www.invoicecloud.com/cloudpaymentsapi/v2
Manual testing document provided by Rob Hoerning.
EBPP-20212
Assignee: Bruno Saenz
Repo Changed: 
MyIIS
The 
AllowDonations
 parameter was added to the 
MyIIS
 repository in this 
pull request.
The functionality to display the Donations Page is contained within 
CloudPayment.aspx.vb
 and 
DonationService.cs
. Within 
CloudPayment.aspx.vb
, the 
RedirectToDonationPageIfSupported
 function invokes the 
ShouldOfferDonationsToPayer
 function from 
DonationService.cs
. The 
ShouldOfferDonationsToPayer
 function has been updated with a new parameter, 
allowDonationsViaCloudPayV2
. Now, this function will return false if the 
allowDonationsViaCloudPayV2
 condition is not satisfied, which is defined as follows: the condition is considered true if the variable is set to any value other than false. This condition can be true under two circumstances: either the 
AllowDonations
 parameter in the CloudPaymentV2 API request is true, or there is an absence of a 
CloudPaymentSession
, leaving the 
allowDonationsViaCloudPayV2
 variable set to null.
Endpoint used:
CloudPaymentV2 Endpoint:
https://www.invoicecloud.com/cloudpaymentsapi/v2
Testing Procedure
The testing procedure for this item was to make CloudPaymentV2 API requests with the 
AllowDonations
 parameter set to false, true, and not included in the request.  This item was also tested in both iframe and non iframe tests. CloudPaymentV2 also has five different request types: new customer with a new invoice, non-existing customer, existing customer with an existing invoice, existing customer with the latest invoice, existing customer with a new invoice. Each of these request types were also tested with the new parameter.
Test Cases For EBPP-20212
All test cases for EBPP-20212
AgentConnect
EBPP-20082
Assignee: Katelyn Espinoza
Repo Changed: 
ICCSRConnectAPI
Database Subtask: 
EBPP-20355
2278e126-27dc-36c8-aef9-a32d91bc7ad7
System Jira
 
The database changes consisted of adding the new 
AllowDonations
 column in 
dbo.AgentConnectRequest 
table. 
The parameter is off (0) by default since AgentConnect originally did not support donations.
 The new parameter was then added to the following stored procedures:
dbo.spAgentandCloudPaymentRequest
dbo.insAgentConnectRequest
In the 
ICCSRConnectAPI
, the new parameter was added in this 
pull request
.
Testing Procedure
The testing procedure for this item was simply calling the two AgentConnect API endpoints and then confirming that the URL provided jumped to InvoiceCloud. Test cases included:
AllowDonations
 set to false
AllowDonations
 set to true
AllowDonations
 not included in request body
Endpoints used:
AgentConnect One Time Payment URL: 
https://www.invoicecloud.com/agentconnectapi/OneTimePayment/GenerateOneTimePaymentUrl
AgentConnect Endpoint:
https://www.invoicecloud.com/agentconnectapi/
Manual testing document provided by Rob Hoerning.
EBPP-20215
Assignee: Katelyn Espinoza
Repo Changed: 
MyIIS
The 
AllowDonations
 parameter was added to 
MyIIS
 in this 
pull request.
The functionality to display the Donations Page is contained within 
CloudPayment.aspx.vb
 and 
DonationService.cs
. Within 
CloudPayment.aspx.vb
, the 
RedirectToDonationPageIfSupported
 function invokes the 
ShouldOfferDonationsToPayer
 function from 
DonationService.cs
. The 
ShouldOfferDonationsToPayer
 function has been updated with a new parameter, 
allowDonationsViaAgentConnect
. Now, this function will return false if the 
allowDonationsViaAgentConnect
 condition is not satisfied, which is defined as follows: the condition is considered true if the variable is set to any value other than false. This condition can be true under two circumstances: either the 
AllowDonations
 parameter in the CloudPaymentV2 API request is true, or there is an absence of a 
CloudPaymentSession
, leaving the 
allowDonationsViaAgentConnect
 variable set to null.
Testing Procedure
The testing procedure for this item was to make  AgentConnect API requests with the 
AllowDonations
 parameter set to false, true, and not included in the request.  This item was also tested in both iframe and non iframe tests. AgentConnect also had to endpoints to test: regular AgentConnect endpoint and the one-time payment endpoint. Each of these endpoints were tested with the new parameter.
Endpoints used:
AgentConnect One Time Payment URL: 
https://www.invoicecloud.com/agentconnectapi/OneTimePayment/GenerateOneTimePaymentUrl
AgentConnect Endpoint:
https://www.invoicecloud.com/agentconnectapi/
Manual testing document provided by Rob Hoerning.
Test Cases For EBPP-20215
Test Cases for EBPP-20215
 URL:/spaces/PE/pages/3400105986/Texas+Farm+PAC+Donation+Changes