EBPP-26149
2278e126-27dc-36c8-aef9-a32d91bc7ad7
System Jira
 
Summary Table
Transaction Type
Condition
Redirection (ReceiptUrl)
Email Queued
Existing Customer
 (CreateCustomerRecord = True)
CustomerList has only valid customers (CustomerID ≠ 0)
Single invoice type: 
 ReceiptUrl = 
cartpaymentconfirmation.aspx?...
 
Multiple invoice types: 
 ReceiptUrl = 
Confirmation.aspx?...
Confirmation page queues a consolidated receipt via clsPayments.AddCloudPaymentConsolidatedQueue (EmailQueueTypeID = 112)
Non‑Existing Customer
 (CreateCustomerRecord = False)
CustomerList contains a placeholder (CustomerID = 0)
ReceiptUrl is set to an empty string (avoiding redirection to the consolidated receipt pages)
Review page queues an individual receipt via clsPayments.AddCloudPaymentToReceiptQueue (EmailQueueTypeID = 41); CloudPaymentConfirmation.aspx handles fallback for nonexistent customers
– Will add detailed breakdown of these 2 possible flows, there are too many variables
Proposal 1: Add a Uniqueness Check in the Stored Procedure
Since both methods (for individual and consolidated receipts) call the same stored procedure (insEmailQueue) with different parameters, we could modify the SP so that it “short-circuits” an insert when a duplicate is detected. For example:
Define What Constitutes a Duplicate:
– A duplicate might be defined as an entry for the same PaymentID (passed as FKID), for the same EmailQueueTypeID, and to the same EmailRecipient.
– Optionally, we could also consider InvoiceTypeID or RecTypeID if needed
Proposal 2: Track Receipt Queuing In-Code
We’ve established that the issue is likely the way our review and confirmation pages each send out receipt emails on different conditions. One approach would be to track these events in memory (thru session or similar), so that we don’t send out duplicate receipts (consolidated or otherwise) then clean up at  the end of confirmation.
 URL:/spaces/PE/pages/4034134017/SPIKE+-+EBPP-26149+-+receipt+duplication