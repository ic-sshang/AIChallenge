Prerequisites
Please read the following documents to gain a better understanding of the architecture:
Data-Access-On-Applications - Overview
 
Secret Management - Overview
 
Secret Management - Retrieving Secrets On Azure Resources
 
Use the IC.Database NuGet package.
The NuGet package IC.Database can be found in our private NuGet feed. This library is the backbone of our Database Service.
We should only use this library if we encounter the following scenarios: 
The application is running outside of our network.
  Examples are: 
Azure Functions
Azure Batch jobs
Azure Web Apps
We have a serious performance reason as to why the database service is not sufficient for the application.
  Examples:
My dataset is too large to get a response back from the database service in time. 
We may have jobs that run every 5 minutes, and the expectation for that job is to finish within the 5-minute window. 
  Having a direct call to the database may improve the performance of the application. 
My application will run in many instances, and each instance will perform a multishard call every x minutes. 
  We can remove the strain of heavy calls from the Database Service by moving the database call inside the application. 
  This will help the app's performance and overall system health. 
Additional information
When downloading the NuGet package, there will be an XML transform applied to your web.config or app.config.
This transform will inject connection string values required for a fallback approach if AAD is down. 
Flow
The client application will obtain a Managed Identity from a Key Vault (or via PowerShell by accessing the Managed Identity resource via the Azure CLI). This id will be used to talk to the Azure token service. 
The token service will return an Access Token. 
The token will be stored in an internal cache. 
The cache will be a singleton so it will be used throughout the application. 
The cache will request a new token from the Azure token service when it reaches the TokenExpirationOffset threshold.
  Basically (ExpirationDate - TokenExpirationOffset ) < Now. 
The token will then be used to authenticate with SQL when making a new SQL Connection. 
Data will be returned to the caller. 
Required NuGet packages
Please use the 1.* versions as 2.* versions are in beta.
IC.Database.
IC.Database.Authentication
IC.Azure.keyVault
Code Samples
*.config appSetting keys
xml
    <appSettings>
        <add key="UseManagedIdentity" value="true">
        <!-- Set to true if using Managed Identities for KeyVault/Token -->
        </add>
        <add key="ClientId" value="">
        <!-- ClientId value used for Azure Key Vault access or Azure Token creation -->
        </add>
        <add key="VaultName" value="icappsettingsdevtest">
        <!-- VaultName value to be used for the Azure Key Vault that will be accessed -->
        </add>
        <add key="TokenExpirationOffset" value="30">
        <!-- TokenExpirationOffest used for expiration time of tokens created -->
        </add>
    </appSettings>
    <connectionStrings>
        <add name="DBLIVE" connectionString="Junk">
        <!-- Connection string used by IC.Database -->
        </add>
        <add name="DBPDF" connectionString="Junk">
        <!-- Connection string used by IC.Database -->
        </add>
        <add name="JITBITHELPDESK" connectionString="Junk">
        <!-- Connection string used by IC.Database -->
        </add>
        <add name="DBDATAWAREHOUSE" connectionString="Junk">
        <!-- Connection string used by IC.Database -->
        </add>
        <add name="DBPERFLOGGING" connectionString="Junk">
        <!-- Connection string used by IC.Database -->
        </add>
        <add name="ICGATEWAY" connectionString="Junk">
        <!-- Connection string used by IC.Database -->
        </add>
        <add name="ICGATEWAYTEST" connectionString="Junk">
        <!-- Connection string used by IC.Database -->
        </add>
        <add name="ICGATEWAYAUDIT" connectionString="Junk">
        <!-- Connection string used by IC.Database -->
        </add>   
    </connectionStrings>   
This is a code sample for 
http://VB.NET
 . 
vbnet
    Imports IC.Database
    Imports Auth = IC.Database.Authentication
    Imports IC.Azure.KeyVault
    Imports IC.Interfaces 

    Public Class Database
        Private Shared _proxy As DatabaseProxy = Nothing
        Public Shared Property TokenProvider As IC.Interfaces.ITokenProvider
        Shared Sub New()
            ' Get values from app.config using SettingsService
            Dim clientId As String = SettingsService.Instance.GetSetting("ClientId")
            Dim vaultName As String = SettingsService.Instance.GetSetting("VaultName")

            ' Create DatabaseProxy using token provider and keyvault
            TokenProvider = New Auth.DatabaseTokenProvider(clientId)

            Dim dbOptions As DatabaseOptions = New DatabaseOptions With {
                                    .AzureSqlAuthTokenService = TokenProvider,
                                    .KeyVaultClient = KeyVaultClient.Instance.GetKeyVault,
                                    .SettingsService = SettingsService.Instance
                                    }

            _proxy = New DatabaseProxy(dbOptions)
            _proxy.ApplicationName = "MyAppName"
        End Sub

        Public Shared Function GET_DATASET(SQL As String, BillerID As Integer, Optional CommandTimeout As Integer = 600000) As DataSet
            Return _proxy.GET_DATASET(SQL, CommandTimeout, BillerID)
        End Function

        Public Shared Function GET_DATATABLE(SQL As String, BillerID As Integer, Optional CommandTimeout As Integer = 600000) As DataTable
            Return _proxy.GET_DATATABLE(SQL, CommandTimeout, BillerID)
        End Function

        Public Shared Function EXECUTE_COMMAND_NONQUERY(SQL As String, BillerID As Integer, Optional CommandTimeout As Integer = 1800) As Integer
            Return _proxy.EXECUTE_COMMAND_NONQUERY(SQL, CommandTimeout, BillerID)
        End Function

        Public Shared Function GET_DATATABLE_MULTISHARD(SQL As String, list As List(Of Integer), Optional CommandTimeout As Integer = 600) As DataTable
            Return _proxy.GET_DATATABLE_MULTISHARD(SQL, CommandTimeout, list)
        End Function

        Public Shared Function EXECUTE_COMMAND_SINGLE_RESULT(SQL As String, BillerID As Integer, Optional CommandTimeout As Integer = 600) As String
            Return _proxy.EXECUTE_COMMAND_SINGLE_RESULT(SQL, CommandTimeout, BillerID)
        End Function
    End Class

    Public Class SettingsService : Implements IC.Database.ISettingsService

        Public Function UseManagedIdentity() As Boolean Implements ISettingsService.UseManagedIdentity
            Return Configuration.ConfigurationManager.AppSettings("UseManagedIdentity")
        End Function
        Public Function GetConnectionString(name As String) As String Implements ISettingsService.GetConnectionString
            Return Configuration.ConfigurationManager.ConnectionStrings(name.ToUpper()).ConnectionString
        End Function
        Public Function GetSetting(key As String) As String
            Return Configuration.ConfigurationManager.AppSettings(key)
        End Function
        Private Shared _instance As New Lazy(Of SettingsService)(Function()
                                                                    Return New SettingsService()
                                                                End Function)
        Public Shared ReadOnly Property Instance As SettingsService
            Get
                Return _instance.Value
            End Get
        End Property
    End Class 

    Public Class KeyVaultClient
        Private Shared _instance As KeyVaultClient = Nothing
        Private Property azureKeyVaultClient As IKeyVaultReader

        Private Sub New()
            ' Get values from app.config using SettingsService
            Dim clientId As String = SettingsService.Instance.GetSetting("ClientId")
            Dim vaultName As String = SettingsService.Instance.GetSetting("VaultName")

            ' If there is no clientId use DefaultIdentity else use ManagedIdentities
            If String.IsNullOrWhiteSpace(clientId) Then
                azureKeyVaultClient = KeyVaultReader.CreateFromDefaultIdentity(vaultName)
            Else
                azureKeyVaultClient = KeyVaultReader.CreateFromManagedIdentity(vaultName, clientId)
            End If
        End Sub
        Public Shared ReadOnly Property Instance() As KeyVaultClient
            Get
                If _instance Is Nothing Then
                    _instance = New KeyVaultClient()
                End If
                Return _instance
            End Get
        End Property
        Public Function GetKeyVaultValue(accessKey As String) As String
            Return azureKeyVaultClient.GetSecret(accessKey)
        End Function
        Public Function GetKeyVault() As IKeyVaultReader
            Return azureKeyVaultClient
        End Function
    End Class
This is a code sample for C#. 
c#
    using System;
    using System.Collections.Generic;
    using System.Diagnostics;
    using System.Globalization;
    using System.IO;
    using System.Linq;
    using System.Reflection;
    using System.Runtime.CompilerServices;
    using System.Security;
    using System.Text;
    using System.Threading.Tasks;
    using Microsoft.VisualBasic;
    using IC.Database;
    using Auth = IC.Database.Authentication;
    using IC.Azure.KeyVault;
    using IC.Interfaces;

    public class Database
    {
        private static DatabaseProxy _proxy = null/* TODO Change to default(_) if this is not a reference type */;
        public static IC.Interfaces.ITokenProvider TokenProvider { get; set; }
        public static Database()
        {
            // Get values from app.config using SettingsService
            string clientId = SettingsService.Instance.GetSetting("ClientId");
            string vaultName = SettingsService.Instance.GetSetting("VaultName");

            // Create DatabaseProxy using token provider and keyvault
            TokenProvider = new Auth.DatabaseTokenProvider(clientId);

            DatabaseOptions dbOptions = new DatabaseOptions()
            {
                AzureSqlAuthTokenService = TokenProvider,
                KeyVaultClient = KeyVaultClient.Instance.GetKeyVault(),
                SettingsService = SettingsService.Instance
            };

            _proxy = new DatabaseProxy(dbOptions);
            _proxy.ApplicationName = "MyAppName";
        }

        public static DataSet GET_DATASET(string SQL, int BillerID, int CommandTimeout = 600000)
        {
            return _proxy.GET_DATASET(SQL, CommandTimeout, BillerID);
        }

        public static DataTable GET_DATATABLE(string SQL, int BillerID, int CommandTimeout = 600000)
        {
            return _proxy.GET_DATATABLE(SQL, CommandTimeout, BillerID);
        }

        public static int EXECUTE_COMMAND_NONQUERY(string SQL, int BillerID, int CommandTimeout = 1800)
        {
            return _proxy.EXECUTE_COMMAND_NONQUERY(SQL, CommandTimeout, BillerID);
        }

        public static DataTable GET_DATATABLE_MULTISHARD(string SQL, List<int> list, int CommandTimeout = 600)
        {
            return _proxy.GET_DATATABLE_MULTISHARD(SQL, CommandTimeout, list);
        }

        public static string EXECUTE_COMMAND_SINGLE_RESULT(string SQL, int BillerID, int CommandTimeout = 600)
        {
            return _proxy.EXECUTE_COMMAND_SINGLE_RESULT(SQL, CommandTimeout, BillerID);
        }
    }

    public class SettingsService : IC.Database.ISettingsService
    {
        public bool UseManagedIdentity()
        {
            return System.Configuration.ConfigurationManager.AppSettings("UseManagedIdentity");
        }
        public string GetConnectionString(string name)
        {
            return System.Configuration.ConfigurationManager.ConnectionStrings(name.ToUpper()).ConnectionString;
        }
        public string GetSetting(string key)
        {
            return System.Configuration.ConfigurationManager.AppSettings(key);
        }
        private static Lazy<SettingsService> _instance = new Lazy<SettingsService>(() =>
        {
            return new SettingsService();
        });
        public static SettingsService Instance
        {
            get
            {
                return _instance.Value;
            }
        }
    }

    public class KeyVaultClient
    {
        private static KeyVaultClient _instance = null;
        private IKeyVaultReader azureKeyVaultClient { get; set; }

        private KeyVaultClient()
        {
            // Get values from app.config using SettingsService
            string clientId = SettingsService.Instance.GetSetting("ClientId");
            string vaultName = SettingsService.Instance.GetSetting("VaultName");

            // If there is no clientId use DefaultIdentity else use ManagedIdentities
            if (string.IsNullOrWhiteSpace(clientId))
                azureKeyVaultClient = KeyVaultReader.CreateFromDefaultIdentity(vaultName);
            else
                azureKeyVaultClient = KeyVaultReader.CreateFromManagedIdentity(vaultName, clientId);
        }
        public static KeyVaultClient Instance
        {
            get
            {
                if (_instance == null)
                    _instance = new KeyVaultClient();
                return _instance;
            }
        }
        public string GetKeyVaultValue(string accessKey)
        {
            return azureKeyVaultClient.GetSecret(accessKey);
        }
        public IKeyVaultReader GetKeyVault()
        {
            return azureKeyVaultClient;
        }
    }

Troubleshooting
Access Issues?
Please refer to this guide: 
Authentication-Troubleshooting.md
 URL:/spaces/ED/pages/2806284403/Using+the+IC.Database+Nuget+Package