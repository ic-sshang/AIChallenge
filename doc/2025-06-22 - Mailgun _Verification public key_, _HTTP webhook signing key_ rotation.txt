Library 
ICFramework.Email
 uses these 2 values.  Newer versions pull these values from Azure Keyvault.  Unfortunately old versions that are not in nuget exist out there and those are accessing these values from the host config file.  Any repository using this library needed to be reviewed.
1
6
false
default
list
true
Repo Analysis (6/20)
Repository
Tony Analysis (6/20)
Action
EmailQueueProcessor
ICFramework.Email uses public/private keys in vault that match config values.  Keyvault values need rotation
Redeploy after key change as AZ Function requires it to refresh values
EmailQueueProcessing
ICFramework.Email uses public/private keys in vault that match config values.  Keyvault values need rotation
Restart app after key change
ICRedirect
ICFramework.Email uses public/private keys in vault that match config values.  Keyvault values need rotation
Restart app after key change
ICCRM
ICFramework.Email uses public/private keys in vault that match config values.  Keyvault values need rotation
Restart app after key change
MyIIS
ICFramework.Email uses public/private keys in vault that match config values.  Keyvault values need rotation
Restart app after key change
BillerPortal
ICFramework.Email uses public/private keys in vault that match config values.  Keyvault values need rotation
Restart app after key change
ICRTDRService
Used a non-nuget version of ICFramework.Email that reads the values from config file and not keyvault.  The config values will need to be replaced with the new values or upgrade the icframework.email reference to use the nuget version that uses keyvault.  Proj already has the IC.Azure.Keyvault reference so we can just upgrade ICFramework.email to the nuget version and pass in the keyvault reference to it.
Update code to use latest ICFramework.Email that reads from keyvault.  Deploy.
Update 6/20 5:09PM - Integrations team made the change to upgrade the version but determined after PR completion that the code calling it was no longer in use.  They will add an item to the backlog to remove references to it.  This repo is no longer an issue for Sunday.
MailgunDeclineMonitor
ICFramework.Email uses public/private keys in vault that match config values.  Keyvault values need rotation
Restart app after key change
BouncedEmailMonitor
ICFramework.Email uses public/private keys in vault that match config values.  Keyvault values need rotation
Restart app after key change
BostonFileUploadConfirmation
ICFramework.Email uses public/private keys in vault that match config values.  Keyvault values need rotation
Restart app after key change
ICGenerateAgentReport
Used a non-nuget version of ICFramework.Email that reads the values from config file and not keyvault.  The config values will need to be replaced with the new values or upgrade the icframework.email reference to use the nuget version that uses keyvault.  Proj already has the IC.Azure.Keyvault reference so we can just upgrade ICFramework.email to the nuget version and pass in the keyvault reference to it.
Update code to use latest ICFramework.Email that reads from keyvault.  Deploy.
Analysis Summary
9 of 11 code repositories have versions of 
ICFramework.Email
 that read the 2 values directly from Mailgun.  Post rotation of the values those apps need to be restarted or redeployed to pull in the latest values.
2 of 11 code repositories have versions non-existent in our nuget feed.  Simply really old versions.  Those versions read from the host config file.  I recommend we upgrade these 2 repos to use latest of 
ICFramework.Email
 and pass in the pre-existing keyvault instance.  This will level up these apps to what the rest of the apps do, and read the values from keyvault.  After code changes they will need to be deployed.
Changing the values in Mailgun and populating Keyvault
Go to API Security section in Mailgun Portal
Find HTTP webhook signing key section and Verification public key section
Click Refresh icon in the HTTP web hook signing key section
Click Reset Key when ready [
NOTE:  This was ineffective, at least for our use case.  See notes further down.  We did do this but ultimately we basically needed to create a new API Key.
]
Click Refresh icon in the Verification public key section
Click Reset Key when ready
Copy both values
Locate ExternalAppSettings KeyVault in Azure Portal. This is our PROD keyvault instance.
Change the values according to this mapping
MailgunAPIPublicKey
 = “Verification public key”
MailgunAPIPrivateKey
 = “HTTP webhook signing key”
Apply the same settings to the icappsettingsdevtest Keyvault.  This is our DEVTEST keyvault instance.
Sync the keyvault settings to other keyvault. See Scott for more information.  There is a pipeline that does this.
Plan Timeline
Date
Action
Notes
Before 6/22 4AM
Update the repos that require code changes
 ICRTDRService - 
 
 
 ICGenerateAgentReport - 
 
ICGenerateAgentReport PR
6/22 4AM
Rotate values in Mailgun and save to Keyvault
 
 
Started change at 4:17AM CST.  Ran into a problem.  See retro for more info.  Issue addressed.
6/22 430AM
Deploy updated versions:
ICRTDRService 
 ICGenerateAgentReport - 
 
Deployed
 ICGenerateAgentReport.  HealthCheck failed but the new one HealthCheckEmailCheck, which does set the keyvault, passed.  Eddie will update repo before next deployment so main HealthCheck calls same functionality as HealthCheckEmailCheck
Redeploy AZ Func apps:
 EmailQueueProcessor - 
 
Verified working by Mark
Restart Skybot apps:
 EmailQueueProcessing - 
 
 MailgunDeclineMonitor - 
 
 BouncedEmailMonitor - 
 
BostonFileUploadConfirmation - 
 
 
Platform Maintenance Plan
 led to Skybot scheduler being stopped.  After starting the scheduler, the apps on run will pull latest values.
Restart K8s apps:
MailgunSpamComplaints  - 
 
 BillerMailgunMessageStatusJob - 
 
Added during the call after having to change 
MailGun-ApiKey
.  Needs a keyvault sync before.  
Restart IIS apps:
ICRedirect
 ICCRM - Email Logs search just spins but we’re unsure if it’s related to the key change.  I’ve tasked Shanki/Rajesh to look into it as they have made recent changes related to Custom Email Domains project.
 MyIIS - Email validation appears to work (payment route)
 BillerPortal - Email validation appears to work (Email Recipients)
 will coordinate assistance from Platform team to restart/recycle IIS pools tied to these apps.
IIS was restarted on all servers.  
Validate functioning connectivity to Mailgun that uses the 2 values.  
Day-Of Notes
I used a modified BouncedEmailMonitor repo in my devtest AVD to be able to call functions that use the 2 keys we were rotating.  They worked as expected before key rotation.
EmailAddressValidation uses 
MailgunAPIPublicKey
EmailLogs uses 
MailgunAPIPrivateKey
Changing “Verification public key” had somewhat of a expected result.  After the change my local test continued to work.  I attributed it to some delay in rolling out the change on the Mailgun side.  Regardless, I still changed it in keyvault.  It worked after the change as well.
Changing “HTTP webhook signing key” DID NOT have the expected result.  After the change my test failed, as expected.  But once I changed the value in keyvault, the test still would not work.  I waited a bit, just in case Mailgun has some type of delay in rolling out changes like this.  After a reasonable amount of time, it still didn’t work.  
I decided to create a new API Key to see if that key would be accepted through my test.   I used that key locally and I was able to pull EmailLogs again.
There was a pre-existing API key in Mailgun that had “migrated api key” in the description.  Created in 2023.  Role was just empty.  Mailgun does not allow you to see old values.
I believe that the “HTTP webhook signing key” and the “migrated api key” values were the same.  The “HTTP webhook signing key” value matched 
MailgunAPIPrivateKey
 in keyvault.  So I thought that must’ve been the value to change.  The “migrated api key” description in the pre-existing API Key was, I believe, a hint that at some point Mailgun decided to use that value for multiple systems and to do so it had to duplicate the values, migrating it from one system to another.
Since creating a new API Key worked for my test I used this as an opportunity to create environment segmented keys
Given the deviation from plan for “HTTP webhook signing key”, we did take opportunity to create environment segmented keys which was long needed.  We now have one each for PROD and DEVTEST.  They were applied to the 
MailgunAPIPrivateKey
key in the environment keyvaults.
While I was at it I decided to delete the pre-existing API Key since I assumed that value matched the key we wanted to change.  After deleting I remembered we had a 
MailGun-ApiKey
in the keyvaults.  Turns out the value for that key also matched the one we wanted to change.  We had the same value in multiple keys.  This value is what must’ve been in the API Key I deleted.  Again I couldn’t validate.
Given that we needed a new value for the 
MailGun-ApiKey
.  I decided to use the values from the new environment-segmented api keys I created earlier.  So now 
MailgunAPIPrivateKey
 and 
MailGun-ApiKey
are the same values in the keyvaults.  
We should update ICFramework.Email repo to deprecate usage of 
MailgunAPIPrivateKey
 and instead have it pull the value from 
MailGun-ApiKey
. No point in having both keys have the same values.  
MailgunAPIPrivateKey
  basically dates back many years at a time when Mailgun supported a “private key”, probably before they introduced API Keys.  Then at some point they introduced API Keys, putting “private key” in an odd position.  To address they probably migrated the “private key” values to API keys and updated the description to have “migrated api key”.  And the old “private key” was renamed to “HTTP webhook signing key”.  This gave Users a way to rotate each individually.  
Since we unexpected had to change the 
MailGun-ApiKey
 value, MailgunSpamComplaints was added to the list of repos that needed a restart.  It was using that value.  Randy brought this up on the call.  Also added BillerMailgunMessageStatusJob that also uses 
MailGun-ApiKey
 
We need to “sync the keyvaults” using the pipeline
.  Scott took care of this during the call.  
Post Event Action Items
Through this we now know that all these apps pull their values from keyvault, nullifying the need for the values to be in the configuration file.  We should remove entries from config files to eliminate confusion.  While at it check if the other values can also be removed.  Below are the ones that definitely can be removed.
    <!-- Mailgun settings-->
    <add key="Mailgun.API.PrivateKey" value="" />
    <add key="Mailgun.API.PublicKey" value="" />
    <!-- End Mailgun settings-->
Update ICFramework.Email to eliminate use of 
MailgunAPIPrivateKey
 and replace with 
MailGun-ApiKey
.  Both values are the same in keyvault and are used for the same functionality, which is calling APIs. 
 URL:/spaces/ED/pages/4428824943/2025-06-22+-+Mailgun+Verification+public+key+HTTP+webhook+signing+key+rotation