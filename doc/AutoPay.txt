AutoPay Definition
AutoPay is a payment solution provided by Invoice Cloud to Billers and their customers. Customers can be enrolled in AutoPay for more than one invoice type or any available (AutoPay eligible) invoice type. When enrolling for AutoPay the customer must choose their default payment method as this payment method will be used to make the transaction. AutoPay will automatically bill the customers' saved payment method tied to their AutoPay enrollment on the AutoPayCollectionDate which is set by the Biller on the Invoice level. 
Triaging AutoPay issues could involve: 
The ”AutoPay” tab in the Customer Profile under the Biller Portal,
Looking into various tables such as Invoices, Payments, Adjustments, CustomerAutoPay, etc.,
Real-Time Data Refresh, 
Microsoft Azure IClogstorage, ICAutopay logs 
Biller Portal
Split Submitter Fee
If the Invoice Type for a Invoice being paid with AutoPayment is split submitter fee the transaction, payment to the convenience fee will be processed first. If the convenience fee payment is declined only a record for the convenience fee will be added to the payments table, and the 'amount due' will not be processed.
CRM Portal
There is an autopay priority setting in CRM that will take care of the priority. The AutoPayController will take care 
Useful SQL queries
 
Autopay will not process if the record is added after the AutoPayCollectionDate, this query will provide you a list of invoices that have or will fail to be processed for this reason:
select * from invoices where DateRecAdded > AutopayCollectionDate order by 1 desc
If an AutoPayment is Voided these queries will help you determine who voided it:
select * from changelogs where fkid = [PaymentID] order by 1 desc -- Find the paymentid for the voided payment, then find the logs for the change of PaymentMessage to 'Voided'

select * from billeruseractivity where daterecadded between '2023-01-30 14:41:14.360' and '2023-01-30 14:43:14.360' order by 1 desc -- Dates 1 minute apart from when the payment message was changed to void

select BillerUserID,UserFullName,UserName,EmailAddress from billerusers where billeruserid = 4039
Common queries
sql
select * from customers where accountnumber = '****'                --use this query to find the customerID

select * from pendingautopayregistrations where customerid = ****   --use this query to see if the customer has completed the autopay registration

select * from customerautopay where customerid = ****               --use this query to see the customer autopay settings

--use these query to confirm their saved payment method has been added before the autopayment date

select * from mcl.customerlogins where customerID in(85024030) -- To Get loginid
select * from customerbanks where loginid = ***                     
select * from customercreditcards where loginid = ***

-- DailyJobErrors on IC_PerfLogging
-- sql to find the errors in the DailyJobErrors table

select * from DailyJobErrors where JobErrorSourceID=1 and billerid = <Biller ID> order by 1 desc

-- Another Table to get the stats on AutoPay for the day
select * from dailyprocessingstatus order by 1 desc

-- Verify the MICR table
select * from micr where accountnumber like 'XXX0000'
-- 
sql
-- This is the query to run to identify why the invoice id was not selected for autopay

SELECT DISTINCT
	I.InvoiceID,  
	I.InvoiceGUID,  
	I.InvoiceTypeID,  
	I.InvoiceNumber,  
	I.InvoiceDate,  
	I.InvoiceDueDate,  
	I.AutoPayCollectionDate,  
	I.TotalTaxAmount,
	I.ConvenienceFee,  
	I.RefundConvenienceFeeForACH,  
	I.CreditCardServiceFee,  
	I.AchServiceFee,  
	I.PromptPayDiscountAmount,  
	I.TotalAmountDue,  
	C.CustomerID,  
	C.CustomerGUID,  
	C.AccountNumber,  
	C.CustomerName,  
	C.Address1,  
	C.Address2,  
	C.City,  
	C.State,  
	C.Zip,  
	C.Phone,  
	C.EmailAddress,  
	B.BillerID,  
	B.BillerGUID,  
	B.BillerDBA,  
	B.SafeSubscriberGUID,  
	B.SafeWebServiceKey  
	,CASE  
		WHEN CAP.DefaultCreditCardID > 0 THEN CAP.DefaultCreditCardID  
		WHEN CAP.DefaultBankID > 0 THEN CAP.DefaultBankID  
		ELSE 0  
		END AS FKID  
	,CASE  
		WHEN CAP.DefaultCreditCardID > 0 THEN 1  
		WHEN CAP.DefaultBankID > 0 THEN 2  
		ELSE 0  
		END AS PaymentTypeID  
	,t.SubmitterProgram  
	,CAP.LoginID
	,I.BillerInstallmentNumber
FROM   
	dbo.Invoices I   
INNER JOIN
	dbo.Customers C  ON I.CustomerID = C.CustomerID  
INNER JOIN 
	dbo.Billers B  ON I.BillerID = B.BillerID  
INNER JOIN 
	dbo.CustomerAutoPay CAP  ON I.CustomerID = CAP.CustomerID  
INNER JOIN 
	dbo.TerminalSettings AS ts ON ts.InvoiceTypeID=i.InvoiceTypeID AND ts.PaymentSourceID=15 AND ts.PaymentTypeID=(CASE WHEN DefaultCreditCardID>0 THEN 1 WHEN DefaultBankID>0 THEN 2 END)
INNER JOIN 
	dbo.Terminals AS t ON t.TerminalID=ts.TerminalID
WHERE
	B.HighVolumeAutoPay = 0  
	AND I.BalanceDue >  0 
	AND I.Active = 1  
	AND C.Active = 1  
	AND CAP.AutoPay = 1  
	AND CAP.InvoiceTypeID = I.InvoiceTypeID -- sometimes invoicetypeid on customerautopay doesn't match with invoicetypeid on invoice
	AND B.Active = 1  
	AND I.InvoiceGroupGUID IS NULL  
	AND CAST(I.AutoPayCollectionDate AS DATE) = '2022-12-15'
	AND B.BillerID = 292
	AND i.InvoiceID = 403166380
Custom Failed AutoPay Report
This report provides a list of accounts that were supposed to have AutoPay processed on a 
specific past date
. 
Please 
make sure you understand how temporary tables work before running this report, if you have any questions ask 
 .
sql
--To clear the temp tables
drop table #elegible
drop table #trx
--Eligible Invoices for AutoPay
select distinct i.*
into #elegible
from invoices as i
inner join customerautopay as ca on  i.customerid = ca.customerid
where i.autopaycollectiondate between '2022-12-01 00:00:00.000' and '2022-12-02 00:00:00.000'
and ca.autopay=1
and i.totalamountdue > 0
and ca.autopayregdate < '2022-12-01 00:00:00.000'
--Processed Transactions
select * 
into #trx
from payments as p 
where p.invoiceid in (
	select e.invoiceid from #elegible as e
	)
and paymentsourceid = 15
and termid !=4 -- Terminal for fees

--Failed Invoices
select * from #elegible as e
where e.invoiceid not in (select t.invoiceid from #trx as t)

-- Report
select 
c.AccountNumber,c.CustomerName,t.PaymentAmount, t.PaymentDate, 
case when paymentamount is null
	 then 'Failed'
	 else 'Completed'
end as AutoPayProcess
from #elegible as e
left join #trx as t on e.invoiceid = t.invoiceid
left join customers as c on e.customerid = c.customerid

Transactions Report (Payments and Adjustments)
This query is to find all the related payments and adjustments for one invoice, and rep-orts them in a single table. If you have any questions about the query below please reach out to 
 .
sql
-- Execute all the code below together
DECLARE @invoiceid AS Integer
SET @invoiceid = 17306 -- Input the invoiceid in question.

select paymentid as FKID,
InvoiceID,
paymentdate as TransactionDate,
paymentamount as TransactionAmount,
paymenttypedesc as TransactionType,
paymentdescription as TransactionDescription,
paymentsourcedesc as TransactionSource

from payments as p
left join tblpaymenttype as pt on p.paymenttypeid = pt.paymenttypeid
left join tblpaymentsource as ps on p.paymentsourceid = ps.paymentsourceid
where invoiceid =@invoiceid

union

select adjustmentid as FKID,
InvoiceID,
adjustmentdate as TransactionDate,
adjustmentamount as TransactionAmount,
concat('Adjustment-',AdjustmentTypeDesc) as TransactionType,
adjustmentdesc as TransactionDescription,
um.uploadmethoddesc as TransactionSource

from adjustments as a
left join tbladjustmenttype as at on a.adjustmenttypeid = at.adjustmenttypeid
left join files_adjustments as fa on a.files_adjustmentid = fa.files_adjustmentid
left join tbluploadmethod as um on fa.uploadmethodid = um.uploadmethodid
where invoiceid=@invoiceid
order by TransactionDate desc
Code Repo’s
 
The EmailQueueProcessing repo takes part in the autopay process by sending out notification for autopay reminders, autopay declines, and autopayment success. In 
Module1.
vb, the StartProcessingEmails sub will provide all cases for email notifications. If a customer is 
signed up for autopay
, but 
no autopay reminder
 or 
payment success emails have gone out
, following the logic for case 33 (AutoPayReminderQueue.vb) should help in finding out where the process is stopping. The code primarily looks through the customer’s payment method, invoice balance, RTDR, and service fee calculation before sending out a notification.
Note: 
No email is sent when the biller removed autopay from a customers
Training and Knowledge Materials
Guru Cards:
https://app.getguru.com/card/ibXjLMgT/AutoPay-Did-not-Process
Batch Autopay Logs Video:
video1409135173.mp4
 URL:/spaces/DS/pages/2402746415/AutoPay