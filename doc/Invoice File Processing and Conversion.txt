Invoice File Processing Overview
Invoice File Processing/File Conversion is the process where a biller uploads a raw file (sometimes called a “pre-converted file”) via FTP or Stratus, and Invoice Cloud converts the raw file into an Invoice Cloud BIF (Biller Invoice File).
Note: Some Billers upload BIFs directly via FTP, Stratus, or Webservices; in this case, they will not go through our conversion process and will import as-is. 
Triaging the File Conversion process can involve using the Biller File Search Tool on the CRM, executing T-SQL Calls in our Database, and running our Stratus Web Services repository. 
Retrieving the Affected Invoice File
CRM
Invoice Files that are uploaded through FTP and the Stratus application can be found in CRM → Tools → Biller Tools → Biller File Search.
Note: Invoice Files will only appear here 24 hours after they were uploaded by the Biller. 
 
App Servers
Invoice Files that are uploaded through FTP can be retrieved from the App servers before they appear in the Biller File Search tool on the CRM. They are located in App Servers 1-8 (10.0.6.4 through 10.0.6.8) at E:\Data\AppData\Files\FTPFilesBackup and have their Biller’s ID prepended to the filename. 
Jira
If the file cannot be found with the above steps, you can ask CS if the biller can provide the file. 
Finding the File / File Format ID used for Conversion
IC_Perflogging Database
sql
SELECT TOP 100 * FROM StratusFileProcessor WHERE BillerID = XXX AND FileName LIKE 'BIF_%' ORDER BY 1 DESC
* In our IC_Perflogging Database, in the StratusFileProcessor table, the FileName Field is in the format: [FileType]_[BillerID]_[FileFormatID]_[Date]_[IP]_[FileName].[FileExtension]. The most significant fields from this filename are the FileType, FileFormatID, and the FileName. 
** IC_Perflogging is the preferred way to definitively determine what File Format was used for conversion. 
Biller’s Shard Database
sql
SELECT CustomerID FROM Customers WHERE AccountNumber = 'XXXXX'
SELECT InvoiceNumber,FileID,DateRecAdded FROM Invoices WHERE CustomerID = XXXXX ORDER BY 1 DESC
SELECT * FROM Files WHERE Fileid = XXXXX
SELECT TOP 20 * From PendingFileImports ORDER BY 1 DESC -- Use this if the file did not import at all

-- In order to make sure the file is processed or loaded into our system
SELECT * FROM Files WHERE FileName = <FileName> -- Get the fileguid
SELECT * FROM PendingFileImports WHERE FileGuid='XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX'  ORDER BY 1 DESC -- Check if the file was imported or not
SELECT * FROM ImportErrorsRealtime WHERE FileGuid='XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX' --Check for errors during import
SELECT * FROM ImportRealtime WHERE FileGuid='XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX'-- The BIF File content and this fileguid stays only temporarily 
SELECT * FROM Invoices WHERE InvoiceNumber='XXXXX' ORDER BY 1 DESC -- Did the invoice make it to the table ?
SELECT * FROM FileImportErrorHandlingLog WHERE PendingFileImportId = <PENDINGFILEIMPORTID> --Was anything wrong with the file?

-- Added Tables That Are Useful
select * from billerfileuploadv2
select * from billerfileuploaddetailsv2

-- Find if there are duplicates in the database or the file
DECLARE @FileID AS Integer
SET @FileId = 384521 -- Input the FILEID in question.

SELECT f.FileName,InvoiceNumber,AccountNumber,DupeInDataBase,DupeInFile--,Column1 AS InvoiceHeaderRow
FROM ImportInvoiceExceptionDetails d
LEFT JOIN ImportInvoiceExceptionRecords r on r.importInvoiceExceptionDetailID = d.ImportInvoiceExceptionDetailID
LEFT JOIN files f on f.fileguid = r.fileguid
WHERE fileid = @FileID 
AND r.Column1 LIKE '7~IH%'
--
Finding the File Format Code
Open the Repo ‘StratusWebServices' on the ‘Main’ branch and navigate to 
frmInvoiceUpload.aspx.vb
. This page contains a large Visual Basic 'Case’ statement containing a Case for each existing File Format ID. Simply use the Find feature (Ctrl + F) to search for the Case statement of the file format used for conversion. 
The name of the File Format will appear as a comment next to the Case statement. Take note of this name, as you will be using this for the actual conversion step.
 For example, if the FileFormatID is 75, you can use the Find feature to search for “Case 75”. In this case statement, there will be an instantiated object of the associated base Class for that FileFormatID. This object will invoke a method that will begin to process the file in question. 
For the Example above, the base class would be modMunis, the object would be MUNIS and the method would be PersonalPropertyBIF(). 
BIF File Specifications
You can find more information about which BIF spec IDs map to which fields in our database through our documentation site 
here
, under Specifications → Invoice File. 
Running StratusWebServices to Convert Files
Once you have located the code, it may be necessary to set set Breakpoints for debugging purposes. This will require running the code repository and converting the files. Follow the steps below to do this.
Clone the Repository
The Repository in question is called “StratusWebServices”. The latest branch is the “Main” branch. Make sure to open the .sln file and Fetch/Pull the latest changes. 
Locate the Invoice File Upload Page
The page is called “frmInvoiceUpload.aspx”. Right-Click this page, and select “Set As Start Page” 
Run the Project
Is it best to run this page using Google Chrome. You can change this setting using the drop-down menu next to the run button. 
If you get a message about the port already being in use, you can update the port number by right-clicking on the Solution at the top of the Solution Explorer and selecting “Open Folder in File Explorer”.  
From the File Explorer window, you can open the file named “StratusWebServices.sln” with Notepad++ and search for the field called “VWDPort“. Change or edit this value to be a different 5-digit number and save your changes. Close Notepad++ and go back to Visual Studio. A prompt may display a message saying that you need to reload the project; select Yes. 
Once all this is done, you can continue to run the project. 
Converting the File
If there are no build errors, you will see this screen: 
Ignore the text saying “Payment Export Module”, as long as the URL says they page is “frmInvoiceUpload.aspx” then you are in the right place. 
From here, search for your biller using the Biller’s name in the filed marked “Biller:” (Note: BillerIDs cannot be used for this step). Once the biller is selected, the field called “Format:” will populate with all the File Formats that the biller is setup for. Use the File Format name that you found earlier (see the portion of this document called “Finding the File Format Code” to find this information). Afterwards, use the “Import Source Path:” field to enter the location of the file that you want to convert. Include the full path of the file in addition to the filename. 
From here, all you need to do is select the “Create BIF File” button and the file will attempt to convert. If you placed any breakpoints in the conversion code, they will be hit after clicking this button.
If an exception is thrown, an error message will be displayed. If the file converts successfully, then the BIF file will be placed in the same directory as the file you converted, and the “Upload Bif Path:” field will automatically populate with the location of this BIF file. 
If, 
and only if
, you want to upload the file on behalf of the biller, then you can click the “Upload File to IC” button. Otherwise, you can ignore this button. 
You can also use the “Get MD5 Hash” button to get the MD5 hash of the raw file. The “Validate BIF” button will also provide some utility if you care to use it. 
Invoice File Import Process (Database)
The stored procedure that processes records in the ImportRealTime table is: 
ImportFileRealTimeSetBasedInv
. 
If the file was uploaded through a webservice, it will use: 
ImportFileRealTimeSetBasedInv_WS
.
 URL:/spaces/DS/pages/2517106729/Invoice+File+Processing+and+Conversion