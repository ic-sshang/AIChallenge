Overview
We implemented Google reCAPTCHA Enterprise to deter bots (except nice ones like web crawlers) from accessing our site. We use two scoring keys on multiple pages including login, registration, account/invoice search, and payment pages.
The first scoring key is used by an invisible reCAPTCHA. The presence of the invisible reCAPTCHA is noted by the badge on the bottom-right of the page. When present, once a customer performs an action (e.g., click a search or pay button), then we send a client-side reCAPTCHA token to Google for validation (server-side). If it’s valid, the customer continues. Otherwise, they will remain on the page and have to interact with a checkbox reCAPTCHA.
The second scoring key is for the checkbox reCAPTCHA. It works the same as the first: when the customer clicks the checkbox and, if applicable, passes the CAPTCHA challenge, a token is created and sent for validation. If Google still thinks this customer is a high risk (low score), i.e., invalid, then they will remain on the page and be presented with the checkbox reCAPTCHA again.
We have some nifty New Relic dashboards now:
 
New Relic One
Is reCAPTCHA rendered?
This table is how reCAPTCHA 
should work
. By “rendered”, we mean the 
ic-primary-button-recaptcha
 css class is applied to the submit button(s), which is responsible for triggering reCAPTCHA on the client. Note: some reCAPTCHA JS/HTML may be present even when the widget is disabled.
IP is whitelisted (dbmaster)
FullyDisableReCaptcha
Biller is whitelisted (web.config)
Behavior
false
false
false
render the reCAPTCHA (widget/control)
a passing score allows the payer to continue
a low/bad score will keep them on the page
true
false
false
render the reCAPTCHA (widget/control)
a passing score allows the payer to continue
a bad score allows the payer to continue (it will be annotated)
true
false
true
do not render the reCaptcha (nothing to score)
reason: biller whitelist takes precedence
true
true
false
do not render the reCaptcha
reason: disable flag is true
true
true
true
do not render the reCaptcha
reason: biller whitelist takes precedence
false
false
true
do not render the reCaptcha
reason: biller whitelist takes precedence
false
true
false
NOT A VALID SCENARIO lol (disable flag can’t be set on a non-existent record)
Known Issues
Endless CAPTCHA verification loop
Sometimes Google flags a user or IP address as suspicious. All their reCAPTCHA attempts are considered invalid, no matter how many times they pass the checkbox challenge. Unfortunately, we do not know or control the way Google identifies “high risk” users [Note: we log risk reasons for each invalid response from Google, but they aren’t obligated to provide any]. Since we cannot “un-flag” these false positives, our only option is to bypass reCAPTCHA via our code.
This often happens to biller users and agents who are going through the payment route constantly throughout the day. To bypass reCAPTCHA, we have a whitelist of IP addresses that can be updated. The file is maintained in the 
App_Data
 folder of the payer site (MyIIS): ReCaptchaAllowedIPs.txt.
To update the whitelist, follow this process:
Identify IP addresses that require whitelisting (usually static IPs for the biller’s offices / call center / etc.).
Use New Relic to identify other potential IPs to whitelist for the biller. Example query for SEMCO:
SELECT count(*) FROM Log WHERE  `entity.name` = 'ICRecaptchaAPI' AND allColumnSearch('semco', insensitive: true) AND allColumnSearch('isvalid: false', insensitive: true) AND allColumnSearch('BillerID: 309') SINCE 6 hours ago FACET Message.Properties.remoteIP
Create a Jira task or story and reach out to a team/tech lead so it can get prioritized.
The team will create a pull request to add the IPs to the text file.
Alternatively, dev support can create a pull request and escalate it to a tech lead / CRC.
Engineering will make best efforts to deploy the same day. In an emergency (VIP biller?), we may be able to modify the file during the day instead of waiting for a nightly release.
Custom Flow for NFG†
Purple
 is for server-side MyIIS actions / conditions.
Blue
 is for the client-side (browser).
Green
 
is for the ICRecaptchaAPI.
The “check if we force reCAPTCHA” condition is a simplification of the full logic involving the kill switch, whitelist text file, ForceRecaptcha setting, and database IP whitelist.
†
 Custom logic for NFG and any biller with the ForceRecaptcha setting enabled in the database
 URL:/spaces/PE/pages/2643591169/reCAPTCHA