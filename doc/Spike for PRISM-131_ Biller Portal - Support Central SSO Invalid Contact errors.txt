Objective:
To analyze and understand the existing implementation in the Biller Portal, Salesforce integration, and CRM/Biller Portal logic to ensure the following:
Allow at least one demo biller (BID 1834 - QA2) to have a Salesforce account.
Ensure Salesforce users are correctly created with a role.
Successful Single Sign-On (SSO) jump from the biller portal to Salesforce, especially when dealing with previously identified bugged users.
Refer the below confluence link for on Salesforce SSO details
:
Salesforce SSO - Development Support - Confluence
POC Details:
POC changes for MyIIS Repo has been in the 
“PRISM-131-SupportCentralSSOErrorPOC”
 branch
POC changes for IC.Salesforce Repo has been in the 
“PRISM-131-SupportCentralSSOErrorSFPOC” 
branch
POC changes for ICCRM Repo has been in the 
“PRISM-131-SupportCentralSSOErrorCRMPOC” 
branch
Current Behavior in BP:
File:
 MyIIS\BillerPortal\BillerTechnicalSupport.aspx.vb
The "Visit Support Central" button is enabled and visible for all users except IC users.
Scenarios and Behavior:
ForceLoginToSF Query String:
If the query string ForceLoginToSF is passed as 1, the system attempts to directly access Salesforce production and initiates the login process.
ICUser Flag in BillerUsers Table:
If the ICUser flag is enabled for a user in the [BillerUsers] table, the system will 
not
 display the "Visit Support Central" button on the page load for that user.
Current Behavior in CRM:
File: 
ICCRM\editForms\EditBillerUser.aspx.vb
Method:
btnSave_Click
When saving user details from CRM, we are creating the Salesforce contact.
When updating the user details, we are updating the 'Biller_Portal_User__c' field of the contact and not any other fields.
As of now this functionality not applicable for demo billers.
If a user has more than one contact, we are not updating the contact during the update process.
Changes Required for the Following Cases (Analyzed and Segregated as per Acceptance Criteria)
Case 1:
Allow at least one dev demo biller to have a Salesforce account (BID 1834 - QA2)
Current Behavior:
You can retrieve the account details by passing the biller ID as the account number to the API using the following query:
SELECT Id, AccountNumber, Name FROM Account WHERE AccountNumber = '<biller_id>'
If no account is found, an error is returned as shown in the screenshot below.
Required Modifications:
We need to create a Salesforce account using the biller ID.
Case 2:
Show a message in the biller portal for demo billers to indicate support central is unavailable
Required Modifications:
Required below modification to make the "Visit Support Central" button invisible and prevent it from being clickable
Method:
 BillerTechnicalSupport_Load
File:
 MyIIS\BillerPortal\BillerTechnicalSupport.aspx.vb
POC Code Implementation:
Public Enum DemoBillerIDs
    QA2_1834 = 1834
End Enum
If Me.CurrentBiller.DemoAccount And Me.CurrentBiller.BillerID <> DemoBillerIDs.QA2_1834 Then
    ' Make the "Visit Support Central" button invisible
    phSupportCentral.Visible = False   
    ' Show error message for demo billers
    ShowErrorMessage("Support Central is currently unavailable for demo billers.", Me.phErrorMessage)
End If
Ensure the logic is applied using enums for the biller IDs.
Add this validation in the button click event as well to prevent demo billers from interacting with the button.
If the current biller is in demo mode (i.e., DemoAccount is true), and their BillerID is not 1834 (QA2), the "Visit Support Central" button will be hidden, and demo billers will see an error message as shown in the screenshot below.
Alternate Solution for Demo Biller with Salesforce Account
:
Retrieve Account Details Using the Biller ID:
Instead of relying on the demo mode flag, we can retrieve account details by passing the biller ID as the account number to the API using the following query:
SELECT Id, AccountNumber, Name FROM Account WHERE AccountNumber = '<biller_id>'
If an account is found, proceed to show the "Visit Support Central" button.
No Account Found:
If no account is found, show an error message stating that the biller does not have a Salesforce account, and hide the "Visit Support Central" button.
If the current biller is in demo mode (i.e., DemoAccount is true), and If no account is found), the "Visit Support Central" button will be hidden, and demo billers will see an error message as shown in the screenshot above.
Modification require :
SalesforceAccountCheck Implementation:
File:
 MyIIS\BillerPortal\BillerTechnicalSupport.aspx.vb
The logic for checking if the account exists needs to be added within the BillerTechnicalSupport_Load method. This will prevent demo billers who don't have a Salesforce account from accessing Support Central.
POC Code Implementation:
If Me.CurrentBiller.DemoAccount And AccountExists(Me.CurrentBiller.BillerID) = False Then
    ' Make the "Visit Support Central" button invisible
    phSupportCentral.Visible = False   
    ' Show an error message for demo billers without Salesforce accounts
    ShowErrorMessage("Support Central is currently unavailable for demo billers.", Me.phErrorMessage)
End If
New Method for Validation: AccountExists
Private Function AccountExists(accountNumber As Integer) As Boolean
    ' Define the fields that we want to retrieve from Salesforce Account
    Dim accountFields As New List(Of String) From {
        "Id", "Name", "AccountNumber"
    }
    Dim accountFilter As String = "AccountNumber = '" & accountNumber & "'"   
    Dim accountQuery As String = "SELECT " & String.Join(", ", accountFields) & " FROM Account WHERE " & accountFilter   
    Dim accountRecords As List(Of Account) = Salesforce.Client.AccountController.GetAccounts(accountQuery)      
    If accountRecords.Count <> 1 Then
        ' If no account exists or multiple accounts are found, do not continue with provisioning
        Return False
    End If   
    ' If exactly one account is found, return True
    Return True
End Function
Case 3:
If the biller is in demo mode, do not create the user via CRM/BP (except for QA2).
Changing a biller user’s email address in the CRM/BP should update the contact email (and user?) in Salesforce
Update the IC.Salesforce library with documentation / takeaways from these issues
Current Behavior:
When a biller user's username, name, or email is updated in the CRM/Biller Portal (CRM/BP), Salesforce is not updated.
Salesforce contact and user are created only when the "Visit Support Central" button is clicked.
User Creation Logic in CRM/BP
:
The system checks if the username exists but does not validate the email or name.
Contact Query Logic
:
The following query is used to fetch contact information from Salesforce: 
SELECT AccountId, Id, Email, FirstName, LastName, Biller_Portal_User__c FROM Contact WHERE EMAIL = '' AND LASTNAME = '' AND ACCOUNTID = ''
Name Parsing Logic
:
The ToFirstAndLast function splits the full name into first and last names.
Salesforce User Details Query Logic:
To fetch user details, the following query is used: 
SELECT FederationIdentifier, ContactId FROM User WHERE FederationIdentifier = '' AND ContactId = ''
 
Required Modifications:
Name Change
:
When the name is updated in CRM/BP, use the ToFirstAndLast function to extract first and last names, and update the corresponding Salesforce Contact and User records.
Email Change
:
When the email is updated in CRM/BP, the new email should be updated in both the Salesforce Contact and User records.
Username Change
:
When the username is updated in CRM/BP, the FederationIdentifier (constructed as <BillerID>-<Username>) should be updated in Salesforce.
Ensure the new username (formatted as [Username] + [BillerID]@InvoiceCloud.Com) is updated in Salesforce as well.
Update any related SSO claims or connections.
Suggested Steps to Implement:
Check the current Salesforce API to see if user details like username,Name and email can be updated using existing methods.
If not, create a new API endpoint to update User details in Salesforce.
Ensure proper syncing of name, Username and email across both the Contact and User objects in Salesforce.
Instead of passing the Name to CommunityNickname for user, we can use the Biller Username, as we are maintaining uniqueness for the username. 
Update 
IC.Salesforce
 library documentation with new changes
POC Code Implementation when user details change from BP:
File:
 MyIIS\BillerPortal\BillerAddEditUser.aspx.vb
Method: 
btnAddNewUser_Click in  If BillerUserID > 0 Then condition after user update
' Check if email, username, or name has changed
Dim currentFullName As String = billerUserTable.Rows(0)("UserFullName").ToString()
Dim currentEmail As String = billerUserTable.Rows(0)("EmailAddress").ToString()
Dim currentUsername As String = billerUserTable.Rows(0)("Username").ToString()
Dim currentActiveStatus As Boolean = Convert.ToBoolean(billerUserTable.Rows(0)("Active"))
If txtUserFullName.Text.Trim() <> currentFullName OrElse txtEmailAddress.Text.Trim() <> currentEmail OrElse txtUsername.Text.Trim() <> currentUsername OrElse isActive <> currentActiveStatus Then
     Dim account As Account = AccountExists(Me.CurrentBiller.BillerID)
    If Not account Is Nothing Then
     ' Update Salesforce contact and user details with retry logic
     CallSalesforceWithRetry(Sub()
                                 UpdateSalesforceContactAndUserDetails(billerUserTable, account.Id, txtUserFullName.Text.Trim(), txtEmailAddress.Text.Trim(), txtUsername.Text.Trim(), isActive)
                             End Sub, 2)
     'or if the user is a not demo account or the biller is 1834
     'If Not Me.CurrentBiller.DemoAccount OrElse Me.CurrentBiller.BillerID = DemoBillerIDs.QA2_1834 Then
     '    ' Update Salesforce contact and user details
     ' Update Salesforce contact and user details with retry logic
     'CallSalesforceWithRetry(Sub()
     '                            UpdateSalesforceContactAndUserDetails(billerUserTable, account.Id, txtUserFullName.Text.Trim(), txtEmailAddress.Text.Trim(), txtUsername.Text.Trim(), isActive)
     '                        End Sub, 2)
     'End If
    ElseIf Not Me.CurrentBiller.DemoAccount Then
        clsUtilities.EMAIL("no-reply@invoicecloud.com",
              "MMaldonado@invoicecloud.com;mlagunez@invoicecloud.com",
              "",
              "",
              Body:="Issue with Salesforce Account object." &
              "<br>Biller User: " & Me.CurrentBiller.BillerAdminUser &
              "<br>Biller Username: " & Me.CurrentBiller.BillerAdminUsername &
              "<br>Biller DBA: " & Me.CurrentBiller.BillerDBA &
              "<br>BID: " & Me.CurrentBiller.BillerID &
              "<br>Date: " & DateTime.Now.Date,
              Subject:="Salesforce BP UpdateSalesforceContactAndUserDetails - No Account Found",
              IsHtml:=True,
              EmailFilename:="")
    End If
End If
  Add UpdateSalesforceContactAndUserDetails, GetSalesforceContact, GetSalesforceUse Methods
  Private Property SalesforceEnvironment As SalesforceEnvironment
  Private Property RecordTypeId As String
  
  Private Const DEMO_RECORD_TYPE_ID As String = "0127d000000GrAaAAK"
  Private Const PRODUCTION_RECORD_TYPE_ID As String = "0121M000001BR32QAG"
Private Sub UpdateSalesforceContactAndUserDetails(billerUserTable As DataTable, accountId As String, newFullName As String, newEmail As String, newUsername As String, isActive As Boolean)
    If billerUserTable.Rows.Count > 0 Then
        Dim currentFullName As String = billerUserTable.Rows(0)("UserFullName").ToString()
        Dim oldFullName As Dictionary(Of String, String) = StringExtensions.ToFirstAndLast(currentFullName)
        Dim currentEmail As String = billerUserTable.Rows(0)("EmailAddress").ToString()
        Dim currentUsername As String = billerUserTable.Rows(0)("Username").ToString()
        Dim currentActiveStatus As Boolean = Convert.ToBoolean(billerUserTable.Rows(0)("Active"))
        Dim federationID As String = Me.CurrentBiller.BillerID & "-" & currentUsername
        Me.SalesforceEnvironment = SalesforceEnvironment.Production
        'Me.SalesforceEnvironment = SalesforceEnvironment.Sandbox
        If SalesforceEnvironment = SalesforceEnvironment.Production Then
            RecordTypeId = PRODUCTION_RECORD_TYPE_ID
        Else
            RecordTypeId = DEMO_RECORD_TYPE_ID
        End If
        'These scenarios are handled in the order of priority and based on requirement

        ' Retrieve the current contact details from Salesforce
        Dim contactRecords As List(Of Contact) = GetSalesforceContact(currentEmail, accountId, oldFullName("LastName"))

        ' If no contact found with old data, check with new data
        If contactRecords.Count = 0 Then
            Dim newFullNameDict As Dictionary(Of String, String) = StringExtensions.ToFirstAndLast(newFullName)
            contactRecords = GetSalesforceContact(newEmail, accountId, newFullNameDict("LastName"))
        End If

        ' If still no contact found, create a new contact
        If contactRecords.Count = 0 Then
            Dim newContact As New Contact With {
            .AccountId = accountId,
            .Email = newEmail,
            .LastName = StringExtensions.ToFirstAndLast(newFullName)("LastName"),
            .BillerPortalUser = isActive,
            .RecordTypeId = Me.RecordTypeId
        }
            If StringExtensions.ToFirstAndLast(newFullName).ContainsKey("FirstName") Then
                newContact.FirstName = StringExtensions.ToFirstAndLast(newFullName)("FirstName")
            End If
            Salesforce.Client.ContactController.CreateContact(newContact)
            contactRecords = GetSalesforceContact(newEmail, accountId, StringExtensions.ToFirstAndLast(newFullName)("LastName"))
            'Add user logic based on requirement
            Exit Sub

        End If
        If contactRecords.Count > 1 Then
            ' there was a contact found, so we don't want to create a new one, the user being provisioned will be linked to the existing contact
            clsUtilities.EMAIL("no-reply@invoicecloud.com",
                    "MMaldonado@invoicecloud.com;mlagunez@invoicecloud.com",
                    "",
                    "",
                    Body:="A Salesforce contact was not updated." &
                    "<br>Biller User: " & Me.CurrentBiller.BillerAdminUser &
                    "<br>Biller Username: " & Me.CurrentBiller.BillerAdminUsername &
                    "<br>Biller DBA: " & Me.CurrentBiller.BillerDBA &
                    "<br>BID: " & Me.CurrentBiller.BillerID &
                    "<br>Date: " & DateTime.Now.Date,
                    Subject:="Salesforce BP UpdateSalesforceContactAndUserDetails - More Than One Contact Exists",
                    IsHtml:=True,
                    EmailFilename:="")
            Exit Sub
        End If
        If contactRecords.Count > 0 Then
            Dim currentContact As Contact = contactRecords(0)
            Dim fullName As Dictionary(Of String, String) = StringExtensions.ToFirstAndLast(newFullName)
            Dim updateRequired As Boolean = False
            Dim contactUpdateDictionary As New Dictionary(Of String, Object)

            ' Check and update email if necessary
            If currentContact.Email <> newEmail Then
                contactUpdateDictionary("Email") = newEmail
                updateRequired = True
            End If

            ' Check and update first name if necessary
            If fullName.ContainsKey("FirstName") AndAlso currentContact.FirstName <> fullName("FirstName") Then
                contactUpdateDictionary("FirstName") = fullName("FirstName")
                updateRequired = True
            End If

            ' Check and update last name if necessary
            If currentContact.LastName <> fullName("LastName") Then
                contactUpdateDictionary("LastName") = fullName("LastName")
                updateRequired = True
            End If
            ' Check and update email if necessary
            If isActive <> currentActiveStatus Then
                contactUpdateDictionary("Biller_Portal_User__c") = isActive
                updateRequired = True
            End If

            ' Update contact if any changes were made
            If updateRequired Then
                Salesforce.Client.ContactController.UpdateContact(currentContact.Id, contactUpdateDictionary)
            End If

            ' Check and update user details if necessary
            Dim userRecords As List(Of User) = GetSalesforceUser(federationID, currentContact.Id)
            If userRecords.Count > 0 Then
                Dim currentUser As User = userRecords(0)
                Dim userUpdateDictionary As New Dictionary(Of String, Object)
                updateRequired = False

                ' Check and update username if necessary
                If currentUser.UserName <> newUsername Then
                    userUpdateDictionary("UserName") = newUsername & Me.CurrentBiller.BillerID.ToString & "@invoicecloud.net"
                    userUpdateDictionary("FederationIdentifier") = Me.CurrentBiller.BillerID & "-" & newUsername
                    updateRequired = True
                End If

                ' Check and update email if necessary
                If currentUser.Email <> newEmail Then
                    userUpdateDictionary("Email") = newEmail
                    updateRequired = True
                End If

                'Need to update User class to add FirstName property
                '' Check and update first name if necessary
                'If fullName.ContainsKey("FirstName") AndAlso currentUser.FirstName <> fullName("FirstName") Then
                '    userUpdateDictionary("FirstName") = fullName("FirstName")
                '    updateRequired = True
                'End If

                ' Check and update last name if necessary
                If currentUser.LastName <> fullName("LastName") Then
                    userUpdateDictionary("LastName") = fullName("LastName")
                    updateRequired = True
                End If

                If currentUser.CommunityNickname <> newFullName Then
                    userUpdateDictionary("CommunityNickname") = newFullName
                    updateRequired = True
                End If
                ' Update user if any changes were made
                'If updateRequired Then
                '    Salesforce.Client.UserController.UpdateUser(currentUser.Id, userUpdateDictionary)
                'End If
            End If
        End If

        'Need to send a mail or add create logic based on requirement'
    End If
End Sub

   Private Function GetSalesforceContact(email As String, accountId As String, lastName As String) As List(Of Contact)
       Dim contactFields As New List(Of String) From {
               "AccountId",
               "Id",
               "Email",
               "FirstName",
               "LastName",
               "Biller_Portal_User__c"
           }
       Dim contactFilter As String = "Email = '" & email & "' AND AccountId='" & accountId & "' AND LastName='" & lastName & "'"
       Dim contactQuery As String = "SELECT " & String.Join(", ", contactFields) & " FROM " & "Contact" & " WHERE " & contactFilter
       Dim contactRecords As List(Of Contact) = Salesforce.Client.ContactController.GetContacts(contactQuery)
       Return contactRecords
   End Function

   Private Function GetSalesforceUser(federationIdentifier As String, contactId As String) As List(Of User)
       Dim userFields As New List(Of String) From {
               "Id",
               "UserName",
               "Email",
               "LastName",
               "CommunityNickname",
               "FederationIdentifier",
               "ContactId"
           }
       Dim userFilter As String = "FederationIdentifier = '" & federationIdentifier & "' AND ContactId= '" & contactId & "'"
       Dim userQuery As String = "SELECT " & String.Join(", ", userFields) & " FROM User WHERE " & userFilter
       Dim userRecords As List(Of User) = Salesforce.Client.UserController.GetUsers(userQuery)
       Return userRecords
   End Function
   
Private Function AccountExists(accountNumber As Integer) As Account
    Dim accountFields As New List(Of String) From {
    "Id",
    "Name",
    "AccountNumber"
}
    Dim accountFilter As String = "AccountNumber = '" & accountNumber & "'"
    Dim accountQuery As String = "SELECT " & String.Join(", ", accountFields) & " FROM " & "Account" & " WHERE " & accountFilter
    Dim accountRecords As List(Of Account) = Salesforce.Client.AccountController.GetAccounts(accountQuery)

    If accountRecords.Count <> 1 Then
        ' we do not want to continue with provisioning if there isn't a Biller account. This is a red flag and should be brought up to a Salesforce lead
        Return Nothing
    End If

    Return accountRecords(0)
End Function
Add UpdateUser and CreateUser method in  SalesForceLibrary 
File:
 IC.SalesForce\Controllers\UserController.cs
 public void UpdateUser(string userId, Dictionary<string, object> updateValues)
 {
     if (string.IsNullOrEmpty(userId))
     {
         throw new ArgumentException("User ID cannot be null or empty", nameof(userId));
     }

     if (updateValues == null || updateValues.Count == 0)
     {
         throw new ArgumentException("Update values cannot be null or empty", nameof(updateValues));
     }

     UpdateSalesforceRecord(userId, updateValues, RecordType.User);
 }
 'Based on need we need to add the below method'
 public void CreateUser(User user)
 {
     // validation
     IList<ValidationResult> validationResults = Validation.ValidateModel(user);
     IEnumerable<string> validationResultMessages = validationResults.Select((vr) => vr.ErrorMessage);
     if (validationResults.Count > 0) throw new ArgumentException(string.Join(Environment.NewLine, validationResultMessages));

     CreateSalesforceRecord(user, RecordType.User);
 }

POC Code Implementation when user details change from CRM:
File: 
ICCRM\App_Code\Models\SalesForce\SalesforceContact.vb
Add below 
Private biller As New clsBillers
Public Sub New(active As Boolean, billerId As Integer, emailAddress As String, salesforceEnvironment As SalesforceEnvironment, fullName As String, userName As String)
    Me.active = active
    Me.billerId = billerId
    Me.emailAddress = emailAddress
    Me.fullName = fullName
    Me.userName = userName
    Me.nameElements = fullName.ToFirstAndLast()
    Me.salesforceEnvironment = salesforceEnvironment
    If salesforceEnvironment = SalesforceEnvironment.Production Then
        recordTypeID = BILLER_RECORD_TYPE_ID_PRODUCTION
    Else
        recordTypeID = BILLER_RECORD_TYPE_ID_SANDBOX
    End If
    Me.biller = clsBillers.LoadBillerByBillerID(billerId)
End Sub
Public Sub UpdateSalesforceContactandUser(billerUserID As Integer)
    Try
        ' making sure the biller account exists on Salesforce
        Dim accountRecords As List(Of Account) = SalesforceAccountRepository.GetSalesforceAccountRecords(billerId)

        If accountRecords.Count <> 1 Then
            ' we do not want to continue with provisioning if there isn't a Biller account. This is a red flag and should be brought up to a Salesforce lead
            ' send an email to relevant parties
            SendSalesforceErrorEmail("Issue with Salesforce Account object.", "Salesforce CRM UpdateSalesforceContactBillerPortalUserStatus - No Account Found")
            Exit Sub
        End If
        biller.BillerUser.LoadBillerUser(billerUserID, Me.billerId)
        ' get contact records
        Dim contactEmail As String = biller.BillerUser.EmailAddress
        Dim lastName As String = biller.BillerUser.UserFullName.ToFirstAndLast("LastName")
        Dim contactRecords As List(Of Contact) = GetSalesforceContactRecords(contactEmail, accountRecords(0).Id, lastName)

        contactEmail = emailAddress
        Dim newFullNameDict As Dictionary(Of String, String) = StringExtensions.ToFirstAndLast(fullName)
        ' If no contact found with old data, check with new data
        If contactRecords.Count = 0 Then
            contactRecords = GetSalesforceContactRecords(emailAddress, accountRecords(0).Id, newFullNameDict("LastName"))
        End If

        If contactRecords.Count > 1 Then
            ' there was a contact found, so we don't want to create a new one, the user being provisioned will be linked to the existing contact
            SendSalesforceErrorEmail("A Salesforce contact was not updated.", "Salesforce CRM UpdateSalesforceContactBillerPortalUserStatus - More Than One Contact Exists")
            Exit Sub
        End If
        If contactRecords.Count = 0 Then
            ' if the account exists but no contact exists, we create a contact.
            Dim contact As New Contact With {
            .AccountId = accountRecords(0).Id,
            .Email = contactEmail,
            .LastName = newFullNameDict("LastName"),
            .BillerPortalUser = active,
            .RecordTypeId = recordTypeID
            }

            If nameElements.ContainsKey("FirstName") Then
                contact.FirstName = newFullNameDict("FirstName")
            End If

            Salesforce.Client.ContactController.CreateContact(contact)
            Exit Sub
        End If
        Dim valuesToUpdate As Dictionary(Of String, Object) = New Dictionary(Of String, Object) From {
            {"Biller_Portal_User__c", active},
            {"Email", contactEmail},
            {"LastName", newFullNameDict("LastName")}
        }
        If newFullNameDict.ContainsKey("FirstName") Then
            valuesToUpdate("FirstName") = newFullNameDict("FirstName")
        End If
        Salesforce.Client.ContactController.UpdateContact(contactRecords(0).Id, valuesToUpdate)
        Dim federationID As String = Me.billerId & "-" & biller.BillerUser.UserName
        ' Check and update user details if necessary
        Dim userRecords As List(Of User) = GetSalesforceUser(federationID, contactRecords(0).Id)
        If userRecords.Count > 0 Then
            Dim currentUser As User = userRecords(0)
            Dim userUpdateDictionary As New Dictionary(Of String, Object)
            Dim updateRequired As Boolean = False
            ' Check and update username if necessary
            If biller.BillerUser.UserName <> userName Then
                userUpdateDictionary("UserName") = userName & Me.billerId.ToString & "@invoicecloud.net"
                userUpdateDictionary("FederationIdentifier") = Me.billerId & "-" & userName
                updateRequired = True
            End If
            ' Check and update email if necessary
            If biller.BillerUser.EmailAddress <> contactEmail Then
                userUpdateDictionary("Email") = contactEmail
                updateRequired = True
            End If

            'Need to update User class to add FirstName property
            '' Check and update first name if necessary
            'If fullName.ContainsKey("FirstName") AndAlso currentUser.FirstName <> fullName("FirstName") Then
            '    userUpdateDictionary("FirstName") = fullName("FirstName")
            '    updateRequired = True
            'End If

            ' Check and update last name if necessary
            If biller.BillerUser.UserFullName.ToFirstAndLast("LastName") <> newFullNameDict("LastName") Then
                userUpdateDictionary("LastName") = newFullNameDict("LastName")
                updateRequired = True
            End If

            If biller.BillerUser.UserFullName <> fullName Then
                userUpdateDictionary("CommunityNickname") = fullName
                updateRequired = True
            End If
            'Uncomment when UserController is updated from IC.Salesforce library
            ' Update user if any changes were made
            'If updateRequired Then
            '    Salesforce.Client.UserController.UpdateUser(currentUser.Id, userUpdateDictionary)
            'End If
        End If

    Catch ex As Exception
        ' send an email to relevant parties
        SendSalesforceErrorEmail("A Salesforce exception when updating a contact object has occurred.", "Salesforce CRM UpdateSalesforceContactBillerPortalUserStatus - Contact Update Exception")
        Throw
    End Try
End Sub

Private Function GetSalesforceUser(federationIdentifier As String, contactId As String) As List(Of User)
    Dim userFields As New List(Of String) From {
            "Id",
            "UserName",
            "Email",
            "LastName",
            "CommunityNickname",
            "FederationIdentifier",
            "ContactId"
        }
    Dim userFilter As String = "FederationIdentifier = '" & federationIdentifier & "' AND ContactId= '" & contactId & "'"
    Dim userQuery As String = "SELECT " & String.Join(", ", userFields) & " FROM User WHERE " & userFilter
    Dim userRecords As List(Of User) = Salesforce.Client.UserController.GetUsers(userQuery)
    Return userRecords
End Function

File:
 ICCRM\editForms\EditBillerUser.aspx.vb
Method:
 btnSave_Click 
Update the method name to 
UpdateSalesforceContactandUser
on below logic.
'update salesforce contact if active status changed and not demo biller
If OriginalActiveStatus <> Me.chkActive.Checked AndAlso Not Me.chkSupport.Checked AndAlso Not biller.DemoAccount Then
    salesforceContact.CallSalesforceWithRetry(Sub() salesforceContact.UpdateSalesforceContactandUser(BillerUserID),
                                              retryCount)
End If  
Case 4:
Ensure Salesforce users are correctly created with a role
In the CRM and Biller Portal, don’t allow duplicate emails for biller users that are part of the same biller (i.e., creating or updating biller users in CRM/BP should validate against existing email addresses)
Current Behavior:
User Creation Logic in CRM/BP:
 
Currently, when creating a user in CRM/BP, we are only validating whether the username exists or not and not validating the email or name. The username is maintained as unique.
We are creating the Salesforce contact if we are creating the user from CRM, but the user is not already in BP.
Issues and suggested changes:
The username also accepts spaces, and Salesforce uses it in the format [Username] + [BillerID]@InvoiceCloud.Com as the username for the user. However, Salesforce validation throws the error: "Username must be in the form of an email address" when accessing Salesforce.
Either we need to trim the username wherever we are using it in Salesforce logic or restrict spaces at the time of user creation/update in CRM/BP.
Currently, Salesforce users are created when we click on the "Visit Support Central" button from BP. We need to ensure that demo billers have access to this process for successful creation 
Modify the above shared code as per the requirement for added users.
As per discussion with Byron, further clarification is needed to get a clear understanding of this requirement.
Case 5:
Successful SSO jump from the biller portal to Salesforce using previously identified bugged users
Current Issues:
Errors may occur due to:
Duplicate community nickname.
"Username must be in the form of an email address" error.
Other issues related to user data.
For the mentioned biller, based on the error, one user is having an issue because the username contains a space. For the other user, I am assuming there is some data mismatch based on the error I received. I haven’t tried creating a new user for that biller as it is a live BID.
Action:
Investigate the existing data and identify the root causes of these errors.
Ensure that the system performs necessary checks and fixes before attempting to jump to Salesforce.
Impact Analysis
Customer Experience:
Faster, automated user creation and synchronization between CRM/Biller Portal and Salesforce, improving the customer journey.
Salesforce Integration:
Addressing issues like duplicate usernames ensures consistency across systems and reduces user frustration.
Operational Efficiency:
Improved user data consistency between CRM/Biller Portal and Salesforce enhances data integrity and reduces the need for manual reconciliation.
Risk Analysis
Risk: Demo Billers Without Salesforce Account Access
Impact
: Demo billers, except for the specified QA2 biller, may not be able to access the "Visit Support Central" button or Salesforce, impacting testing and support access.
Mitigation
:
Ensure that demo billers who should have Salesforce access are correctly set up in the system, and those without access are shown clear messaging.
Hide the "Visit Support Central" button for demo billers who should not have access and show an informative message instead.
Risk: Incomplete or Incorrect User Data in Salesforce
Impact
: If Salesforce contact or user data is not correctly updated during creation or modification, users may encounter access issues, leading to a poor experience.
Mitigation
:
Implement checks to ensure that all relevant fields (email, username, first and last name) are correctly synced between CRM/Biller Portal and Salesforce.
Update Salesforce data in real time or via scheduled syncs to ensure consistency.
Helpful information can be found in the URL whenever the user gets the error message when accessing the Support Central. Common errors are:
“
PORTAL_USER_ALREADY_EXISTS_FOR_CONTACT+Api+Exception
”
In this case, a similar username exists in the system. A solution would be to change the username or last name or both.
“
Invalid contact
”
For this case, the user might have an incorrect username related to account. E.g. unnecessary data in username. A solution would be to update the username. even not resolves update the last name.
“
Username change is not allowed
”
Similar solution as above.
“
Duplicate community nickname in insert
”
As the error states, a duplicate community nickname exists which must be updated.
Sometimes the error description might be empty, or no error description show
Clarification Needed:
Should Salesforce contact and user be created before clicking the "Visit Support Central" button? Ans: 
Contact - only create on visit support cental button
Should we verify Salesforce Account, Contact, and User exist, and then update their information in Salesforce during the user creation or modification process in CRM/BP?  
Yes
Should Salesforce updates occur first before updating CRM/BP, or vice versa?
 Yes
What should be done if Salesforce contact or user updates fail due to validation errors? 
Display error if Saleforce contact exists, but is unable to update.  Do not update any information on IC is salesforce error occurs.  Log error so team can investigate further
What should be done if the contact or user we are modifying is not found in Salesforce during the update? Do we need to create the contact and user during the update process? 
No only create the user in Salesforce when they click the Support central link
If there is already a contact with the old email and last name, as well as a new email and last name, and the user is created with the old contact ID, we need to update the old contact. However, what should we do if an existing contact matches our changes?  
Let’s discuss
While creating a new user, if there is already a Salesforce contact with the same email and last name for the same biller, what should we do? The same applies to user details as well.  
We should try and find a way to make each saleforce contact unique if the duplicate emails are created with the same last name.
User creation and updation do not accept spaces in the username, but we have some users with spaces. Should we replace them with underscores or other characters to resolve the 'Username must be in the form of an email address' error when accessing Salesforce?  
replace with underscores when old usernames with spaces are created with a Salesforce account
If a user with the same name and email already exists during new user creation and the system tries to redirect to SSO, we get the 'PORTAL USER ALREADY EXISTS FOR CONTACT' error. The issue is resolved only when I change the name or username.  
Need to find a way to make each duplicate unique
What should we do if the contact already exists? Do we need to maintain uniqueness for the contact with the username? Based on the error above, we are only allowing one user per contact. So, if the contact exists, should we also check if a user already exists for that contact? Do we need to perform this check before updating/creating the user? 
If contact exists then we should update their contactid with the new information provided when they update it in our system 
How can we check what fields are present in the Contact and User tables from salesforce apart from library? If there is any data, please share it. 
 You may need to reach out to Lauren or I might be able to login to saleforce and confirm
Do we have any documentation need to update if we modify salesforce library? I am not find any as of now  please help me to get if we have any.
Discussed points:
Don't create Salesforce Contact and User until the user clicks on "Visit Support Central."
Currently, the CRM creates the contact at the time of user creation, but BP is not doing this. The Contact and User should only be created when the user clicks on "Visit Support Central."
Update Contact and User information if old values are found during CRM/BP user updates.
If old values are found while updating the CRM/BP user, update the contact and user information accordingly.
Maintain uniqueness using the Username as FirstName when creating the Contact.
To maintain uniqueness, use the 
Username
 as the 
FirstName
 when creating the contact. Add an additional step to update the same data with old records.
Use Biller Username for 
CommunityNickname
 instead of Name during User creation in Salesforce.
Instead of passing the 
Name
 to 
CommunityNickname
 during Salesforce user creation, use the 
Biller Username
 to maintain uniqueness for the username.
Update the existing user's 
CommunityNickname
 with the 
Biller Username
 when the user clicks on "Visit Support Central."
Log information in New Relic if the Contact is not found during User update from CRM/BP.
If the contact is not found during the user update, log that information in New Relic.
Also, update the email list CRM is using to send emails if the contact does not exist or is duplicated.
Only perform operations if the Biller has an Account.
These operations should only occur if the Biller has an account.
If the Biller is not a demo account and does not have a Salesforce account, display a different error message for 
Case 2
.
Create a database request to fetch user details from all Billers using the same LastName and Email.
A database request should be created to fetch user details for all Billers who are using the same 
LastName
 and 
Email
.
Split the name by space into 
FirstName
 and 
LastName
.
If the name has only one word, assign it to 
LastName
.
If the name has more than two words, everything after the first space should be considered as 
LastName
.
DBR-6324
 created to fetch the data.
 URL:/spaces/PE/pages/4106420227/Spike+for+PRISM-131+Biller+Portal+-+Support+Central+SSO+Invalid+Contact+errors