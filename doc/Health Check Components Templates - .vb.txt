Database:
Health Check - IC.Database 
Imports System
Imports System.Linq
Imports IC.Interfaces
Imports IC.Database
Imports IC.Database.Authentication.AzureFunctions
Imports IC.Interfaces.Database.Enums
Imports Microsoft.Extensions.Logging

Public Partial Class HealthCheck
    Public Shared Function DatabaseHealthCheck(ByVal logger As ILogger, ByVal keyVaultClient As IKeyVaultReader, ByVal settingsService As ISettingsService, ByVal applicationName As String, ByVal databaseName As DatabaseName) As Boolean
        logger.Information("DatabaseHealthCheck: Started")
        Dim result As Boolean = False

        Try
            Dim query = "Select 1"
            Dim dbProxy = GetDatabaseProxy(keyVaultClient, settingsService, applicationName, databaseName)
            Dim dataTable = dbProxy.GET_DATASET(query, 0).Tables(0)

            If dataTable.Rows.Count > 0 Then
                logger.Information("DatabaseHealthCheck: Passed")
                result = True
            Else
                logger.[Error]("DatabaseHealthCheck: Finished with GET_DATASET returning invalid value {result}", result)
            End If

        Catch ex As Exception
            logger.[Error](ex, "DatabaseHealthCheck: GET_DATASET Failed")
            result = False
        End Try

        Return result
    End Function

    Private Function GetDatabaseProxy(ByVal keyVaultClient As IKeyVaultReader, ByVal settingsService As ISettingsService, ByVal applicationName As String, ByVal databaseName As DatabaseName) As DatabaseProxy
        Dim dbOptions As DatabaseOptions = New DatabaseOptions() With {
            .AzureSqlAuthTokenService = New IC.Database.Authentication.AzureFunctions.DatabaseTokenProvider(String.Empty),
            .KeyvaultClient = keyVaultClient,
            .SettingsService = settingsService
        }
        Dim proxy = New DatabaseProxy(dbOptions)
        proxy.ApplicationName = applicationName
        proxy.DefaultDatabase = databaseName
        Return proxy
    End Function
End Class

Health Check - IC.MicroService.DAL.EntityFramework
 
Imports IC.MicroService.DAL.EntityFramework
Imports Microsoft.EntityFrameworkCore

Public Partial Class HealthCheck
    Private ReadOnly _dbContextProvider As IDbContextProvider

    Public Sub New(ByVal dbContextProvider As IDbContextProvider)
        _dbContextProvider = dbContextProvider
    End Sub

    Public Function DatabaseHealthCheck(ByVal billerId As Integer) As Boolean
 
        Try
            Dim dbContext = _dbContextProvider.GetBillerDbContext(Of DbContext)(billerId).Result
            Return dbContext IsNot Nothing
        Catch
            Return False
        End Try
    End Function
End Class

KeyVault
HealthCheck - 
EnvironmentVariableReader
Imports System
Imports IC.Interfaces
Imports IC.Database.Authentication.AzureFunctions
Imports Microsoft.Extensions.Logging

Public Partial Class HealthCheck
    Public Function KeyvaultHealthCheck(ByVal logger As ILogger, ByVal keyVaultClient As IKeyVaultReader, ByVal secretKey As String) As Boolean
        logger.Information("KeyvaultHealthCheck: Started")
        Dim result As Boolean = False

        Try
            Dim secret As String
            keyVaultClient.TryGetSecret(secretKey, secret)

            If secret IsNot Nothing Then
                logger.Information("KeyvaultHealthCheck: Passed")
                result = True
            Else
                logger.[Error]("KeyvaultHealthCheck: TryGetSecret Failed returning empty value")
            End If

        Catch ex As Exception
            logger.[Error](ex, "KeyvaultHealthCheck: TryGetSecret Failed")
        End Try

        Return result
    End Function
End Class

Queue
HealtCheck - 
ICAzureMessageQueue
Imports System
Imports IC.Interfaces
Imports ICAzureMessageQueue
Imports Microsoft.Extensions.Logging

Public Partial Class HealthCheck
    Public Function QueueHealthCheck(ByVal logger As ILogger, ByVal queueNameStorageName As String, ByVal queueType As QueueType) As Boolean
        logger.Information("QueueHealthCheck: Started")
        Dim result As Boolean = False

        Try
            Dim keyVaultClient As IKeyVaultReader = GetKeyVaultClient()
            Dim factory = New AzureMessageQueueFactory(keyVaultClient)
            Dim queueName = keyVaultClient.GetSecret(queueNameStorageName).ToString()
            Dim client = factory.CreateQueueClient(queueType, queueName)
            client.PeekMessages(1)
            logger.Information("QueueHealthCheck: Passed")
            result = True
        Catch ex As Exception
            logger.[Error](ex, "QueueHealthCheck: PeekMessages Failed")
        End Try

        Return result
    End Function
End Class

Logging
HealtCheck - 
Microsoft.Extensions.Logging
Imports Microsoft.Extensions.Logging
Imports System
Imports System.Runtime.InteropServices
Public Partial Class HealthCheck
    Private ReadOnly _logger As ILogger(Of HealthCheck)

    Public Sub New(logger As ILogger(Of HealthCheck))
        _logger = logger
    End Sub
    Public Function LoggingHealth(<Out> ByRef logerror As String) As Boolean
        Try
            _logger.LogInformation("Performing health check for the logging system...")
            logerror = String.Empty
            Return True
        Catch ex As Exception
            logerror = "An error occurred while performing health check for the logging system" & ex.ToString()
            Return False
        End Try
    End Function
End Class


 URL:/spaces/EN/pages/3070492686/Health+Check+Components+Templates+-+.vb