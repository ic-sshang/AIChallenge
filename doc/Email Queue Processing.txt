Introduction
EmailQueueProcessing is our centralized email sending process, and is responsible for sending any email notifications with an EmailQueueTypeID. Please note that there are some email notifications that do not have an EmailQueueTypeID and most of these are not processed using EmailQueueProcessing.
Useful Queries
sql
select * from emailqueuelog where fkid=26295 --emailqueueid from emailqueue
select * from tbltabletypes
select * from tblemailqueuetype
select * from invoices where invoicenumber='915531302A-11032022-2022'
select * from payments  where invoiceid=320909 -- 2022-11-29 12:35:38.000
select top 10 * from emailqueue where fkid=90299  --2022-11-29 13:01:56.630 fkid is paymentid
select * from emailqueuelog where emailqueueLogid in (26295,26294)
select datediff(minute,DateRecAdded,EmailSentDate) as lag, * from emailqueue where datediff(minute,DateRecAdded,EmailSentDate) > 10 order by emailqueueID desc
SELECT DATEADD(hour,-6,getutcdate()) -- CST
select dateadd(minute,-360,getutcdate()) -- CST
select * from emailqueue where emailsentdate is NULL and invoicetypeid !=0 and daterecadded > dateadd(minute,-690,getutcdate())  order by 1 desc
select datediff(minute,startqueuedatetime,Completeddatetime) as lag, * from emailqueuelog where datediff(minute,startqueuedatetime,Completeddatetime) > 10 order by emailqueuelogid desc

-- To find number of emails has been sent for a given EmailQueueType on a particular date
select t.QueueDate, t.BillerID,  count (t.QueueDate) from (select BillerID, cast (StartQueueDateTime as date) as QueueDate ,emailqueuelogid   from EmailQueueLog where EmailQueueTypeID = 1 ) as t
group by t.QueueDate,t.BillerID ORDER by t.QueueDate DESC


-- Get a count of emails not processed by EmailQueueType
select  emailqueuetypedesc,emailsubject ,count(emailqueueid)
from emailqueue e
left join tblemailqueuetype  t on e.emailqueuetypeid = t.emailqueuetypeid
where emailsentdate is null  
group by emailqueuetypedesc,emailsubject
sql
select * from tbltabletypes

1	EmailQueue	2020-06-05 15:12:33.830
2	EmailTracking	2020-06-05 15:12:33.830
3	CreditCardExpiration	2020-06-05 15:12:33.830
4	BillerPaperlessBouncedReport	2020-06-05 15:12:33.830
NewRelic
sql
select * from EmailProcessTracking
select average (TotalQueueTime) FROM EmailQueueLog since 1 month ago limit max timeseries auto 
Time Saver: Identify if and when a First/Second/Third Notification was attempted
This steps will help you quickly identify the time an invoice notification was attempted.
Required information
: BillerID, InvoiceID, New Relic
Steps
Navigate to New Relic > Logs
Set the date range
Search the following:
 message:"BILLERID" message:"selInvoiceDataForNotification"  message:"INVOICEID"
Based on the results you can determine when did Automate Schedule ran the jobs for email queue processing
Logs
Once you find the logs in Automate Schedule, you can review the logs to identify exceptions
Example
[2024-02-29 05:32:29.261] - STARTING RTDR - BillerID: 1700  CustomerID: 3180
[2024-02-29 05:32:29.261] - Sending Request
[2024-02-29 05:32:31.580] - Retrieved Request
Object Type: RTDRResponse
Fields: 
----------------------------------------------------------------------------------------------------
Success                                           :False
BalanceChanged                                    :False
ErrorMessage                                      :IC: Account balance was not provided in the API Response.
----------------------------------------------------------------------------------------------------

Problem with RTDR on CustomerID=3180 - IC.EmailQueue.RTDRException: Problem with RTDR - IC: Account balance was not provided in the API Response.
   at IC.EmailQueue.EmailQueueBase.RefreshCustomerByCustomerID(Int32 BillerID, Int32 CustomerID) in C:\agent\A2\_work\108\s\IC.EmailQueue\EmailQueue.vb:line 1436
[2024-02-29 05:32:31.580] - ENDING RTDR - BillerID: 1700  CustomerID: 3180
This process of identification logs are particularly beneficial to confirm if an email was not sent due to an RTDR error.
Automate Job
There is at least one Automate Job per EmailQueueType, and logs can be found in the 'STAGING-'  jobs
Source Code
https://invoicecloud.visualstudio.com/Src/_git/EmailQueueProcessing?path=%2FIC.EmailQueue%2FEmailQueue.vb&_a=contents&version=GBmain
Azure Queue Storage
These emails are triggered from Biller Portal, Biller Portal adds the message to the Storage and the emailqueueprocessor follows a queueing mechanism to send the email. 
https://dev.azure.com/invoicecloud/Src/_git/EmailQueueProcessor
Additional logs for other email types can be found through the Azure Portal under the ICLog Storage Container → 
iclogstorage - Microsoft Azure
Queue Types include:
AchRejectChargebackNotices
CcExpirationResendNotification
PasswordResetNotification
ResetBillerUserPassword
BillerUserCreatePassword
For password related queue types the logs can be found in → 
SendPasswordResetEmail - Microsoft Azure
 and are valid for the current day.
Email Bounce Process
Email Bouncing occurs when mail gun and any other mailing services we have detects an address as not recognized or an invalid recipient. The emails are pulled through automate jobs and processed. The Processed emails are then sent over to our database in tables such as the 
dbo.EmailDoNotSendList
 and that gets reported on the Biller portal through 
Reports -> Email -> Email Do Not Send List
 
Mailgun Suppressions
Mailgun suppressions hold information on the types of email address issues categorized between Bounces, Complaints, Unsubscribes and Whitelist.
Email Bounce Jobs
Jobs automate will have the errand scheduled to pick up the error prone addresses between two types of jobs: BouncedEmailMonitor and BouncedEmailProcessing
Code Source
https://dev.azure.com/invoicecloud/Src/_git/MailgunSpamComplaints?path=/MailgunSpamComplaints/Module1.vb&_a=contents&version=GBmain
 
 URL:/spaces/DS/pages/2538274909/Email+Queue+Processing