Products
The products / jobs / applications listed below are all critical to Invoice Cloud. They 
must run daily
. 
Any issue 
that prevents these jobs from running, e.g., which introduce 
a delay of more than 15 minutes from the scheduled run time, must be resolved ASAP
.
As a rule, refer to this runbook to try and resolve issues. If the instructions do not resolve the issue, then 
add SPAM as a responder in Jira Ops, post to #spam-spark and @tag the on-call engineers
. If engineers do not respond within 5-10 minutes, 
post to #production-ops
 for further assistance.
“AutoPay”
Multiple applications comprise what product/DS/CS generally call “AutoPay”. From the engineering perspective, “AutoPay” may specifically refer to the AutoPaymentsProcessing application, which is one of several that run in Azure Batch. To refer to these jobs as a whole, you can use the term “AP/SP chain” or “AutoPay chain” (SP is for scheduled payments, and there are other steps in the chain, as well). Please refer to other Confluence docs to learn more about the jobs & AP/SP chain.
“AutoPay” Applications
The following jobs are involved in the AP/SP chain and all run in Azure Batch: 
icautopaydevtest
 and 
icautopay
.
ICAutoPayController - called from a daily recurring job schedule, this creates the jobs and tasks for each biller to execute the AP/SP chain, each Azure task runs the applications below in sequence
ScheduledPaymentBalanceCheck - checks if pending scheduled payments need to be applied to a new invoice (updates InvoiceID in ScheduledPayments table)
RecurringScheduledPaymentsGenerator - deletes existing RSPs in the ScheduledPayments table, then re-generates all RSPs for the next 30 days (not just today’s – this lets payers see the upcoming scheduled payment in the customer portal)
ScheduledPaymentProcessing - processes scheduled payments (includes RSPs, flexpay)
ScheduledPaymentProcessingMultiInvoice - processes 
multi-invoice
 scheduled payments (invoices that are bundled with an invoicegroupguid)
AutoPaymentProcessing - processes autopayments (will not charge more than the balance due)
AutoPaymentsProcessingMultiInvoice - processes 
multi-invoice
 autopayments
CreateLateFees - inserts records into the late fees email queue for past due, unpaid invoices
“Email Queue / EQP”
We are responsible for multiple queues. In Azure Batch, a daily recurring job schedule runs to process 1st/2nd/3rd email notifications. In Skybot, multiple queues run at various frequencies throughout the day.
Email Applications
Skybot
EmailQueueProcessing - Skybot jobs are in the form 
EmailQueueProcessing-#
 where # refers to the EmailQueueTypeID; we are only responsible for notifications, registrations (regular, paperless, autopay), AP/SP reminders, and some payment receipts
Azure Batch
ICEmailQueueController - called by job schedule at 12:15 AM CT to create jobs+tasks for billers' 1st/2nd/3rd email notifications
EmailQueueProcessing - executed multiple times in each biller’s task, once for each queue type (1st/2nd/3rd) - while running in Azure Batch, billers will not be picked up for these notifications in Skybot; there is an additional step at the end of the task to set the flag that will allow Skybot to resume picking up the notifications
Reminders
Email reminders for upcoming scheduled payments and autopayments are sent out daily. Records are inserted into the EmailQueue table for the respective email queue type (AP/SP). These are then processed via the Skybot jobs.
Reminders Applications
ICAutoPayScheduledPayRemindersController - called by daily recurring job schedule in Azure Batch to create jobs+tasks that call the reminder apps
AutoPaymentReminders - inserts reminders into the EmailQueue
ScheduledPaymentReminders - inserts reminders into the EmailQueue
Alerts
AutoPaymentProcessingCompleted
Purpose: To identify billers that successfully completed their AutoPaymentProcessing step each day between 3:40AM and 8:00AM CT. If no biller has completed the step in the past 20 minutes, then an alert is sent. It could indicate tasks are failing / aborted.
Trigger time
:
 20-minute interval
Biller scope: Applies to all billers
Alert channel: Post in 
#dailyautomatedpayalerts 
in slack channel
AutoPaymentProcessing
Purpose: To monitor and identify billers whose AutoPay transactions had a large % of declines or exceptions. It could indicate an outage and/or need to rerun the job for the biller.
Trigger time: Scheduled daily process runs during the AP’s chain runs since 3:00AM CT
Biller scope:Applies to all live billers.
Alert channel: Post in 
#dailyautomatedpayalerts 
in slack channel
High Volume AutoPay – 
runs via Skybot, not Azure Batch
These alerts come from the STAGING-HighVolumeAutoPay job on skybot
A failed status may require a rerun and requires checking the logs in the Job History
Trigger time: Scheduled daily process runs at 3:00AM CT
Biller scope: 2 billers(BID 145 & 830)
ICAutoPayScheduledPayReminder
This alerts comes from the ICAutopayScheduledPayRemindersController on azure batch
Trigger time: Scheduled daily process runs at 2:00PM CT
Biller scope: All active billers
As of today, we sometime get the token expiry alert
Email queue processing(EQP)
This alert comes from ICEmailQueueController on azure batch
Trigger time: Scheduled daily process runs at 12:05AM
Biller scope: all active billers
Alert handling procedures
Acknowledge the alert’s call first. (
ACK
)
AutoPaymentProcessingCompleted
Check the alerts in:
The AP job on azure batch(home/icautopay/jobs)
Are there jobs/tasks created/running?
If It’s running then good
If It’s created but not running → Figure out why (this is worst scenario). It depends on the issue; here are some scenarios that happened in the past:
- Forgot to reset the AP schedule, It might set run after 8:00AM. Reset AP schedule to run at 3:00AM everyday on azure batch(icautopay → job schedules → AutoPayScheduledPayChain → Schedule)
- Forgot to reset AP schedule & remove the rerun variable in Job configuration task. Reset AP schedule to 3:00 AM and remove the rerun variable(icautopay → job schedules → AutoPayScheduledPayChain → job configuration task)
Check the channel #dailyautomatedpminfo to see if there’re messages post on channel. It means that jobs/tasks were created and It’s running → we’re good
Close the alerts at the end of step
AutoPaymentProcessing
Acknowledge the call first
The alert will post on #
dailyautomatedpayalerts
Reviews the log on azure batch base on the BID on the alert. To review the log go to 
iclogstorage → containers → icautopay 
False positive situation: Biller will get the declined payments due to invalid CC/ACH info(accout closed etc). We do not to do here
True positive: payments get declined due to failure of calculate service fee/ ctp. We need to rerun manually these payments.
Rerun autopay processing. 
See the rerun section of the RunBooks for AutoPayment processing
Close the alerts at the end of step
HighVolumeAutoPay
Acknowledge the alerts first
FALSE POSITIVE (nothing to be done, as it failed because there was no payment to be made): System.Exception: Invoice404351844 balance is less than or equal to 0 - current balance: 0
Log it in the Notes column.
In case there was an actual fatal error and nothing got processed, rerun via Skybot (locally if partial success and need to rerun only 1 biller).
remember to run this SP before rerun on skybot: HIghVolumeAutoPay sp: exec tps.selAutoPayProcessingListHighVolume @AutoPayCollectionDate='2022-12-15', @billerid=830
Close the alerts at the end of step
ICAutoPayScheduledPayReminders
Acknowledge the alerts first
Looks in the log on azure batch to determine what causing the alerts. If all billers are processed and completed successfully, otherwise we need to rerun it on azure batch
Close the alerts at the end of step
EmailQueueProcessing
Acknowledge the alerts first
There are 2 kinds of alerts: one from azure batch (first, second and third notification queue) and one from Skybot (rest of the queues).
I don’t have so much info the one from azure batch as today. this will be updated once we get it again.
The current one we get today is comes from skybot. Log in skybot and review the log
Job name should be like STAGING-EmailQueueProcessing-…. Wait until the next run kick off on skybot, review the log of next run. If It’s success then close the alert, If not then ask away.
Maintenance
We have maintenance once a month, it will usually be on a Sunday, and it requires us to modify the run times of the AutoPayChain and EmailQueueProcessing jobs on Azure so that they do not run during the maintenance window.
TBD: Need to verify if the maintenance date is set or changes every month
Changing the start time of the jobs
We will need to modify the run times to 8 AM CST
The AutoPaySchedulePayChain and ICEmailQueueController-CREATED-2023-09-01 are the jobs that will need to be modified in the icautopay batch account
You can find them here: 
Azure icautopay Job Schedules
You will have to navigate to the Schedule of each job and modify the start time
icautopay → Job Schedules → (AutoPaySchedulePayChain) → Schedule
Disabling the alert
We also have logic apps in place that monitor the jobs. These will need to be disabled so that the alerts do not go out
To disable the alerts, you can navigate to the logic apps section of Azure: 
Logic Apps
The logic apps we use for the AutoPayChain:
IC Monitor - AutoPaymentProcessing
IC Monitor - AutoPaymentProcessingCompleted
Once you select a logic app you can disable it from the menu towards the top
Note: View/Read permissions may be required for this step
Resetting the job time when maintenance is done
After the maintenance, we need to reset the schedules back to the original start times
AutoPaySchedulePayChain - Original start time = 3:00 AM CST
ICEmailQueueController-CREATED-2023-09-01 - Original start time = 12:00 AM CST
Re-enable the logic apps
Additional Resources
ICAutoPayController README
 
How To: Rerun Autopay - Development Support - Confluence
 – 
supplements the instructions here (may be redundant in some cases)
AutoPay - Development Support - Confluence
 – 
another overview of the jobs
icautopay Batch Account
 
– production batch account for autopay and reminders
icbatch - Microsoft Azure
 
– production batch account for emails
IC Monitor - AutoPaymentProcessing
 
– logic app
IC Monitor - AutoPaymentProcessingCompleted
 – logic app
Resolution strategies
Reruns
AutoPaymentProcessing (and other AP/SP jobs)
There are two ways to rerun AutoPay. The Azure Batch and manually running AutoPaymentProcessing
Azure Batch
Set up a rerun on icautopay on Azure Batch with these rerun variables(billeridlist, startindex, and rerun)
Note: To start the AutoPayChain at the AutoPaymentProcessing step, we need to set the startindex = 5
After the rerun is finished, we need to remove all rerun variables and reset AP’s schedule to 3:00 AM
Running AutoPayment Manually
Sometimes a Billers AutoPayChain completes successfully, but there were some failed payments during the AutoPaymentProcessing step that need to be rerun.
 First, check the payments table and the AutoPaymentProcessing SP on the database to see if the Invoices that failed need to be rerun. 
Repo Needed: AutoPaymentProcessing
Note: If re-running more than for more than one Biller, or not from a fresh clone, 
AutoPaymentProcessing
 may require a re-build to run with new changes. 
Do 
Build
 → 
Rebuild AutoPaymentProcessing
Change the BillerID property to return only the BillerID to rerun (You have to rerun the Billers that had errors 1 by 1)
If needing to isolate specific invoice/s for the rerun, use the following snippet to do so. Place this just below the Try in the ProcessAutoPayPayments method in Module1.vb to run only the InvoiceIDs added to the list.
' code to skip the invoices which do not need to be manually run (modify the XXXX)
Dim invoiceIDsToRunManually As New List(Of Integer) From { XXXX }
If Not invoiceIDsToRunManually.Contains(autoPayPayment.InvoiceID) Then
    Return True
End If
Rerunning Azure Batch For a Failed Task
If a Billers task failed on one of the seven steps of the AutoPayChain you will need to schedule a rerun
Determine which step the task failed on
1|ScheduledPaymentBalanceCheck 
2|RecurringScheduledPaymentsGenerator 
3|ScheduledPaymentProcessing 
4|ScheduledPaymentProcessingMultiInvoice 
5|AutoPaymentProcessing 
6|AutoPaymentsProcessingMultiInvoice  
7|CreateLateFees
Once you have determined which step you have to set the schedule to start from, you will need to proceed with the same steps from the section on rerunning AutoPaymentProcessing on Azure Batch. However, the 
startindex
 variable will be set to the step the task failed on. Also add the 
recordfailures
 variable and set the value to 1.
After the rerun is finished, we need to remove all rerun variables and reset AP’s schedule to 3:00 AM CT
Summary email exceptions (for AutoPay)
At the end of the AutoPayChain the ICAutoPayController will send out summary emails to the it_processes inbox.
SP & Auto Pay Completed Successfully:
Note: If any billers had their task fail during the Azure run, they will be listed at the bottom
Auto Payment Summary:
Note: Any invoices that had issues during AutoPay will be listed here. These invoices will need to be rerun if they haven’t been processed
The rest of the AutoPayChain will also have summary emails listing the exceptions during the run at the bottom
AutoPay Multi-Invoice Processing Summary
Scheduled Payment Summary - Multi Invoice
Scheduled Payment Summary
Example use cases for common support issues
Email queue processing
There’s an RTDR issue that make this SFB(3898) process slowly on azure batch. We must terminate it around 7:00PM-8:00PM to help the EQP complete before the next day run.
AutoPaymentProcessing
You might see “Checking general Exception: Bad Request” in the Auto Payment Summary email. These can be ignored because they were failures that we have already attempted to rerun but could not.
You might see “The source contains no DataRows” in the Auto Payment Summary email. These can also be ignored because these are usually errors during the sending of the payment email, but the payment has already been processed.
Slack Channels
#dailyautomatedpmtinfo – informational channel about the status of all billers for AP/SP chain
#daily-invoice-email-notifications – information channel about the status of all billers for 1st/2nd/3rd email notifications
#dailyautomatedreminders – status of all billers for AP/SP reminders
#productionops – the first channel to bring up questions or discussion around potentially larger issues (use @here)
#dailyopsissues – channel for incidents to be posted and discussed – escalates from production ops
#dailyautomatedpayalerts – channel where autopay alerts are posted from the logic apps
#spam-spark – coordination & questions about alerts etc
Notes & best practices
AP/SP chain of events
2
1
0
0
4505305089
4495081492
1
Untitled Diagram-1752759258045.drawio
1
1
https://invoicecloud.atlassian.net/wiki
Untitled Diagram-1752759258045.drawio
0
231
721
 URL:/spaces/PE/pages/4495081492/Team+SPAM+SPARK+Runbook