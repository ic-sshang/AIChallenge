Safety Insurance Technical Design
Referenced Jira Items: 
EBPP-14659
EBPP-16992
EBPP-17850
Biller Options Enabled:
Option 102 ON
Option 147 ON
Option 150 ON
Agent Limitations on Invoice Cloud Pages During Enrollment
Once the Agent is handed over to Invoice Cloud, they should have some limitations as to what they are able to do on behalf of the insured.
The Agent should be able to:
Add bank account
Enable AutoPay with added bank account
Only add bank and enroll AutoPay on the specified policy
The Agent should 
NOT
 be able to:
Enroll in AutoPay using credit card
Enroll an insured’s 2nd policy (if applicable) in AutoPay
Redirect to Saved Payments Page
Safety has custom logic that redirects the user to the Saved Methods Page from the AutoPay page if they do not have any saved payments available.
Code Linked
Home Button Redirect
A new AgentConnect parameter (HomeButtonUrl) was requested by Safety to change the home button’s link during an AgentConnect session to whatever is provided in the AgentConnect HomeButtonUrl request.  This was done after Safety noticed their agents would be allowed to access the CustomerWelcome.aspx page which provided a way for their agents to make unauthorized payments for the customer. Instead, when an agent clicks on the home button, they will be redirected to the URL that is in the HomeButtonUrl parameter in Safety’s AgentConnect API request. By default, if a HomeButtonUrl is not provided, the agent will be directed to the CustomerWelcome.aspx page as normal. Should Safety provide an invalid URL, they will receive the following error.
Invalid URL error message in Postman
Home Button Link that is altered through AgentConnect’s HomeButtonURL parameter. 
 
Link on Saved Payments Page Logic
Safety has 
Biller Option 102
 to hide the AutoPay link. 
Biller Option 147
 will override Biller Option 102 and allow this link to be shown when AgentConnect is in session and RedirectMode is 3(AutoPay Setting). This allows the agent to be redirected to the AutoPay page using the link. Since Safety uses IFrame, the agent cannot access the AutoPay page without this link when they’ve been redirected to the Saved Payments Method page if the customer has no Saved Payment Methods. Therefore, if Biller Option 147 is not on, the Agent cannot sign the customer up with AutoPay. 
With option 147 on
Code Link
Safety also has logic to show the “Only bank accounts are supported for AutoPay” message.
Code Link
Safety also does not allow an agent to sign up for AutoPay using a credit card. To emphasize this, code was added to not show the “+ Add New Credit Card” link when the agent is using RedirectMode = 3 for Safety and only show “+Add New Bank”. 
Code Link
Safety’s AutoPay Strategy logic
Safety’s autopay strategies can be found in the AutoPayStrategyFactory class in the IC.Common Project in the MyIIS repo. This section will describe what each strategy of the class does.
GetEligibilityStrategy
Safety has a Custom 5 flag on their invoices that determines AutoPay eligibility. A Safety customer cannot be signed up for AutoPay without this flag. This logic does not apply to AgentConnect. The only requirement for AgentConnect is that RedirectMode = 3. If so, the customer can be signed for AutoPay and does not check the Custom 5 flag.
Code Link
: An error message will appear if the account is not eligible for AutoPay 
For non-Safety billers, they follow the standard logic of not checking the Custom 5 flag.
GetBillerUsesCCAutoPayStrategy
Safety does not allow signing up for AutoPay with a credit card
Code Link
:
 Used to show the “+ Add New Credit Card” link
GetStrategyForFilteringAgentConnectAutoPayCustomers
Safety uses linked accounts/policies. However, Safety only wants the passed in account to be signed up for AutoPay. Therefore, no dropdowns should show the non-passed in linked accounts/policies.
Code Linked
: Only load the incoming customer account
Code Linked
: Only display the incoming customer account in the drop-down
Code Linked
: Gets the filter strategy for the biller
Code Linked
: Only does the filtering for Safety’s filtering strategy and if an AgentConnectSession is in progress.
Code Linked
: Only have the AutoPay report pull the customer passed in
Code Linked
: If should override hide AutoPay setting, then allow AutoPay link to be shown if AgentConnect session exists and option 147 is on, and RedirectMode = 3. 
GetStrategyForForcedPaperless()
Safety does not want an agent to force a customer to sign up for paperless enrollment through AgentConnect; however, they do want to force paperless everywhere else. This strategy checks that an AgentConnectSession exists and biller option 150 is on.
Code Linked
: Logic to not show the forced paperless notice when biller option 150 is on and there is an AgentConnectSession
Code Linked
: Send a boolean to ICRestAPI to confirm whether or not the API should override forced paperless and not sign the customer for paperless.
Code Linked
: Do not put the customer on the pending registration table if the biller does not want to force paperless.
Code Linked
: Do not force paperless enrollment if biller option 150 is on and an AgentConnect session exists
Code Linked
: If the sent boolean is true, then do not force paperless in ICRestAPI
 URL:/spaces/PE/pages/3031859288/AgentConnect+-+Safety+Customization