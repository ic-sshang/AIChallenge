1
6
false
circle
list
true
Setting Up the Development Environment
Install .Net 8 SDK
Install Visual Studio Professional / Visual Studio Code
Creating a New ASP.NET Console Application Project
Create a new code repository in Azure DevOps (use Pascal naming convention).
{YourProject}
Code repositories are now organized by domain. Check if your application’s domain has an ADO project (e.g., “Biller”). If you are unsure what domain your API falls under or which ADO project to use, work with your team's architect.
Use the appropriate project structure for your project’s assets, 
Solution/Project Structure
 
Console Application Solutions typically have the following projects: 
{YourProjectName}.ConsoleApp
{YourProjectName}.Core
{YourProjectName}.Repositories
{YourProjectName}.Services
{YourProjectName}.UnitTests
Visual Studio Code
Create sub folders: 
{YourProjectName}.ConsoleApp
{YourProjectName}.Core
{YourProjectName}.Repositories
{YourProjectName}.Services
{YourProjectName}.UnitTests
Use the following CLI command to scaffold {YourProjectName}.ConsoleApp
#Creates {YourProjectName}.ConsoleApp
dotnet new console -n ProjectName.ConsoleApp

#Create {YourProjectName}.Core , Services etc. 
dotnet new classlib -n ProjectName.Core

#Create {YourProjectName}.UnitTests
dotnet new nunit -n ProjectName.UnitTests
Visual Studio
Use the C# Console App Template
Configure your new project
Solution Name: {YourProjectName}
Project Name: {YourProjectName}.ConsoleApp
Additional Information
Framework: .Net 8.0
Uncheck container support
Optional: Do not use top-level statements
Uncheck Enable native AOT Publish
Add new projects to your solution using the 
Class Library
 template for the below projects. 
{YourProjectName}.Core
{YourProjectName}.Repositories
{YourProjectName}.Services
Add a new project to your solution using the 
Nunit 3 Test Project
 template for the unit test project, be sure to place it under a subfolder called Tests. 
{YourProjectName}.UnitTests
Nuget
Create a 
nuget.config
 in the root of your project folder
<?xml version="1.0" encoding="utf-8"?>
<configuration>
  <packageSources>
    <clear />
    <add key="nuget.org" value="https://api.nuget.org/v3/index.json" protocolVersion="3" />
    <add key="ICPackages" value="https://pkgs.dev.azure.com/invoicecloud/_packaging/ICPackages/nuget/v3/index.json" />
    <add key="ICQE" value="https://pkgs.dev.azure.com/invoicecloud/QA_Src/_packaging/QE-Framework/nuget/v3/index.json" />
    <add key="test-feed" value="https://pkgs.dev.azure.com/invoicecloud/_packaging/test-feed/nuget/v3/index.json" />
  </packageSources>
  <packageSourceCredentials>
    <ICPackages>
      <add key="Username" value="%NUGET_USERNAME%" />
      <add key="ClearTextPassword" value="%NUGET_PAT%" />
    </ICPackages>
    <ICQE>
      <add key="Username" value="%NUGET_USERNAME%" />
      <add key="ClearTextPassword" value="%NUGET_PAT%" />
    </ICQE>
    <test-feed>
      <add key="Username" value="%NUGET_USERNAME%" />
      <add key="ClearTextPassword" value="%NUGET_PAT%" />
    </test-feed>
  </packageSourceCredentials>
</configuration>
Docker
Create a 
Dockerfile 
in the root of your project folder
docker
# helpful link on using private nuget feed in build process - http://mikehadlow.blogspot.com/2020/08/restoring-from-azure-artifacts-nuget.html
ARG NUGET_USERNAME
ARG NUGET_PAT
ARG SEMVER=0.0.0.0
ARG NUGET_VERSION=0.0.0

#build layer
FROM mcr.microsoft.com/dotnet/sdk:8.0 AS build
ARG NUGET_USERNAME
ARG NUGET_PAT
ARG SEMVER
ARG NUGET_VERSION
ENV NUGET_USERNAME=${NUGET_USERNAME}
ENV NUGET_PAT=${NUGET_PAT}

WORKDIR /src
COPY . .
RUN dotnet restore -p:Configuration=Release -v:n || exit 1
RUN dotnet build --no-restore -c:Release -p:Version=$SEMVER -p:NuGetVersion=$NUGET_VERSION ./YourProjectName.ConsoleApp
RUN dotnet publish --no-build -o /publish -c:Release ./YourProjectName.ConsoleApp

#deployed layer
FROM mcr.microsoft.com/dotnet/runtime:8.0 AS runtime
WORKDIR /app
COPY --from=build /publish .


# create a new group and non root user
RUN addgroup --gid 2000 job && adduser --uid 1000 --gid 2000 --disabled-password --gecos "" jobapp

# apply new user ownership, run as the new user
RUN chown -R jobapp:job /app
USER jobapp:job
ENTRYPOINT ["./YourProjectName.ConsoleApp"]
Build Pipeline
Create a 
.devops
 subfolder in the root of your project folder. 
Create a 
build.yaml 
file in the 
.devops
 folder
resources:
  repositories:
    - repository: templates
      type: git
      name: Platform/azure-pipelines-container-templates
      ref: refs/tags/platform-0/2.3.0

extends:
  template: stages/dotnet-container-build.yaml@templates
  parameters:
    projectName: YourProject
    imageName: yourProject-job
    registry: acrglbimages1sbx.azurecr.io
    gitversionYml: .devops/gitversion.yaml
    nugetConfigPath: ./nuget.config
    extraBuildArgs: --build-arg NUGET_USERNAME=$(nuget_username) --build-arg NUGET_PAT=$(nuget_pat) --build-arg SEMVER="$(GitVersion.SemVer)" --build-arg NUGET_VERSION="$(GitVersion.NuGetVersion)"

variables:
  - group: Nuget Feed Reader
  - group: yourproject-dev #this would be payer-dev, biller-dev etc.

Create a 
gitversion.yaml
 file in the 
.devops 
folder
mode: Mainline
assembly-versioning-scheme: MajorMinorPatchTag
assembly-file-versioning-scheme: MajorMinorPatchTag
branches: 
  main:
    prevent-increment-of-merged-branch-version: true
    regex: '^main$'
Example
Deployment Pipeline
Create a deploy.yaml file in the .devops folder
trigger: none

resources:
  repositories:
    - repository: templates
      type: git
      name: azure-pipelines-container-templates
      project: Platform
      ref: refs/tags/platform-0/2.3.0
  pipelines:
    - pipeline: build
      source: Build_MailgunSpamComplaints
      trigger: true

parameters:
  - name: devInstance
    displayName: 'Development Instance'
    default: main
    type: string
  - name: enablePostDeploymentTests
    displayName: 'Enable Post Deployment Tests'
    type: boolean
    default: false

extends:
  template: stages/helm-deploy.yaml@templates
  parameters:
    infrastructureVersion: 3
    chartName: cronjob
    chartVersion: 0.1.0
    spoke: payer
    serviceName: 'mailgun-spam-complaints' #yourproject-name-*
    gitVersionConfigFile: .devops/gitversion.yaml
    nonProdAcrName: acrglbimages1sbx
    nonProdAcrSubscription: "Sandbox"
    variableGroupWithNonProdAcrAccess: 'payer-dev' #use your cluster name, payer-dev is used here
    enablePostDeploymentTests: ${{ parameters.enablePostDeploymentTests }}
    environments:
      dev:
        testFilter: ""
        testFilterExtension: ""
        instance: ${{ parameters.devInstance }}
        agentPool: "sbx-agents"
        testingPool: sbx-agents
        variableGroupName: "payer-dev" #use your cluster name here
        subscription: "Enterprise Dev/Test"
        promoteImagesPrior: false
        acrName: acrglbimages1sbx
      prd-pri:
        testFilter: "Category=smoke"
        testFilterExtension: ""
        instance: main
        agentPool: "prd-agents"
        testingPool: prd-agents
        variableGroupName: "payer-prd" #use your cluster name here
        subscription: "Enterprise Prod"
        promoteImagesPrior: true
        acrName: acrglbimages1
Helm Environment Configurations
Create a 
.helm
 subfolder in the root of your project folder
Create a 
environments
 subfolder in the 
.helm
 folder
Create a YAML file for each environment under environments using the following naming convention
{env_abbrv}.yaml
dev.yaml
 
(Development)
# Image configuration
image:
  repository: acrglbimages1sbx.azurecr.io/mailgun-spam-complaints-job # your project job image repository

# Concurrency policy to prevent concurrent runs
concurrencyPolicy: "Forbid"

# Environment variables
extraEnvVars:
  - name: IC__SqlDatabase__MasterConnectionString
    value: Server=tcp:ic-dbtest-east-server1.database.windows.net,1433;Initial Catalog=DbMaster_GoldAzure;Connection Timeout=120;Authentication=Active Directory Default; # Master database connection string
  - name: IC__SqlDatabase__BillerConnectionStringTemplate
    value: Server=tcp:ic-dbtest-east-server1.database.windows.net,1433;Initial Catalog={BillerShard};Connection Timeout=120;Authentication=Active Directory Default; # Biller shard connection string template
  - name: Job__MaxParallelism
    value: "3" # Maximum parallelism set to 3

# Secret provider configuration
secretProvider:
  keyVaultName: kv-glb-vault1-dev # Key Vault name
  secretObjects: 
    - secretName: MailGun-ApiKey
      envVarName: IC__MailgunApi__MailgunApiKey # Environment variable for MailGun API key

# Schedule configuration
schedule: "30 6/12 * * *" # Runs at 30 minutes past every 6th and 12th hour

# Resource requests and limits
resources: 
  requests:
    memory: .5Gi # Memory request
    cpu: .5 # CPU request
  limits:
    memory: .5Gi # Memory limit

# Node selector configuration
nodeSelector:
  agentpool: job # Specifies the job agent pool

prd-pri.yaml 
(Production Primary)
# Image configuration
image:
  repository: acrglbimages1.azurecr.io/mailgun-spam-complaints-job # your project job image repository

# Concurrency policy to prevent concurrent runs
concurrencyPolicy: "Forbid"

# Environment variables
extraEnvVars:
  - name: IC__SqlDatabase__MasterConnectionString
    value: Server=tcp:ic-db-fg1.database.windows.net,1433;Initial Catalog=DbMaster_GoldAzure;Connection Timeout=120;Authentication=Active Directory Default; # Master database connection string
  - name: IC__SqlDatabase__BillerConnectionStringTemplate
    value: Server=tcp:ic-db-fg1.database.windows.net,1433;Initial Catalog={BillerShard};Connection Timeout=120;Authentication=Active Directory Default; # Biller shard connection string template
  - name: Job__MaxParallelism
    value: "3" # Maximum parallelism set to 3

# Secret provider configuration
secretProvider:
  keyVaultName: kv-glb-vault1 # Key Vault name
  secretObjects: 
    - secretName: MailGun-ApiKey
      envVarName: IC__MailgunApi__MailgunApiKey # Environment variable for MailGun API key

# Schedule configuration
schedule: "30 6/12 * * *" # Runs at 30 minutes past every 6th and 12th hour

# Resource requests and limits
resources: 
  requests:
    memory: 2Gi # Memory request
    cpu: 2 # CPU request
  limits:
    memory: 2Gi # Memory limit
 URL:/spaces/ED/pages/4083515412/.Net+Core+Console+Applications+k8s+Containerized