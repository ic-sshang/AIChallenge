We host our own Azure Pipeline agents to run many of our pipelines. This is necessary primarily due to networking requirements. If I want to run tests against or deploy to an environment,  I’ll need to be able to reach that environment. To facilitate this, we’ve created agent pools within our various network spaces.
Our pools
Agents of Quality
This pool contains a single Windows server based agent - 
IC-SELENIUM1
. It’s only used to run legacy functional tests. It shouldn’t be used for new workloads and will be phased out as the legacy functional tests are migrated to our newer BDD suites.
Azure Pipelines
Frankly, I’m confused on this one. The pool’s owner is also named ‘Azure Pipelines’. It appears to be running jobs that are supposed to be running on ‘IC-Kubernetes’. However, when you look at the pipeline that ran, you see that the pipeline did actually execute on ‘IC-Kubernetes’.
Default
This hasn’t been used in over a year and only has one offline agent. It can probably be deleted.
IC-Azure
This contains a single agent, 
IC-BUILDAGENT1
. It’s typically used for dotnet application builds, including web apps, console apps, and proxy apps. 
IC-Azure2019
This contains a single agent, 
IC-BUILDAGENT2. 
It is typically used to execute functional tests and facilitate deployments by starting and stopping Skybot jobs. 
IC-Kubernetes
This pool contains multiple agents which live in the Kubernetes cluster ‘aks-east-akstooling-legacyapps’ in Primary-Subscription. It lives in the Internal-Network and mostly runs functional tests.
prd-agents
This pool contains multiple agents which live in the Kubernetes cluster ‘aks-pri-tooling2’ in the ‘Enterprise Prod’ subscription. It lives in the primary production network hub and handles Kubernetes deployments, Terraform deployments and functional test execution for everything within its network space.
prd-sec-agents
This pool is the equivalent to ‘prd-agents’, but in the secondary network rather than the primary.
sbx-agents
This pool lives in the Kubernetes cluster ‘aks-pri-tooling2-sbx’ in the ‘Sandbox’ subscription. It lives in the sandbox network hub and handles everything that ‘prd-agents’ does within its own network space.
windows-container-build-agents
This pool lives in the same place as ‘sbx-agents’ and is used only to run Windows Docker based jobs.
windows-docker-agents
This pool is a duplicate of ‘windows-container-build-agents’.
Deploying a Kubernetes Pool
Authenticate to the desired cluster. You may need to SSH/RDP into a jumpbox to achieve network connectivity to the cluster. To connect to the cluster ‘aks-pri-tooling2-sbx’, you’d need to run the rest of these commands from one of the Sandbox jumpboxes.
az login
az aks get-credentials -n <cluster name> -g <cluster resource group> --subscription <subscription name>
Clone the pipeline agents repository. 
git clone https://invoicecloud@dev.azure.com/invoicecloud/QA_Src/_git/app-pipeline-agents
Update stateful-agents.yaml to match your desired configuration.
Replace 
< insert PAT here >
 with your ADO PAT that has access to read and manage agent pools
Set 
replicas
 to your desired count. It is currently 8 by default. This will be the number of agents in your pool.
Set 
image
 to the image registry, repository and tag for an ACR accessible in your cluster. For the sandbox tooling cluster, this would be 
acrglbimages1sbx.azurecr.io/pipeline-agent:latest
Set the value for the environment variable 
AZP_POOL
 to the pool name in which you’d like to register these agents.
Run 
kubectl apply -f stateful-agents.yaml
 to deploy the pool.
Check on the status of the agents either in the cluster or in the ADO UI. You should see the agents registering within the pool in the UI. Some helpful commands to check the cluster are
kubectl get pods -n buildagents
kubectl get statefulsets -n buildagents
kubectl describe statefulsets -n buildagents
 URL:/spaces/platform/pages/2783248415/ADO+Agents