Objective:
 
To 
enable blocking AutoPay enrolment for ACH payment methods
 based on 
Invoice Type settings
 in the system, allowing business control over ACH AutoPay enablement per invoice type. 
 
Current System: 
AutoPay is currently allowed for ACH without restrictions based on Invoice Type. 
The AutoPaymentConfig table holds AutoPay configuration at the invoice type level. 
AutoPay enrolment options are shown on: 
AutoPay page
 
OTP route
  
CloudPaymentAutopayEnroll page
 
 
Required Changes: 
Database:
 
Add a new column BlockAutoPayACH (bit) to AutoPaymentConfig table to indicate if ACH AutoPay should be blocked for the invoice type. 
Update the following stored procedures to handle this column: 
[dbo].[insAutoPaymentConfig] 
[dbo].[selAutoPaymentConfig] 
[dbo].[updAutoPaymentConfig] 
CRM (InvoiceSetting Page):
Add an 
Allow/Block toggle
 for ACH AutoPay at the invoice type level. 
Update SP calls to save and retrieve the BlockAutoPayACH flag. 
Customer Portal (AutoPay Page):
 
Check the BlockAutoPayACH flag for the invoice type before displaying ACH as a payment method for AutoPay. 
If blocked, 
hide ACH payment method for AutoPay enrolment
. 
OTP Route:
 
During ACH payment, check if AutoPay for ACH is blocked for the invoice type. 
If blocked, 
hide or disable AutoPay enrolment option
. 
CloudPaymentAutopayEnroll Page:
 
Check the BlockAutoPayACH flag for the invoice type before enrolling the user for ACH AutoPay. 
If blocked, 
prevent enrolment and return an appropriate validation message
. 
 
Implementation Plan: 
Database Changes
 
Add column:
 
ALTER TABLE AutoPaymentConfig ADD BlockAutoPayACH BIT NOT NULL DEFAULT 0; 
Update SPs:
 
Add the BlockAutoPayACH parameter in ins, upd, sel SPs. 
 CRM Changes (InvoiceSetting Page)
 
Add 
Allow/Block ACH AutoPay toggle
 in UI. 
Update SP calls to send and retrieve BlockAutoPayACH flag. 
AutoPay Page Updates
 
On page load, fetch BlockAutoPayACH for the invoice type. 
Hide ACH payment method if blocked. 
OTP Route Updates
 
Before displaying AutoPay enrolment options during ACH payment, check BlockAutoPayACH. 
Hide enrolment option if blocked. 
CloudPaymentAutopayEnroll Page Updates
 
Check BlockAutoPayACH during ACH AutoPay enrolment. 
If blocked, return a validation error: "AutoPay enrolment for ACH is not allowed for this invoice type." 
 
Testing Plan: 
Unit Tests:
 
For stored procedure updates. 
For backend SP call changes. 
Integration Tests:
 
End-to-end ACH AutoPay enrolment tests for blocked and allowed scenarios. 
UI Tests:
 
Ensure toggle visibility and behaviour on the CRM InvoiceSetting page. 
Ensure correct hiding/showing of ACH AutoPay options on customer portal pages. 
 
Test Scenarios: 
Scenario 1(Automation): Allow ACH AutoPay Enrolment when BlockAutoPayACH is False
 
Given
 the admin has set BlockAutoPayACH to false for InvoiceTypeA in the InvoiceSetting page 
When
 a user visits the AutoPay enrolment page for InvoiceTypeA 
Then
 the ACH payment method should be visible for AutoPay enrolment 
 
Scenario 2(Automation): Block ACH AutoPay Enrolment on AutoPay Page when BlockAutoPayACH is True
 
Given
 the admin has set BlockAutoPayACH to true for InvoiceTypeB in the InvoiceSetting page 
When
 a user visits the AutoPay enrolment page for InvoiceTypeB 
Then
 the ACH payment method should not be visible for AutoPay enrolment 
 
Scenario 3(Automation): Block ACH AutoPay Enrolment during ACH Payment Flow via OTP Route
 
Given
 the admin has set BlockAutoPayACH to true for InvoiceTypeC in the InvoiceSetting page 
When
 a user initiates an ACH payment for InvoiceTypeC and completes OTP verification 
Then
 the AutoPay enrolment option should not be displayed during or after the payment flow 
 
Scenario 4: Block ACH AutoPay Enrolment on CloudPaymentAutopayEnroll API when BlockAutoPayACH is True
 
Given
 the admin has set BlockAutoPayACH to true for InvoiceTypeD in the InvoiceSetting page 
When
 a user attempts to enrol in ACH AutoPay for InvoiceTypeD using the CloudPaymentAutopayEnroll endpoint 
Then
 the system should return a validation error stating "AutoPay enrolment for ACH is not allowed for this invoice type." 
 
Scenario 5: Allow ACH AutoPay Enrolment on CloudPaymentAutopayEnroll API when BlockAutoPayACH is False
 
Given
 the admin has set BlockAutoPayACH to false for InvoiceTypeE in the InvoiceSetting page 
When
 a user attempts to enrol in ACH AutoPay for InvoiceTypeE using the CloudPaymentAutopayEnroll endpoint 
Then
 the system should successfully enrol the user for ACH AutoPay 
 
Scenario 6 (Autoamtion): CRM InvoiceSetting Allows Admin to Set BlockAutoPayACH Flag
 
Given
 the admin accesses the InvoiceSetting page in CRM 
When
 the admin toggles the Allow/Block ACH AutoPay setting for an invoice type 
Then
 the system should update the BlockAutoPayACH flag in the AutoPaymentConfig table accordingly 
 
Scenario 7: Default Behavior for Existing Invoice Types (Backwards Compatibility)
 
Given
 BlockAutoPayACH is not explicitly set for existing invoice types after migration 
When
 a user visits the AutoPay page for these invoice types 
Then
 the ACH payment method should remain visible for AutoPay enrolment (default behaviour) 
 
Scenario 8: UI Consistency Across Pages
 
Given
 the admin has set BlockAutoPayACH to true for InvoiceTypeF
 
When
 the user navigates to: 
AutoPay enrolment page 
OTP payment flow for ACH 
Attempts ACH AutoPay enrolment via CloudPaymentAutopayEnroll 
Then
 the ACH payment method for AutoPay enrolment should be consistently blocked across all touchpoints for InvoiceTypeF 
 
Impact Analysis: 
No impact on existing ACH payments. 
Only impacts 
AutoPay enrolment
 for ACH payment methods. 
Does not affect Credit Card or other payment methods. 
Minor changes to CRM UI and customer portal UI to handle the allow/block flag. 
 
Dependency with any cross functional team: No 
Estimated Total Timeline: 1 Sprint (including Automation) 
Tentative Release Plan for Sprint 16:
 
Development completion by 24
th
 July with Unit testing. 
Complete Automation by 25
th
 July. 
QA manual testing should be done by 25
th
 July. 
Complete Review and merge changes to main branch by 25
th
 July EOD. 
Move items to Development Queue by 28
th
 July. 
Target release date: 29
th
 July. 
 
 
 
 URL:/spaces/PE/pages/4504322086/Blocking+AutoPay+enrollment+for+ACH+payment+method