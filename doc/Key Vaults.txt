2
6
false
default
list
false
NextGen
There are 3 Levels of KeyVaults in the InvoiceCloud NextGen Architecture:
Environment Wide
AKS Cluster Level
Application Service Level
Environment Wide
There are 6 Environments in the InvoiceCloud NextGen Architecture:
Sandbox (
sbx
)
Development (
dev
)
Internal User Acceptance Testing (
iat
)
Quality Assurance Regression Testing (
qar
)
External User Acceptance Testing (
xat
)
Production (
prd
)
Each Environment has 2 Key Vaults (listed below) that can be used by any Application in the Environment.
Environment Wide Application Secrets and Configurations Key Vault
Naming Convention: 
kv-glb-vault{deployment-version}-{environment-specifier}
kv-glb-vault1-sbx
kv-glb-vault1-dev
kv-glb-vault1-iat
kv-glb-vault1-qar
kv-glb-vault1-xat
kv-glb-vault1
Environment Wide Cryptographic Secrets Key Vault
Naming Convention: 
kv-glb-crypto{deployment-version}-{environment-specifier}
kv-glb-crypto1-sbx
kv-glb-crypto1-dev
kv-glb-crypto1-iat
kv-glb-crypto1-qar
kv-glb-crypto1-xat
kv-glb-crypto1
Access to Environment Wide Key Vaults
Access to the Environment Wide Key Vaults are governed by Azure Active Directory (AAD) Groups.  There is a set of AAD Groups per Environment for each type of Environment Wide Key Vault (Application and Crypto).
Environment Wide Application Secrets and Configurations Key Vault AAD Groups
ic-iac-global-vault-admins-{environment-specifier}
ic-iac-global-vault-readers-{environment-specifier}
Environment Wide Cryptographic Secrets Key Vault AAD Groups
ic-iac-crypto-vault-admins-{environment-specifier}
ic-iac-crypto-vault-readers-{environment-specifier}
AKS Cluster Level
The primary application/workload hosting model in the InvoiceCloud NextGen Architecture is Kubernetes Clusters attached to Spoke VNets.  Each Cluster will have a Key Vault that can be used by the Applications hosted in the Cluster for Secrets and Configurations management.
Naming convention: 
kv-{high-availability-region}-{application-name}{deployment-version}-{environment-specifier}
Example: 
kv-pri-payer3-dev
Access to AKS Cluster Level Key Vaults
Access to the AKS Cluster Level Key Vaults are controlled by the Application Development Team AAD Groups that get created per Environment as listed below:
ic-iac-{application-name}-team-admins-{environment-specifier}
ic-iac-{application-name}-team-developers-{environment-specifier}
ic-iac-{application-name}-team-readers-{environment-specifier}
Application Service Level
It is expected that each Kubernetes Cluster will host multiple Application Services related to the Workload being hosted in the Cluster.  Each Application Service will have a Key Vault dedicated to that Application Service for Secrets and Configurations management.
Naming convention: 
kv-{high-availability-region}-{application-service-name}{deployment-version}-{environment-specifier}
Example: 
kv-pri-otp-main3-dev
Access to Application Service Level Key Vaults
Access to the Application Service Level Key Vaults are controlled by the Application Development Team AAD Groups that get created per Environment as listed below:
ic-iac-{application-name}-team-admins-{environment-specifier}
ic-iac-{application-name}-team-developers-{environment-specifier}
ic-iac-{application-name}-team-readers-{environment-specifier}
Legacy
DevTest
IC-BrainyBanditsKV
Usage: 
Unknown
Networking:
Selected Networks
Public Access
Private Endpoints
None
icappsettingsdevtest
Usage: 
DevTest Applications Secrets and Configuration Store
Networking: 
Selected Networks
az keyvault network-rule list -n icappsettingsdevtest -g rg-east-devapp
{
  "bypass": "AzureServices",
  "defaultAction": "Deny",
  "ipRules": [
    {
      "value": "52.179.97.15/32"
    },
    {
      "value": "20.102.115.105/32"
    },
    {
      "value": "20.49.104.57/32"
    },
    {
      "value": "13.68.141.91/32"
    },
    {
      "value": "20.49.104.49/32"
    },
    {
      "value": "20.49.104.29/32"
    },
    {
      "value": "20.75.169.55/32"
    },
    {
      "value": "20.75.169.116/32"
    },
    {
      "value": "20.75.169.54/32"
    },
    {
      "value": "20.193.156.81/32"
    },
    {
      "value": "8.29.228.186/32"
    }
  ],
  "virtualNetworkRules": [
    {
      "id": "/subscriptions/f89b91a0-e110-4fbb-b84b-24c02f68cd81/resourcegroups/rg-east-infraqacommon-dev/providers/microsoft.network/virtualnetworks/vnet-east-infraqacommon-dev/subnets/snet-mgmt-infraqacommon-dev",
      "ignoreMissingVnetServiceEndpoint": false,
      "resourceGroup": "rg-east-infraqacommon-dev"
    },
    {
      "id": "/subscriptions/c1e3635c-98d4-47f5-96e0-926717b6f0c4/resourcegroups/primary_rg/providers/microsoft.network/virtualnetworks/internalnetwork/subnets/termserver",
      "ignoreMissingVnetServiceEndpoint": false,
      "resourceGroup": "primary_rg"
    },
    {
      "id": "/subscriptions/c1e3635c-98d4-47f5-96e0-926717b6f0c4/resourcegroups/primary_rg/providers/microsoft.network/virtualnetworks/internalnetwork/subnets/ic-proxy",
      "ignoreMissingVnetServiceEndpoint": false,
      "resourceGroup": "primary_rg"
    },
    {
      "id": "/subscriptions/c1e3635c-98d4-47f5-96e0-926717b6f0c4/resourcegroups/primary_rg/providers/microsoft.network/virtualnetworks/internalnetwork/subnets/ic-apps",
      "ignoreMissingVnetServiceEndpoint": false,
      "resourceGroup": "primary_rg"
    },
    {
      "id": "/subscriptions/c1e3635c-98d4-47f5-96e0-926717b6f0c4/resourcegroups/primary_rg/providers/microsoft.network/virtualnetworks/internalnetwork/subnets/management",
      "ignoreMissingVnetServiceEndpoint": false,
      "resourceGroup": "primary_rg"
    },
    {
      "id": "/subscriptions/c1e3635c-98d4-47f5-96e0-926717b6f0c4/resourcegroups/primary_rg/providers/microsoft.network/virtualnetworks/internalnetwork/subnets/ic-dev-proxy",
      "ignoreMissingVnetServiceEndpoint": false,
      "resourceGroup": "primary_rg"
    },
    {
      "id": "/subscriptions/f89b91a0-e110-4fbb-b84b-24c02f68cd81/resourcegroups/rg-east-infraqa1to6-dev/providers/microsoft.network/virtualnetworks/vnet-east-infraqa1to6-dev/subnets/snet-mgmt-infraqa1to6-dev",
      "ignoreMissingVnetServiceEndpoint": false,
      "resourceGroup": "rg-east-infraqa1to6-dev"
    },
    {
      "id": "/subscriptions/f89b91a0-e110-4fbb-b84b-24c02f68cd81/resourcegroups/rg-azbatch/providers/microsoft.network/virtualnetworks/azbatch_devtest/subnets/controllerpool",
      "ignoreMissingVnetServiceEndpoint": false,
      "resourceGroup": "rg-azbatch"
    },
    {
      "id": "/subscriptions/c1e3635c-98d4-47f5-96e0-926717b6f0c4/resourcegroups/rg-azbatch-test/providers/microsoft.network/virtualnetworks/azbatch_test/subnets/azbatch_test_controllerpool",
      "ignoreMissingVnetServiceEndpoint": false,
      "resourceGroup": "rg-azbatch-test"
    },
    {
      "id": "/subscriptions/c1e3635c-98d4-47f5-96e0-926717b6f0c4/resourcegroups/primary_rg/providers/microsoft.network/virtualnetworks/internalnetwork/subnets/ic-term-contractor",
      "ignoreMissingVnetServiceEndpoint": false,
      "resourceGroup": "primary_rg"
    },
    {
      "id": "/subscriptions/f89b91a0-e110-4fbb-b84b-24c02f68cd81/resourcegroups/rg-east-infra-common-app-dev/providers/microsoft.network/virtualnetworks/vnet-east-infra-common-app-dev/subnets/snet-mgmt-infra-common-app-dev",
      "ignoreMissingVnetServiceEndpoint": false,
      "resourceGroup": "rg-east-infra-common-app-dev"
    },
    {
      "id": "/subscriptions/c1e3635c-98d4-47f5-96e0-926717b6f0c4/resourcegroups/primary_rg/providers/microsoft.network/virtualnetworks/internalnetwork/subnets/ic-dev-web",
      "ignoreMissingVnetServiceEndpoint": false,
      "resourceGroup": "primary_rg"
    },
    {
      "id": "/subscriptions/c1e3635c-98d4-47f5-96e0-926717b6f0c4/resourcegroups/centralindia-rg/providers/microsoft.network/virtualnetworks/centralindia-avd/subnets/avd",
      "ignoreMissingVnetServiceEndpoint": false,
      "resourceGroup": "centralindia-rg"
    },
    {
      "id": "/subscriptions/c1e3635c-98d4-47f5-96e0-926717b6f0c4/resourcegroups/centralindia-rg/providers/microsoft.network/virtualnetworks/centralindia-avd/subnets/private-endpoint",
      "ignoreMissingVnetServiceEndpoint": false,
      "resourceGroup": "centralindia-rg"
    },
    {
      "id": "/subscriptions/c1e3635c-98d4-47f5-96e0-926717b6f0c4/resourcegroups/centralindia-rg/providers/microsoft.network/virtualnetworks/centralindia-avd/subnets/dns-resolver",
      "ignoreMissingVnetServiceEndpoint": false,
      "resourceGroup": "centralindia-rg"
    },
    {
      "id": "/subscriptions/c1e3635c-98d4-47f5-96e0-926717b6f0c4/resourcegroups/centralindia-rg/providers/microsoft.network/virtualnetworks/centralindia-avd/subnets/gatewaysubnet",
      "ignoreMissingVnetServiceEndpoint": false,
      "resourceGroup": "centralindia-rg"
    },
    {
      "id": "/subscriptions/1354872a-6bc9-4eb1-a4f0-feb046832e65/resourcegroups/rg-pri-eus-avd1-npd/providers/microsoft.network/virtualnetworks/vnet-pri-eus-avd1-npd/subnets/snet-pri-eus-avd1-private-endpoints-npd",
      "ignoreMissingVnetServiceEndpoint": false,
      "resourceGroup": "rg-pri-eus-avd1-npd"
    },
    {
      "id": "/subscriptions/1354872a-6bc9-4eb1-a4f0-feb046832e65/resourcegroups/rg-pri-eus-avd1-npd/providers/microsoft.network/virtualnetworks/vnet-pri-eus-avd1-npd/subnets/snet-pri-eus-avd1-avd-npd",
      "ignoreMissingVnetServiceEndpoint": false,
      "resourceGroup": "rg-pri-eus-avd1-npd"
    }
  ]
}
Private Endpoints
Non Prod Hub
keyvault-eastus-app-1
Usage: 
Unknown
Networking: 
Selected Networks
az keyvault network-rule list -n keyvault-eastus-app-1 -g rg-global-app-1
{
  "bypass": "AzureServices",
  "defaultAction": "Deny",
  "ipRules": [],
  "virtualNetworkRules": [
    {
      "id": "/subscriptions/f89b91a0-e110-4fbb-b84b-24c02f68cd81/resourcegroups/rg-east-infraqacommon-dev/providers/microsoft.network/virtualnetworks/vnet-east-infraqacommon-dev/subnets/snet-mgmt-infraqacommon-dev",
      "ignoreMissingVnetServiceEndpoint": null,
      "resourceGroup": "rg-east-infraqacommon-dev"
    },
    {
      "id": "/subscriptions/c1e3635c-98d4-47f5-96e0-926717b6f0c4/resourcegroups/primary_rg/providers/microsoft.network/virtualnetworks/internalnetwork/subnets/ic-apps",
      "ignoreMissingVnetServiceEndpoint": null,
      "resourceGroup": "primary_rg"
    },
    {
      "id": "/subscriptions/c1e3635c-98d4-47f5-96e0-926717b6f0c4/resourcegroups/primary_rg/providers/microsoft.network/virtualnetworks/internalnetwork/subnets/termserver",
      "ignoreMissingVnetServiceEndpoint": null,
      "resourceGroup": "primary_rg"
    },
    {
      "id": "/subscriptions/f89b91a0-e110-4fbb-b84b-24c02f68cd81/resourcegroups/rg-east-infra-common-app-dev/providers/microsoft.network/virtualnetworks/vnet-east-infra-common-app-dev/subnets/snet-mgmt-infra-common-app-dev",
      "ignoreMissingVnetServiceEndpoint": false,
      "resourceGroup": "rg-east-infra-common-app-dev"
    }
  ]
}
Private Ednpoints
Non Prod Hub
Production Primary Subscription
ExternalAppSettings
Usage: 
Production Application Secrets and Configuration Store
Networking: 
Selected Networks
{
  "bypass": "AzureServices",
  "defaultAction": "Deny",
  "ipRules": [
    {
      "value": "52.226.130.177/32"
    },
    {
      "value": "20.49.104.5/32"
    },
    {
      "value": "76.224.172.125/32"
    },
    {
      "value": "20.102.115.105/32"
    },
    {
      "value": "52.249.254.34/32"
    },
    {
      "value": "52.151.228.9/32"
    },
    {
      "value": "52.151.229.67/32"
    },
    {
      "value": "52.151.231.120/32"
    },
    {
      "value": "52.188.73.153/32"
    },
    {
      "value": "52.179.97.15/32"
    },
    {
      "value": "51.143.102.21/32"
    },
    {
      "value": "40.112.191.159/32"
    },
    {
      "value": "20.75.169.55/32"
    },
    {
      "value": "20.75.169.116/32"
    },
    {
      "value": "20.75.169.54/32"
    },
    {
      "value": "52.158.222.44/32"
    },
    {
      "value": "52.142.19.228/32"
    },
    {
      "value": "20.121.73.155/32"
    },
    {
      "value": "20.241.220.149/32"
    },
    {
      "value": "20.246.147.177/32"
    },
    {
      "value": "20.246.148.216/32"
    },
    {
      "value": "52.226.237.175/32"
    },
    {
      "value": "20.121.255.25/32"
    },
    {
      "value": "20.81.93.0/32"
    },
    {
      "value": "52.142.22.70/32"
    },
    {
      "value": "20.124.49.235/32"
    },
    {
      "value": "20.237.96.228/32"
    },
    {
      "value": "20.246.227.78/32"
    },
    {
      "value": "20.51.128.81/32"
    },
    {
      "value": "8.29.228.186/32"
    }
  ],
  "virtualNetworkRules": [
    {
      "id": "/subscriptions/c1e3635c-98d4-47f5-96e0-926717b6f0c4/resourcegroups/primary_rg/providers/microsoft.network/virtualnetworks/internalnetwork/subnets/publicfacing",
      "ignoreMissingVnetServiceEndpoint": false,
      "resourceGroup": "primary_rg"
    },
    {
      "id": "/subscriptions/c1e3635c-98d4-47f5-96e0-926717b6f0c4/resourcegroups/primary_rg/providers/microsoft.network/virtualnetworks/internalnetwork/subnets/ic-dev-web",
      "ignoreMissingVnetServiceEndpoint": false,
      "resourceGroup": "primary_rg"
    },
    {
      "id": "/subscriptions/c1e3635c-98d4-47f5-96e0-926717b6f0c4/resourcegroups/primary_rg/providers/microsoft.network/virtualnetworks/internalnetwork/subnets/termserver",
      "ignoreMissingVnetServiceEndpoint": false,
      "resourceGroup": "primary_rg"
    },
    {
      "id": "/subscriptions/f89b91a0-e110-4fbb-b84b-24c02f68cd81/resourcegroups/rg-east-infraqacommon-dev/providers/microsoft.network/virtualnetworks/vnet-east-infraqacommon-dev/subnets/snet-mgmt-infraqacommon-dev",
      "ignoreMissingVnetServiceEndpoint": false,
      "resourceGroup": "rg-east-infraqacommon-dev"
    },
    {
      "id": "/subscriptions/c1e3635c-98d4-47f5-96e0-926717b6f0c4/resourcegroups/primary_rg/providers/microsoft.network/virtualnetworks/internalnetwork/subnets/ic-apps",
      "ignoreMissingVnetServiceEndpoint": false,
      "resourceGroup": "primary_rg"
    },
    {
      "id": "/subscriptions/c1e3635c-98d4-47f5-96e0-926717b6f0c4/resourcegroups/primary_rg/providers/microsoft.network/virtualnetworks/internalnetwork/subnets/management",
      "ignoreMissingVnetServiceEndpoint": false,
      "resourceGroup": "primary_rg"
    },
    {
      "id": "/subscriptions/c1e3635c-98d4-47f5-96e0-926717b6f0c4/resourcegroups/primary_rg/providers/microsoft.network/virtualnetworks/internalnetwork/subnets/ic-proxy",
      "ignoreMissingVnetServiceEndpoint": false,
      "resourceGroup": "primary_rg"
    },
    {
      "id": "/subscriptions/c1e3635c-98d4-47f5-96e0-926717b6f0c4/resourcegroups/primary_rg/providers/microsoft.network/virtualnetworks/internalnetwork/subnets/ic-dev-proxy",
      "ignoreMissingVnetServiceEndpoint": false,
      "resourceGroup": "primary_rg"
    },
    {
      "id": "/subscriptions/c1e3635c-98d4-47f5-96e0-926717b6f0c4/resourcegroups/primary_rg/providers/microsoft.network/virtualnetworks/internalnetwork/subnets/ic-gateway-web",
      "ignoreMissingVnetServiceEndpoint": false,
      "resourceGroup": "primary_rg"
    },
    {
      "id": "/subscriptions/c1e3635c-98d4-47f5-96e0-926717b6f0c4/resourcegroups/primary_rg/providers/microsoft.network/virtualnetworks/internalnetwork/subnets/ic-production-term",
      "ignoreMissingVnetServiceEndpoint": false,
      "resourceGroup": "primary_rg"
    },
    {
      "id": "/subscriptions/c1e3635c-98d4-47f5-96e0-926717b6f0c4/resourcegroups/primary_rg/providers/microsoft.network/virtualnetworks/internalnetwork/subnets/ic-term-contractor",
      "ignoreMissingVnetServiceEndpoint": false,
      "resourceGroup": "primary_rg"
    },
    {
      "id": "/subscriptions/f89b91a0-e110-4fbb-b84b-24c02f68cd81/resourcegroups/rg-east-infraqa1to6-dev/providers/microsoft.network/virtualnetworks/vnet-east-infraqa1to6-dev/subnets/snet-mgmt-infraqa1to6-dev",
      "ignoreMissingVnetServiceEndpoint": false,
      "resourceGroup": "rg-east-infraqa1to6-dev"
    },
    {
      "id": "/subscriptions/c1e3635c-98d4-47f5-96e0-926717b6f0c4/resourcegroups/rg-azbatch/providers/microsoft.network/virtualnetworks/azbatch_prod/subnets/standard_notifications_pool",
      "ignoreMissingVnetServiceEndpoint": false,
      "resourceGroup": "rg-azbatch"
    },
    {
      "id": "/subscriptions/c1e3635c-98d4-47f5-96e0-926717b6f0c4/resourcegroups/rg-azbatch-test/providers/microsoft.network/virtualnetworks/azbatch_test/subnets/azbatch_test_controllerpool",
      "ignoreMissingVnetServiceEndpoint": false,
      "resourceGroup": "rg-azbatch-test"
    },
    {
      "id": "/subscriptions/f89b91a0-e110-4fbb-b84b-24c02f68cd81/resourcegroups/rg-east-infra-common-app-dev/providers/microsoft.network/virtualnetworks/vnet-east-infra-common-app-dev/subnets/snet-mgmt-infra-common-app-dev",
      "ignoreMissingVnetServiceEndpoint": false,
      "resourceGroup": "rg-east-infra-common-app-dev"
    }
  ]
}
Private Endpoints
InternalNetwork/ExternalKeySettingsKeyVaultPVESubnet
New Private Endpoint Plan
Implementation Plan
“Run new” 
deployment pipeline
Check to ensure the Network Rules are still as expected, documented above.
If not, we can ClickOps fix based on the documentation above.
Rollback Plan
Run 
destroy pipeline
 URL:/spaces/platform/pages/3021406238/Key+Vaults